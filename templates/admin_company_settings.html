<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Configurazione Azienda ¬∑ JobLog</title>
    <link rel="manifest" href="{{ static_version('manifest.json') }}">
    <link rel="icon" type="image/svg+xml" href="{{ static_version('icons/icon-192x192.svg') }}" />
    <script>
        window.APP_VERSION = 'v2026.01.07c';
    </script>
    <script>
        (function applyStoredTheme() {
            const stored = localStorage.getItem('joblog-theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = stored || (prefersDark ? 'dark' : 'light');
            document.documentElement.dataset.theme = theme;
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap');
        :root {
            color-scheme: light dark;
            --bg: #0b1224;
            --bg-panel: #0f172a;
            --bg-soft: #111a30;
            --bg-card: #0f172a;
            --card: #10182f;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --brand: #38bdf8;
            --brand-strong: #0ea5e9;
            --border: rgba(148, 163, 184, 0.18);
            --shadow: 0 20px 60px rgba(3, 7, 18, 0.4);
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #a855f7;
            --pink: #ec4899;
            --cyan: #06b6d4;
        }
        [data-theme="light"] {
            --bg: #f6f8fc;
            --bg-panel: #ffffff;
            --bg-soft: #eef2ff;
            --bg-card: #ffffff;
            --card: #ffffff;
            --text: #0f172a;
            --muted: #475569;
            --brand: #2563eb;
            --brand-strong: #1d4ed8;
            --border: rgba(15, 23, 42, 0.1);
            --shadow: 0 14px 38px rgba(15, 23, 42, 0.15);
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --purple: #9333ea;
            --pink: #db2777;
            --cyan: #0891b2;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Manrope', 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .hidden { display: none !important; }

        /* Update Banner Styles */
        .update-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 210;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }
        .update-banner.hidden {
            display: none !important;
        }
        .update-banner span {
            font-weight: 700;
            font-size: 14px;
            flex: 1;
        }
        .update-banner button {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            color: #ffffff;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
            white-space: nowrap;
        }
        .update-banner button:hover {
            background: rgba(255,255,255,0.35);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #667eea 0%, #4f46e5 100%);
            color: #f8fafc;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            overflow: visible;
        }
        .header-left { display: flex; align-items: center; gap: 16px; overflow: visible; }
        .header-title { color: white; }
        .header-title h1 { font-size: 20px; font-weight: 700; margin: 0; }
        .header-title p { font-size: 13px; opacity: 0.85; margin: 0; }
        .logo-title { font-weight: 700; font-size: 20px; letter-spacing: 0.4px; color: white; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .header-icon-btn {
            width: 40px; height: 40px;
            border: none; border-radius: 10px;
            background: rgba(255,255,255,0.12);
            color: white; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .header-icon-btn:hover { background: rgba(255,255,255,0.2); }

        /* Menu Overlay */
        .menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 210;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .menu-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 92vw;
            height: 100vh;
            height: 100dvh;
            background: var(--bg-card, #0f172a);
            z-index: 220;
            box-shadow: 2px 0 24px rgba(0,0,0,0.5);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transform: translateX(-105%);
            transition: transform 0.24s ease;
            overflow: hidden;
        }
        .side-menu.open {
            transform: translateX(0);
        }
        .side-menu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .side-menu-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .side-menu-avatar {
            width: 72px;
            height: 72px;
            min-width: 72px;
            min-height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #4f46e5 100%);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            text-transform: uppercase;
            overflow: hidden;
        }
        .side-menu-avatar:has(img) {
            background: transparent;
            border-radius: 8px;
        }
        .side-menu-avatar img {
            width: 72px;
            height: 72px;
            max-width: 72px;
            max-height: 72px;
            object-fit: contain;
        }
        .side-menu-brand-text {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }
        .side-menu-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text, #e2e8f0);
        }
        .side-menu-subtitle {
            font-size: 12px;
            color: var(--muted, #94a3b8);
            font-weight: 600;
        }
        .side-menu-version-chip {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(56, 189, 248, 0.15);
            border: 1px solid rgba(56, 189, 248, 0.4);
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--brand, #38bdf8);
            font-family: 'Courier New', monospace;
            letter-spacing: 0.4px;
            width: fit-content;
        }
        .side-menu-close {
            border: none;
            border-radius: 50%;
            background: transparent;
            color: var(--muted, #94a3b8);
            width: 36px;
            height: 36px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .side-menu-close:hover {
            background: rgba(102, 126, 234, 0.12);
            color: var(--brand, #667eea);
        }
        .menu-items {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            padding: 12px 0;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 12px;
            color: var(--text, #e2e8f0);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s ease;
        }
        .menu-item:hover { background: rgba(102, 126, 234, 0.1); }
        .menu-item.active { background: linear-gradient(135deg, #667eea 0%, #4f46e5 100%); color: #fff; }
        .menu-divider {
            height: 1px;
            background: rgba(148, 163, 184, 0.4);
            margin: 8px 16px;
        }
        .menu-item.danger { color: var(--danger); }
        .menu-item.danger:hover { background: rgba(102, 126, 234, 0.1); }
        .menu-badge {
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            margin-left: auto;
            min-width: 18px;
            text-align: center;
        }

        .header-user {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 999px;
        }
        .header-user-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px;
        }
        .header-user-name { font-weight: 600; font-size: 14px; }

        /* Main content */
        main {
            flex: 1;
            padding: 24px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .page-header {
            margin-bottom: 24px;
        }
        .page-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }
        .page-subtitle {
            color: var(--muted);
            font-size: 15px;
        }

        /* Cards */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title-icon {
            font-size: 22px;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        .form-input, .form-textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-soft);
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-hint {
            font-size: 12px;
            color: var(--muted);
        }

        /* Logo upload */
        .logo-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 24px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: var(--bg-soft);
            transition: border-color 0.2s, background 0.2s;
            cursor: pointer;
        }
        .logo-upload-area:hover {
            border-color: var(--brand);
            background: rgba(56, 189, 248, 0.05);
        }
        .logo-upload-area.dragover {
            border-color: var(--brand);
            background: rgba(56, 189, 248, 0.1);
        }
        .logo-preview {
            max-width: 200px;
            max-height: 120px;
            border-radius: 8px;
            object-fit: contain;
        }
        .logo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--muted);
        }
        .logo-upload-text {
            text-align: center;
        }
        .logo-upload-text strong {
            display: block;
            font-size: 15px;
            margin-bottom: 4px;
        }
        .logo-upload-text span {
            font-size: 13px;
            color: var(--muted);
        }
        .logo-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        /* Modules section */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .module-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-soft);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .module-card:hover {
            border-color: var(--brand);
        }
        .module-card.enabled {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.08);
        }
        .module-icon {
            font-size: 28px;
        }
        .module-info {
            flex: 1;
        }
        .module-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 2px;
        }
        .module-desc {
            font-size: 12px;
            color: var(--muted);
        }
        .module-toggle {
            width: 48px;
            height: 26px;
            border-radius: 13px;
            background: var(--border);
            position: relative;
            transition: background 0.2s;
        }
        .module-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .module-card.enabled .module-toggle {
            background: var(--success);
        }
        .module-card.enabled .module-toggle::after {
            transform: translateX(22px);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn.primary {
            background: var(--brand);
            color: white;
        }
        .btn.primary:hover {
            background: var(--brand-strong);
            transform: translateY(-1px);
        }
        .btn.secondary {
            background: var(--bg-soft);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover {
            background: var(--border);
        }
        .btn.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        .btn.danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        .btn.sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .actions-bar {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast.success {
            background: var(--success);
            color: white;
        }
        .toast.error {
            background: var(--danger);
            color: white;
        }
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 600px) {
            main { padding: 16px; }
            .card { padding: 16px; }
            .form-grid { grid-template-columns: 1fr; }
            .page-title { font-size: 22px; }
        }

        /* GPS Location Cards */
        .gps-location-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }
        .gps-location-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .gps-location-header input {
            flex: 1;
            font-weight: 600;
        }
        .gps-location-delete {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .gps-location-delete:hover {
            background: rgba(239, 68, 68, 0.25);
        }
        .gps-location-coords {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 600px) {
            .gps-location-coords {
                grid-template-columns: 1fr;
            }
        }
        .gps-location-coords .form-group {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <!-- Side Menu -->
    <nav class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <div class="side-menu-brand">
                <span class="side-menu-avatar">
                    {% if company_logo %}
                        <img src="{{ company_logo }}" alt="Logo">
                    {% else %}
                        {{ session.get('user', 'U')[0]|upper }}
                    {% endif %}
                </span>
                <div class="side-menu-brand-text">
                    <span class="side-menu-title">JobLog Admin</span>
                    <span class="side-menu-subtitle">Pannello Amministrazione</span>
                    <span class="side-menu-version-chip" id="adminVersionBadge">v2026.01.07c</span>
                </div>
            </div>
            <button class="side-menu-close" onclick="closeMenu()">‚úï</button>
        </div>
        <div class="menu-items">
            <a href="/admin" class="menu-item">üìä Dashboard</a>
            <a href="/admin/activity-analysis" class="menu-item">üìà Analisi Attivit√†</a>
            <div class="menu-divider"></div>
            <a href="/admin/group-planning" class="menu-item">üìÜ Planning Gruppo</a>
            <a href="/admin/employee-shifts" class="menu-item">üìÖ Turni Dipendenti</a>
            <a href="/admin/rentman-planning" class="menu-item">üìã Pianificazioni</a>
            <div class="menu-divider"></div>
            <a href="/admin/sessions" class="menu-item">‚è±Ô∏è Sessioni</a>
            <a href="/admin/documents" class="menu-item">üìÑ Documenti</a>
            <a href="/admin/user-requests" class="menu-item">
                üì• Richieste
                <span class="menu-badge" id="pendingRequestsBadge" style="display: none;"></span>
            </a>
            <div class="menu-divider"></div>
            <a href="/admin/operators" class="menu-item">üë∑ Operatori Rentman</a>
            <a href="/admin/request-types" class="menu-item">üìù Tipologie Richieste</a>
            <a href="/admin/users" class="menu-item">üë• Utenti</a>
            <a href="/admin/groups" class="menu-item">üè∑Ô∏è Gruppi</a>
            <a href="/admin/timbratura-rules" class="menu-item">‚ö° Regole Timbrature</a>
            <a href="/admin/company-settings" class="menu-item active">‚öôÔ∏è Impostazioni</a>
            <div class="menu-divider"></div>
            <a href="/logout" class="menu-item danger">üö™ Logout</a>
        </div>
    </nav>

    <header>
        <div class="header-left">
            <button class="header-icon-btn" onclick="toggleMenu()" title="Menu">‚ò∞</button>
            <div class="header-title">
                <h1>‚öôÔ∏è Configurazione Azienda</h1>
                <p>Impostazioni generali</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-icon-btn" onclick="toggleTheme()" title="Tema">üåì</button>
            <div class="header-user">
                <div class="header-user-avatar">{{ session.get('user', 'U')[0]|upper }}</div>
                <span class="header-user-name">{{ session.get('user', 'Utente') }}</span>
            </div>
        </div>
    </header>

    <!-- Update Banner -->
    <div id="updateBanner" class="update-banner hidden" role="status" aria-live="polite" aria-hidden="true">
        <span>üîÑ Nuova versione disponibile <strong id="newVersionDisplay"></strong></span>
        <button id="dismissUpdateBtn" type="button" style="background: transparent; border: 1px solid rgba(255,255,255,0.4); margin-right: 8px;">Pi√π tardi</button>
        <button id="refreshAppBtn" type="button">Aggiorna</button>
    </div>

    <main>
        <div class="page-header">
            <h1 class="page-title">üè¢ Configurazione Azienda</h1>
            <p class="page-subtitle">Gestisci le informazioni aziendali e i moduli attivi</p>
        </div>

        <!-- Logo e Informazioni Base -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">üñºÔ∏è</span>
                Logo Aziendale
            </h2>
            <div class="logo-upload-area" id="logoUploadArea">
                <div id="logoPreviewContainer">
                    <div class="logo-placeholder" id="logoPlaceholder">üè¢</div>
                    <img src="" alt="Logo" class="logo-preview hidden" id="logoPreview">
                </div>
                <div class="logo-upload-text">
                    <strong>Clicca o trascina per caricare</strong>
                    <span>PNG, JPG, SVG, WebP (max 2MB)</span>
                </div>
                <input type="file" id="logoInput" accept="image/*" class="hidden">
            </div>
            <div class="logo-actions" id="logoActions" style="display: none; justify-content: center;">
                <button type="button" class="btn secondary sm" id="btnChangeLogo">üì∑ Cambia</button>
                <button type="button" class="btn danger sm" id="btnDeleteLogo">üóëÔ∏è Rimuovi</button>
            </div>
        </div>

        <!-- Dati Aziendali -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">üìã</span>
                Informazioni Aziendali
            </h2>
            <form id="companyForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nome Azienda *</label>
                        <input type="text" class="form-input" id="companyName" required placeholder="Es. Acme S.r.l.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ID Esterno</label>
                        <input type="text" class="form-input" id="externalId" placeholder="Es. ID Rentman, SAP, etc.">
                        <span class="form-hint">Identificativo per integrazioni esterne</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Partita IVA</label>
                        <input type="text" class="form-input" id="vatNumber" placeholder="Es. IT12345678901">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Codice Fiscale</label>
                        <input type="text" class="form-input" id="fiscalCode" placeholder="Es. 12345678901">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Indirizzo</label>
                        <textarea class="form-textarea" id="address" rows="2" placeholder="Via, numero civico, CAP, Citt√†"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email" placeholder="info@azienda.it">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefono</label>
                        <input type="tel" class="form-input" id="phone" placeholder="+39 02 12345678">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Sito Web</label>
                        <input type="url" class="form-input" id="website" placeholder="https://www.azienda.it">
                    </div>
                </div>
            </form>
        </div>

        <!-- Moduli (predisposizione futura) -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">üß©</span>
                Moduli Abilitati
            </h2>
            <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">
                Attiva o disattiva le funzionalit√† disponibili nell'applicazione
            </p>
            <div class="modules-grid" id="modulesGrid">
                <div class="module-card enabled" data-module="timbrature">
                    <span class="module-icon">‚è±Ô∏è</span>
                    <div class="module-info">
                        <div class="module-name">Timbrature</div>
                        <div class="module-desc">Gestione presenze e orari</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card enabled" data-module="sessions">
                    <span class="module-icon">üóìÔ∏è</span>
                    <div class="module-info">
                        <div class="module-name">Sessioni Lavoro</div>
                        <div class="module-desc">Tracciamento attivit√†</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card enabled" data-module="requests">
                    <span class="module-icon">üìù</span>
                    <div class="module-info">
                        <div class="module-name">Richieste</div>
                        <div class="module-desc">Ferie, permessi, rimborsi</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card" data-module="magazzino">
                    <span class="module-icon">üì¶</span>
                    <div class="module-info">
                        <div class="module-name">Magazzino</div>
                        <div class="module-desc">Gestione inventario</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card" data-module="reports">
                    <span class="module-icon">üìä</span>
                    <div class="module-info">
                        <div class="module-name">Report Avanzati</div>
                        <div class="module-desc">Analytics e statistiche</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card enabled" data-module="straordinari">
                    <span class="module-icon">‚è∞</span>
                    <div class="module-info">
                        <div class="module-name">Straordinari</div>
                        <div class="module-desc">Gestione ore extra</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
            </div>
        </div>

        <!-- Integrazioni Esterne -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">üîÑ</span>
                Integrazioni Esterne
            </h2>
            <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">
                Configura la sincronizzazione con servizi esterni
            </p>
            <div class="modules-grid">
                <div class="module-card enabled" data-module="rentman">
                    <span class="module-icon">üîó</span>
                    <div class="module-info">
                        <div class="module-name">Integrazione Rentman</div>
                        <div class="module-desc">Sincronizzazione progetti</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card" data-integration="cedolino_sync" id="cedolinoSyncCard">
                    <span class="module-icon">üì§</span>
                    <div class="module-info">
                        <div class="module-name">CedolinoWeb Sync</div>
                        <div class="module-desc">Invia timbrature a CedolinoWeb</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
            </div>
        </div>

        <!-- Configurazione Timbratura -->
        <div class="card">
            <h2 class="card-title">
                <span class="card-title-icon">‚è±Ô∏è</span>
                Configurazione Timbratura
            </h2>
            <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">
                Configura i metodi di verifica per la timbratura dei dipendenti
            </p>
            
            <!-- Metodi di Timbratura -->
            <div style="margin-bottom: 24px;">
                <label class="form-label" style="margin-bottom: 12px; display: block;">Metodi di Verifica</label>
                <div class="modules-grid">
                    <div class="module-card enabled" data-timbratura="qr_enabled" id="timbraturaQr">
                        <span class="module-icon">üì∑</span>
                        <div class="module-info">
                            <div class="module-name">QR Code</div>
                            <div class="module-desc">Scansione codice in sede</div>
                        </div>
                        <div class="module-toggle"></div>
                    </div>
                    <div class="module-card" data-timbratura="gps_enabled" id="timbraturaGps">
                        <span class="module-icon">üìç</span>
                        <div class="module-info">
                            <div class="module-name">GPS</div>
                            <div class="module-desc">Geolocalizzazione</div>
                        </div>
                        <div class="module-toggle"></div>
                    </div>
                </div>
            </div>

            <!-- Impostazioni GPS -->
            <div id="gpsSettingsPanel" style="display: none;">
                <div style="background: var(--bg-soft); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <span>üìç</span> Impostazioni GPS
                    </h3>
                    
                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">Precisione GPS Massima (metri)</label>
                        <input type="number" class="form-input" id="gpsMaxAccuracy" value="50" min="10" max="200" style="max-width: 150px;">
                        <span class="form-hint">L'utente deve avere una precisione GPS inferiore a questo valore</span>
                    </div>

                    <div style="margin-top: 20px;">
                        <label class="form-label" style="margin-bottom: 12px; display: block;">Sedi Autorizzate</label>
                        <div id="gpsLocationsContainer"></div>
                        <button type="button" class="btn secondary sm" id="btnAddLocation" style="margin-top: 12px;">
                            ‚ûï Aggiungi Sede
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurazione Straordinari -->
        <div class="card" id="overtimeSettingsCard">
            <h2 class="card-title">
                <span class="card-title-icon">‚è∞</span>
                Gestione Straordinari
            </h2>
            <p style="color: var(--muted); margin-bottom: 16px; font-size: 14px;">
                Configura le regole per il rilevamento e la gestione degli Extra Turni
            </p>
            
            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Soglia Minima Extra Turno (minuti)</label>
                <input type="number" class="form-input" id="overtimeThreshold" value="15" min="5" max="120" style="max-width: 150px;">
                <span class="form-hint">Differenza minima tra orario pianificato e effettivo per considerare l'Extra Turno</span>
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
                <label class="form-label">Arrotondamento Extra Turno</label>
                <select class="form-input" id="overtimeRounding" style="max-width: 200px;">
                    <option value="1">Al minuto</option>
                    <option value="5">Ogni 5 minuti</option>
                    <option value="15" selected>Ogni 15 minuti</option>
                    <option value="30">Ogni 30 minuti</option>
                </select>
                <span class="form-hint">Come arrotondare i minuti di Extra Turno</span>
            </div>

            <div class="modules-grid">
                <div class="module-card enabled" id="overtimeAutoDetect">
                    <span class="module-icon">üîç</span>
                    <div class="module-info">
                        <div class="module-name">Rilevamento Automatico</div>
                        <div class="module-desc">Rileva straordinari al checkout</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
                <div class="module-card enabled" id="overtimeRequireApproval">
                    <span class="module-icon">‚úÖ</span>
                    <div class="module-info">
                        <div class="module-name">Richiede Approvazione</div>
                        <div class="module-desc">Admin deve approvare</div>
                    </div>
                    <div class="module-toggle"></div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-bar">
            <button type="button" class="btn secondary" onclick="loadSettings()">‚Ü∫ Annulla modifiche</button>
            <button type="button" class="btn primary" id="btnSave">üíæ Salva Impostazioni</button>
        </div>
    </main>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
    </div>

    <script>
        // State
        let currentSettings = {};
        let hasChanges = false;
        let gpsLocations = [];

        // DOM Elements
        const menuToggle = document.getElementById('menuToggle');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');
        const menuClose = document.getElementById('menuClose');
        const themeToggle = document.getElementById('themeToggle');
        const logoInput = document.getElementById('logoInput');
        const logoUploadArea = document.getElementById('logoUploadArea');
        const logoPreview = document.getElementById('logoPreview');
        const logoPlaceholder = document.getElementById('logoPlaceholder');
        const logoActions = document.getElementById('logoActions');
        const btnChangeLogo = document.getElementById('btnChangeLogo');
        const btnDeleteLogo = document.getElementById('btnDeleteLogo');
        const btnSave = document.getElementById('btnSave');
        const modulesGrid = document.getElementById('modulesGrid');
        const gpsSettingsPanel = document.getElementById('gpsSettingsPanel');
        const gpsLocationsContainer = document.getElementById('gpsLocationsContainer');
        const btnAddLocation = document.getElementById('btnAddLocation');
        const timbraturaQrCard = document.getElementById('timbraturaQr');
        const timbraturaGpsCard = document.getElementById('timbraturaGps');
        const overtimeAutoDetectCard = document.getElementById('overtimeAutoDetect');
        const overtimeRequireApprovalCard = document.getElementById('overtimeRequireApproval');
        const cedolinoSyncCard = document.getElementById('cedolinoSyncCard');
        const cedolinoConfigNote = document.getElementById('cedolinoConfigNote');

        // Menu toggle - funzioni globali per onclick
        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('open');
            document.getElementById('menuOverlay').classList.toggle('open');
        }
        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('menuOverlay').classList.remove('open');
        }
        // Side menu: il bottone ha gi√† onclick="toggleMenu()"

        // Theme toggle
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const root = document.documentElement;
                const current = root.dataset.theme;
                const next = current === 'dark' ? 'light' : 'dark';
                root.dataset.theme = next;
                localStorage.setItem('joblog-theme', next);
            });
        }

        // Logo upload
        logoUploadArea.addEventListener('click', () => logoInput.click());
        btnChangeLogo.addEventListener('click', (e) => {
            e.stopPropagation();
            logoInput.click();
        });

        logoUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            logoUploadArea.classList.add('dragover');
        });
        logoUploadArea.addEventListener('dragleave', () => {
            logoUploadArea.classList.remove('dragover');
        });
        logoUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            logoUploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                uploadLogo(file);
            }
        });

        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadLogo(file);
            }
        });

        btnDeleteLogo.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (!confirm('Eliminare il logo aziendale?')) return;
            
            showLoading();
            try {
                const res = await fetch('/api/admin/company-settings/logo', { method: 'DELETE' });
                const data = await res.json();
                if (data.ok) {
                    currentSettings.logo_path = null;  // Aggiorna lo stato!
                    showLogo(null);
                    showToast('Logo eliminato', 'success');
                } else {
                    showToast(data.error || 'Errore', 'error');
                }
            } catch (err) {
                showToast('Errore di connessione', 'error');
            }
            hideLoading();
        });

        async function uploadLogo(file) {
            if (file.size > 2 * 1024 * 1024) {
                showToast('File troppo grande (max 2MB)', 'error');
                return;
            }

            showLoading();
            const formData = new FormData();
            formData.append('logo', file);

            try {
                const res = await fetch('/api/admin/company-settings/logo', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok) {
                    currentSettings.logo_path = data.logo_path;  // Aggiorna lo stato!
                    showLogo(data.logo_path);
                    showToast('Logo caricato', 'success');
                } else {
                    showToast(data.error || 'Errore upload', 'error');
                }
            } catch (err) {
                showToast('Errore di connessione', 'error');
            }
            hideLoading();
        }

        function showLogo(path) {
            if (path) {
                logoPreview.src = path + '?t=' + Date.now();
                logoPreview.classList.remove('hidden');
                logoPlaceholder.classList.add('hidden');
                logoActions.style.display = 'flex';
            } else {
                logoPreview.classList.add('hidden');
                logoPlaceholder.classList.remove('hidden');
                logoActions.style.display = 'none';
            }
        }

        // Modules toggle
        modulesGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.module-card');
            if (card && card.dataset.module) {
                card.classList.toggle('enabled');
                hasChanges = true;
                
                // Se √® il modulo straordinari, mostra/nascondi la sezione di configurazione
                if (card.dataset.module === 'straordinari') {
                    updateOvertimeSettingsVisibility();
                }
            }
        });
        
        function updateOvertimeSettingsVisibility() {
            const straordinariModule = document.querySelector('.module-card[data-module="straordinari"]');
            const overtimeCard = document.getElementById('overtimeSettingsCard');
            if (straordinariModule && overtimeCard) {
                overtimeCard.style.display = straordinariModule.classList.contains('enabled') ? 'block' : 'none';
            }
        }

        // Timbratura toggles
        timbraturaQrCard.addEventListener('click', () => {
            timbraturaQrCard.classList.toggle('enabled');
            hasChanges = true;
        });

        timbraturaGpsCard.addEventListener('click', () => {
            timbraturaGpsCard.classList.toggle('enabled');
            updateGpsSettingsVisibility();
            hasChanges = true;
        });

        // Overtime toggles
        overtimeAutoDetectCard.addEventListener('click', () => {
            overtimeAutoDetectCard.classList.toggle('enabled');
            hasChanges = true;
        });

        overtimeRequireApprovalCard.addEventListener('click', () => {
            overtimeRequireApprovalCard.classList.toggle('enabled');
            hasChanges = true;
        });

        // CedolinoWeb Sync toggle
        cedolinoSyncCard.addEventListener('click', () => {
            cedolinoSyncCard.classList.toggle('enabled');
            hasChanges = true;
        });

        function updateGpsSettingsVisibility() {
            const gpsEnabled = timbraturaGpsCard.classList.contains('enabled');
            gpsSettingsPanel.style.display = gpsEnabled ? 'block' : 'none';
        }

        // GPS Locations Management
        btnAddLocation.addEventListener('click', () => {
            addGpsLocation({ name: '', latitude: '', longitude: '', radius_meters: 100 });
            hasChanges = true;
        });

        function addGpsLocation(loc, index = null) {
            if (index === null) {
                index = gpsLocations.length;
                gpsLocations.push(loc);
            }
            
            const card = document.createElement('div');
            card.className = 'gps-location-card';
            card.dataset.index = index;
            card.innerHTML = `
                <div class="gps-location-header">
                    <input type="text" class="form-input" placeholder="Nome sede (es. Sede Centrale)" 
                           value="${loc.name || ''}" data-field="name">
                    <button type="button" class="gps-location-delete" title="Elimina">üóëÔ∏è</button>
                </div>
                <div class="gps-location-coords">
                    <div class="form-group">
                        <label class="form-label">Latitudine</label>
                        <input type="text" inputmode="decimal" class="form-input" placeholder="45.4642" 
                               value="${loc.latitude || ''}" data-field="latitude">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Longitudine</label>
                        <input type="text" inputmode="decimal" class="form-input" placeholder="9.1900" 
                               value="${loc.longitude || ''}" data-field="longitude">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Raggio (m)</label>
                        <input type="number" class="form-input" placeholder="100" min="10" max="1000"
                               value="${loc.radius_meters || 100}" data-field="radius_meters">
                    </div>
                </div>
                <button type="button" class="btn secondary sm gps-get-location" style="margin-top: 12px; width: 100%;">
                    üìç Usa posizione attuale
                </button>
            `;
            
            // Event listeners
            card.querySelector('.gps-location-delete').addEventListener('click', () => {
                const idx = parseInt(card.dataset.index);
                gpsLocations.splice(idx, 1);
                renderGpsLocations();
                hasChanges = true;
            });
            
            // Pulsante "Usa posizione attuale"
            card.querySelector('.gps-get-location').addEventListener('click', async function() {
                const btn = this;
                const idx = parseInt(card.dataset.index);
                
                if (!navigator.geolocation) {
                    showToast('‚ö†Ô∏è Geolocalizzazione non supportata', 'error');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'üìç Rilevamento in corso...';
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = Math.round(position.coords.accuracy);
                        
                        // Aggiorna i campi
                        card.querySelector('[data-field="latitude"]').value = lat.toFixed(6);
                        card.querySelector('[data-field="longitude"]').value = lng.toFixed(6);
                        
                        // Aggiorna lo stato
                        gpsLocations[idx].latitude = lat;
                        gpsLocations[idx].longitude = lng;
                        hasChanges = true;
                        
                        btn.disabled = false;
                        btn.textContent = 'üìç Usa posizione attuale';
                        showToast(`‚úÖ Posizione rilevata (precisione: ¬±${accuracy}m)`, 'success');
                    },
                    (error) => {
                        btn.disabled = false;
                        btn.textContent = 'üìç Usa posizione attuale';
                        
                        let msg = 'Errore GPS';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                msg = '‚ö†Ô∏è Permesso posizione negato';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                msg = '‚ö†Ô∏è Posizione non disponibile';
                                break;
                            case error.TIMEOUT:
                                msg = '‚ö†Ô∏è Timeout rilevamento GPS';
                                break;
                        }
                        showToast(msg, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
            
            card.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    const idx = parseInt(card.dataset.index);
                    const field = input.dataset.field;
                    let value = input.value;
                    if (field === 'latitude' || field === 'longitude') {
                        // Gestisce sia virgola che punto come separatore decimale
                        value = parseFloat(value.replace(',', '.')) || '';
                    } else if (field === 'radius_meters') {
                        value = parseInt(value) || 100;
                    }
                    gpsLocations[idx][field] = value;
                    hasChanges = true;
                });
            });
            
            gpsLocationsContainer.appendChild(card);
        }

        function renderGpsLocations() {
            gpsLocationsContainer.innerHTML = '';
            gpsLocations.forEach((loc, idx) => {
                addGpsLocation(loc, idx);
            });
        }

        // Form tracking
        document.querySelectorAll('.form-input, .form-textarea').forEach(el => {
            el.addEventListener('input', () => { hasChanges = true; });
        });

        // Save
        btnSave.addEventListener('click', saveSettings);

        async function loadSettings() {
            showLoading();
            try {
                const res = await fetch('/api/admin/company-settings');
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                const data = await res.json();
                
                currentSettings = data;
                
                // Populate form
                document.getElementById('companyName').value = data.company_name || '';
                document.getElementById('externalId').value = data.external_id || '';
                document.getElementById('vatNumber').value = data.vat_number || '';
                document.getElementById('fiscalCode').value = data.fiscal_code || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('phone').value = data.phone || '';
                document.getElementById('website').value = data.website || '';
                
                // Show logo
                showLogo(data.logo_path);
                
                // Set modules
                const modules = data.modules_enabled || {};
                document.querySelectorAll('.module-card[data-module]').forEach(card => {
                    const mod = card.dataset.module;
                    const enabled = modules[mod] !== false; // default enabled
                    card.classList.toggle('enabled', enabled);
                });
                
                // Set timbratura config
                const timbratura = data.custom_settings?.timbratura || {};
                timbraturaQrCard.classList.toggle('enabled', timbratura.qr_enabled !== false);
                timbraturaGpsCard.classList.toggle('enabled', timbratura.gps_enabled === true);
                
                // Set CedolinoWeb sync
                const cedolinoEnabled = data.custom_settings?.cedolino_sync_enabled === true;
                cedolinoSyncCard.classList.toggle('enabled', cedolinoEnabled);
                // Mostra nota se config.json non √® configurato (lo verifichiamo via flag dal server)
                if (cedolinoConfigNote) {
                    cedolinoConfigNote.style.display = data.cedolino_configured ? 'none' : 'block';
                }
                
                // GPS Settings
                document.getElementById('gpsMaxAccuracy').value = timbratura.gps_max_accuracy_meters || 50;
                gpsLocations = timbratura.gps_locations || [];
                renderGpsLocations();
                updateGpsSettingsVisibility();
                
                // Overtime Settings
                const overtime = data.custom_settings?.overtime || {};
                document.getElementById('overtimeThreshold').value = overtime.threshold_minutes || 15;
                document.getElementById('overtimeRounding').value = overtime.rounding_minutes || 15;
                overtimeAutoDetectCard.classList.toggle('enabled', overtime.auto_detect !== false);
                overtimeRequireApprovalCard.classList.toggle('enabled', overtime.require_approval !== false);
                
                // Mostra/nascondi sezione straordinari in base al modulo
                updateOvertimeSettingsVisibility();
                
                hasChanges = false;
            } catch (err) {
                console.error('Errore caricamento settings:', err);
                showToast('Errore caricamento: ' + err.message, 'error');
            }
            hideLoading();
        }

        async function saveSettings() {
            const data = {
                company_name: document.getElementById('companyName').value.trim() || 'La Mia Azienda',
                external_id: document.getElementById('externalId').value.trim() || null,
                vat_number: document.getElementById('vatNumber').value.trim() || null,
                fiscal_code: document.getElementById('fiscalCode').value.trim() || null,
                address: document.getElementById('address').value.trim() || null,
                email: document.getElementById('email').value.trim() || null,
                phone: document.getElementById('phone').value.trim() || null,
                website: document.getElementById('website').value.trim() || null,
                modules_enabled: {},
                custom_settings: currentSettings.custom_settings || {},
                logo_path: currentSettings.logo_path
            };

            // Collect modules
            document.querySelectorAll('.module-card[data-module]').forEach(card => {
                const mod = card.dataset.module;
                data.modules_enabled[mod] = card.classList.contains('enabled');
            });

            // Collect timbratura settings
            const validLocations = gpsLocations.filter(loc => 
                loc.name && loc.latitude && loc.longitude
            );
            
            data.custom_settings.timbratura = {
                qr_enabled: timbraturaQrCard.classList.contains('enabled'),
                gps_enabled: timbraturaGpsCard.classList.contains('enabled'),
                gps_max_accuracy_meters: parseInt(document.getElementById('gpsMaxAccuracy').value) || 50,
                gps_locations: validLocations.map(loc => ({
                    name: loc.name,
                    latitude: parseFloat(loc.latitude),
                    longitude: parseFloat(loc.longitude),
                    radius_meters: parseInt(loc.radius_meters) || 100
                }))
            };

            // CedolinoWeb sync setting
            data.custom_settings.cedolino_sync_enabled = cedolinoSyncCard.classList.contains('enabled');

            // Overtime settings
            data.custom_settings.overtime = {
                threshold_minutes: parseInt(document.getElementById('overtimeThreshold').value) || 15,
                rounding_minutes: parseInt(document.getElementById('overtimeRounding').value) || 15,
                auto_detect: overtimeAutoDetectCard.classList.contains('enabled'),
                require_approval: overtimeRequireApprovalCard.classList.contains('enabled')
            };

            showLoading();
            try {
                const res = await fetch('/api/admin/company-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.ok) {
                    showToast('Impostazioni salvate!', 'success');
                    hasChanges = false;
                    currentSettings = { ...currentSettings, ...data };
                } else {
                    showToast(result.error || 'Errore salvataggio', 'error');
                }
            } catch (err) {
                showToast('Errore di connessione', 'error');
            }
            hideLoading();
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Warn on leave
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Carica contatore richieste pendenti
        fetch('/api/admin/user-requests/pending-count')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('pendingRequestsBadge');
                if (badge && data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                }
            }).catch(() => {});

        // Init
        loadSettings();
    </script>
    <script src="{{ static_version('js/admin_update_system.js') }}"></script>
</body>
</html>
