<!DOCTYPE html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>JOBlog</title>

<!-- PWA Meta Tags -->
<meta name="application-name" content="JobLog">
<meta name="description" content="Gestione timer e attività per progetti Rentman">
<meta name="theme-color" content="#0ea5e9">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="JobLog">

<!-- PWA Manifest -->
<link rel="manifest" href="{{ static_version('manifest.json') }}">

<!-- PWA Icons -->
<link rel="icon" type="image/svg+xml" sizes="192x192" href="{{ static_version('icons/icon-192x192.svg') }}">
<link rel="icon" type="image/png" sizes="192x192" href="{{ static_version('icons/icon-192x192.png') }}">
<link rel="shortcut icon" href="{{ static_version('icons/icon-192x192.png') }}" type="image/png">
<link rel="icon" type="image/svg+xml" sizes="512x512" href="{{ static_version('icons/icon-512x512.svg') }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ static_version('icons/icon-192x192.png') }}">

<link rel="preconnect" href="{{ static_version('js/app.js') }}" />
<style>
:root {
  /* Theme Colors - Light Mode (default) */
  --bg: #f0f4f8;
  --bg-card: #ffffff;
  --text-primary: #0f172a;
  --text-secondary: #475569;
    --brand: #2563eb;
    --brand-hover: #1d4ed8;
  --ok: #16a34a;
  --warn: #dc2626;
  --border: #cbd5e1;
  --shadow: rgba(0,0,0,0.12);
  --shadow-lg: rgba(0,0,0,0.22);
  --overlay: rgba(15,23,42,0.5);
  --member-bg: #dbeafe;
  --member-selected-bg: #93c5fd;
    --header-height: 72px;
    --project-bar-offset: calc(var(--header-height) + 12px);
    --selection-toolbar-height: 0px;
  /* Touch target minimo per uso con guanti */
  --touch-min: 52px;
}

/* Dark Mode Variables */
[data-theme="dark"] {
    --bg: #0f172a;
    --bg-card: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --brand: #38bdf8;
    --brand-hover: #0ea5e9;
    --ok: #4ade80;
    --warn: #f87171;
    --border: #334155;
    --shadow: rgba(0,0,0,0.3);
    --shadow-lg: rgba(0,0,0,0.5);
    --overlay: rgba(0,0,0,0.6);
    --member-bg: #334155;
    --member-selected-bg: #475569;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text-primary); margin: 0; padding: 0; -webkit-font-smoothing: antialiased; transition: background-color 0.2s ease, color 0.2s ease; }
body.modal-open, body.menu-open { overflow: hidden; }
header { background: linear-gradient(90deg, rgba(15,23,42,0.96), rgba(12,74,110,0.9)); color: #f8fafc; padding: 14px 16px; font-size: 18px; display: flex; flex-direction: column; gap: 8px; position: sticky; top: 0; z-index: 220; box-shadow: 0 10px 30px rgba(3,7,18,0.35); }
.header-row-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.header-row-bottom { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.header-left { display:flex; align-items:center; gap:12px; }
.logo-title { font-weight: 700; font-size: 28px; letter-spacing: 0.5px; }
.header-actions #clock { font-size: 16px; font-weight: 600; letter-spacing: 0.3px; white-space: nowrap; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 8px; }
.header-actions { display: flex; align-items: center; gap: 12px; }
.header-user { display:flex; align-items:center; gap:8px; padding:8px 16px; background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; min-height:var(--touch-min); touch-action:manipulation; transition:all 0.2s ease; }
.header-user:hover { background:rgba(255,255,255,0.2); border-color:rgba(255,255,255,0.3); }
.header-user-avatar { display:none; }
.header-user-icon { font-size:16px; opacity:0.9; }
.header-user-name { font-weight:600; font-size:14px; max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:0.3px; }
.header-icon-btn { width:52px; height:52px; border:none; border-radius:14px; background:rgba(255,255,255,0.18); color:white; font-size:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background 0.2s ease, transform 0.1s ease; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
.header-icon-btn:active { background:rgba(255,255,255,0.35); transform: scale(0.92); }
.menu-overlay { position:fixed; inset:0; background:rgba(32,33,36,0.32); z-index:210; }
.side-menu { position:fixed; top:0; left:0; height:100vh; height:100dvh; width:320px; max-width:92vw; background:var(--bg-card); z-index:220; box-shadow:2px 0 24px var(--shadow-lg); padding:16px 16px; display:flex; flex-direction:column; gap:12px; transform:translateX(-105%); transition:transform 0.24s ease, background-color 0.2s ease; overflow:hidden; }
.side-menu.open { transform:translateX(0); }
.side-menu-header { display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
.side-menu-brand { display:flex; align-items:center; gap:12px; }
.side-menu-avatar { width:42px; height:42px; border-radius:50%; background:#1a73e8; color:#ffffff; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:600; text-transform:uppercase; }
.side-menu-brand-text { display:flex; flex-direction:column; gap:1px; }
.side-menu-title { font-size:16px; font-weight:600; color:var(--text-primary); max-width:170px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.side-menu-subtitle { font-size:12px; color:var(--text-secondary); }
.side-menu-username { font-size:11px; color:var(--text-secondary); font-weight:500; }
.side-menu-brand-text .side-menu-release-chip { margin-top:6px; }
.side-menu-close { border:none; border-radius:50%; background:transparent; color:#5f6368; width:36px; height:36px; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:background 0.2s ease, color 0.2s ease; flex-shrink:0; }
.side-menu-close:active { background:rgba(66,133,244,0.12); color:#1a73e8; }
.side-menu-body { flex:1; display:flex; flex-direction:column; gap:12px; overflow-y:auto; overflow-x:hidden; padding-right:4px; padding-bottom:20px; -webkit-overflow-scrolling:touch; }
.side-menu-section { display:flex; flex-direction:column; gap:6px; }
.side-menu-section-title { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.8px; color:#5f6368; margin:0 0 2px 4px; }
.side-menu-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:2px; }
.side-menu-item { border:none; border-radius:12px; padding:10px 12px; background:transparent; color:var(--text-primary); font-size:14px; font-weight:600; text-align:left; cursor:pointer; transition:background 0.2s ease, color 0.2s ease; display:flex; align-items:center; gap:12px; }
.side-menu-item.side-menu-link { text-decoration:none; color:var(--text-primary); }
.side-menu-item.side-menu-link:visited { color:var(--text-primary); }
.side-menu-item:active, .side-menu-item:focus { background:#e8f0fe; color:#174ea6; outline:none; }
.side-menu-item-icon { width:32px; height:32px; border-radius:50%; background:#f1f3f4; display:flex; align-items:center; justify-content:center; font-size:16px; color:#5f6368; flex-shrink:0; }
.side-menu-item:active .side-menu-item-icon, .side-menu-item:focus .side-menu-item-icon { background:#d2e3fc; color:#174ea6; }
.side-menu-item-label { flex:1; display:flex; flex-direction:column; gap:1px; min-width:0; }
.side-menu-item-text { font-weight:600; font-size:14px; }
.side-menu-item-hint { font-size:11px; color:#5f6368; font-weight:400; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.side-menu-release-chip { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:14px; background:#e8f0fe; color:#174ea6; font-size:13px; font-weight:600; text-transform:none; letter-spacing:0.4px; width:fit-content; }
.side-menu-release-dot { width:10px; height:10px; border-radius:50%; background:#1a73e8; }
.side-menu-release { font-family:"Courier New", monospace; font-size:15px; font-weight:700; color:#174ea6; letter-spacing:0.4px; text-transform:none; }
.container { padding: 12px 20px; }
.hidden { display: none !important; }
.btn:disabled { opacity: 0.55; cursor: not-allowed; }
.project-bar { background:var(--bg-card); border-radius:12px; box-shadow:0 2px 5px var(--shadow); padding:16px; margin-bottom:20px; display:flex; flex-direction:column; gap:14px; position: sticky; top: calc(var(--project-bar-offset) + var(--selection-toolbar-height)); z-index: 180; transition: background-color 0.2s ease; }
.project-bar-header { display:flex; justify-content:space-between; align-items:flex-start; cursor:pointer; }
.project-bar-body { display:flex; flex-wrap:wrap; gap:14px; align-items:flex-start; justify-content:flex-start; }
.project-bar.collapsed .project-bar-body { display: none; }
.project-bar .project-expand-indicator { font-size: 12px; color: var(--text-secondary); transition: transform 0.2s ease; margin-left: 8px; flex-shrink: 0; }
.project-bar.collapsed .project-expand-indicator { transform: rotate(-90deg); }
.project-info { display:flex; gap:12px; align-items:flex-start; font-size:16px; font-weight:bold; color:var(--text-primary); }
.project-info-icon { white-space:nowrap; }
.project-info-details { display:flex; flex-direction:column; gap:6px; font-weight:500; }
.project-metrics-row { display:flex; gap:20px; flex-wrap:wrap; align-items:center; }
.project-metric { display:flex; align-items:center; gap:8px; font-size:14px; font-weight:600; color:var(--text-primary); }
.project-metric .metric-label { text-transform:uppercase; letter-spacing:0.4px; font-size:11px; color:var(--text-secondary); }
.project-metric .metric-value { font-family:"Courier New", monospace; font-size:18px; font-weight:700; color:var(--text-primary); }
.project-actions { display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start; }
.project-actions > .btn { display:flex; gap:6px; align-items:center; height:fit-content; }
.project-input { display:flex; flex-direction:column; gap:12px; }
.project-input input { border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:15px; letter-spacing:0.3px; text-align:center; width:100%; max-width:280px; background:var(--bg); color:var(--text-primary); transition: background-color 0.2s ease, border-color 0.2s ease; }
.project-input input:focus { outline:2px solid var(--brand); }
.keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.keypad button { border:none; border-radius:14px; padding:20px 0; font-size:26px; font-weight:bold; background:#e5f0ff; color:#1f2937; cursor:pointer; transition:background 0.2s ease, transform 0.1s ease; min-height:var(--touch-min); touch-action:manipulation; }
.keypad button:active { background:#cbdafc; transform:scale(0.95); }
.keypad button.action { font-size:18px; font-weight:700; background:#dfe7f3; }
.keypad button.wide { grid-column: span 2; }
.empty-state { background:var(--bg-card); border-radius:12px; padding:40px 24px; margin-bottom:20px; box-shadow:0 2px 5px var(--shadow); font-size:18px; color:var(--text-secondary); display:none; justify-content:center; align-items:center; text-align:center; min-height:120px; transition: background-color 0.2s ease; }
.timeline-card { margin-top: -4px; }
.team-card, .task-card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 2px 5px var(--shadow); padding: 16px; margin-bottom: 20px; transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; position: relative; overflow: hidden; }
/* Card collassabile */
.task-card .task-header { cursor: pointer; }
.task-card.card-collapsed .task-card-body { display: none; }
.task-card .task-card-body { display: block; }
.task-card .card-expand-indicator { display: none; font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; margin-left: auto; }
.task-card.card-collapsed .card-expand-indicator { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; }
.task-card:not(.card-collapsed) .card-expand-indicator { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; transform: rotate(180deg); }
.task-card.card-collapsed .task-header-info .task-schedule,
.task-card.card-collapsed .task-header-info .task-duration { display: none; }
.task-card.card-collapsed .task-header-meta { flex-direction: row; align-items: center; gap: 12px; flex-wrap: nowrap; }
.task-card.card-collapsed .task-header-meta .activity-times-row,
.task-card.card-collapsed .task-header-meta .activity-collapse-btn,
.task-card.card-collapsed .task-header-meta .activity-select-btn,
.task-card.card-collapsed .task-header-meta .activity-complete-btn,
.task-card.card-collapsed .task-header-meta .activity-delay-summary { display: none; }
.task-card.card-collapsed .collapsed-summary { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-secondary); }
.task-card:not(.card-collapsed) .collapsed-summary { display: none; }
.collapsed-summary .collapsed-time { font-family: "Courier New", monospace; font-weight: 700; color: var(--brand); }
/* Team card collassabile */
.team-card .team-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.team-card.card-collapsed .team-card-body { display: none; }
.team-card .team-card-body { display: block; }
.team-card .card-expand-indicator { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; font-size: 20px; color: var(--text-secondary); transition: transform 0.2s ease; }
.team-card:not(.card-collapsed) .card-expand-indicator { transform: rotate(180deg); }
.task-card-overdue { border: 2px solid var(--warn); background: linear-gradient(125deg, rgba(220,53,69,0.08), rgba(255,255,255,0)); box-shadow: 0 14px 25px rgba(220,53,69,0.25); }
.task-card-overdue::before { content: ""; position: absolute; inset: 0; border-radius: inherit; border-left: 6px solid rgba(220,53,69,0.65); box-shadow: inset 0 0 30px rgba(220,53,69,0.12); pointer-events: none; }
.task-card-overdue::after { content: ""; position: absolute; inset: -6px; border-radius: inherit; border: 2px solid rgba(220,53,69,0.35); opacity: 0; animation: overduePulse 2.4s ease-in-out infinite; pointer-events: none; }
@keyframes overduePulse { 0% { opacity: 0.65; transform: scale(0.98); } 60% { opacity: 0; transform: scale(1.08); } 100% { opacity: 0; transform: scale(1.12); } }
.task-title-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.activity-delay-summary { min-width: 140px; }
.activity-delay-summary.hidden { display: none !important; }
.activity-delay-summary .activity-time-label,
.activity-delay-summary .activity-time-value { color: var(--warn); }
.activity-delay-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 999px; background: rgba(220,53,69,0.13); color: var(--warn); font-size: 12px; font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; box-shadow: inset 0 0 0 1px rgba(220,53,69,0.35); }
.activity-delay-badge::before { content: "⏱"; font-size: 13px; }
.activity-delay-badge.hidden { display: none !important; }
.task-card-overdue .activity-delay-badge { background: rgba(220,53,69,0.2); box-shadow: 0 0 0 2px rgba(220,53,69,0.3); }
.notification-card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 2px 5px var(--shadow); padding: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; transition: background-color 0.2s ease; }
.notification-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.notification-title { font-weight:700; font-size:18px; color:var(--text-primary); }
.notification-actions { display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
.notification-action-btn { flex:1; min-width:120px; border:1px solid var(--border); border-radius:12px; padding:12px 16px; font-size:15px; font-weight:600; background:var(--bg); color:var(--text-primary); cursor:pointer; transition:background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease; }
.notification-action-btn:hover { background:var(--brand); color:#fff; border-color:var(--brand); }
.notification-action-btn:active { transform:scale(0.97); }
.notification-list { display:flex; flex-direction:column; gap:10px; }
.notification-item { border:1px solid var(--border); border-radius:10px; padding:12px 14px; background:var(--bg); display:flex; flex-direction:column; gap:6px; transition:background 0.2s ease, border-color 0.2s ease; }
.notification-item:hover { border-color:var(--brand); }
.notification-item-title { font-weight:600; font-size:15px; color:var(--text-primary); }
.notification-item-body { font-size:14px; color:var(--text-secondary); }
.notification-item-meta { font-size:12px; color:var(--text-secondary); letter-spacing:0.3px; text-transform:uppercase; }
.notification-empty { font-size:14px; color:var(--text-secondary); font-style:italic; border:1px dashed var(--border); border-radius:10px; padding:16px; text-align:center; }
.attachments-card { background:var(--bg-card); border-radius:16px; box-shadow:0 2px 5px var(--shadow); padding:20px; margin-bottom:20px; transition:box-shadow 0.2s ease, border-color 0.2s ease; border:1px solid transparent; }
.attachments-card.highlight { box-shadow:0 10px 25px rgba(14,165,233,0.28); border-color:rgba(14,165,233,0.35); }
.attachments-card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap; }
.attachments-title { font-size:20px; font-weight:700; display:block; }
.attachments-subtitle { font-size:14px; color:var(--text-secondary); }
.attachments-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
.attachments-meta { display:flex; justify-content:space-between; align-items:center; margin-top:12px; font-size:14px; color:var(--text-secondary); }
.attachments-count { font-weight:600; letter-spacing:0.3px; text-transform:uppercase; }
.attachments-upload-btn { display:flex; align-items:center; gap:8px; border-radius:999px; padding:10px 18px; background:var(--brand); color:#fff; border:none; font-weight:600; cursor:pointer; box-shadow:0 8px 20px rgba(14,165,233,0.35); transition:background 0.2s ease, box-shadow 0.2s ease; }
.attachments-upload-btn:hover { background:var(--brand-hover); box-shadow:0 10px 24px rgba(14,165,233,0.45); }
.attachments-refresh-btn { border-radius:999px; padding:10px 18px; background:#e2e8f0; color:#0f172a; border:none; font-weight:600; cursor:pointer; transition:background 0.2s ease, color 0.2s ease; }
.attachments-refresh-btn:hover { background:#cbd5e1; color:#0f172a; }
.attachments-grid { margin-top:16px; display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:16px; }
.attachment-card { border:1px solid var(--border); border-radius:14px; padding:16px; display:flex; gap:12px; align-items:flex-start; background:var(--bg); box-shadow:0 1px 3px var(--shadow); }
.attachment-icon { width:44px; height:44px; border-radius:12px; background:#e0f2fe; color:#0f172a; font-size:22px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.attachment-details { flex:1; display:flex; flex-direction:column; gap:6px; }
.attachment-name { font-weight:600; font-size:15px; color:var(--text-primary); word-break:break-word; }
.attachment-meta { font-size:12px; color:var(--text-secondary); display:flex; gap:8px; flex-wrap:wrap; }
.attachment-actions { display:flex; flex-direction:column; gap:8px; min-width:100px; }
.attachment-action { border:none; border-radius:999px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; background:var(--bg-card); color:var(--brand); box-shadow:0 2px 6px rgba(15,23,42,0.08); }
.attachment-action:disabled { opacity:0.5; cursor:not-allowed; }
.attachment-action.download { background:var(--brand); color:#fff; }
.attachments-empty { border:1px dashed var(--border); border-radius:12px; padding:24px; text-align:center; font-size:15px; color:var(--text-secondary); margin-top:16px; }
.attachments-loading { margin-top:12px; font-size:14px; color:var(--text-secondary); display:flex; align-items:center; gap:8px; }
.team-header, .task-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 17px; margin-bottom: 10px; gap: 12px; }
.team-header-info { display:flex; flex-direction:column; gap:4px; }
.team-header-meta { display:flex; align-items:center; gap:8px; }
.team-count { font-size:14px; font-weight:600; color:var(--text-secondary); }
.task-header-info { display: flex; flex-direction: column; gap: 4px; }
.task-schedule { font-size: 20px; font-weight: 700; color: #1d4ed8; letter-spacing:0.28px; }
.task-duration { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.task-header-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; }
.activity-times-row { display:flex; gap:12px; align-items:stretch; justify-content:center; width:100%; }
.activity-time-summary { display:flex; flex-direction:column; align-items:center; gap:2px; min-width:90px; background:rgba(37,99,235,0.08); padding:8px 12px; border-radius:10px; }
.activity-time-label { font-size:10px; letter-spacing:0.5px; text-transform:uppercase; color:var(--text-secondary); font-weight:700; }
.activity-time-value { font-family:"Courier New", monospace; font-size:18px; font-weight:800; color:var(--brand); }
.activity-duration-summary { }
.activity-duration-summary .activity-time-value { color:#0f172a; }
.team-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px; }
.new-activity-form { display:flex; flex-direction:column; gap:16px; text-align:left; }
.new-activity-form .form-group { display:flex; flex-direction:column; gap:8px; }
.new-activity-form label { font-size:15px; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:6px; }
.new-activity-form label .required { color:var(--warn); font-size:16px; }
.new-activity-form input,
.new-activity-form textarea { border:2px solid var(--border); border-radius:12px; padding:16px 18px; font-size:17px; background:var(--bg); color:var(--text-primary); transition:border-color 0.2s ease, box-shadow 0.2s ease; width:100%; box-sizing:border-box; }
.new-activity-form input:focus,
.new-activity-form textarea:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(14,165,233,0.15); }
.new-activity-form textarea { min-height:100px; resize:vertical; font-family:inherit; }
.new-activity-form .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.new-activity-form .form-hint { font-size:13px; color:var(--text-secondary); margin-top:2px; }

/* Modal Form Styles - Shared */
.modal-form { display:flex; flex-direction:column; gap:20px; text-align:left; }
.modal-form .form-group { display:flex; flex-direction:column; gap:8px; }
.modal-form label { font-size:15px; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:6px; }
.modal-form label .required { color:var(--warn); font-size:16px; font-weight:700; }
.modal-form input,
.modal-form select,
.modal-form textarea { border:2px solid var(--border); border-radius:12px; padding:16px 18px; font-size:17px; background:var(--bg); color:var(--text-primary); transition:border-color 0.2s ease, box-shadow 0.2s ease; width:100%; box-sizing:border-box; }
.modal-form input:focus,
.modal-form select:focus,
.modal-form textarea:focus { outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(14,165,233,0.15); }
.modal-form input::placeholder,
.modal-form textarea::placeholder { color:var(--text-secondary); opacity:0.7; }
.modal-form textarea { min-height:100px; resize:vertical; font-family:inherit; }
.modal-form .form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.modal-form .form-hint { font-size:13px; color:var(--text-secondary); margin-top:2px; }
.modal-form .form-actions { display:flex; gap:12px; margin-top:8px; }
.modal-form .form-actions .btn { flex:1; padding:16px 20px; font-size:16px; }

/* Modal Header */
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border); }
.modal-title { font-size:22px; font-weight:700; color:var(--text-primary); margin:0; display:flex; align-items:center; gap:10px; }
.modal-close-btn { width:52px; height:52px; border:none; border-radius:50%; background:var(--bg); color:var(--text-secondary); font-size:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background 0.2s ease, color 0.2s ease, transform 0.1s ease; min-width:var(--touch-min); touch-action:manipulation; }
.modal-close-btn:hover { background:var(--border); color:var(--text-primary); }
.modal-close-btn:active { transform:scale(0.92); }

/* Improved btn-secondary for modal buttons */
.modal-form .btn-secondary,
.new-activity-form .btn-secondary { background:var(--bg); color:var(--text-primary); border:2px solid var(--border); }
.modal-form .btn-secondary:hover,
.new-activity-form .btn-secondary:hover { background:var(--border); }

.btn { border:none; border-radius:14px; padding:16px 22px; font-size:16px; font-weight:700; color:white; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:10px; min-height:var(--touch-min); touch-action: manipulation; -webkit-tap-highlight-color: transparent; transition: transform 0.1s ease, background 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.btn:active { transform: scale(0.94); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
.btn-primary{ background: var(--brand); }
.btn-toggle{ background: var(--warn); }
.btn-secondary { background: rgba(255,255,255,0.18); color:white; border:1px solid rgba(255,255,255,0.35); }
.btn-secondary.active { background: rgba(0,0,0,0.25); }
.team-member, .member-task { background: var(--member-bg); color: var(--text-primary); border-radius: 14px; padding: 20px 18px; margin-bottom: 12px; cursor: pointer; user-select: none; transition: background 0.15s ease, transform 0.1s ease, color 0.2s ease, box-shadow 0.15s ease; min-height: 68px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.team-member:active, .member-task:active { transform: scale(0.97); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
.team-member.selected, .member-task.selected { background: var(--member-selected-bg); border-left: 6px solid var(--brand); border-color: var(--brand); box-shadow: 0 4px 16px rgba(37,99,235,0.25); }
.drop-zone { border: 2px dashed var(--brand); border-radius: 10px; padding: 10px; text-align: center; font-size: 16px; color: var(--brand); margin-top: 10px; }
.task-header-row { display: flex; justify-content: space-between; align-items: center; }
.member-name-block { display:flex; flex-direction:column; gap:4px; }
.member-name { font-size:19px; font-weight:800; color:var(--text-primary); letter-spacing:-0.2px; }
.member-start { font-size:14px; color:var(--text-secondary); font-weight:700; }
.timer-display { font-weight: 800; color: var(--brand); font-size: 20px; font-family: 'Courier New', monospace; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(37,99,235,0.15); }
.activity-select-btn { border:none; border-radius:999px; background:#2563eb; color:#fff; padding:14px 20px; font-size:15px; font-weight:700; cursor:pointer; transition:transform 0.1s ease; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height:var(--touch-min); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
.activity-select-btn:active { transform: scale(0.94); box-shadow: 0 2px 6px rgba(37,99,235,0.4); }
.team-add-activity-btn { background:#16a34a; color:#fff; }
.team-add-activity-btn:active { background:#15803d; }
.team-add-operator-btn { background:#8b5cf6; color:#fff; }
.team-add-operator-btn:active { background:#7c3aed; }
.operator-tabs { display:flex; gap:8px; margin-bottom:16px; }
.operator-tab { flex:1; border:none; border-radius:8px; background:#e2e8f0; color:#1f2937; padding:10px 16px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.15s ease; }
.operator-tab.active { background:#2563eb; color:#fff; }
.operator-tab:hover:not(.active) { background:#cbd5e1; }
.operator-tab-content { display:none; }
.operator-tab-content.active { display:block; }
.available-operators-list { max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:10px; }
.available-operator-item { padding:14px 16px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.12s ease; }
.available-operator-item:last-child { border-bottom:none; }
.available-operator-item:hover { background:var(--bg-hover, #f1f5f9); }
.available-operator-item:active { background:#e2e8f0; }
.available-operator-name { font-weight:600; color:var(--text-primary); }
.available-operator-add { color:#16a34a; font-size:20px; font-weight:700; }
.loading-operators { padding:24px; text-align:center; color:var(--text-secondary); }
.no-operators { padding:24px; text-align:center; color:var(--text-secondary); font-style:italic; }
.activity-complete-btn { border:none; border-radius:999px; background:#16a34a; color:#fff; padding:14px 24px; font-size:16px; font-weight:800; cursor:pointer; transition:transform 0.1s ease, box-shadow 0.2s ease; touch-action: manipulation; -webkit-tap-highlight-color: transparent; box-shadow:0 6px 20px rgba(22,163,74,0.35); min-height:var(--touch-min); letter-spacing:0.3px; }
.activity-complete-btn:active { transform:scale(0.93); box-shadow:0 3px 12px rgba(22,163,74,0.4); }
.task-members { display:flex; flex-direction:column; gap:10px; }
.task-members .member-task { margin-bottom: 0; }
.activity-collapse-btn { border:none; border-radius:999px; background:#e2e8f0; color:#0f172a; padding:14px 20px; font-size:15px; font-weight:700; cursor:pointer; transition:transform 0.1s ease, background 0.15s ease; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height:var(--touch-min); }
.activity-collapse-btn:active { transform: scale(0.94); background:#cbd5e1; }
.task-card.collapsed .activity-collapse-btn { background:#1d4ed8; color:#fff; }
.task-card.card-collapsed .task-header { padding: 4px 0; }
.team-actions .activity-collapse-btn { background:#2563eb; color:#fff; }
.team-actions .activity-collapse-btn:active { background:#1d4ed8; }
.datetime-info { font-size: 20px; color: #0f172a; margin-top: 10px; display: flex; justify-content: space-between; font-weight:600; letter-spacing:0.22px; }
.datetime-info span { display:block; }
.pause-info { font-size: 12px; color: #999; margin-top: 2px; text-align:right; }
.popup { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--ok); color: white; padding: 18px 28px; border-radius: 16px; font-size: 18px; font-weight: 700; opacity: 0; transition: opacity 0.3s ease-in-out; z-index: 999; box-shadow: 0 8px 30px rgba(0,0,0,0.35); max-width: 90vw; text-align: center; }
.popup.show { opacity: 1; }
.offline-banner { background: #b45309; color: #fff; text-align: center; padding: 12px 16px; font-weight: 600; letter-spacing: 0.3px; position: sticky; top: var(--header-height); z-index: 215; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
.update-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #0ea5e9; color: #fff; padding: 14px 18px; border-radius: 999px; display: flex; align-items: center; gap: 12px; box-shadow: 0 12px 30px rgba(14,165,233,0.4); z-index: 320; font-weight: 600; letter-spacing: 0.2px; }
.update-banner button { border: none; border-radius: 999px; background: #fff; color: #0f172a; font-weight: 700; padding: 8px 16px; cursor: pointer; }
.update-banner button:active { transform: scale(0.95); }
.selection-toolbar { position: sticky; top: calc(var(--header-height) + 16px); z-index: 210; background: linear-gradient(145deg, var(--bg-card), rgba(37,99,235,0.06)); color: var(--text-primary); padding: 20px 22px; border-radius: 18px; border: 2px solid var(--brand); box-shadow: 0 10px 30px rgba(37,99,235,0.2); display: flex; align-items: center; justify-content: space-between; gap: 18px; margin: 10px 0 28px; }
.selection-count { font-weight: 800; letter-spacing: 0.4px; font-size: 17px; color: var(--brand); background: rgba(37,99,235,0.12); padding: 10px 16px; border-radius: 12px; }
.selection-actions { flex: 1; display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
.selection-actions .selection-btn { flex: 1; min-width: 140px; }
.selection-btn { border: none; border-radius: 14px; padding: 16px 20px; font-size: 16px; font-weight: 700; color: #fff; cursor: pointer; min-height: var(--touch-min); display: inline-flex; align-items: center; justify-content: center; gap: 8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; transition: transform 0.1s ease, opacity 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 6px 20px rgba(15,23,42,0.22); letter-spacing: 0.3px; }
.selection-btn:active { transform: scale(0.94); box-shadow: 0 3px 10px rgba(15,23,42,0.25); }
.selection-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.selection-start { background: #38bdf8; }
.selection-move { background: #a855f7; }
.selection-pause { background: #f97316; }
.selection-finish { background: #ef4444; }
.modal { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: center; justify-content: center; z-index: 300; padding: 16px; overflow: hidden; box-sizing: border-box; }
.modal.open { display: flex; }
.modal-card { background: var(--bg-card); width: 94vw; max-width: 520px; max-height: 90vh; border-radius: 16px; padding: 26px; text-align: center; box-shadow: 0 8px 20px var(--shadow-lg); display: flex; flex-direction: column; gap: 18px; transition: background-color 0.2s ease; overflow-y: auto; overflow-x: hidden; box-sizing: border-box; -webkit-overflow-scrolling: touch; }
.modal-card h3 { color: var(--text-primary); }
.modal-card h3 { margin: 0; }

/* QR Timbratura Modal Styles */
.qr-modal-card { max-width: 420px; width: 94vw; padding: 0; overflow: hidden; }
.qr-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: #fff; }
.qr-modal-title { display: flex; align-items: center; gap: 12px; }
.qr-modal-icon { font-size: 28px; }
.qr-modal-title-text h2 { margin: 0; font-size: 20px; font-weight: 700; }
.qr-device-id { font-size: 12px; opacity: 0.85; font-weight: 500; }
.qr-modal-actions { display: flex; align-items: center; gap: 8px; }
.qr-fullscreen-btn { width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.2); color: #fff; font-size: 18px; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: background 0.2s ease; }
.qr-fullscreen-btn:hover { background: rgba(255,255,255,0.3); }
.qr-modal-header .modal-close-btn { position: static; width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.2); color: #fff; font-size: 22px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s ease; }
.qr-modal-header .modal-close-btn:hover { background: rgba(255,255,255,0.3); }
.qr-modal-body { padding: 24px 20px; display: flex; flex-direction: column; align-items: center; gap: 16px; }
.qr-container { position: relative; width: 280px; height: 280px; background: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; }
.qr-loading { display: flex; flex-direction: column; align-items: center; gap: 12px; color: var(--text-secondary); font-size: 14px; }
.qr-spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: var(--brand); border-radius: 50%; animation: qr-spin 0.8s linear infinite; }
@keyframes qr-spin { to { transform: rotate(360deg); } }
.qr-image { width: 260px; height: 260px; object-fit: contain; display: none; }
.qr-image.loaded { display: block; }
.qr-time { font-size: 32px; font-weight: 700; color: var(--text-primary); font-variant-numeric: tabular-nums; letter-spacing: 1px; }
.qr-refresh-bar { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; overflow: hidden; }
.qr-refresh-progress { height: 100%; background: linear-gradient(90deg, #0ea5e9, #2563eb); width: 100%; transition: width linear; }
.qr-info { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
.qr-info strong { color: var(--brand); }

/* Foto Progetto Styles */
.photos-modal-card { max-width: 800px; width: 96vw; padding: 16px; max-height: 92vh; overflow-y: auto; overflow-x: hidden; }
.photos-card { display: flex; flex-direction: column; gap: 16px; }
.photos-card-header { display: flex; justify-content: space-between; gap: 16px; flex-wrap: wrap; align-items: flex-start; }
.photos-title { font-size: 20px; font-weight: 700; display: block; }
.photos-subtitle { font-size: 14px; color: var(--text-secondary); display: block; }
.photos-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
.photos-action-btn { border: none; border-radius: 999px; padding: 10px 18px; font-size: 14px; font-weight: 600; cursor: pointer; background: #e2e8f0; color: #0f172a; transition: background 0.2s ease; }
.photos-action-btn.primary { background: var(--brand); color: #fff; box-shadow: 0 6px 16px rgba(14,165,233,0.35); }
.photos-action-btn.danger { background: #ef4444; color: #fff; }
.photos-action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.photos-meta { display: flex; flex-wrap: wrap; gap: 10px; font-size: 13px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.4px; font-weight: 600; justify-content: space-between; }
.photos-count { background: #e2e8f0; padding: 4px 10px; border-radius: 999px; }
.photos-loading { padding: 40px; text-align: center; color: var(--text-secondary); font-size: 15px; }
.photos-empty { border: 1px dashed var(--border); border-radius: 12px; padding: 40px 20px; text-align: center; font-size: 15px; color: var(--text-secondary); }
.photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
.photo-thumb { position: relative; aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease, transform 0.15s ease; background: #f1f5f9; }
.photo-thumb:hover { border-color: var(--brand); transform: scale(1.03); }
.photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
.photo-thumb-caption { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: #fff; font-size: 11px; padding: 20px 8px 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.photo-preview-modal-card { max-width: 90vw; max-height: 90vh; padding: 12px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.photo-preview-image { max-width: 100%; max-height: 60vh; object-fit: contain; border-radius: 12px; flex-shrink: 0; }
.photo-preview-caption { font-size: 14px; color: var(--text-secondary); text-align: center; flex-shrink: 0; }
.photo-preview-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; flex-shrink: 0; padding: 8px 0; }

/* Camera Modal */
.camera-modal-card { max-width: 100vw; width: 100%; height: 100%; max-height: 100vh; padding: 0; border-radius: 0; display: flex; flex-direction: column; background: #000; }
.camera-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(0,0,0,0.8); }
.camera-title { color: #fff; font-size: 18px; font-weight: 600; }
.camera-header .photos-action-btn { background: rgba(255,255,255,0.2); color: #fff; }
.camera-viewfinder { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #000; }
.camera-viewfinder video { width: 100%; height: 100%; object-fit: cover; }
.camera-actions { padding: 20px; display: flex; justify-content: center; background: rgba(0,0,0,0.8); }
.camera-capture-btn { width: 72px; height: 72px; border-radius: 50%; border: 4px solid #fff; background: rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.15s ease, background 0.15s ease; }
.camera-capture-btn:hover { background: rgba(255,255,255,0.5); }
.camera-capture-btn:active { transform: scale(0.95); background: #fff; }
.camera-capture-icon { font-size: 28px; }

.modal-scroll-footer { position: sticky; bottom: 0; margin-top: auto; padding: 16px 16px 8px 16px; background: linear-gradient(180deg, rgba(255,255,255,0) 0%, var(--bg-card) 40%, var(--bg-card) 100%); }
.modal-scroll-footer-actions { display: flex; gap: 12px; justify-content: center; padding: 0 8px; }
.modal-scroll-footer .materials-action-btn { flex: 0 1 auto; min-width: 120px; max-width: 180px; }
/* Stili specifici per header attrezzature */
.equipment-header { padding-top: 12px; }
.equipment-actions-center { justify-content: center; }
.attachments-modal-card { max-width: 720px; padding: 10px; }
.activity-search { width: 100%; padding: 12px 14px; border: 1px solid var(--border); border-radius: 12px; font-size: 17px; box-sizing: border-box; background: var(--bg); color: var(--text-primary); transition: background-color 0.2s ease, border-color 0.2s ease; }
.activity-search + #choices { margin-top: 4px; }
#choices { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 8px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
.activity-search:focus { outline: 2px solid var(--brand); }
.activity-empty { padding: 18px; border-radius: 10px; background: #f8fafc; color: #475569; font-size: 15px; }
.choice { background: var(--brand); color: #fff; border: none; border-radius: 14px; padding: 18px; width: 100%; font-size: 18px; cursor: pointer; touch-action: manipulation; }
.choice:active { transform: scale(0.98); }
.btn-danger { background: var(--warn); color: #fff; border: none; padding: 18px; border-radius: 12px; width: 100%; font-size: 18px; }
.modal-open #selectionToolbar { display: none !important; }
.feedback-card { align-items:center; text-align:center; gap:20px; }
.feedback-title { font-size:22px; font-weight:700; margin:0; color:#0f172a; }
.feedback-subtitle { margin:0; font-size:15px; color:#475569; }
.feedback-activity { font-weight:700; color:#1a73e8; display:inline-block; max-width:100%; word-break:break-word; }
.feedback-stars { display:flex; justify-content:center; gap:12px; }
.feedback-star { border:none; background:transparent; font-size:36px; color:#cbd5f5; cursor:pointer; transition:transform 0.15s ease, color 0.15s ease; padding:4px; }
.feedback-star:focus { outline:2px solid #1a73e8; outline-offset:4px; }
.feedback-star:hover { color:#facc15; }
.feedback-star.active { color:#fbbf24; transform:scale(1.12); }
.feedback-rating-value { font-size:14px; font-weight:600; color:#475569; letter-spacing:0.3px; }
.feedback-actions { display:flex; flex-direction:column; gap:12px; width:100%; }
.feedback-submit { border:none; border-radius:14px; background:#1a73e8; color:#fff; padding:16px; font-size:18px; font-weight:600; cursor:pointer; transition:background 0.2s ease; }
.feedback-submit:disabled { background:#a7c5f9; cursor:not-allowed; }
.feedback-submit:not(:disabled):active { background:#1558c0; }
.feedback-cancel { border:none; background:transparent; color:#5f6368; font-size:15px; font-weight:600; cursor:pointer; }
.feedback-cancel:hover { text-decoration:underline; }
.materials-card { background:var(--bg-card); border-radius:16px; box-shadow:0 2px 6px var(--shadow); padding:20px; border:1px solid transparent; transition:border-color 0.2s ease, box-shadow 0.2s ease; display:flex; flex-direction:column; gap:16px; }
.materials-card.active { border-color:rgba(14,165,233,0.35); box-shadow:0 10px 25px rgba(14,165,233,0.15); }
.materials-header { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; padding-top:8px; }
.materials-title { font-size:22px; font-weight:700; display:block; }
.materials-subtitle { font-size:14px; color:var(--text-secondary); }
.materials-actions { display:flex; gap:10px; flex-wrap:nowrap; justify-content:flex-end; align-items:center; }
.materials-action-btn { border:none; border-radius:999px; padding:10px 18px; font-size:14px; font-weight:600; cursor:pointer; background:#e2e8f0; color:#0f172a; transition:background 0.2s ease, color 0.2s ease; }
.materials-action-btn.primary { background:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(14,165,233,0.35); }
.materials-action-btn:disabled { opacity:0.6; cursor:not-allowed; }
.materials-stats { margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; font-size:13px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.4px; font-weight:600; }
.materials-status-pill { padding:4px 10px; border-radius:999px; background:#e2e8f0; color:#0f172a; font-size:12px; letter-spacing:0.3px; }
.materials-list { margin-top:16px; display:flex; flex-direction:column; gap:12px; }
.materials-equipment { margin-top:24px; padding-top:20px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:12px; }
.materials-equipment-heading { display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:flex-start; }
.materials-equipment-title { font-size:16px; font-weight:700; color:var(--text-primary); }
.materials-equipment-hint { font-size:13px; color:var(--text-secondary); }
.materials-equipment-status { font-size:13px; font-weight:600; color:var(--text-secondary); }
.materials-group { display:flex; flex-direction:column; gap:12px; padding:4px 0 12px; }
.materials-group-header { display:flex; justify-content:space-between; align-items:center; padding:8px 0 12px; border-bottom:1px solid var(--border); gap:10px; }
.materials-group-toggle { border:none; background:transparent; font-size:18px; cursor:pointer; line-height:1; padding:6px 8px; color:var(--text-secondary); border-radius:8px; transition: background 0.2s ease, color 0.2s ease; }
.materials-group-toggle:hover { background:rgba(148,163,184,0.2); color:var(--text-primary); }
.materials-group-toggle:active { background:rgba(14,165,233,0.15); color:var(--brand); }
.materials-group-title { font-size:15px; font-weight:700; color:var(--text-primary); display:flex; align-items:center; gap:6px; flex:1; min-width:0; }
.materials-group-count { font-size:13px; color:var(--text-secondary); font-weight:600; letter-spacing:0.3px; white-space:nowrap; }
.materials-group-body { display:flex; flex-direction:column; gap:12px; }
.materials-group-materials { display:flex; flex-direction:column; gap:12px; }
.materials-group-children { display:flex; flex-direction:column; gap:12px; border-left:2px solid var(--border); margin-left:12px; padding-left:12px; }
.materials-group.collapsed .materials-group-body { display:none; }
/* Card materiale compatta */
.material-row { border:1px solid var(--border); border-radius:12px; padding:12px 14px; display:flex; flex-direction:column; gap:8px; background:var(--bg); box-shadow:0 1px 2px var(--shadow); width:100%; box-sizing:border-box; }
.material-row-compact { gap: 6px; }
.material-header-compact { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
.material-name { font-size:14px; font-weight:700; color:var(--text-primary); flex:1; min-width:0; word-wrap:break-word; }
.material-qty-badge { background:var(--brand); color:#fff; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:600; white-space:nowrap; flex-shrink:0; }
.material-note { font-size:12px; color:var(--text-secondary); font-style:italic; }
.material-info-row { display:flex; flex-wrap:wrap; gap:12px; font-size:12px; color:var(--text-secondary); }
.material-info-item { display:inline-flex; align-items:center; gap:4px; }
.material-footer-compact { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:4px; padding-top:8px; border-top:1px solid var(--border); }
.material-status { font-size:12px; font-weight:600; padding:4px 10px; border-radius:999px; }
.materials-photo-btn.compact { padding:6px 12px; font-size:12px; }
.equipment-row { border-color:rgba(59,130,246,0.3); padding: 10px 12px !important; gap: 4px !important; }
.equipment-checkbox-column { display:flex; align-items:center; order: -1; }
.equipment-checkbox { display:flex; align-items:center; gap:6px; font-size:12px; font-weight:600; color:var(--text-primary); }
.equipment-checkbox-input { width:28px; height:28px; cursor:pointer; accent-color: var(--brand); min-width:28px; }
.equipment-timestamp { font-size:11px; color:var(--text-secondary); font-weight:500; text-align:right; }
.equipment-row .material-header-compact { order: 0; }
.equipment-row .material-info-row { order: 1; font-size: 11px; gap: 8px; }
.equipment-row .material-footer-compact { order: 2; padding-top: 6px; margin-top: 2px; }
.material-primary { flex:1; display:flex; flex-direction:column; gap:6px; }
.material-period { font-size:13px; color:var(--text-secondary); font-weight:600; }
.material-qty { min-width:80px; display:flex; flex-direction:column; align-items:flex-end; gap:4px; font-family:"Courier New", monospace; font-size:18px; font-weight:700; color:var(--text-primary); }
.material-qty-label { font-size:11px; text-transform:uppercase; color:var(--text-secondary); letter-spacing:0.4px; font-weight:600; }
.material-details { display:flex; flex-direction:column; gap:8px; min-width:180px; }
.material-detail { display:flex; flex-direction:column; gap:2px; }
.material-detail-label { font-size:11px; text-transform:uppercase; color:var(--text-secondary); letter-spacing:0.4px; font-weight:600; }
.material-detail-value { font-size:14px; font-weight:600; color:var(--text-primary); }
.material-status { min-width:120px; text-align:right; font-size:13px; font-weight:700; letter-spacing:0.4px; text-transform:uppercase; padding:6px 10px; border-radius:999px; }
.material-status-planned { background:rgba(16,185,129,0.15); color:#047857; }
.material-status-reserved { background:rgba(59,130,246,0.15); color:#1d4ed8; }
.material-status-subrent { background:rgba(245,158,11,0.18); color:#b45309; }
.material-status-delayed { background:rgba(249,115,22,0.2); color:#c2410c; }
.material-status-missing { background:rgba(239,68,68,0.18); color:#b91c1c; }
.material-status-option { background:rgba(148,163,184,0.25); color:#334155; }
.material-actions { display:flex; align-items:center; justify-content:flex-end; flex:1; min-width:160px; }
.materials-empty { margin-top:16px; border:1px dashed var(--border); border-radius:12px; padding:20px; text-align:center; font-size:15px; color:var(--text-secondary); }
.materials-modal-card { max-width:760px; width:94vw; padding:20px; max-height:90vh; overflow-y:auto; overflow-x:hidden; display:flex; flex-direction:column; box-sizing:border-box; }
.materials-modal-card .materials-card { margin:0; box-shadow:none; border:none; width:100%; flex:1; display:flex; flex-direction:column; overflow:hidden; }
.materials-modal-card .materials-list { flex:1; overflow-y:auto; overflow-x:hidden; padding-right:8px; }
.materials-modal-card .materials-list::-webkit-scrollbar { width:6px; }
.materials-modal-card .materials-list::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.6); border-radius:999px; }
.materials-modal-card .materials-empty { flex:1; display:flex; align-items:center; justify-content:center; margin-top:0; }
.equipment-modal-card { max-width:680px; }
/* Fullscreen modals on mobile */
@media (max-width: 640px) {
    .attachments-modal-card,
    .materials-modal-card,
    .equipment-modal-card {
        width: 100vw !important;
        max-width: 100vw !important;
        height: 100vh !important;
        height: 100dvh !important;
        max-height: 100vh !important;
        max-height: 100dvh !important;
        border-radius: 0 !important;
        margin: 0 auto !important;
        padding: 12px 16px !important;
        box-sizing: border-box !important;
    }
    #attachmentsModal,
    #materialsModal,
    #equipmentModal {
        padding: 0 !important;
        align-items: center !important;
        justify-content: center !important;
    }
    /* Centrare header e contenuto */
    .materials-header {
        justify-content: center !important;
        text-align: center;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }
    .materials-header > div:first-child {
        text-align: center;
        width: 100%;
    }
    .materials-actions {
        justify-content: center !important;
        width: 100%;
    }
    .materials-stats {
        justify-content: center;
        width: 100%;
    }
    .materials-card {
        width: 100% !important;
        padding: 0 !important;
    }
    .materials-list {
        padding: 0 !important;
        width: 100%;
    }
    .materials-group {
        width: 100%;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    .materials-group-header {
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    /* Card larghezza piena */
    .material-row,
    .equipment-row {
        width: 100% !important;
        margin: 0 !important;
        box-sizing: border-box;
    }
}
.materials-folders { margin-top:20px; padding-top:20px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:14px; }
.materials-folder-heading { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px; }
.materials-folder-title { font-weight:700; font-size:16px; }
.materials-folder-hint { font-size:13px; color:var(--text-secondary); }
.materials-folder-list { display:flex; flex-direction:column; gap:12px; }
.materials-folder-row { border:1px solid var(--border); border-radius:14px; padding:14px 16px; background:var(--bg); box-shadow:0 1px 3px var(--shadow); display:flex; flex-direction:column; gap:10px; }
.materials-folder-info { display:flex; flex-direction:column; gap:4px; }
.materials-folder-name { font-weight:600; font-size:15px; color:var(--text-primary); }
.materials-folder-path { font-size:13px; color:var(--text-secondary); word-break:break-word; }
.materials-folder-meta { font-size:12px; color:var(--text-secondary); letter-spacing:0.3px; text-transform:uppercase; font-weight:600; }
.materials-folder-actions { display:flex; gap:10px; flex-wrap:wrap; }
.materials-photo-btn { border:none; border-radius:999px; padding:14px 20px; font-size:15px; font-weight:700; cursor:pointer; background:var(--brand); color:#fff; box-shadow:0 6px 16px rgba(14,165,233,0.35); min-height:var(--touch-min); touch-action:manipulation; }
.materials-photo-btn.secondary { background:#e2e8f0; color:var(--text-primary); box-shadow:none; }
.materials-photo-btn:disabled { opacity:0.45; cursor:not-allowed; box-shadow:none; }
.materials-photo-btn:active { transform:scale(0.94); }
.material-photo-modal-card { max-width:520px; width:92vw; align-items:center; text-align:center; gap:16px; }
.material-photo-image { width:100%; max-height:60vh; object-fit:contain; border-radius:16px; box-shadow:0 8px 24px var(--shadow-lg); background:#000000; }
.material-photo-caption { font-size:14px; color:var(--text-secondary); word-break:break-word; }
.material-photo-actions { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
.material-photo-link { border-radius:999px; padding:10px 18px; background:var(--brand); color:#fff; font-weight:600; text-decoration:none; box-shadow:0 6px 16px rgba(14,165,233,0.35); }
.material-photo-link:visited { color:#fff; }
.material-photo-link.hidden { display:none; }
/* Media Queries Mobile */
@media (max-width: 640px) {
        header { padding: 14px 16px; gap: 8px; }
        .logo-title { font-size: 22px; }
        .header-actions { gap: 10px; }
        .header-actions .btn { padding: 12px 16px; font-size: 14px; }
    .header-user { padding: 6px 12px; gap: 6px; }
    .header-user-icon { font-size: 14px; }
    .header-user-name { max-width: 90px; font-size: 13px; font-weight: 600; }
        #clock { font-size: 16px; padding: 8px 12px; font-weight: 700; }
        .container { padding: 12px 14px; }
        .selection-toolbar { padding: 16px 18px; margin-top: 12px; }
        .project-bar { padding: 16px 14px; gap: 14px; flex-direction: column; position: static; top: auto; }
        .project-info { flex-direction: column; width: 100%; }
        .project-actions { width: 100%; flex-direction: column; align-items: stretch; gap: 14px; }
        .project-input { width: 100%; }
        .project-input input { width: 100%; min-width: 0; font-size: 22px; letter-spacing: 2px; font-weight: 700; }
        #projectKeypad { width: 100%; grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .task-card, .team-card { padding: 16px 14px; }
        .task-header { flex-direction: column; align-items: flex-start; gap: 12px; }
        .task-header-meta { width: 100%; justify-content: flex-start; }
    .attachments-card-header { flex-direction: column; align-items: flex-start; }
    .attachments-actions { width: 100%; justify-content: flex-start; gap: 12px; }
    .attachments-actions button { flex: 1; min-width: 0; min-height: var(--touch-min); }
    .materials-actions { width: 100%; justify-content: center; flex-wrap: nowrap; gap: 12px; }
    .material-actions { width: 100%; justify-content: flex-start; }
    .material-details { width: 100%; }
    .material-row { flex-direction: column; align-items: flex-start; gap: 14px; }
    .material-qty { align-items: flex-start; font-size: 20px; }
    .material-status { text-align: left; font-size: 14px; padding: 8px 14px; }
        .popup { bottom: 100px; font-size: 17px; padding: 18px 24px; }
}
@media (max-width: 480px) {
    .project-info-icon { font-size: 14px; }
    .project-metric { width: 100%; justify-content: space-between; }
    .project-metric .metric-value { font-size: 18px; }
    .btn { width: 100%; justify-content: center; }
    .selection-toolbar { flex-direction: column; align-items: stretch; gap: 14px; }
    .selection-count { width: 100%; text-align: left; }
    .selection-actions { width: 100%; flex-direction: column; }
    .selection-actions .selection-btn { min-width: 0; }
    .team-member, .member-task { padding: 14px 12px; font-size: 15px; }
    .activity-time-summary { width: 100%; align-items: flex-start; }
    .activity-select-btn,
    .activity-collapse-btn,
    .activity-complete-btn { width: 100%; }
}
@media (max-width: 360px) {
    header { padding: 10px 12px; gap: 5px; }
    .header-left { gap: 8px; }
    .logo-title { font-size: 22px; }
  #clock { font-size: 13px; padding: 4px 8px; }
  .header-icon-btn { width: 40px; height: 40px; font-size: 18px; }
  .header-user { padding: 4px 8px; gap: 4px; }
  .header-user-icon { font-size: 12px; }
  .header-user-name { display: none; }
  .btn { padding: 12px 14px; font-size: 14px; min-height: 44px; }
  .team-member, .member-task { padding: 16px 12px; }
}
.install-prompt { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:300; width:90%; max-width:400px; }
.install-prompt-content { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(15,23,42,0.25); padding:18px 20px; display:flex; align-items:center; gap:16px; animation:slideUp 0.3s ease; }
@keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
.install-prompt-icon { font-size:32px; }
.install-prompt-text { flex:1; display:flex; flex-direction:column; gap:2px; }
.install-prompt-text strong { font-size:16px; font-weight:700; color:#0f172a; }
.install-prompt-text span { font-size:13px; color:#64748b; }
.install-prompt-btn { border:none; background:#1a73e8; color:#fff; padding:14px 24px; border-radius:14px; font-size:16px; font-weight:700; cursor:pointer; white-space:nowrap; min-height:var(--touch-min); }
.install-prompt-btn:active { background:#1558c0; transform:scale(0.95); }
.install-prompt-dismiss { border:none; background:transparent; color:#94a3b8; font-size:20px; cursor:pointer; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; }
.install-prompt-dismiss:active { background:#f1f5f9; }
#iosInstallBanner { position:fixed; left:50%; bottom:24px; transform:translateX(-50%); width:min(90%,420px); background:#ffffff; color:#111827; border-radius:18px; box-shadow:0 18px 45px rgba(15,23,42,0.25); padding:16px 18px; font-family:-apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif; font-size:15px; line-height:1.4; display:none; z-index:350; }
#iosInstallBanner.show { display:flex; gap:10px; align-items:center; }
#iosInstallBanner svg { width:20px; height:20px; }
#iosInstallBanner button { margin-left:auto; border:none; background:transparent; font-size:18px; cursor:pointer; color:#6b7280; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
#iosInstallBanner button:active { background:#f1f5f9; }
#iosInstallBanner::after { content:""; position:absolute; left:50%; bottom:-12px; transform:translateX(-50%); width:18px; height:18px; background:#ffffff; clip-path:polygon(50% 100%, 0 0, 100% 0); box-shadow:0 10px 30px rgba(15,23,42,0.2); }
.ios-install-graphic { display:inline-flex; vertical-align:middle; margin:0 4px; }
.timeline-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.35); z-index: 110; }
.timeline-panel { position: fixed; top: 0; right: 0; width: 340px; max-width: 90vw; height: 100vh; background: var(--bg-card); z-index: 120; box-shadow: -4px 0 18px var(--shadow-lg); transform: translateX(100%); transition: transform 0.28s ease, background-color 0.2s ease; display: flex; flex-direction: column; }
.timeline-panel.open { transform: translateX(0); }
.timeline-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #e2e8f0; font-weight:600; font-size:17px; color:#1f2937; }
.timeline-body { flex:1; overflow-y:auto; padding:18px 20px; display:flex; flex-direction:column; gap:12px; }
.event-list { display:flex; flex-direction:column; gap:12px; }
.event-item { background:#f4f7fb; border-radius:10px; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; font-size:15px; color:#1f2937; }
.event-summary { font-weight:600; }
.event-meta { font-size:13px; color:#6b7280; margin-left:16px; white-space:nowrap; }
.event-empty { color:#6b7280; font-style:italic; text-align:center; padding:18px 0; border:1px dashed #cbd5e0; border-radius:10px; background:#f8fafc; }
</style>
</head>
<body>
<header>
<div class="header-row-top">
<div class="header-left">
<button id="menuToggle" class="header-icon-btn" aria-label="Apri menu">☰</button>
<span class="logo-title">🔷 JOBlog</span>
</div>
</div>
<div class="header-row-bottom">
<div class="header-actions">
<span id="clock">{{ header_clock or '--/--/---- | --:--' }}</span>
</div>
<div class="header-user" title="Accesso come {{ user_name or user_display or 'Utente' }}">
<span class="header-user-icon">👤</span>
<span class="header-user-name">{{ user_name or user_display or 'Utente' }}</span>
</div>
</div>
</header>

<div id="offlineBanner" class="offline-banner hidden">⚠️ Connessione assente. Dati in sola lettura</div>
<div id="updateBanner" class="update-banner hidden" role="status" aria-live="polite" aria-hidden="true">
<span>🔄 Nuova versione disponibile</span>
<button id="refreshAppBtn" type="button">Aggiorna</button>
</div>

<div id="menuOverlay" class="menu-overlay hidden"></div>
<nav id="sideMenu" class="side-menu" aria-hidden="true">
<div class="side-menu-header">
<div class="side-menu-brand">
<span class="side-menu-avatar">{{ user_initials or '?' }}</span>
<div class="side-menu-brand-text">
<span class="side-menu-title">{{ user_name or 'Utente' }}</span>
<span class="side-menu-subtitle">Accesso attivo</span>
{% if user_display %}
<span class="side-menu-username">@{{ user_display }}</span>
{% endif %}
<span class="side-menu-release-chip">
<span class="side-menu-release-dot"></span>
<span id="menuReleaseVersion" class="side-menu-release">–</span>
</span>
</div>
</div>
<button id="menuCloseBtn" class="side-menu-close" aria-label="Chiudi menu">✕</button>
</div>
<div class="side-menu-body">
{% if user_role != 'user' %}
<div class="side-menu-section">
<span class="side-menu-section-title">Navigazione</span>
<ul class="side-menu-list">
<li>
<button class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">🏠</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Dashboard</span>
<span class="side-menu-item-hint">Panoramica generale</span>
</span>
</button>
</li>
<li>
<button id="attachmentsMenuBtn" class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">📎</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Allegati Progetto</span>
<span class="side-menu-item-hint">File collegati al progetto attivo</span>
</span>
</button>
</li>
<li>
<button id="materialsMenuBtn" class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">🧰</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Materiali pianificati</span>
<span class="side-menu-item-hint">Apri pannello dedicato</span>
</span>
</button>
</li>
<li>
<button id="equipmentMenuBtn" class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">⚙️</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Attrezzature</span>
<span class="side-menu-item-hint">Check-list dedicata</span>
</span>
</button>
</li>
<li>
<button id="photosMenuBtn" class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">📷</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Foto Progetto</span>
<span class="side-menu-item-hint">Galleria immagini del cantiere</span>
</span>
</button>
</li>
<li>
<button class="side-menu-item" type="button" data-open-notifications>
<span class="side-menu-item-icon">🔔</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Storico notifiche</span>
<span class="side-menu-item-hint">Apri pannello dedicato</span>
</span>
</button>
</li>
<li>
<button id="qrTimbraturaMenuBtn" class="side-menu-item" type="button" data-menu-action>
<span class="side-menu-item-icon">📱</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">QR Timbratura</span>
<span class="side-menu-item-hint">Mostra QR per timbratura operatori</span>
</span>
</button>
</li>
{% if is_admin %}
<li>
<a href="{{ url_for('admin_sessions_page') }}" class="side-menu-item side-menu-link" data-menu-action>
<span class="side-menu-item-icon">⚙️</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Gestione Sessioni</span>
<span class="side-menu-item-hint">Verifica e aggiorna le sessioni</span>
</span>
</a>
</li>
<li>
<a href="{{ url_for('admin_request_types_page') }}" class="side-menu-item side-menu-link" data-menu-action>
<span class="side-menu-item-icon">📝</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Tipologie Richieste</span>
<span class="side-menu-item-hint">Configura ferie, permessi, rimborsi</span>
</span>
</a>
</li>
<li>
<a href="{{ url_for('admin_user_requests_page') }}" class="side-menu-item side-menu-link" data-menu-action>
<span class="side-menu-item-icon">📥</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Gestione Richieste</span>
<span class="side-menu-item-hint">Approva ferie, permessi, rimborsi</span>
</span>
</a>
</li>
{% endif %}
</ul>
</div>
<div class="side-menu-section">
<span class="side-menu-section-title">Impostazioni</span>
<ul class="side-menu-list">
<li>
<button id="themeToggle" class="side-menu-item" type="button">
<span class="side-menu-item-icon">🌙</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Dark Mode</span>
<span class="side-menu-item-hint" id="themeStatus">Tema scuro disattivato</span>
</span>
</button>
</li>
<li>
<button id="pushToggle" class="side-menu-item" type="button">
<span class="side-menu-item-icon">🔔</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Notifiche Push</span>
<span class="side-menu-item-hint" id="pushStatus">Verifica supporto...</span>
</span>
</button>
</li>
<li id="pwa-install-menu-item" style="display: none;">
<button id="pwaInstallBtn" class="side-menu-item" type="button" onclick="installPwa()">
<span class="side-menu-item-icon">📲</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Installa App</span>
<span class="side-menu-item-hint">Aggiungi alla schermata Home</span>
</span>
</button>
</li>
{% endif %}
<li>
<a href="{{ url_for('logout') }}" class="side-menu-item side-menu-link" data-menu-action>
<span class="side-menu-item-icon">🚪</span>
<span class="side-menu-item-label">
<span class="side-menu-item-text">Logout</span>
<span class="side-menu-item-hint">Chiudi la sessione corrente</span>
</span>
</a>
</li>
{% if user_role != 'user' %}
</ul>
</div>
{% endif %}
</div>
</nav>


<div class="container">
<div id="selectionToolbar" class="selection-toolbar hidden">
<span id="selectionCount" class="selection-count">0 operatori selezionati</span>
<div class="selection-actions">
<button id="selectionStartBtn" class="selection-btn selection-start">▶️ Avvia selezione</button>
<button id="selectionMoveBtn" class="selection-btn selection-move">➡️ Sposta sull'attività</button>
<button id="selectionPauseBtn" class="selection-btn selection-pause">⏸️ Pausa selezione</button>
<button id="selectionFinishBtn" class="selection-btn selection-finish">✅ Fine attività</button>
</div>
</div>
<div id="projectBar" class="project-bar">
<div class="project-bar-header">
<div class="project-info">
<span class="project-info-icon">📦 Progetto attivo:</span>
<div class="project-info-details">
<span id="projectLabel">Nessun progetto attivo</span>
<div class="project-metrics-row">
<div class="project-metric">
<span class="metric-label">📋 Durata prevista</span>
<span id="plannedDuration" class="metric-value">--:--:--</span>
</div>
<div class="project-metric">
<span class="metric-label">⏱️ Tempo in corso</span>
<span id="totalRunningTime" class="metric-value">00:00:00</span>
</div>
</div>
</div>
</div>
<span class="project-expand-indicator">▼</span>
</div>
<div class="project-bar-body">
<div class="project-actions">
<div id="projectInputGroup" class="project-input">
<input id="projectDateInput" type="date" placeholder="Data di riferimento" />
<input id="projectInput" type="text" placeholder="Codice progetto" readonly />
<div id="projectKeypad" class="keypad hidden">
<button data-digit="1">1</button>
<button data-digit="2">2</button>
<button data-digit="3">3</button>
<button data-digit="4">4</button>
<button data-digit="5">5</button>
<button data-digit="6">6</button>
<button data-digit="7">7</button>
<button data-digit="8">8</button>
<button data-digit="9">9</button>
<button class="action" data-action="clear">Canc</button>
<button data-digit="0">0</button>
<button class="action" data-action="back">⌫</button>
</div>
</div>
<button id="loadProjectBtn" class="btn btn-primary">🚚 Carica Progetto</button>
</div>
</div>
</div>
<div id="emptyState" class="empty-state">Carica un codice numerico per iniziare la pianificazione.</div>
<div id="teamCard" class="team-card card-collapsed">
<div class="team-header">
<div class="team-header-info">
<span>👷 Squadra</span>
<span id="teamMemberCount" class="team-count">0 operatori</span>
</div>
<div class="team-header-meta">
<span class="card-expand-indicator">▼</span>
</div>
</div>
<div class="team-card-body">
<div class="team-actions">
<button id="teamCollapseBtn" type="button" class="activity-collapse-btn" aria-expanded="false">Mostra squadra</button>
<button id="teamSelectBtn" type="button" class="activity-select-btn" aria-pressed="false">Seleziona tutti</button>
<button id="teamAddActivityBtn" type="button" class="activity-select-btn team-add-activity-btn" data-open-new-activity="true">➕ Nuova attività</button>
<button id="teamAddOperatorBtn" type="button" class="activity-select-btn team-add-operator-btn">👤+ Aggiungi operatore</button>
</div>
<div class="member-list hidden" id="memberList"></div>
</div>
</div>


<div id="activities"></div>
</div>

<!-- Modal Aggiungi Operatore -->
<div id="addOperatorModal" class="modal">
<div class="modal-card" style="max-width:520px;">
<div class="modal-header">
<h2 class="modal-title">👤+ Aggiungi Operatore</h2>
<button type="button" class="modal-close-btn" id="addOperatorCancelBtn" aria-label="Chiudi">&times;</button>
</div>

<div class="operator-tabs">
<button type="button" class="operator-tab active" data-tab="list">Da lista</button>
<button type="button" class="operator-tab" data-tab="manual">Manuale</button>
</div>

<div id="operatorListTab" class="operator-tab-content active">
<input type="text" id="operatorSearchInput" class="activity-search" placeholder="Cerca operatore..." autocomplete="off" />
<div id="availableOperatorsList" class="available-operators-list">
<div class="loading-operators">Caricamento...</div>
</div>
</div>

<div id="operatorManualTab" class="operator-tab-content" style="display:none;">
<form id="addOperatorManualForm" class="modal-form">
<div class="form-group">
<label for="manualOperatorName">Nome operatore <span class="required">*</span></label>
<input type="text" id="manualOperatorName" placeholder="Es. Mario Rossi" autocomplete="off" required />
</div>
<div class="form-actions">
<button type="submit" class="btn btn-primary">Aggiungi</button>
</div>
</form>
</div>
</div>
</div>

<div id="activityModal" class="modal">
<div class="modal-card">
<h3>📍 Scegli destinazione</h3>
<input id="activitySearch" class="activity-search" type="text" placeholder="Filtra attività" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');" />
<div id="choices"></div>
<button class="btn-danger" id="cancelBtn">Annulla</button>
</div>
</div>


<div id="newActivityModal" class="modal">
<div class="modal-card" style="max-width:520px;">
<div class="modal-header">
<h2 class="modal-title">➕ Nuova attività</h2>
<button type="button" class="modal-close-btn" id="newActivityCancelBtn" aria-label="Chiudi">&times;</button>
</div>
<form id="newActivityForm" class="modal-form">
<div class="form-group">
<label for="newActivityLabelInput">Nome attività <span class="required">*</span></label>
<input id="newActivityLabelInput" type="text" placeholder="Es. Montaggio palco" autocomplete="off" required />
</div>

<div class="form-group">
<label for="newActivityIdInput">Codice (opzionale)</label>
<input id="newActivityIdInput" type="text" placeholder="Es. MONT-001" autocomplete="off" />
<div class="form-hint">Lascia vuoto per generazione automatica</div>
</div>

<div class="form-group">
<label for="newActivityNotesInput">Note</label>
<textarea id="newActivityNotesInput" placeholder="Dettagli o istruzioni..." rows="3"></textarea>
</div>

<div class="form-actions">
<button type="submit" class="btn btn-primary" id="newActivitySaveBtn">Crea attività</button>
</div>
</form>
</div>
</div>


<div id="feedbackModal" class="modal">
<div class="modal-card feedback-card">
<h3 class="feedback-title">Attività completata</h3>
<p class="feedback-subtitle">Com'è andata "<span id="feedbackActivityName" class="feedback-activity">Attività</span>"?</p>
<div class="feedback-stars" role="group" aria-label="Valuta l'attività">
<button type="button" class="feedback-star" data-rating="1" aria-label="1 stella su 5">★</button>
<button type="button" class="feedback-star" data-rating="2" aria-label="2 stelle su 5">★</button>
<button type="button" class="feedback-star" data-rating="3" aria-label="3 stelle su 5">★</button>
<button type="button" class="feedback-star" data-rating="4" aria-label="4 stelle su 5">★</button>
<button type="button" class="feedback-star" data-rating="5" aria-label="5 stelle su 5">★</button>
</div>
<span id="feedbackRatingValue" class="feedback-rating-value">0/5</span>
<div class="feedback-actions">
<button id="feedbackSubmitBtn" type="button" class="feedback-submit" disabled>Salva feedback</button>
<button id="feedbackCancelBtn" type="button" class="feedback-cancel">Annulla</button>
</div>
</div>
</div>


<div id="exportModal" class="modal">
<div class="modal-card">
<h3>📊 Esporta Report Attività</h3>
<div style="display:flex;flex-direction:column;gap:16px;align-items:stretch;">
<div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
<label style="font-size:14px;font-weight:600;color:var(--text-secondary);">Periodo</label>
<div style="display:flex;gap:10px;width:100%;">
<input id="exportStartDate" type="date" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text-primary);" />
<input id="exportEndDate" type="date" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text-primary);" />
</div>
</div>
<div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
<label style="font-size:14px;font-weight:600;color:var(--text-secondary);">Formato</label>
<div style="display:flex;gap:12px;width:100%;">
<button id="exportExcelBtn" class="btn btn-primary" style="flex:1;">📊 Excel (.xlsx)</button>
<button id="exportCsvBtn" class="btn btn-secondary" style="flex:1;background:#64748b;">📄 CSV</button>
</div>
</div>
</div>
<button class="btn-danger" id="exportCancelBtn">Annulla</button>
</div>
</div>


<div id="popup" class="popup">✅ Operazione eseguita</div>

<!-- PWA Install Prompt -->
<div id="installPrompt" class="install-prompt hidden">
<div class="install-prompt-content">
<div class="install-prompt-icon">📱</div>
<div class="install-prompt-text">
<strong>Installa JobLog</strong>
<span>Accesso rapido dalla schermata home</span>
</div>
<button id="installBtn" class="install-prompt-btn">Installa</button>
<button id="dismissInstallBtn" class="install-prompt-dismiss">✕</button>
</div>
</div>

<!-- iOS Safari Install Banner -->
<div id="iosInstallBanner" role="dialog" aria-live="polite" aria-label="Suggerimento installazione iOS" aria-hidden="true">
<span>
Installa l'app: premi
<span class="ios-install-graphic" aria-hidden="true">
<svg viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="1.8">
<path d="M12 16V4M12 4l-4 4M12 4l4 4" stroke-linecap="round" stroke-linejoin="round" />
<rect x="5" y="10" width="14" height="10" rx="2" ry="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
</span>
e poi Aggiungi alla Home
<span class="ios-install-graphic" aria-hidden="true">
<svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="1.8">
<rect x="3" y="3" width="18" height="18" rx="4" ry="4" />
<path d="M12 8v8M8 12h8" stroke-linecap="round" stroke-linejoin="round" />
</svg>
</span>
</span>
<button type="button" aria-label="Chiudi suggerimento">&times;</button>
</div>

<div id="timelineOverlay" class="timeline-overlay hidden"></div>
<div id="timelinePanel" class="timeline-panel">
<div class="timeline-header">
<span>🕒 Cronologia</span>
<button id="closeTimelineBtn" class="btn btn-secondary">Chiudi</button>
</div>
<div class="timeline-body">
<div id="eventList" class="event-list"></div>
</div>
</div>


<div id="pushNotificationsModal" class="modal">
<div class="modal-card" style="width:94vw;max-width:600px;gap:18px;">
<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
<div style="display:flex;flex-direction:column;gap:4px;">
<span class="notification-title" style="font-size:20px;">🔔 Storico notifiche</span>
<span id="pushNotificationsCount" class="notification-count hidden" style="font-size:13px;color:var(--text-muted,#6b7280);"></span>
</div>
<div class="notification-actions" style="gap:10px;">
<button id="refreshPushNotificationsBtn" class="notification-action-btn" type="button">Aggiorna</button>
<button id="closePushNotificationsBtn" class="notification-action-btn" type="button">Chiudi</button>
</div>
</div>
<div id="pushNotificationsEmpty" class="notification-empty">Ancora nessuna notifica ricevuta.</div>
<div id="pushNotificationsList" class="notification-list" style="max-height:55vh;overflow-y:auto;"></div>
</div>
</div>

<!-- QR Timbratura Modal -->
<div id="qrTimbraturaModal" class="modal">
<div class="modal-card qr-modal-card">
<div class="qr-modal-header">
<div class="qr-modal-title">
<span class="qr-modal-icon">📱</span>
<div class="qr-modal-title-text">
<h2>QR Timbratura</h2>
<span id="qrDeviceId" class="qr-device-id"></span>
</div>
</div>
<div class="qr-modal-actions">
<a href="{{ url_for('qr_timbratura_page') }}" target="_blank" class="qr-fullscreen-btn" title="Apri a schermo intero">⛶</a>
<button type="button" class="modal-close-btn" id="qrTimbraturaCloseBtn" aria-label="Chiudi">&times;</button>
</div>
</div>
<div class="qr-modal-body">
<div id="qrTimbraturaContainer" class="qr-container">
<div id="qrTimbraturaLoading" class="qr-loading">
<div class="qr-spinner"></div>
<span>Generazione QR...</span>
</div>
<img id="qrTimbraturaImage" class="qr-image" alt="QR Code Timbratura" />
</div>
<div id="qrTimbraturaTime" class="qr-time"></div>
<div class="qr-refresh-bar">
<div id="qrRefreshProgress" class="qr-refresh-progress"></div>
</div>
<div class="qr-info">
<span>🔄 Aggiornamento automatico ogni <strong id="qrRefreshSeconds">10</strong> secondi</span>
</div>
</div>
</div>
</div>

<div id="attachmentsModal" class="modal">
<div class="modal-card attachments-modal-card">
<div id="attachmentsCard" class="attachments-card" aria-live="polite">
<div class="attachments-card-header">
<div>
<span class="attachments-title">📎 Allegati Progetto</span>
<span class="attachments-subtitle">Scarica e consulta i file collegati al progetto attivo.</span>
</div>
<div class="attachments-actions">
<button id="attachmentsRefreshBtn" class="attachments-refresh-btn" type="button">Aggiorna elenco</button>
<button id="attachmentsUploadBtn" class="attachments-upload-btn" type="button">➕ Nuovo allegato</button>
<button id="attachmentsCloseBtn" class="attachments-refresh-btn" type="button">Chiudi</button>
</div>
</div>
<div class="attachments-meta">
<span id="attachmentsProjectLabel">Nessun progetto attivo</span>
<span class="attachments-count"><span id="attachmentsCount">0</span> file</span>
</div>
<div id="attachmentsLoading" class="attachments-loading hidden">Aggiorno gli allegati...</div>
<div id="attachmentsGrid" class="attachments-grid hidden"></div>
<div id="attachmentsEmpty" class="attachments-empty">Carica un progetto per visualizzare gli allegati disponibili.</div>
</div>
</div>
</div>


<div id="materialsModal" class="modal">
<div id="materialsModalCard" class="modal-card materials-modal-card">
<div id="materialsCard" class="materials-card hidden" aria-live="polite">
<div class="materials-header">
<div>
<span class="materials-title">🧰 Materiale pianificato</span>
<span id="materialsSubtitle" class="materials-subtitle">Nessun progetto attivo</span>
</div>
<div class="materials-actions">
<button id="materialsRefreshBtn" class="materials-action-btn primary" type="button">Aggiorna materiali</button>
<button id="materialsCloseBtn" class="materials-action-btn" type="button">Chiudi</button>
</div>
</div>
<div class="materials-stats">
<span id="materialsCountLabel">0 elementi</span>
<span id="materialsStatusPill" class="materials-status-pill hidden">Aggiornato ora</span>
</div>
<div id="materialsEmpty" class="materials-empty">Carica un progetto per visualizzare l'elenco dei materiali pianificati.</div>
<div id="materialsList" class="materials-list hidden" role="list"></div>
<div class="modal-scroll-footer">
<div class="modal-scroll-footer-actions">
<button id="materialsScrollTopBtn" class="materials-action-btn secondary" type="button">↑ Torna su</button>
<button id="materialsCloseBottomBtn" class="materials-action-btn primary" type="button">Chiudi</button>
</div>
</div>
</div>
</div>
</div>


<div id="equipmentModal" class="modal">
<div id="equipmentModalCard" class="modal-card materials-modal-card equipment-modal-card">
<div id="equipmentCard" class="materials-card hidden" aria-live="polite">
<div class="materials-header equipment-header">
<div>
<span class="materials-title">⚙️ Attrezzature</span>
<span id="equipmentSubtitle" class="materials-subtitle">Nessun progetto attivo</span>
</div>
<div class="materials-actions equipment-actions-center">
<button id="equipmentAddBtn" class="materials-action-btn" type="button">➕ Aggiungi</button>
<button id="equipmentCloseBtn" class="materials-action-btn" type="button">Chiudi</button>
</div>
</div>
<div class="materials-stats">
<span id="equipmentCountLabel">0 elementi</span>
<span id="equipmentStatusPill" class="materials-status-pill hidden">Aggiornato ora</span>
<span id="equipmentCheckedSummary" class="materials-equipment-status hidden"></span>
</div>
<div id="equipmentEmpty" class="materials-empty">Carica un progetto per visualizzare la checklist.</div>
<div id="equipmentList" class="materials-list hidden" role="list"></div>
<div class="modal-scroll-footer">
<div class="modal-scroll-footer-actions">
<button id="equipmentScrollTopBtn" class="materials-action-btn secondary" type="button">↑ Torna su</button>
<button id="equipmentCloseBottomBtn" class="materials-action-btn primary" type="button">Chiudi</button>
</div>
</div>
</div>
</div>
</div>


<div id="newEquipmentModal" class="modal">
<div class="modal-card" style="max-width:480px;">
<div class="modal-header">
<h2 class="modal-title">➕ Nuova Attrezzatura</h2>
<button id="newEquipmentCloseBtn" type="button" class="modal-close-btn" aria-label="Chiudi">&times;</button>
</div>
<form id="newEquipmentForm" class="modal-form">
<div class="form-group">
<label for="newEquipmentName">Nome attrezzatura <span class="required">*</span></label>
<input type="text" id="newEquipmentName" name="name" placeholder="Es. Cavo HDMI 10m" required>
</div>
<div class="form-row">
<div class="form-group">
<label for="newEquipmentQuantity">Quantità</label>
<input type="number" id="newEquipmentQuantity" name="quantity" value="1" min="1">
</div>
<div class="form-group">
<label for="newEquipmentGroup">Gruppo</label>
<input type="text" id="newEquipmentGroup" name="group_name" placeholder="Attrezzature extra">
</div>
</div>
<div class="form-group">
<label for="newEquipmentNotes">Note</label>
<textarea id="newEquipmentNotes" name="notes" rows="3" placeholder="Note aggiuntive..."></textarea>
</div>
<div class="form-actions">
<button type="button" id="newEquipmentCancelBtn" class="btn btn-secondary">Annulla</button>
<button type="submit" class="btn btn-primary">Aggiungi</button>
</div>
</form>
</div>
</div>


<div id="photosModal" class="modal">
<div class="modal-card photos-modal-card">
<div class="photos-card" aria-live="polite">
<div class="photos-card-header">
<div>
<span class="photos-title">📷 Foto Progetto</span>
<span class="photos-subtitle">Scatta e carica foto del cantiere</span>
</div>
<div class="photos-actions">
<button id="photosRefreshBtn" class="photos-action-btn" type="button">Aggiorna</button>
<button id="photosCameraBtn" class="photos-action-btn primary" type="button">📸 Fotocamera</button>
<label id="photosUploadBtn" class="photos-action-btn" tabindex="0">
📁 Galleria
<input type="file" id="photosFileInput" accept="image/*" multiple hidden>
</label>
<button id="photosCloseBtn" class="photos-action-btn" type="button">Chiudi</button>
</div>
</div>
<div class="photos-meta">
<span id="photosProjectLabel">Nessun progetto attivo</span>
<span class="photos-count"><span id="photosCount">0</span> foto</span>
</div>
<div id="photosLoading" class="photos-loading hidden">Caricamento in corso...</div>
<div id="photosGrid" class="photos-grid hidden"></div>
<div id="photosEmpty" class="photos-empty">Carica un progetto per visualizzare e aggiungere foto.</div>
</div>
</div>
</div>

<!-- Input nascosto per la fotocamera (fallback) -->
<input type="file" id="photosCameraInput" accept="image/*" capture="environment" hidden>

<!-- Modal Fotocamera -->
<div id="cameraModal" class="modal">
<div class="modal-card camera-modal-card">
<div class="camera-header">
<span class="camera-title">📸 Fotocamera</span>
<button id="cameraCloseBtn" class="photos-action-btn" type="button">✕</button>
</div>
<div class="camera-viewfinder">
<video id="cameraVideo" autoplay playsinline muted></video>
<canvas id="cameraCanvas" hidden></canvas>
</div>
<div class="camera-actions">
<button id="cameraCaptureBtn" class="camera-capture-btn" type="button">
<span class="camera-capture-icon">📷</span>
</button>
</div>
</div>
</div>

<div id="photoPreviewModal" class="modal">
<div class="modal-card photo-preview-modal-card">
<img id="photoPreviewImage" class="photo-preview-image" src="" alt="Anteprima foto" />
<div id="photoPreviewCaption" class="photo-preview-caption"></div>
<div class="photo-preview-actions">
<button id="photoDeleteBtn" class="photos-action-btn danger" type="button">🗑️ Elimina</button>
<button id="photoPreviewCloseBtn" class="photos-action-btn" type="button">Chiudi</button>
</div>
</div>
</div>


<div id="materialPhotoModal" class="modal">
<div class="modal-card material-photo-modal-card">
<img id="materialPhotoImage" class="material-photo-image" src="" alt="Anteprima foto materiale" />
<div id="materialPhotoCaption" class="material-photo-caption">–</div>
<div class="material-photo-actions">
<a id="materialPhotoLink" class="material-photo-link" href="#" target="_blank" rel="noopener noreferrer">Apri originale</a>
<button id="materialPhotoCloseBtn" class="materials-action-btn" type="button">Chiudi</button>
</div>
</div>
</div>


<script>
window.__INITIAL_ATTACHMENTS__ = {{ initial_attachments|tojson|safe }};
window.__INITIAL_MATERIALS__ = {{ initial_materials|tojson|safe }};
window.__SAVED_SUPERVISOR_PROJECT__ = {{ saved_supervisor_project|tojson|safe }};
</script>
<script src="{{ static_version('js/app.js') }}"></script>
<script>
// PWA Service Worker Registration
const SW_UPDATE_INTERVAL_MS = 60_000;
let swUpdateIntervalId = null;

function scheduleServiceWorkerUpdates(registration) {
    if (!registration || typeof registration.update !== 'function') {
        return;
    }
    const runUpdateCheck = () => {
        try {
            const result = registration.update();
            if (result && typeof result.catch === 'function') {
                result.catch((error) => console.warn('registration.update fallita', error));
            }
        } catch (error) {
            console.warn('Impossibile forzare l\'update del service worker', error);
        }
    };
    runUpdateCheck();
    if (swUpdateIntervalId) {
        clearInterval(swUpdateIntervalId);
    }
    swUpdateIntervalId = setInterval(runUpdateCheck, SW_UPDATE_INTERVAL_MS);
}

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js?v=2026.01.08e')
            .then((registration) => {
                console.log('✓ Service Worker registrato:', registration.scope);
                if (registration.active && navigator.serviceWorker.controller === null) {
                    registration.active.postMessage({ type: 'claim-clients' });
                }
                scheduleServiceWorkerUpdates(registration);
                monitorServiceWorkerUpdates(registration);
            })
            .catch((error) => {
                console.log('✗ Service Worker fallito:', error);
            });
    });
}

window.addEventListener('beforeunload', () => {
    if (swUpdateIntervalId) {
        clearInterval(swUpdateIntervalId);
    }
});

// PWA Install Prompt
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');
const installBtn = document.getElementById('installBtn');
const dismissInstallBtn = document.getElementById('dismissInstallBtn');
const updateBanner = document.getElementById('updateBanner');
const refreshAppBtn = document.getElementById('refreshAppBtn');
let pendingServiceWorker = null;
let reloadOnControllerChange = false;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Check if user dismissed before
    const dismissed = localStorage.getItem('pwa-install-dismissed');
    if (!dismissed) {
        setTimeout(() => {
            if (installPrompt) {
                installPrompt.classList.remove('hidden');
            }
        }, 3000);
    }
});

if (installBtn) {
    installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log('PWA install:', outcome);
        
        if (installPrompt) {
            installPrompt.classList.add('hidden');
        }
        deferredPrompt = null;
    });
}

if (dismissInstallBtn) {
    dismissInstallBtn.addEventListener('click', () => {
        if (installPrompt) {
            installPrompt.classList.add('hidden');
        }
        localStorage.setItem('pwa-install-dismissed', 'true');
    });
}

// Listen for app installed
window.addEventListener('appinstalled', () => {
    console.log('✓ PWA installata');
    if (installPrompt) {
        installPrompt.classList.add('hidden');
    }
});

if (refreshAppBtn) {
    refreshAppBtn.addEventListener('click', () => {
        hideUpdateBanner();
        if (pendingServiceWorker) {
            reloadOnControllerChange = true;
            pendingServiceWorker.postMessage({ type: 'claim-clients' });
            pendingServiceWorker = null;
        } else {
            window.location.reload();
        }
    });
}

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (reloadOnControllerChange) {
            reloadOnControllerChange = false;
            window.location.reload();
        }
    });
}

function showUpdateAvailable() {
    if (!updateBanner) {
        return;
    }
    updateBanner.classList.remove('hidden');
    updateBanner.setAttribute('aria-hidden', 'false');
}

function hideUpdateBanner() {
    if (!updateBanner) {
        return;
    }
    updateBanner.classList.add('hidden');
    updateBanner.setAttribute('aria-hidden', 'true');
}

function monitorServiceWorkerUpdates(registration) {
    if (!registration || !navigator.serviceWorker.controller) {
        return;
    }

    const handleWaitingWorker = (worker) => {
        if (!worker || worker.state !== 'installed') {
            return;
        }
        pendingServiceWorker = worker;
        showUpdateAvailable();
    };

    if (registration.waiting) {
        handleWaitingWorker(registration.waiting);
    }

    const onUpdateFound = () => {
        const newWorker = registration.installing;
        if (!newWorker) {
            return;
        }
        newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                handleWaitingWorker(newWorker);
            }
        });
    };

    if (typeof registration.addEventListener === 'function') {
        registration.addEventListener('updatefound', onUpdateFound);
    } else {
        registration.onupdatefound = onUpdateFound;
    }
}

// Gentle banner for iOS Safari users (no native beforeinstallprompt event)
(function () {
    const STORAGE_KEY = 'ios-install-dismissed';
    const banner = document.getElementById('iosInstallBanner');
    if (!banner) return;

    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const dismissed = localStorage.getItem(STORAGE_KEY);

    if (!isIOS || isStandalone || dismissed) {
        return;
    }

    banner.classList.add('show');
    banner.setAttribute('aria-hidden', 'false');

    const closeBtn = banner.querySelector('button');
    closeBtn?.addEventListener('click', () => {
        banner.classList.remove('show');
        banner.setAttribute('aria-hidden', 'true');
        localStorage.setItem(STORAGE_KEY, '1');
    });
})();
</script>
</body>
</html>