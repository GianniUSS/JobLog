<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#667eea" />
<link rel="manifest" href="/static/manifest.json" />
<link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<title>Timbratura - JOBLog</title>
<style>
:root {
  --bg: #f0f2f5;
  --bg-card: #ffffff;
  --bg-card-hover: #f8fafc;
  --brand: #667eea;
  --brand-light: #818cf8;
  --brand-dark: #4f46e5;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --green: #22c55e;
  --green-dark: #16a34a;
  --red: #ef4444;
  --red-dark: #dc2626;
  --success: #10b981;
  --success-bg: #d1fae5;
  --warning: #f59e0b;
  --warning-bg: #fef3c7;
  --danger: #ef4444;
  --danger-bg: #fee2e2;
  --orange: #f97316;
  --orange-light: #fed7aa;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow: rgba(0,0,0,0.1);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --radius: 16px;
  --radius-sm: 10px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
[data-theme="dark"] {
  --bg: #0f172a;
  --bg-card: #1e293b;
  --bg-card-hover: #334155;
  --brand: #818cf8;
  --brand-light: #a5b4fc;
  --brand-dark: #6366f1;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #334155;
  --border-light: #1e293b;
  --success-bg: rgba(16, 185, 129, 0.2);
  --warning-bg: rgba(245, 158, 11, 0.2);
  --danger-bg: rgba(239, 68, 68, 0.2);
  --shadow: rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html {
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh;
  touch-action: manipulation;
  -webkit-overflow-scrolling: touch;
}

/* Main Header with Gradient */
.main-header {
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
  padding: calc(var(--safe-top) + 20px) 20px 20px;
  position: relative;
}
.main-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  pointer-events: none;
}
.main-header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
}
.main-header-title {
  flex: 1;
  text-align: center;
}
.main-header-title h1 {
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 2px;
}
.main-header-title p {
  color: rgba(255,255,255,0.8);
  font-size: 0.875rem;
}
.main-header-spacer {
  width: 44px;
  height: 44px;
  flex-shrink: 0;
}

.refresh-btn {
  width: 44px;
  height: 44px;
  border-radius: 14px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 1.1rem;
}

.refresh-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.refresh-btn.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.container {
  max-width: 420px;
  margin: 0 auto;
  padding: 8px 16px 16px;
  padding-bottom: calc(80px + var(--safe-bottom));
}
header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0 16px;
}
.header-info {
  flex: 1;
  text-align: center;
}
.header-title {
  font-size: 20px;
  font-weight: 700;
}
.header-date {
  font-size: 13px;
  color: var(--text-secondary);
}
.clock-section {
  text-align: center;
  padding: 0;
}
.clock {
  font-size: 42px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: -1px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.clock-icon {
  display: inline-block;
  font-size: 28px;
  animation: clockTick 2s ease-in-out infinite;
}
@keyframes clockTick {
  0%, 100% { transform: rotate(0deg); }
  10% { transform: rotate(8deg); }
  20% { transform: rotate(0deg); }
}

/* Scanner Modal */
.scanner-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  padding-top: env(safe-area-inset-top, 20px);
  padding-bottom: env(safe-area-inset-bottom, 20px);
}
.scanner-modal.active {
  display: flex;
}
.scanner-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.scanner-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.scanner-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}
#qr-reader {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  min-height: 280px;
}
#qr-reader video {
  border-radius: 12px;
  width: 100% !important;
  height: auto !important;
}
#qr-reader__scan_region {
  min-height: 250px;
}
.scanner-close {
  padding: 14px 32px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 48px;
  touch-action: manipulation;
}

/* Method Choice Modal */
.method-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.method-modal.active {
  display: flex;
}
.method-container {
  background: var(--bg-card);
  border-radius: 20px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.method-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.method-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}
.method-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}
.method-btn {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px 20px;
  border: 2px solid var(--border);
  border-radius: 14px;
  background: var(--bg-card);
  cursor: pointer;
  transition: all 0.2s ease;
}
.method-btn:hover {
  border-color: var(--brand);
  background: rgba(102, 126, 234, 0.1);
}
.method-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.method-btn-icon {
  font-size: 32px;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  border-radius: 12px;
}
.method-btn-content {
  text-align: left;
  flex: 1;
}
.method-btn-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}
.method-btn-desc {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.method-cancel {
  padding: 12px 24px;
  background: var(--bg);
  color: var(--text-secondary);
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* GPS Modal */
.gps-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.gps-modal.active {
  display: flex;
}
.gps-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.gps-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.gps-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.gps-location-name {
  font-size: 15px;
  color: var(--text-primary);
  padding: 10px 16px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.1) 100%);
  border-radius: 10px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.gps-location-name .location-label {
  font-size: 18px;
}
.gps-status {
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  background: var(--bg);
}
.gps-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.gps-icon.loading {
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}
.gps-message {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.gps-accuracy {
  font-size: 12px;
  color: var(--text-muted);
}
.gps-accuracy.good { color: var(--green); }
.gps-accuracy.medium { color: var(--warning); }
.gps-accuracy.poor { color: var(--danger); }
.gps-tip {
  font-size: 11px;
  color: var(--text-secondary);
  display: block;
  margin-top: 4px;
}
.gps-buttons {
  display: flex;
  gap: 12px;
}
.gps-btn {
  flex: 1;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}
.gps-btn.primary {
  background: var(--green);
  color: white;
}
.gps-btn.primary:disabled {
  background: #64748b;
  cursor: not-allowed;
}
.gps-btn.secondary {
  background: var(--bg);
  color: var(--text-primary);
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}
.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 18px 24px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  color: white;
  min-height: 60px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.action-btn:active:not(:disabled) {
  transform: scale(0.98);
}
.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.action-btn.start {
  background: var(--green);
}
.action-btn.start:hover:not(:disabled),
.action-btn.start:active:not(:disabled) {
  background: var(--green-dark);
}
.action-btn.end {
  background: var(--red);
}
.action-btn.end:hover:not(:disabled),
.action-btn.end:active:not(:disabled) {
  background: var(--red-dark);
}
.action-btn .icon {
  font-size: 20px;
}
.action-btn .check {
  margin-left: auto;
  width: 24px;
  height: 24px;
  border: 2px solid rgba(255,255,255,0.5);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.action-btn .check.done {
  background: white;
  border-color: white;
  color: var(--green);
}
.pause-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.pause-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 16px;
  border: 2px solid var(--orange);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  min-height: 52px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s ease;
  background: var(--orange-light);
  color: #9a3412;
}
.pause-btn:hover:not(:disabled) {
  background: var(--orange);
  color: white;
}
.pause-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.pause-btn .icon {
  font-size: 18px;
}
.history-section {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 900;
  background: var(--bg-card);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  border-radius: 16px 16px 0 0;
}
.history-toggle {
  width: 100%;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  border: none;
  padding: 14px 20px;
  font-size: 15px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: #fff;
  border-radius: 16px 16px 0 0;
}
.history-toggle .history-arrow {
  margin-left: auto;
  font-size: 14px;
  transition: transform 0.3s ease;
  color: #fff;
}
.history-section.open .history-toggle .history-arrow {
  transform: rotate(180deg);
}
.history-content {
  max-height: 0;
  overflow-y: auto;
  transition: max-height 0.35s ease;
}
.history-section.open .history-content {
  max-height: 50vh;
  padding: 12px 16px 16px;
}
.history-spacer {
  height: 56px;
}
.history-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.history-list {
  list-style: none;
}
.history-item {
  display: flex;
  align-items: stretch;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  min-height: 50px;
}
.history-item > *:not(.location-badge):not(.overtime-badge) {
  display: flex;
  align-items: center;
}
.history-item:last-child {
  border-bottom: none;
}
.history-item .time {
  font-weight: 600;
  min-width: 55px;
  align-self: center;
  display: flex;
  flex-direction: column;
  line-height: 1.3;
  align-items: flex-start;
  justify-content: center;
}
.history-item .time .time-main {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.history-item .time .ora-originale {
  opacity: 0.6;
  font-weight: 400;
  font-size: 12px;
  text-decoration: line-through;
}
.history-item .time .ora-mod {
  color: var(--green);
  font-weight: 700;
}
.history-item .pausa-durata {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 4px;
}
.history-item .pausa-durata .ora-mod {
  color: var(--green);
  font-weight: 600;
}
.history-item .pausa-durata-row {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 2px;
  margin-left: 0;
  display: block;
  width: 100%;
}
.history-item .pausa-durata-row .ora-mod {
  color: var(--green);
  font-weight: 600;
}
.history-item .type {
  color: var(--text-secondary);
  align-self: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.history-item .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  align-self: center;
}
.history-item .dot.start { background: var(--green); }
.history-item .dot.end { background: var(--red); }
.history-item .dot.pause { background: var(--orange); }

/* Sync status indicator */
.history-item .sync-status {
  margin-left: auto;
  font-size: 14px;
  align-self: center;
}
.history-item .sync-status.synced {
  color: var(--green);
  font-size: 12px;
}
.history-item .sync-status.pending {
  animation: pulse-cloud 1.5s ease-in-out infinite;
}
@keyframes pulse-cloud {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Overtime badge (straordinario in attesa) - riga separata */
.history-item.has-overtime {
  border-left: 3px solid #f59e0b;
  padding-left: 12px;
  margin-left: -3px;
}
.history-item.pending-confirmation {
  border-left: 3px solid #f97316;
}
.overtime-info-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0 6px 15px;
  margin-top: -8px;
  font-size: 12px;
  color: #92400e;
  background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
  border-bottom: 1px solid var(--border);
}
.overtime-info-row.pending-confirmation {
  background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
  color: #9a3412;
}
.overtime-info-row .overtime-icon {
  font-size: 14px;
}
.overtime-info-row .overtime-text {
  font-weight: 600;
}
.overtime-info-row .overtime-time {
  background: #fbbf24;
  color: #78350f;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 11px;
}

/* Late Arrival Request */
.late-arrival-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0 6px 15px;
  margin-top: -8px;
  font-size: 12px;
  border-bottom: 1px solid var(--border);
}
.late-arrival-row.pending-confirmation {
  background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
  color: #9a3412;
}
.late-arrival-row.approved {
  background: linear-gradient(90deg, rgba(34, 197, 94, 0.15), transparent);
  color: #166534;
}
.late-arrival-row.registered {
  background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
  color: #92400e;
}
.late-arrival-row .overtime-icon {
  font-size: 14px;
}
.late-arrival-row .overtime-text {
  font-weight: 600;
}

/* Location badge - chip grande con contenuto su 2 righe */
.history-item .location-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 42px;
  padding: 6px 14px;
  font-size: 11px;
  font-weight: 500;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-radius: 12px;
  margin-left: auto;
  max-width: 130px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  line-height: 1.2;
  text-align: center;
}
.history-item .location-badge .loc-icon {
  font-size: 14px;
  margin-bottom: 2px;
}
.history-item .location-badge .loc-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.history-item .method-badge {
  font-size: 12px;
  margin-left: 6px;
  align-self: center;
}
.history-item .method-badge.qr {
  opacity: 0.7;
}

/* Badge supervisor - per timbrature create dal caposquadra */
.history-item .supervisor-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  font-size: 10px;
  font-weight: 500;
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  border-radius: 10px;
  margin-left: 6px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
}

.history-item.offline-pending {
  background: rgba(245, 158, 11, 0.08);
  border-radius: 8px;
  padding-left: 10px;
  padding-right: 10px;
  margin: 2px -10px;
}

.empty-history {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
  font-size: 14px;
}
.user-badge {
  position: fixed;
  bottom: calc(16px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  padding: 10px 20px;
  border-radius: 24px;
  box-shadow: 0 4px 20px var(--shadow);
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 100;
}
.user-badge .avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--green);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}
.logout-link {
  color: var(--red);
  text-decoration: none;
  margin-left: 4px;
  font-size: 18px;
  padding: 4px;
  touch-action: manipulation;
}
.toast {
  position: fixed;
  top: calc(20px + env(safe-area-inset-top, 0px));
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--bg-card);
  padding: 14px 24px;
  border-radius: 12px;
  box-shadow: 0 8px 32px var(--shadow);
  font-weight: 600;
  z-index: 1001;
  transition: transform 0.3s ease, opacity 0.3s ease;
  max-width: calc(100vw - 40px);
  text-align: center;
  opacity: 0;
  pointer-events: none;
}
.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  pointer-events: auto;
}
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.toast.warning { border-left: 4px solid var(--yellow); }

/* Offline Status Bar */
.offline-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
  color: white;
  padding: 8px 16px;
  text-align: center;
  font-weight: 600;
  font-size: 13px;
  z-index: 1100;
}

/* Box Turno */
.turno-box {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 18px;
  padding: 14px 16px;
  margin-bottom: 16px;
  color: white;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.35);
  position: relative;
  overflow: hidden;
}
.turno-box * {
  color: white !important;
}
.turno-box::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}
.turno-box.no-turno {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  box-shadow: 0 8px 24px rgba(100, 116, 139, 0.35);
}
.turno-nav {
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  z-index: 2;
}
.turno-nav-btn {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.4);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.turno-nav-btn:hover {
  background: rgba(255,255,255,0.35);
  border-color: rgba(255,255,255,0.6);
  transform: scale(1.08) translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}
.turno-nav-btn:active {
  transform: scale(0.93);
}
.turno-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
.turno-nav-btn:disabled:hover {
  background: rgba(255,255,255,0.25);
  border-color: rgba(255,255,255,0.4);
  transform: none;
}
.turno-content {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}
.turno-counter {
  position: absolute;
  top: 12px;
  right: 16px;
  background: rgba(255,255,255,0.3);
  backdrop-filter: blur(10px);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  z-index: 3;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.turno-header {
  display: none; /* Rimosso - ora usiamo direttamente il nome progetto */
}
.turno-project {
  font-size: 15px;
  font-weight: 800;
  margin-bottom: 6px;
  line-height: 1.25;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 2;
  position: relative;
  letter-spacing: -0.3px;
}
.turno-badges-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.turno-badge-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}
.turno-badge-pausa {
  background: rgba(255,140,0,0.9);
  color: white;
}
.turno-badge-note {
  background: rgba(255,193,7,0.9);
  color: #333;
  animation: pulse-note 2s infinite;
}
.turno-badge-note:hover {
  background: rgba(255,193,7,1);
  transform: scale(1.05);
}
.turno-details {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  font-size: 14px;
  opacity: 0.95;
  z-index: 2;
  position: relative;
}
.turno-detail {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.25);
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  white-space: nowrap;
}
.turno-detail .icon {
  font-size: 0.9rem;
  flex-shrink: 0;
}
.turno-detail-row {
  grid-column: 1;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  font-size: 14px;
  border-radius: 6px;
}
.turno-pausa-badge {
  display: none; /* Ora gestito tramite turno-badges-row */
}
.turno-note-btn {
  display: none; /* Ora gestito tramite turno-badges-row */
}
@keyframes pulse-note {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,193,7,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(255,193,7,0); }
}
/* Modal Note Turno */
.note-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.note-modal.open {
  display: flex;
}
.note-container {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border-radius: 20px;
  padding: 24px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.1);
}
.note-title {
  font-size: 20px;
  font-weight: 700;
  color: white;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.note-section {
  background: rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}
.note-section-label {
  font-size: 11px;
  font-weight: 700;
  color: rgba(255,255,255,0.5);
  text-transform: uppercase;
  margin-bottom: 6px;
}
.note-section-text {
  font-size: 14px;
  color: white;
  line-height: 1.5;
  white-space: pre-wrap;
}
.note-close {
  width: 100%;
  padding: 14px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s ease;
}
.note-close:hover {
  background: rgba(255,255,255,0.2);
}
.turno-timbratura {
  width: 100%;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 9px 11px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.25);
  font-weight: 600;
  grid-column: 1;
}
.turno-timbratura .icon {
  font-size: 16px;
  flex-shrink: 0;
}
.turno-timbratura.no-gps {
  background: rgba(239, 68, 68, 0.4);
  border-color: rgba(239, 68, 68, 0.5);
}
.turno-timbratura.inline-location {
  display: flex !important;
  flex-wrap: wrap;
  gap: 8px;
  background: none !important;
  border: none !important;
  padding: 0 !important;
  align-items: flex-start;
}
.location-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  flex: 1 1 auto;
  background: rgba(255, 255, 255, 0.15);
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.25);
}
.location-item .icon {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  flex-shrink: 0;
}
.location-item .value {
  font-weight: 600;
  color: rgba(255, 255, 255, 0.95);
  font-size: 14px;
  white-space: nowrap;
}
.turno-badge {
  display: inline-block;
  background: rgba(251, 191, 36, 0.25);
  border: 1px solid rgba(251, 191, 36, 0.5);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  margin-top: 6px;
  z-index: 2;
  position: relative;
}
.turno-badge.leader {
  background: #fbbf24;
  color: #92400e;
  border: none;
}
.turno-loading {
  text-align: center;
  padding: 12px;
  font-size: 13px;
  opacity: 0.85;
  z-index: 2;
  position: relative;
}

/* Info Button */
.turno-info-btn {
  position: absolute;
  bottom: 10px;
  right: 12px;
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.4);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3;
  transition: background 0.2s, transform 0.15s;
}
.turno-info-btn:hover {
  background: rgba(255,255,255,0.4);
  transform: scale(1.1);
}

/* Crew Info Modal */
.crew-info-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.crew-info-overlay.active {
  display: flex;
}
.crew-info-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 420px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: crewInfoSlideIn 0.3s ease;
}
@keyframes crewInfoSlideIn {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.crew-info-modal * {
  color: inherit !important;
}
.crew-info-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 18px 18px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.crew-info-header * {
  color: white !important;
}
.crew-info-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}
.crew-info-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white !important;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.crew-info-close:hover {
  background: rgba(255,255,255,0.35);
}
.crew-info-body {
  padding: 16px 20px;
}
.crew-info-section {
  margin-bottom: 16px;
}
.crew-info-section:last-child {
  margin-bottom: 0;
}
.crew-info-section-title {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.crew-member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 10px;
  margin-bottom: 4px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
}
.crew-member-item.is-me {
  background: #eff6ff;
  border-color: #bfdbfe;
}
.crew-member-item.is-leader {
  background: #fffbeb;
  border-color: #fbbf24;
  border-width: 2px;
}
.crew-member-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  color: #64748b;
  flex-shrink: 0;
}
.crew-member-item.is-me .crew-member-avatar {
  background: #3b82f6;
  color: white;
}
.crew-member-item.is-leader .crew-member-avatar {
  background: #fbbf24;
  color: white;
}
.crew-member-info {
  flex: 1;
  min-width: 0;
}
.crew-member-name {
  font-weight: 600;
  font-size: 14px;
  color: #1e293b;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.crew-member-role {
  font-size: 11px;
  color: #94a3b8;
}
.crew-member-time {
  font-size: 12px;
  color: #64748b;
  font-weight: 600;
  white-space: nowrap;
}
.crew-leader-badge {
  display: inline-block;
  background: #fbbf24;
  color: #92400e;
  font-size: 9px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 8px;
  margin-left: 4px;
}
.vehicle-info-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 4px;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
}
.vehicle-info-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.vehicle-info-details {
  flex: 1;
  min-width: 0;
}
.vehicle-info-name {
  font-weight: 600;
  font-size: 13px;
  color: #166534;
}
.vehicle-info-driver {
  font-size: 11px;
  color: #64748b;
  margin-top: 2px;
}
.crew-info-loading {
  text-align: center;
  padding: 30px;
  color: #94a3b8;
}
.crew-info-empty {
  text-align: center;
  padding: 20px;
  color: #94a3b8;
  font-size: 13px;
}

/* Switch Activity Modal */
.switch-activity-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  align-items: stretch;
  justify-content: stretch;
  padding: 0;
}
.switch-activity-overlay.active {
  display: flex;
}
.switch-activity-modal {
  background: white;
  border-radius: 0;
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  overflow-y: auto;
  box-shadow: none;
  animation: switchSlideIn 0.3s ease;
}
@keyframes switchSlideIn {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.switch-activity-modal * {
  color: inherit !important;
}
.switch-activity-header {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 18px 18px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.switch-activity-header * {
  color: white !important;
}
.switch-activity-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}
.switch-activity-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white !important;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.switch-activity-close:hover {
  background: rgba(255,255,255,0.35);
}
.switch-activity-body {
  padding: 16px 20px;
}
.switch-activity-item {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 14px;
  padding: 14px 16px;
  transition: all 0.2s ease;
}
.switch-activity-item:not(.current):hover {
  background: #e3f2fd;
  border-color: #2196F3;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(33,150,243,0.15);
}

/* Numpad per cambio progetto */
.numpad-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10001;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.numpad-overlay.active {
  display: flex;
}
.numpad-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 340px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: switchSlideIn 0.3s ease;
  overflow: hidden;
}
.numpad-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white !important;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.numpad-header * { color: white !important; }
.numpad-header h3 { margin: 0; font-size: 15px; font-weight: 700; }
.numpad-display {
  padding: 16px 18px 8px;
  text-align: center;
}
.numpad-display input {
  width: 100%;
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  letter-spacing: 3px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  padding: 12px;
  color: #1a56db !important;
  background: #f8faff;
  outline: none;
}
.numpad-display input:focus {
  border-color: #3b82f6;
}
.numpad-result {
  padding: 0 18px 8px;
  text-align: center;
  min-height: 24px;
}
.numpad-result .found {
  color: #16a34a !important;
  font-weight: 600;
  font-size: 13px;
}
.numpad-result .not-found {
  color: #dc2626 !important;
  font-weight: 600;
  font-size: 13px;
}
.numpad-result .searching {
  color: #888 !important;
  font-size: 13px;
}
.numpad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 8px 18px;
}
.numpad-btn {
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 14px;
  font-size: 22px;
  font-weight: 700;
  color: #1e293b !important;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.numpad-btn:active {
  background: #dbeafe;
  border-color: #3b82f6;
  transform: scale(0.95);
}
.numpad-btn.del {
  background: #fef2f2;
  color: #dc2626 !important;
  border-color: #fecaca;
}
.numpad-btn.del:active {
  background: #fee2e2;
}
.numpad-actions {
  display: flex;
  gap: 10px;
  padding: 10px 18px 18px;
}
.numpad-actions button {
  flex: 1;
  padding: 13px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  border: none;
}

/* Popup note obbligatorie per attivitÃ  Altro */
.notes-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.65);
  z-index: 10002;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.notes-overlay.active {
  display: flex;
}
.notes-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 380px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: switchSlideIn 0.3s ease;
  overflow: hidden;
}
.notes-header {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white !important;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.notes-header * { color: white !important; }
.notes-header h3 { margin: 0; font-size: 15px; font-weight: 700; }
.notes-body {
  padding: 18px;
}
.notes-body textarea {
  width: 100%;
  min-height: 100px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  padding: 12px;
  font-size: 15px;
  font-family: inherit;
  resize: vertical;
  outline: none;
  color: #333;
  background: #fefefe;
}
.notes-body textarea:focus {
  border-color: #f59e0b;
}
.notes-body textarea.error {
  border-color: #dc2626;
  background: #fef2f2;
}
.notes-body .notes-hint {
  font-size: 12px;
  color: #888;
  margin-top: 6px;
}
.notes-body .notes-error {
  font-size: 12px;
  color: #dc2626;
  font-weight: 600;
  margin-top: 6px;
  display: none;
}
.notes-actions {
  display: flex;
  gap: 10px;
  padding: 0 18px 18px;
}
.notes-actions button {
  flex: 1;
  padding: 13px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  border: none;
}

.switch-activity-item.current {
  background: #e8f5e9;
  border-color: #4CAF50;
}
.switch-activity-current {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.switch-activity-current-icon {
  font-size: 20px;
}
.switch-activity-current-info {
  flex: 1;
}
.switch-activity-current-label {
  font-size: 11px;
  color: #92400e;
  font-weight: 700;
  text-transform: uppercase;
}
.switch-activity-current-name {
  font-size: 14px;
  font-weight: 600;
  color: #78350f;
}
.switch-activity-list-title {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
}
.switch-activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 6px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  cursor: pointer;
  transition: all 0.2s;
}
.switch-activity-item:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  transform: translateX(4px);
}
.switch-activity-item:active {
  transform: scale(0.98);
}
.switch-activity-item.current {
  opacity: 0.5;
  pointer-events: none;
  background: #f1f5f9;
}
.switch-activity-item-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: white !important;
  flex-shrink: 0;
}
.switch-activity-item-info {
  flex: 1;
  min-width: 0;
}
.switch-activity-item-project {
  font-weight: 600;
  font-size: 14px;
  color: #1e293b;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.switch-activity-item-detail {
  font-size: 11px;
  color: #94a3b8;
  margin-top: 2px;
}
.switch-activity-item-arrow {
  color: #cbd5e1;
  font-size: 18px;
  flex-shrink: 0;
}

/* Dev Mode Toggle */
.dev-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 10px 16px;
  background: #fef3c7;
  border: 2px dashed #f59e0b;
  border-radius: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #92400e;
}
.dev-toggle label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-weight: 600;
}
.dev-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #f59e0b;
}
.dev-badge {
  background: #f59e0b;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 700;
}

/* Menu Hamburger */
.hamburger-btn {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  width: 44px;
  height: 44px;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: all 0.2s ease;
  touch-action: manipulation;
  flex-shrink: 0;
}
.hamburger-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}
.hamburger-btn span {
  display: block;
  width: 20px;
  height: 2px;
  background: white;
  border-radius: 1px;
  transition: all 0.3s ease;
}
.hamburger-btn.active span:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}
.hamburger-btn.active span:nth-child(2) {
  opacity: 0;
}
.hamburger-btn.active span:nth-child(3) {
  transform: rotate(-45deg) translate(5px, -5px);
}

/* Side Menu */
.side-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}
.side-menu-overlay.active {
  opacity: 1;
  visibility: visible;
}
.side-menu {
  position: fixed;
  top: 0;
  left: -320px;
  width: 300px;
  max-width: 85vw;
  height: 100vh;
  height: 100dvh;
  background: var(--bg-card);
  z-index: 700;
  transition: left 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: 4px 0 20px var(--shadow);
}
.side-menu.active {
  left: 0;
}
.side-menu-header {
  padding: 20px;
  padding-top: calc(20px + env(safe-area-inset-top, 0px));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
}
.side-menu-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}
.side-menu-user-info {
  flex: 1;
}
.side-menu-user-name {
  font-size: 16px;
  font-weight: 700;
  color: white;
}
.side-menu-user-role {
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}
.side-menu-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.menu-section {
  margin-bottom: 24px;
}
.menu-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding: 0 8px;
}
.menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 14px;
  color: var(--text-primary);
  text-decoration: none;
}
.menu-item:hover {
  background: var(--bg);
}
.menu-item.active {
  background: rgba(102, 126, 234, 0.15);
  color: var(--brand);
  font-weight: 600;
}
.menu-item .icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}
.menu-item.danger {
  color: var(--danger);
}
.notification-toggle {
  display: flex;
  align-items: center;
}
.notification-toggle .toggle-switch {
  margin-left: auto;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 28px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider {
  background-color: var(--success);
}
.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(22px);
}
.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Menu Footer con Logo */
.side-menu-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  text-align: center;
}
.side-menu-footer img {
  max-width: 120px;
  max-height: 40px;
  object-fit: contain;
  opacity: 0.8;
  transition: opacity 0.2s;
}
.side-menu-footer img:hover {
  opacity: 1;
}
.side-menu-footer-text {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 8px;
}
}
.user-info-grid {
  display: grid;
  gap: 8px;
}
.user-info-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg);
  border-radius: 8px;
  font-size: 13px;
}
.user-info-row .label {
  color: var(--text-secondary);
}
.user-info-row .value {
  font-weight: 600;
}

/* Profilo Utente Page */
.profile-page {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 800;
  display: none;
  flex-direction: column;
  overflow-y: auto;
}
.profile-page.active {
  display: flex;
}
.profile-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  padding: 24px 20px;
  padding-top: calc(24px + env(safe-area-inset-top, 0px));
  color: white;
  display: flex;
  align-items: center;
  gap: 16px;
}
.profile-back {
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.profile-header-info {
  flex: 1;
}
.profile-header-title {
  font-size: 20px;
  font-weight: 700;
}
.profile-header-subtitle {
  font-size: 13px;
  opacity: 0.9;
}
.profile-avatar-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 700;
}
.profile-content {
  flex: 1;
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  width: 100%;
}
.profile-section {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px var(--shadow);
}
.profile-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.profile-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.profile-field:last-child {
  border-bottom: none;
}
.profile-field-label {
  font-size: 14px;
  color: var(--text-secondary);
}
.profile-field-value {
  font-size: 14px;
  font-weight: 600;
}
.profile-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.profile-input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.profile-input-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.profile-input-group input {
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  background: var(--bg);
  color: var(--text-primary);
  transition: border-color 0.2s;
}
.profile-input-group input:focus {
  outline: none;
  border-color: #3b82f6;
}
.profile-btn {
  padding: 14px 24px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.profile-btn.primary {
  background: var(--green);
  color: white;
}
.profile-btn.primary:hover {
  background: var(--green-dark);
}
.profile-btn.primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.profile-message {
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 14px;
  display: none;
}
.profile-message.success {
  background: #dcfce7;
  color: #166534;
  display: block;
}
.profile-message.error {
  background: #fee2e2;
  color: #991b1b;
  display: block;
}

/* Reset Password Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 800;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 8px 32px var(--shadow);
}
.modal-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.form-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.form-group input {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text-primary);
}
.form-group input:focus {
  outline: none;
  border-color: var(--green);
}
.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}
.modal-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  touch-action: manipulation;
}
.modal-btn.cancel {
  background: var(--bg);
  color: var(--text-primary);
}
.modal-btn.confirm {
  background: var(--green);
  color: white;
}
.modal-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>
<body>

<!-- Main Header -->
<div class="main-header">
  <div class="main-header-content">
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="main-header-title">
      <h1>Timbratura</h1>
      <p id="currentDate">Caricamento...</p>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="refreshPage()">
      <i class="fas fa-sync-alt"></i>
    </button>
  </div>
</div>

<!-- Side Menu Overlay -->
<div class="side-menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <div class="side-menu-avatar">{{ user_initials }}</div>
    <div class="side-menu-user-info">
      <div class="side-menu-user-name">{{ user_display }}</div>
      <div class="side-menu-user-role">{{ user_role|default('Utente', true) }}</div>
    </div>
  </div>
  
  <div class="side-menu-content">
    <div class="menu-section">
      <div class="menu-section-title">ðŸ“‹ Menu</div>
      <a href="{{ url_for('home') }}" class="menu-item active">
        <span class="icon">ðŸ </span>
        <span>Home Timbrature</span>
      </a>
      <a href="{{ url_for('user_turni_page') }}" class="menu-item">
        <span class="icon">ðŸ“…</span>
        <span>I Miei Turni</span>
      </a>
      <a href="{{ url_for('user_requests_page') }}" class="menu-item">
        <span class="icon">ðŸ“</span>
        <span>Richieste</span>
      </a>
      <a href="{{ url_for('user_documents_page') }}" class="menu-item">
        <span class="icon">ðŸ“„</span>
        <span>Documenti</span>
      </a>
      <a href="/user/notifications" class="menu-item">
        <span class="icon">ðŸ””</span>
        <span>Storico Notifiche</span>
      </a>
      <a href="/user/storico-timbrature" class="menu-item">
        <span class="icon">ðŸ•</span>
        <span>Storico Timbrature</span>
      </a>
      {% if magazzino_enabled %}
      <a href="{{ url_for('magazzino_home') }}" class="menu-item">
        <span class="icon">ðŸ“¦</span>
        <span>Magazzino</span>
      </a>
      {% endif %}
    </div>
    
    <div class="menu-section">
      <div class="menu-section-title">âš™ï¸ Impostazioni</div>
      <div class="menu-item" onclick="openProfilePage()">
        <span class="icon">ðŸ‘¤</span>
        <span>Profilo Utente</span>
      </div>
      <div class="menu-item" onclick="toggleTheme(); closeMenu();">
        <span class="icon">ðŸŒ™</span>
        <span>Tema Scuro</span>
      </div>
      <div class="menu-item" id="pwa-install-menu-item" onclick="installPwa()" style="display: none;">
        <span class="icon">ðŸ“²</span>
        <span>Installa App</span>
      </div>
      <div class="menu-item notification-toggle" id="notificationMenuItem">
        <span class="icon" id="notificationIcon">ðŸ”•</span>
        <span id="notificationLabel">Attiva Notifiche</span>
        <label class="toggle-switch">
          <input type="checkbox" id="pushToggle" onchange="togglePushNotifications()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="menu-section">
      <a href="{{ url_for('logout') }}" class="menu-item danger">
        <span class="icon">ðŸšª</span>
        <span>Logout</span>
      </a>
    </div>
  </div>
  
  {% if company_logo %}
  <div class="side-menu-footer">
    <img src="{{ company_logo }}" alt="Logo Azienda">
  </div>
  {% endif %}
</div>

<!-- Profilo Utente Page -->
<div class="profile-page" id="profilePage">
  <div class="profile-header">
    <button class="profile-back" onclick="closeProfilePage()">â†</button>
    <div class="profile-header-info">
      <div class="profile-header-title">Profilo Utente</div>
      <div class="profile-header-subtitle">Gestisci le tue informazioni</div>
    </div>
    <div class="profile-avatar-large">{{ user_initials }}</div>
  </div>
  
  <div class="profile-content">
    <!-- Info Utente -->
    <div class="profile-section">
      <div class="profile-section-title">ðŸ‘¤ Informazioni Account</div>
      <div class="profile-field">
        <span class="profile-field-label">Username</span>
        <span class="profile-field-value">{{ username }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Nome Visualizzato</span>
        <span class="profile-field-value">{{ user_display }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Ruolo</span>
        <span class="profile-field-value">{{ user_role|default('Utente', true) }}</span>
      </div>
    </div>
    
    <!-- Cambio Password -->
    <div class="profile-section">
      <div class="profile-section-title">ðŸ”‘ Cambia Password</div>
      <div id="passwordMessage" class="profile-message"></div>
      <form class="profile-form" id="profilePasswordForm" onsubmit="submitProfilePasswordChange(event)">
        <div class="profile-input-group">
          <label>Password Attuale</label>
          <input type="password" id="profileCurrentPassword" required autocomplete="current-password" placeholder="Inserisci password attuale">
        </div>
        <div class="profile-input-group">
          <label>Nuova Password</label>
          <input type="password" id="profileNewPassword" required minlength="4" autocomplete="new-password" placeholder="Minimo 4 caratteri">
        </div>
        <div class="profile-input-group">
          <label>Conferma Nuova Password</label>
          <input type="password" id="profileConfirmPassword" required minlength="4" autocomplete="new-password" placeholder="Ripeti nuova password">
        </div>
        <button type="submit" class="profile-btn primary" id="btnProfileSavePassword">Aggiorna Password</button>
      </form>
    </div>
  </div>
</div>

<div class="container">
  <div class="clock-section">
    <div class="clock"><span class="clock-icon">ðŸ•</span><span id="clock">--:--:--</span></div>
  </div>

  <!-- Box Turno Oggi -->
  <div class="turno-box" id="turnoBox" style="display:none;">
    <span class="turno-counter" id="turnoCounter" style="display:none;">1/1</span>
    <button class="turno-info-btn" id="turnoInfoBtn" onclick="openCrewInfoModal()" title="Info squadra" style="display:none;">â„¹</button>
    <div class="turno-nav">
      <button class="turno-nav-btn" id="turnoPrevBtn" onclick="navigateTurno(-1)" style="display:none;">â€¹</button>
      <div class="turno-content">
        <div class="turno-project" id="turnoProject">-</div>
        <!-- Riga badge pausa e note -->
        <div class="turno-badges-row" id="turnoBadgesRow" style="display:none;">
          <span class="turno-badge-item turno-badge-pausa" id="turnoBadgePausa" style="display:none;">
            â¸ï¸ Pausa <span id="turnoBadgePausaText">30min</span>
          </span>
          <span class="turno-badge-item turno-badge-note" id="turnoBadgeNote" onclick="showTurnoNotes()" style="display:none;">
            ðŸ“ Note
          </span>
        </div>
        <div class="turno-details">
          <!-- Orario -->
          <div class="turno-detail turno-detail-row" id="turnoOrarioRow">
            <span id="turnoProjectCode" style="font-weight:700; font-size:11px; background:rgba(255,255,255,0.25); padding:2px 6px; border-radius:6px; margin-right:14px; display:none;"></span>
            <span class="icon">ðŸ•</span>
            <span id="turnoOrarioText" style="font-weight:600;">-</span>
          </div>
          
          <!-- Funzione -->
          <div class="turno-detail" id="turnoFunzioneRow">
            <span class="icon">ðŸ‘¤</span>
            <span id="turnoFunzioneText" style="font-weight:600; flex:1;">-</span>
          </div>
          
          <!-- Location -->
          <div class="turno-detail turno-timbratura" id="turnoTimbratura" style="display:none;">
            <span class="icon">ðŸ“</span>
            <span id="turnoTimbraturaText" style="font-weight:600; flex:1;">-</span>
          </div>
        </div>
        <span class="turno-badge" id="turnoBadge" style="display:none;"></span>
      </div>
      <button class="turno-nav-btn" id="turnoNextBtn" onclick="navigateTurno(1)" style="display:none;">â€º</button>
    </div>
  </div>

  <div class="actions">
    <button class="action-btn start" id="btnStartDay" onclick="startTimbratura('inizio_giornata')">
      <span class="icon" id="iconStart">â†’</span>
      <span id="labelStart">Inizio Giornata</span>
      <span class="check" id="checkStart"></span>
    </button>
    
    <div class="pause-row">
      <button class="pause-btn" id="btnStartPause" onclick="startTimbratura('inizio_pausa')">
        <span class="icon">â˜•</span>
        <span>Inizio Pausa</span>
      </button>
      <button class="pause-btn" id="btnEndPause" onclick="startTimbratura('fine_pausa')">
        <span class="icon">âœ“</span>
        <span>Fine Pausa</span>
      </button>
    </div>
    
    <button class="action-btn end" id="btnEndDay" onclick="startTimbratura('fine_giornata')">
      <span class="icon">â†</span>
      <span>Fine Giornata</span>
      <span class="check" id="checkEnd"></span>
    </button>
  </div>

  <div class="history-spacer"></div>
</div>

<div class="history-section" id="historySection">
  <button class="history-toggle" onclick="toggleHistory()">
    ðŸ“‹ Storico Timbrature Oggi
    <span class="history-arrow">â–²</span>
  </button>
  <div class="history-content">
    <ul class="history-list" id="historyList">
      <li class="empty-history">Nessuna timbratura registrata</li>
    </ul>
  </div>
</div>

<!-- Switch Activity Modal -->
<div class="switch-activity-overlay" id="switchActivityOverlay" onclick="closeSwitchActivityModal(event)">
  <div class="switch-activity-modal" onclick="event.stopPropagation()">
    <div class="switch-activity-header">
      <h3>ðŸ”„ Cambia AttivitÃ </h3>
      <button class="switch-activity-close" onclick="closeSwitchActivityModal()">âœ•</button>
    </div>
    <div class="switch-activity-body" id="switchActivityBody">
      <div class="crew-info-loading">Caricamento...</div>
    </div>
  </div>
</div>

<!-- Numpad Cambio Progetto -->
<div class="numpad-overlay" id="numpadOverlay" onclick="closeNumpad(event)">
  <div class="numpad-modal" onclick="event.stopPropagation()">
    <div class="numpad-header">
      <h3>ðŸ”¢ Numero Progetto</h3>
      <button class="switch-activity-close" onclick="closeNumpad()">âœ•</button>
    </div>
    <div class="numpad-display">
      <input type="text" id="numpadInput" readonly placeholder="---" maxlength="10">
    </div>
    <div class="numpad-result" id="numpadResult"></div>
    <div class="numpad-grid">
      <div class="numpad-btn" onclick="numpadPress('1')">1</div>
      <div class="numpad-btn" onclick="numpadPress('2')">2</div>
      <div class="numpad-btn" onclick="numpadPress('3')">3</div>
      <div class="numpad-btn" onclick="numpadPress('4')">4</div>
      <div class="numpad-btn" onclick="numpadPress('5')">5</div>
      <div class="numpad-btn" onclick="numpadPress('6')">6</div>
      <div class="numpad-btn" onclick="numpadPress('7')">7</div>
      <div class="numpad-btn" onclick="numpadPress('8')">8</div>
      <div class="numpad-btn" onclick="numpadPress('9')">9</div>
      <div class="numpad-btn del" onclick="numpadDelete()">âŒ«</div>
      <div class="numpad-btn" onclick="numpadPress('0')">0</div>
      <div class="numpad-btn del" onclick="numpadClear()">C</div>
    </div>
    <div class="numpad-actions">
      <button onclick="closeNumpad()" style="background:#f1f5f9;color:#666 !important;">Annulla</button>
      <button id="numpadConfirmBtn" onclick="numpadConfirm()" style="background:#3b82f6;color:#fff !important;" disabled>Conferma</button>
    </div>
  </div>
</div>

<!-- Popup Note Obbligatorie per attivitÃ  Altro -->
<div class="notes-overlay" id="notesOverlay" onclick="closeNotesPopup(event)">
  <div class="notes-modal" onclick="event.stopPropagation()">
    <div class="notes-header">
      <h3>ðŸ“ Note Obbligatorie</h3>
      <button class="switch-activity-close" onclick="closeNotesPopup()">âœ•</button>
    </div>
    <div class="notes-body">
      <p style="font-size:13px;color:#555;margin:0 0 10px;">Per l'attivitÃ  <strong>"Altro"</strong> Ã¨ necessario specificare cosa si sta facendo.</p>
      <textarea id="notesTextarea" placeholder="Descrivi l'attivitÃ ..." maxlength="500"></textarea>
      <div class="notes-hint">Minimo 3 caratteri</div>
      <div class="notes-error" id="notesError">âš ï¸ Inserisci una descrizione dell'attivitÃ </div>
    </div>
    <div class="notes-actions">
      <button onclick="closeNotesPopup()" style="background:#f1f5f9;color:#666 !important;">Annulla</button>
      <button id="notesConfirmBtn" onclick="confirmNotesAndProceed()" style="background:#f59e0b;color:#fff !important;">Conferma e Avvia</button>
    </div>
  </div>
</div>

<!-- Crew Info Modal -->
<div class="crew-info-overlay" id="crewInfoOverlay" onclick="closeCrewInfoModal(event)">
  <div class="crew-info-modal" onclick="event.stopPropagation()">
    <div class="crew-info-header">
      <h3 id="crewInfoTitle">â„¹ï¸ Info Turno</h3>
      <button class="crew-info-close" onclick="closeCrewInfoModal()">âœ•</button>
    </div>
    <div class="crew-info-body" id="crewInfoBody">
      <div class="crew-info-loading">Caricamento...</div>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-container">
    <h2 class="scanner-title" id="scannerTitle">ðŸ“· Inquadra il QR Code</h2>
    <p class="scanner-subtitle" id="scannerSubtitle">Scansiona per confermare</p>
    <div id="qr-reader"></div>
    <button class="scanner-close" onclick="closeScanner()">Annulla</button>
  </div>
</div>

<!-- Method Choice Modal -->
<div class="method-modal" id="methodModal">
  <div class="method-container">
    <h2 class="method-title" id="methodTitle">Come vuoi confermare?</h2>
    <p class="method-subtitle" id="methodSubtitle">Scegli il metodo di timbratura</p>
    <div class="method-options">
      <button class="method-btn" id="methodQrBtn" onclick="selectMethod('qr')">
        <div class="method-btn-icon">ðŸ“·</div>
        <div class="method-btn-content">
          <div class="method-btn-title">QR Code</div>
          <div class="method-btn-desc">Scansiona il codice in sede</div>
        </div>
      </button>
      <button class="method-btn" id="methodGpsBtn" onclick="selectMethod('gps')">
        <div class="method-btn-icon">ðŸ“</div>
        <div class="method-btn-content">
          <div class="method-btn-title">Posizione GPS</div>
          <div class="method-btn-desc">Conferma con geolocalizzazione</div>
        </div>
      </button>
    </div>
    <button class="method-cancel" onclick="closeMethodModal()">Annulla</button>
  </div>
</div>

<!-- GPS Modal -->
<div class="gps-modal" id="gpsModal">
  <div class="gps-container">
    <h2 class="gps-title" id="gpsTitle">ðŸ“ Verifica Posizione</h2>
    <p class="gps-subtitle" id="gpsSubtitle">Attendere la localizzazione...</p>
    <div class="gps-location-name" id="gpsLocationName"></div>
    <div class="gps-status" id="gpsStatus">
      <div class="gps-icon loading" id="gpsIcon">ðŸ“</div>
      <div class="gps-message" id="gpsMessage">Rilevamento posizione...</div>
      <div class="gps-accuracy" id="gpsAccuracy"></div>
    </div>
    <div class="gps-buttons">
      <button class="gps-btn secondary" onclick="closeGpsModal()">Annulla</button>
      <button class="gps-btn primary" id="gpsConfirmBtn" onclick="confirmGpsLocation()" disabled>Conferma</button>
    </div>
  </div>
</div>

<!-- Note Turno Modal -->
<div class="note-modal" id="noteModal">
  <div class="note-container">
    <h2 class="note-title">ðŸ“ Note sul Turno</h2>
    <div id="noteRemark" class="note-section" style="display:none;">
      <div class="note-section-label">ðŸ“‹ Note progetto</div>
      <div class="note-section-text" id="noteRemarkText"></div>
    </div>
    <div id="notePlanner" class="note-section" style="display:none;">
      <div class="note-section-label">ðŸ‘¤ Note pianificatore</div>
      <div class="note-section-text" id="notePlannerText"></div>
    </div>
    <div id="noteEmpty" class="note-section" style="display:none;">
      <div class="note-section-text" style="text-align:center; color: rgba(255,255,255,0.5);">Nessuna nota disponibile</div>
    </div>
    <button class="note-close" onclick="closeNoteModal()">Chiudi</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const TIMBRATURA_TYPES = {
  'inizio_giornata': { label: 'Inizio Giornata', dotClass: 'start' },
  'fine_giornata': { label: 'Fine Giornata', dotClass: 'end' },
  'inizio_pausa': { label: 'Inizio Pausa', dotClass: 'pause' },
  'fine_pausa': { label: 'Fine Pausa', dotClass: 'pause' }
};

let todayTimbrature = [];
let pendingOvertime = null;  // Straordinario in attesa di revisione
let html5QrcodeScanner = null;
let pendingTimbraturaType = null;  // Tipo di timbratura in attesa di conferma QR
let currentTurnoNotes = { note: null, note_planner: null };  // Note del turno corrente

// Funzioni per Note Turno
function showTurnoNotes() {
  const modal = document.getElementById('noteModal');
  const remarkSection = document.getElementById('noteRemark');
  const plannerSection = document.getElementById('notePlanner');
  const emptySection = document.getElementById('noteEmpty');
  const remarkText = document.getElementById('noteRemarkText');
  const plannerText = document.getElementById('notePlannerText');
  
  // Resetta
  remarkSection.style.display = 'none';
  plannerSection.style.display = 'none';
  emptySection.style.display = 'none';
  
  let hasNotes = false;
  
  if (currentTurnoNotes.note) {
    remarkText.textContent = currentTurnoNotes.note;
    remarkSection.style.display = 'block';
    hasNotes = true;
  }
  
  if (currentTurnoNotes.note_planner) {
    plannerText.textContent = currentTurnoNotes.note_planner;
    plannerSection.style.display = 'block';
    hasNotes = true;
  }
  
  if (!hasNotes) {
    emptySection.style.display = 'block';
  }
  
  modal.classList.add('open');
}

function closeNoteModal() {
  document.getElementById('noteModal').classList.remove('open');
}

// Toggle storico timbrature
function toggleHistory() {
  document.getElementById('historySection').classList.toggle('open');
}

// Aggiorna orologio
function updateClock() {
  const now = new Date();
  const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('clock').textContent = time;
}

// Aggiorna data
function updateDate() {
  const now = new Date();
  const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
  let dateStr = now.toLocaleDateString('it-IT', options);
  dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
  document.getElementById('currentDate').textContent = 'Oggi: ' + dateStr;
}

// Toast notification
let toastTimer = null;
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  if (toastTimer) clearTimeout(toastTimer);
  toast.textContent = message;
  toast.className = 'toast ' + type + ' show';
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    toastTimer = null;
  }, 2000);
}

// Configurazione timbratura (caricata dal server)
let timbraturaConfig = {
  qr_enabled: true,
  gps_enabled: false,
  gps_locations: [],
  gps_max_accuracy_meters: 50
};

// Stato GPS
let gpsWatchId = null;
let lastGpsPosition = null;

// Carica configurazione timbratura dal server
async function loadTimbraturaConfig() {
  try {
    const res = await fetch('/api/timbratura/config');
    if (res.ok) {
      timbraturaConfig = await res.json();
      console.log('Timbratura config loaded:', timbraturaConfig);
    }
  } catch (err) {
    console.warn('Errore caricamento config timbratura:', err);
  }
}

// Inizia processo timbratura: sceglie metodo o apre direttamente
function startTimbratura(tipo) {
  pendingTimbraturaType = tipo;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  // Se NESSUN metodo Ã¨ abilitato (entrambi disabilitati), timbratura diretta
  if (!timbraturaConfig.qr_enabled && !timbraturaConfig.gps_enabled) {
    registerTimbraturaDirectly(tipo);
    return;
  }
  
  // Se entrambi i metodi sono abilitati, mostra la scelta
  if (timbraturaConfig.qr_enabled && timbraturaConfig.gps_enabled) {
    openMethodModal(label);
    return;
  }
  
  // Se solo GPS Ã¨ abilitato
  if (timbraturaConfig.gps_enabled && !timbraturaConfig.qr_enabled) {
    openGpsModal(label);
    return;
  }
  
  // Se solo QR Ã¨ abilitato
  document.getElementById('scannerTitle').textContent = 'ðŸ“· ' + label;
  document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
  openScanner();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// METHOD CHOICE MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openMethodModal(label) {
  document.getElementById('methodTitle').textContent = label;
  document.getElementById('methodSubtitle').textContent = 'Come vuoi confermare la timbratura?';
  
  // Abilita/disabilita pulsanti in base alla config
  document.getElementById('methodQrBtn').style.display = timbraturaConfig.qr_enabled ? 'flex' : 'none';
  document.getElementById('methodGpsBtn').style.display = timbraturaConfig.gps_enabled ? 'flex' : 'none';
  
  document.getElementById('methodModal').classList.add('active');
}

function closeMethodModal() {
  document.getElementById('methodModal').classList.remove('active');
  pendingTimbraturaType = null;  // Reset solo quando l'utente annulla
}

function selectMethod(method) {
  // Salva il tipo PRIMA di chiudere il modal
  const tipo = pendingTimbraturaType;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  // Chiudi solo il modal visivamente
  document.getElementById('methodModal').classList.remove('active');
  
  if (method === 'qr') {
    document.getElementById('scannerTitle').textContent = 'ðŸ“· ' + label;
    document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
    openScanner();
  } else if (method === 'gps') {
    openGpsModal(label);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openGpsModal(label) {
  document.getElementById('gpsTitle').textContent = 'ðŸ“ ' + label;
  document.getElementById('gpsSubtitle').textContent = 'Avvicinati alla sede per timbrare';
  
  // Mostra la sede specifica del turno se presente, altrimenti tutte le location
  let locationNames;
  // Usa currentShiftGpsData se ha dati GPS configurati, altrimenti currentShiftLocationName
  if (currentShiftGpsData && currentShiftGpsData.location) {
    locationNames = currentShiftGpsData.location;
  } else if (currentShiftLocationName) {
    locationNames = currentShiftLocationName;
  } else {
    locationNames = timbraturaConfig.gps_locations.map(l => l.name).join(', ') || 'Sede';
  }
  document.getElementById('gpsLocationName').innerHTML = `<span class="location-label">ðŸ¢</span> <strong>${locationNames}</strong>`;
  
  document.getElementById('gpsIcon').textContent = 'ðŸ“';
  document.getElementById('gpsIcon').classList.add('loading');
  document.getElementById('gpsMessage').textContent = 'Rilevamento posizione...';
  document.getElementById('gpsAccuracy').textContent = '';
  document.getElementById('gpsAccuracy').className = 'gps-accuracy';
  document.getElementById('gpsConfirmBtn').disabled = true;
  
  lastGpsPosition = null;
  
  document.getElementById('gpsModal').classList.add('active');
  
  // Inizia il tracking GPS
  startGpsTracking();
}

function closeGpsModal() {
  document.getElementById('gpsModal').classList.remove('active');
  stopGpsTracking();
  pendingTimbraturaType = null;
  lastGpsPosition = null;
}

function startGpsTracking() {
  if (!navigator.geolocation) {
    updateGpsStatus('error', 'âŒ GPS non supportato', 'Il tuo browser non supporta la geolocalizzazione');
    return;
  }
  
  const options = {
    enableHighAccuracy: true,
    timeout: 15000,
    maximumAge: 0
  };
  
  gpsWatchId = navigator.geolocation.watchPosition(
    onGpsSuccess,
    onGpsError,
    options
  );
}

function stopGpsTracking() {
  if (gpsWatchId !== null) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
}

function onGpsSuccess(position) {
  const { latitude, longitude, accuracy } = position.coords;
  lastGpsPosition = { latitude, longitude, accuracy };
  
  // Calcola distanza dalla sede piÃ¹ vicina
  // Se il turno ha una sede specifica, usa solo quella
  let minDistance = Infinity;
  let nearestLocation = null;
  let locations = timbraturaConfig.gps_locations || [];
  
  // PrioritÃ  1: Usa le coordinate dal turno Rentman (currentShiftGpsData)
  if (currentShiftGpsData && currentShiftGpsData.lat && currentShiftGpsData.lon) {
    // Crea una location temporanea con le coordinate del turno
    locations = [{
      name: currentShiftGpsData.location || 'Sede',
      latitude: parseFloat(currentShiftGpsData.lat),
      longitude: parseFloat(currentShiftGpsData.lon),
      radius_meters: currentShiftGpsData.radius || 300
    }];
  }
  // PrioritÃ  2: Filtra per sede specifica del turno se presente nelle gps_locations
  else if (currentShiftLocationName && locations.length > 0) {
    const filteredLocations = locations.filter(l => l.name === currentShiftLocationName);
    if (filteredLocations.length > 0) {
      locations = filteredLocations;
    }
  }
  
  for (const loc of locations) {
    if (loc.latitude && loc.longitude) {
      const dist = haversineDistance(latitude, longitude, loc.latitude, loc.longitude);
      if (dist < minDistance) {
        minDistance = dist;
        nearestLocation = loc;
      }
    }
  }
  
  // Determina qualitÃ  del segnale
  let accuracyClass = 'poor';
  let accuracyText = 'Precisione bassa';
  let accuracyTip = 'ðŸ’¡ Vai all\'aperto per migliorare';
  
  if (accuracy <= 15) {
    accuracyClass = 'good';
    accuracyText = 'Precisione ottima';
    accuracyTip = '';
  } else if (accuracy <= 30) {
    accuracyClass = 'good';
    accuracyText = 'Precisione buona';
    accuracyTip = '';
  } else if (accuracy <= timbraturaConfig.gps_max_accuracy_meters) {
    accuracyClass = 'medium';
    accuracyText = 'Precisione sufficiente';
    accuracyTip = '';
  }
  
  const isAccuracyOk = accuracy <= timbraturaConfig.gps_max_accuracy_meters;
  
  // Verifica anche la distanza dalla sede
  const maxRadius = nearestLocation ? (nearestLocation.radius_meters || 300) : 300;
  const isDistanceOk = minDistance <= (maxRadius + accuracy); // considera l'accuracy come margine
  const isValid = isAccuracyOk && isDistanceOk;
  
  document.getElementById('gpsIcon').textContent = isValid ? 'âœ…' : (isAccuracyOk ? 'âš ï¸' : 'ðŸ“');
  document.getElementById('gpsIcon').classList.toggle('loading', !isAccuracyOk);
  
  // Messaggio in base allo stato
  if (!isAccuracyOk) {
    document.getElementById('gpsMessage').textContent = 'In attesa di precisione migliore...';
  } else if (!isDistanceOk) {
    document.getElementById('gpsMessage').textContent = 'âš ï¸ Troppo lontano dalla sede';
  } else {
    document.getElementById('gpsMessage').textContent = 'Posizione rilevata!';
  }
  
  // Mostra precisione E distanza
  let accuracyDisplay = `${accuracyText} (Â±${Math.round(accuracy)}m)`;
  if (nearestLocation && minDistance !== Infinity) {
    const distText = minDistance >= 1000 
      ? `${(minDistance/1000).toFixed(1)} km` 
      : `${Math.round(minDistance)} m`;
    const distColor = isDistanceOk ? 'var(--success)' : 'var(--danger, #dc3545)';
    accuracyDisplay += `<br><span style="color: ${distColor}">ðŸ“ Distanza dalla sede: <strong>${distText}</strong></span>`;
    if (!isDistanceOk) {
      accuracyDisplay += `<br><span class="gps-tip">âš ï¸ Devi essere entro ${maxRadius}m dalla sede</span>`;
    }
  }
  if (accuracyTip) {
    accuracyDisplay += `<br><span class="gps-tip">${accuracyTip}</span>`;
  }
  document.getElementById('gpsAccuracy').innerHTML = accuracyDisplay;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy ' + (isValid ? accuracyClass : 'poor');
  document.getElementById('gpsConfirmBtn').disabled = !isAccuracyOk; // Permetti conferma, il server farÃ  la validazione finale
  
  if (isAccuracyOk) {
    document.getElementById('gpsSubtitle').textContent = isDistanceOk 
      ? 'Premi Conferma per timbrare' 
      : 'Avvicinati alla sede per timbrare';
  }
}

// Funzione per calcolare la distanza tra due coordinate (formula di Haversine)
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000; // Raggio della Terra in metri
  const phi1 = lat1 * Math.PI / 180;
  const phi2 = lat2 * Math.PI / 180;
  const deltaPhi = (lat2 - lat1) * Math.PI / 180;
  const deltaLambda = (lon2 - lon1) * Math.PI / 180;
  
  const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  
  return R * c;
}

function onGpsError(error) {
  let message = 'Errore GPS';
  let detail = '';
  
  switch(error.code) {
    case error.PERMISSION_DENIED:
      message = 'âš ï¸ Permesso negato';
      detail = 'Abilita la posizione nelle impostazioni';
      break;
    case error.POSITION_UNAVAILABLE:
      message = 'âš ï¸ Posizione non disponibile';
      detail = 'Prova all\'aperto o attendi';
      break;
    case error.TIMEOUT:
      message = 'âš ï¸ Timeout';
      detail = 'Rilevamento troppo lento';
      break;
  }
  
  updateGpsStatus('error', message, detail);
}

function updateGpsStatus(type, message, detail) {
  document.getElementById('gpsIcon').textContent = type === 'error' ? 'âš ï¸' : 'ðŸ“';
  document.getElementById('gpsIcon').classList.remove('loading');
  document.getElementById('gpsMessage').textContent = message;
  document.getElementById('gpsAccuracy').textContent = detail;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy poor';
  document.getElementById('gpsConfirmBtn').disabled = true;
}

async function confirmGpsLocation() {
  if (!lastGpsPosition) {
    showToast('Posizione non disponibile', 'error');
    return;
  }
  
  const tipo = pendingTimbraturaType;
  const confirmBtn = document.getElementById('gpsConfirmBtn');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Verifica...';
  
  // Se offline, salva la timbratura con coordinate per sincronizzarla dopo
  if (!navigator.onLine) {
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con coordinate GPS. VerrÃ  sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
    return;
  }
  
  try {
    // Valida posizione con il server
    // Se il turno ha una sede specifica, passa il nome per validazione mirata
    const validatePayload = {
      latitude: lastGpsPosition.latitude,
      longitude: lastGpsPosition.longitude,
      accuracy: lastGpsPosition.accuracy
    };
    if (currentShiftLocationName) {
      validatePayload.shift_location_name = currentShiftLocationName;
    }
    // Invia anche le coordinate della sede per il fallback
    if (currentShiftGpsData && currentShiftGpsData.lat && currentShiftGpsData.lon) {
      validatePayload.shift_location_lat = currentShiftGpsData.lat;
      validatePayload.shift_location_lon = currentShiftGpsData.lon;
    }
    
    console.log("ðŸ”µ GPU Validate - currentShiftLocationName:", currentShiftLocationName);
    console.log("ðŸ”µ GPS Validate Payload:", validatePayload);
    console.log("ðŸ”µ currentShiftGpsData:", currentShiftGpsData);
    
    const validateRes = await fetch('/api/timbratura/validate-gps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(validatePayload)
    });
    
    const validateData = await validateRes.json();
    
    console.log("GPS Validate Response:", validateData);
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'Posizione non valida', 'error');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Conferma';
      return;
    }
    
    closeGpsModal();
    
    // GPS valido, registra timbratura
    const token = validateData.token;
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, token })
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      const locationName = validateData.location || 'Sede';
      showToast(`${TIMBRATURA_TYPES[tipo]?.label} registrata (${locationName})! âœ“`, 'success');
      
      // ðŸ§ª TEST PAYLOAD POPUP - Mostra URL CedolinoWeb
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo);
      }
      
      loadTimbrature();
      
      // Se Ã¨ stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
      }
      // Se Ã¨ stato rilevato Fuori FlessibilitÃ , mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se Ã¨ stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se Ã¨ stata rilevata un'attivitÃ  di produzione da avviare
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          _pendingProductionActivity = data.production_activity;
        } else {
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': 'â¸ï¸ AttivitÃ  in pausa',
          'resumed': 'â–¶ï¸ AttivitÃ  ripresa',
          'stopped': 'â¹ï¸ AttivitÃ  terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
      // Mostra anche l'URL di debug in caso di errore
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo, data.error);
      }
    }
  } catch (err) {
    console.error('Errore GPS:', err);
    // Fallback offline
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR SCANNER (esistente)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Registra timbratura direttamente (modalitÃ  diretta o offline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEST PAYLOAD - Imposta a true per vedere popup con payload CedolinoWeb
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TEST_PAYLOAD_POPUP = false;  // <-- Cambia a true per attivare

async function registerTimbraturaDirectly(tipo) {
  try {
    const payload = { tipo, bypass_qr: true, offline_ts: Date.now() };
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! âœ“', 'success');
      
      // ðŸ§ª TEST PAYLOAD POPUP - Mostra URL CedolinoWeb
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo);
      }
      
      loadTimbrature();
      
      // Se Ã¨ stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
      }
      // Se Ã¨ stato rilevato Fuori FlessibilitÃ , mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se Ã¨ stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se Ã¨ stata rilevata un'attivitÃ  di produzione da avviare (mostrato SEMPRE, anche con altri popup)
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          // Se c'Ã¨ anche il ritardo, salva l'attivitÃ  e mostrala dopo chiusura popup ritardo
          _pendingProductionActivity = data.production_activity;
        } else {
          // Delay maggiore se ci sono altri popup
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': 'â¸ï¸ AttivitÃ  in pausa',
          'resumed': 'â–¶ï¸ AttivitÃ  ripresa',
          'stopped': 'â¹ï¸ AttivitÃ  terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
      // Mostra anche l'URL di debug in caso di errore
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo, data.error);
      }
    }
  } catch (err) {
    console.error('Errore:', err);
    
    // Se offline, il Service Worker metterÃ  in coda la richiesta
    if (!navigator.onLine) {
      showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
      // Salva anche in localStorage come backup
      saveOfflineTimbratura(tipo);
    } else {
      showToast('Errore di connessione', 'error');
    }
  }
  pendingTimbraturaType = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP ATTIVITÃ€ PRODUZIONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showProductionActivityPopup(activity) {
  const timbraturaTs = activity.timbratura_ts || Date.now();
  
  // Prendi progetto e attivitÃ  dal turno visualizzato sulla home (prioritario)
  const turno = allTurni[currentTurnoIndex] || {};
  const projectCode = turno.project_code || activity.project_code || '';
  const projectName = turno.project_name || activity.project_name || projectCode;
  const activityLabel = turno.function || activity.activity_label || 'AttivitÃ ';
  
  // Lista attivitÃ  predefinite magazzino
  const ACTIVITIES = [
    { code: 'Preparazione', icon: 'ðŸ“¦', label: 'Preparazione' },
    { code: 'Carico', icon: 'ðŸšš', label: 'Carico' },
    { code: 'Scarico', icon: 'ðŸ“¥', label: 'Scarico' },
    { code: 'Controllo', icon: 'ðŸ”', label: 'Controllo' },
    { code: 'Pulizia', icon: 'ðŸ§¹', label: 'Pulizia' },
    { code: 'Verifica', icon: 'âœ…', label: 'Verifica' },
    { code: 'Manutenzione', icon: 'ðŸ”§', label: 'Manutenzione' },
    { code: 'Altro', icon: 'ðŸ“', label: 'Altro' }
  ];
  
  let listHtml = '<div id="productionActivityGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;display:none;">';
  ACTIVITIES.forEach(a => {
    listHtml += `
      <div onclick="confirmStartProductionActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(a.code)}', ${timbraturaTs})"
           style="background:var(--bg);border:2px solid var(--border);border-radius:14px;padding:16px 10px;cursor:pointer;transition:all 0.2s;text-align:center;"
           onmouseover="this.style.borderColor='var(--brand)';this.style.background='#e3f2fd';this.style.transform='scale(1.03)'"
           onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)';this.style.transform='scale(1)'">
        <div style="font-size:32px;margin-bottom:6px;">${a.icon}</div>
        <div style="font-weight:600;font-size:13px;color:var(--text-primary);">${escapeHtml(a.label)}</div>
      </div>`;
  });
  listHtml += '</div>';
  
  const html = `
    <div id="productionActivityPopup" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:var(--bg-card);color:var(--text-primary);padding:24px;border-radius:16px;max-width:400px;width:100%;box-shadow:var(--shadow-lg);max-height:85vh;overflow-y:auto;">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;margin-bottom:12px;">ðŸ­</div>
          <h3 style="margin:0 0 8px;font-size:18px;font-weight:600;" id="productionPopupTitle">Avviare attivitÃ ?</h3>
          <p style="margin:0;color:var(--text-secondary);font-size:14px;" id="productionPopupSubtitle">Stai iniziando la giornata su un turno di produzione.</p>
        </div>
        
        <div id="productionDefaultView">
          <div style="background:var(--bg);padding:16px;border-radius:12px;margin-bottom:20px;">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">PROGETTO</div>
            <div style="font-weight:600;font-size:15px;margin-bottom:12px;">${escapeHtml(projectName)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">MANSIONE</div>
            <div style="font-weight:600;font-size:15px;color:var(--brand);">${escapeHtml(activityLabel)}</div>
          </div>
          
          <p style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;text-align:center;">
            Vuoi avviare automaticamente il timer per questa attivitÃ ?
          </p>
          
          <div style="display:flex;gap:12px;">
            <button onclick="showProductionActivityGrid()" style="flex:1;padding:14px;background:var(--bg);color:var(--brand);border:2px solid var(--brand);border-radius:10px;font-weight:600;cursor:pointer;">
              ðŸ”„ Cambia AttivitÃ 
            </button>
            <button onclick="confirmStartProductionActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(activityLabel)}', ${timbraturaTs})" style="flex:1;padding:14px;background:var(--green);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">
              Avvia â–¶ï¸
            </button>
          </div>
        </div>
        
        ${listHtml}
        
        <button onclick="hideProductionActivityGrid()" style="width:100%;margin-top:14px;padding:12px;background:var(--bg);color:var(--text-secondary);border:1px solid var(--border);border-radius:10px;font-weight:600;cursor:pointer;display:none;" id="productionBackBtn">
          â† Indietro
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', html);
}

function showProductionActivityGrid() {
  document.getElementById('productionDefaultView').style.display = 'none';
  document.getElementById('productionActivityGrid').style.display = 'grid';
  document.getElementById('productionBackBtn').style.display = 'block';
  document.getElementById('productionPopupTitle').textContent = 'Seleziona attivitÃ ';
  document.getElementById('productionPopupSubtitle').textContent = 'Scegli l\'attivitÃ  da avviare.';
}

function hideProductionActivityGrid() {
  document.getElementById('productionDefaultView').style.display = '';
  document.getElementById('productionActivityGrid').style.display = 'none';
  document.getElementById('productionBackBtn').style.display = 'none';
  document.getElementById('productionPopupTitle').textContent = 'Avviare attivitÃ ?';
  document.getElementById('productionPopupSubtitle').textContent = 'Stai iniziando la giornata su un turno di produzione.';
}

function dismissProductionActivityPopup() {
  const popup = document.getElementById('productionActivityPopup');
  if (popup) popup.remove();
}

// --- Gestione note obbligatorie per attivitÃ  "Altro" ---
let _pendingNotesCallback = null;

function openNotesPopup(callback) {
  _pendingNotesCallback = callback;
  const overlay = document.getElementById('notesOverlay');
  const textarea = document.getElementById('notesTextarea');
  const errorEl = document.getElementById('notesError');
  textarea.value = '';
  textarea.classList.remove('error');
  errorEl.style.display = 'none';
  overlay.classList.add('active');
  setTimeout(() => textarea.focus(), 200);
}

function closeNotesPopup(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('notesOverlay').classList.remove('active');
  _pendingNotesCallback = null;
}

function confirmNotesAndProceed() {
  const textarea = document.getElementById('notesTextarea');
  const errorEl = document.getElementById('notesError');
  const notes = (textarea.value || '').trim();
  
  if (notes.length < 3) {
    textarea.classList.add('error');
    errorEl.style.display = 'block';
    textarea.focus();
    return;
  }
  
  // Chiudi popup e chiama il callback con le note
  document.getElementById('notesOverlay').classList.remove('active');
  if (_pendingNotesCallback) {
    _pendingNotesCallback(notes);
    _pendingNotesCallback = null;
  }
}

async function confirmStartProductionActivity(projectCode, projectName, activityLabel, startTs) {
  // Se attivitÃ  Ã¨ "Altro" e non abbiamo note, chiedi prima le note
  if (activityLabel.toLowerCase() === 'altro') {
    // Non chiudiamo il popup originale ancora - mostriamo il notes popup sopra
    openNotesPopup(async (notes) => {
      dismissProductionActivityPopup();
      await _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, notes);
    });
    return;
  }
  
  dismissProductionActivityPopup();
  await _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, null);
}

async function _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, notes) {
  console.log('[ProductionActivity] Avvio timer con:', { projectCode, projectName, activityLabel, startTs, notes });
  
  try {
    const payload = {
      project_code: projectCode,
      project_name: projectName,
      activity_label: activityLabel,
      start_ts: startTs
    };
    if (notes) payload.notes = notes;
    
    const res = await fetch('/api/production/timer/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    console.log('[ProductionActivity] Risposta server:', data);
    
    if (res.ok && data.ok) {
      showToast('â–¶ï¸ AttivitÃ  avviata: ' + activityLabel, 'success');
    } else {
      showToast(data.error || 'Errore avvio attivitÃ ', 'error');
    }
  } catch (err) {
    console.error('Errore avvio attivitÃ :', err);
    showToast('Errore di connessione', 'error');
  }
}

// Helper per escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// ðŸ§ª TEST PAYLOAD - Mostra popup con dettagli CedolinoWeb
function showTestPayloadPopup(url, tipo, error = null) {
  // Parsa i parametri dall'URL
  const params = new URL(url).searchParams;
  let html = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="this.remove()">
      <div style="background:#1e1e1e;color:#fff;padding:20px;border-radius:12px;max-width:95%;max-height:90vh;overflow:auto;font-family:monospace;font-size:12px;" onclick="event.stopPropagation()">
        <h3 style="color:#4fc3f7;margin:0 0 15px;">ðŸ§ª TEST PAYLOAD CEDOLINO</h3>
        <div style="color:#aaa;margin-bottom:10px;">Tipo: <strong style="color:#fff;">${tipo}</strong></div>
        ${error ? `<div style="color:#ff5252;margin-bottom:15px;">âš ï¸ Errore: ${error}</div>` : ''}
        <table style="width:100%;border-collapse:collapse;">
          <tr style="border-bottom:1px solid #333;">
            <th style="text-align:left;padding:8px;color:#81c784;">Parametro</th>
            <th style="text-align:left;padding:8px;color:#81c784;">Valore</th>
          </tr>
  `;
  
  for (const [key, value] of params) {
    const isNull = value === 'NULL' || value === '' || value === 'N/A';
    html += `
      <tr style="border-bottom:1px solid #333;">
        <td style="padding:8px;color:#fff;">${key}</td>
        <td style="padding:8px;color:${isNull ? '#ff9800' : '#4fc3f7'};">${value || '(vuoto)'}</td>
      </tr>
    `;
  }
  
  html += `
        </table>
        <div style="margin-top:15px;padding:10px;background:#2d2d2d;border-radius:6px;word-break:break-all;font-size:10px;color:#888;">
          <strong>URL completo:</strong><br>${url}
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#4fc3f7;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">
          CHIUDI
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', html);
}

// Salva timbratura offline in localStorage come backup
function saveOfflineTimbratura(tipo, extra = {}) {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  offlineQueue.push({
    tipo,
    timestamp: new Date().toISOString(),
    ts: Date.now(),
    ...extra
  });
  localStorage.setItem('offline_timbrature', JSON.stringify(offlineQueue));
  updateUI(); // Aggiorna subito lo storico per mostrare la timbratura offline
}

// Sincronizza timbrature offline
async function syncOfflineTimbrature() {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  if (offlineQueue.length === 0) return;
  
  console.log('[Offline Sync] Sincronizzazione di', offlineQueue.length, 'timbrature...');
  
  const remaining = [];
  let syncedCount = 0;
  
  for (const item of offlineQueue) {
    try {
      // Costruisci payload con dati opzionali (GPS, QR)
      const payload = { 
        tipo: item.tipo, 
        offline_ts: item.ts,
        offline_timestamp: item.timestamp
      };
      
      // Se ha dati GPS, aggiungi al payload per validazione server
      // NON impostare bypass_qr quando c'Ã¨ GPS - il server deve validare le coordinate
      if (item.gps) {
        payload.offline_gps = item.gps;
      } else if (item.qr_code) {
        // Se ha dati QR, aggiungi al payload
        payload.offline_qr = item.qr_code;
      } else {
        // Solo se non ci sono nÃ© GPS nÃ© QR, usa bypass_qr (timbratura diretta)
        payload.bypass_qr = true;
      }
      
      const res = await fetch('/api/timbratura', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (res.ok) {
        console.log('[Offline Sync] Sincronizzata:', item.tipo, item.timestamp);
        syncedCount++;
      } else {
        const errData = await res.json().catch(() => ({}));
        console.warn('[Offline Sync] Errore server:', errData.error || res.status);
        remaining.push(item);
      }
    } catch (err) {
      remaining.push(item);
    }
  }
  
  localStorage.setItem('offline_timbrature', JSON.stringify(remaining));
  
  if (syncedCount > 0) {
    showToast(`âœ… ${syncedCount} timbratur${syncedCount === 1 ? 'a' : 'e'} sincronizzat${syncedCount === 1 ? 'a' : 'e'}!`, 'success');
    loadTimbrature(); // Ricarica dal server per avere i dati completi
  }
  
  if (remaining.length > 0) {
    console.warn('[Offline Sync] Rimaste', remaining.length, 'timbrature non sincronizzate');
  }
}

// Apri scanner
function openScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.add('active');
  
  html5QrcodeScanner = new Html5Qrcode("qr-reader");
  
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    onScanFailure
  ).catch((err) => {
    console.error('Errore avvio scanner:', err);
    
    // Messaggio specifico per problemi HTTPS/permessi
    let errorMsg = 'Errore accesso alla camera';
    const errStr = String(err).toLowerCase();
    
    if (errStr.includes('notallowed') || errStr.includes('permission')) {
      errorMsg = 'âš ï¸ Permesso camera negato. Controlla le impostazioni del browser.';
    } else if (errStr.includes('notfound') || errStr.includes('no camera')) {
      errorMsg = 'âš ï¸ Nessuna camera trovata sul dispositivo.';
    } else if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      errorMsg = 'âš ï¸ HTTPS richiesto! La camera funziona solo su connessioni sicure (HTTPS) o localhost.';
    }
    
    showToast(errorMsg, 'error');
    closeScanner();
  });
}

// Chiudi scanner
function closeScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.remove('active');
  pendingTimbraturaType = null;
  
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    }).catch((err) => {
      console.error('Errore stop scanner:', err);
    });
  }
}

// Callback scan riuscito - valida QR e registra timbratura
async function onScanSuccess(decodedText, decodedResult) {
  // Salva il tipo PRIMA di chiudere lo scanner (che resetta pendingTimbraturaType)
  const tipo = pendingTimbraturaType;
  
  closeScanner();
  
  if (!tipo) {
    showToast('Errore: nessuna timbratura selezionata', 'error');
    return;
  }
  
  // Se offline, salva QR code per validazione successiva
  if (!navigator.onLine) {
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con QR. VerrÃ  sincronizzata automaticamente.', 'warning');
    return;
  }
  
  try {
    // Prima valida il QR
    const validateRes = await fetch('/api/timbratura/validate-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: decodedText })
    });
    
    const validateData = await validateRes.json();
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'QR non valido', 'error');
      return;
    }
    
    // QR valido, ora registra la timbratura
    const token = validateData.token;
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, token })
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! âœ“', 'success');
      loadTimbrature();
      
      // Se Ã¨ stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
      }
      // Se Ã¨ stato rilevato Fuori FlessibilitÃ , mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se Ã¨ stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se Ã¨ stata rilevata un'attivitÃ  di produzione da avviare
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          _pendingProductionActivity = data.production_activity;
        } else {
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': 'â¸ï¸ AttivitÃ  in pausa',
          'resumed': 'â–¶ï¸ AttivitÃ  ripresa',
          'stopped': 'â¹ï¸ AttivitÃ  terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
    }
  } catch (err) {
    console.error('Errore:', err);
    // Fallback offline
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('ðŸ“´ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. VerrÃ  sincronizzata automaticamente.', 'warning');
  }
}

// Callback scan fallito (ignora errori continui)
function onScanFailure(error) {
  // Ignora - Ã¨ normale durante la scansione
}

// Aggiorna UI in base alle timbrature
function updateUI() {
  // Combina timbrature server + offline pending
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filtra solo timbrature offline di oggi e crea oggetti compatibili
  const offlineToday = offlineQueue
    .filter(item => item.timestamp && item.timestamp.startsWith(today))
    .map(item => ({
      tipo: item.tipo,
      ora: item.timestamp.split('T')[1].substring(0, 8), // HH:MM:SS
      ora_mod: null,
      offline: true,  // Marca come offline
      offline_ts: item.ts
    }));
  
  // Ordine logico dei tipi di timbratura (per risolvere paritÃ  di orario)
  const TIPO_ORDER = {
    'inizio_giornata': 1,
    'inizio_pausa': 2,
    'fine_pausa': 3,
    'fine_giornata': 4
  };
  
  // Combina e ordina per ora (crescente per logica interna)
  const allTimbrature = [...todayTimbrature.map(t => ({...t, offline: false})), ...offlineToday]
    .sort((a, b) => {
      // Normalizza ora con zero-padding (es: "9:20" -> "09:20:00")
      const normalizeOra = (ora) => {
        if (!ora) return '00:00:00';
        const parts = ora.split(':');
        const hh = (parts[0] || '00').padStart(2, '0');
        const mm = (parts[1] || '00').padStart(2, '0');
        const ss = (parts[2] || '00').padStart(2, '0');
        return `${hh}:${mm}:${ss}`;
      };
      const oraA = normalizeOra(a.ora);
      const oraB = normalizeOra(b.ora);
      const cmp = oraA.localeCompare(oraB);
      // In caso di paritÃ , ordina per tipo logico
      if (cmp === 0) {
        return (TIPO_ORDER[a.tipo] || 99) - (TIPO_ORDER[b.tipo] || 99);
      }
      return cmp;
    });
  
  // Per lo storico, ordine decrescente (piÃ¹ recente in alto)
  const allTimbratureDisplay = [...allTimbrature].sort((a, b) => {
    // Normalizza ora con zero-padding (es: "9:20" -> "09:20")
    const oraA = (a.ora || '00:00').split(':').map(p => p.padStart(2, '0')).join(':');
    const oraB = (b.ora || '00:00').split(':').map(p => p.padStart(2, '0')).join(':');
    const cmp = oraB.localeCompare(oraA);  // b-a per decrescente
    // In caso di paritÃ , ordina per tipo logico (inverso per decrescente)
    if (cmp === 0) {
      return (TIPO_ORDER[b.tipo] || 99) - (TIPO_ORDER[a.tipo] || 99);
    }
    return cmp;
  });
  
  const hasStarted = allTimbrature.some(t => t.tipo === 'inizio_giornata');
  const hasEnded = allTimbrature.some(t => t.tipo === 'fine_giornata');
  const lastPause = [...allTimbrature].reverse().find(t => t.tipo === 'inizio_pausa' || t.tipo === 'fine_pausa');
  const inPause = lastPause?.tipo === 'inizio_pausa';

  // Pulsanti - abilitati in base allo stato (la validazione QR avviene al click)
  document.getElementById('btnStartDay').disabled = hasStarted;
  document.getElementById('btnEndDay').disabled = !hasStarted || hasEnded || inPause;
  
  // Se gruppo di produzione e ha giÃ  timbrato inizio, cambia il bottone in "Cambia AttivitÃ "
  const btnStart = document.getElementById('btnStartDay');
  if (timbraturaConfig.is_production_group && hasStarted && !hasEnded) {
    btnStart.disabled = false;
    document.getElementById('labelStart').textContent = 'Cambia AttivitÃ ';
    document.getElementById('iconStart').textContent = 'ðŸ”„';
    btnStart.onclick = function() { openSwitchActivityModal(); };
    document.getElementById('checkStart').className = 'check done';
    document.getElementById('checkStart').innerHTML = 'âœ“';
  } else {
    if (!hasStarted) {
      document.getElementById('labelStart').textContent = 'Inizio Giornata';
      document.getElementById('iconStart').textContent = 'â†’';
    }
    btnStart.onclick = function() { startTimbratura('inizio_giornata'); };
  }
  
  // Check marks
  if (!(timbraturaConfig.is_production_group && hasStarted && !hasEnded)) {
    document.getElementById('checkStart').className = 'check' + (hasStarted ? ' done' : '');
    document.getElementById('checkStart').innerHTML = hasStarted ? 'âœ“' : '';
  }
  document.getElementById('checkEnd').className = 'check' + (hasEnded ? ' done' : '');
  document.getElementById('checkEnd').innerHTML = hasEnded ? 'âœ“' : '';
  
  // Pulsanti pausa
  document.getElementById('btnStartPause').disabled = !hasStarted || hasEnded || inPause;
  document.getElementById('btnEndPause').disabled = !inPause;

  // Storico (ordine decrescente - piÃ¹ recente in alto)
  const historyList = document.getElementById('historyList');
  if (allTimbratureDisplay.length === 0) {
    historyList.innerHTML = '<li class="empty-history">Nessuna timbratura registrata</li>';
  } else {
    historyList.innerHTML = allTimbratureDisplay.map((t, idx) => {
      const info = TIMBRATURA_TYPES[t.tipo] || { label: t.tipo, dotClass: 'start' };
      // Mostra ora originale e ora modificata se diversa (solo HH:MM)
      const formatHHMM = (ora) => {
        if (!ora) return '';
        const parts = String(ora).split(':');
        if (parts.length >= 2) {
          const hh = parts[0].padStart(2, '0');
          const mm = parts[1].padStart(2, '0');
          return `${hh}:${mm}`;
        }
        return ora;
      };
      let oraDisplay = formatHHMM(t.ora);
      let extraInfo = '';
      
      // Icona sync status
      let syncIcon = '';
      if (t.offline) {
        syncIcon = '<span class="sync-status pending" title="In attesa di sincronizzazione">â˜ï¸</span>';
      } else {
        syncIcon = '<span class="sync-status synced" title="Sincronizzata">âœ“</span>';
      }
      
      // Badge Extra Turno in attesa - per qualsiasi timbratura con pending_extra_turno
      let overtimeRow = '';
      let hasOvertimeClass = '';
      
      // Verifica se questa timbratura Ã¨ in attesa di conferma Extra Turno
      if (t.pending_extra_turno) {
        hasOvertimeClass = 'has-overtime pending-confirmation';
        // Usa sync_error se disponibile, altrimenti messaggio generico
        const waitMessage = t.sync_error || 'In attesa di revisione';
        overtimeRow = `
          <div class="overtime-info-row pending-confirmation">
            <span class="overtime-icon">â³</span>
            <span class="overtime-text">${waitMessage}</span>
          </div>
        `;
      } else if (t.tipo === 'fine_giornata' && pendingOvertime) {
        const mins = pendingOvertime.minutes || 0;
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        const timeStr = h > 0 ? `${h}h ${m}m` : `${m}m`;
        hasOvertimeClass = 'has-overtime';
        overtimeRow = `
          <div class="overtime-info-row">
            <span class="overtime-icon">â³</span>
            <span class="overtime-text">Extra Turno in attesa</span>
            <span class="overtime-time">${timeStr}</span>
          </div>
        `;
      }
      
      // Badge Giustificazione Ritardo - per inizio_giornata con late_arrival_request
      if (t.late_arrival_request && t.tipo === 'inizio_giornata') {
        const lateReq = t.late_arrival_request;
        let lateIcon = 'â°';
        let lateText = '';
        let lateClass = 'late-arrival-row';
        
        if (lateReq.status === 'pending') {
          lateIcon = 'â³';
          lateText = 'In attesa di revisione';
          lateClass = 'late-arrival-row pending-confirmation';
        } else if (lateReq.status === 'approved') {
          lateIcon = 'âœ…';
          lateText = 'Giustificazione accettata';
          lateClass = 'late-arrival-row approved';
        } else if (lateReq.status === 'rejected') {
          lateIcon = 'â°';
          lateText = 'Ritardo registrato';
          lateClass = 'late-arrival-row registered';
        }
        
        if (lateText) {
          hasOvertimeClass = hasOvertimeClass || 'has-late-request';
          overtimeRow = `
            <div class="${lateClass}">
              <span class="overtime-icon">${lateIcon}</span>
              <span class="overtime-text">${lateText}</span>
            </div>
          `;
        }
      }
      
      if (t.tipo === 'fine_pausa') {
        // Per fine_pausa, trova l'inizio_pausa corrispondente (quello con ora < fine_pausa)
        // Usiamo allTimbrature (ordine crescente) per trovare l'ultimo inizio_pausa prima di questa fine
        const finePausaOra = t.ora;
        const inizioPausa = [...allTimbrature].filter(x => x.tipo === 'inizio_pausa' && x.ora < finePausaOra).pop();
        if (inizioPausa) {
          const inizioMin = parseInt(inizioPausa.ora.split(':')[0]) * 60 + parseInt(inizioPausa.ora.split(':')[1]);
          const fineMin = parseInt(t.ora.split(':')[0]) * 60 + parseInt(t.ora.split(':')[1]);
          const durataEffettiva = fineMin - inizioMin;
          
          // Calcola anche la durata conteggiata (usando ora_mod)
          const inizioModMin = parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[0]) * 60 + parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[1]);
          const fineModMin = parseInt((t.ora_mod || t.ora).split(':')[0]) * 60 + parseInt((t.ora_mod || t.ora).split(':')[1]);
          const durataConteggiata = fineModMin - inizioModMin;
          
          if (durataConteggiata !== durataEffettiva) {
            // Mostra durata su riga separata sotto l'orario
            extraInfo = `<div class="pausa-durata-row">(${durataEffettiva} min â†’ <span class="ora-mod">${durataConteggiata} min</span>)</div>`;
          } else {
            extraInfo = `<div class="pausa-durata-row">(${durataEffettiva} min)</div>`;
          }
        }
        
        // Mostra ora barrata anche per fine_pausa se ora_mod Ã¨ diversa
        if (t.ora_mod && formatHHMM(t.ora_mod) !== formatHHMM(t.ora)) {
          oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
        }
      } else if (t.ora_mod && formatHHMM(t.ora_mod) !== formatHHMM(t.ora) && t.rounding_mode !== 'daily') {
        // Mostra ora barrata SOLO se NON Ã¨ modalitÃ  daily (arrotondamento a fine giornata)
        oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
      }
      
      // Mostra location se presente (GPS)
      let locationInfo = '';
      if (t.location_name) {
        locationInfo = `<span class="location-badge" title="${t.location_name}">${t.location_name}</span>`;
      } else if (t.method === 'qr' || t.method === 'qr_offline') {
        locationInfo = '<span class="method-badge qr" title="QR Code">ðŸ“±</span>';
      }
      
      // Badge supervisor se la timbratura Ã¨ stata creata da un caposquadra
      let supervisorBadge = '';
      if (t.method === 'supervisor') {
        supervisorBadge = `<span class="supervisor-badge" title="Registrata dal Supervisor">ðŸ‘· Supervisor</span>`;
      }
      
      // Per fine_pausa, extraInfo va su riga separata sotto il tipo
      const pausaDurataInfo = (t.tipo === 'fine_pausa' && extraInfo) ? extraInfo : '';
      const inlineExtraInfo = (t.tipo !== 'fine_pausa' && extraInfo) ? extraInfo : '';
      
      return `
        <li class="history-item ${t.offline ? 'offline-pending' : ''} ${hasOvertimeClass}">
          <span class="dot ${info.dotClass}"></span>
          <span class="time">${oraDisplay}</span>
          <span class="type">${info.label}${pausaDurataInfo}${inlineExtraInfo}</span>
          ${locationInfo}
          ${supervisorBadge}
          ${syncIcon}
        </li>
        ${overtimeRow}
      `;
    }).join('');
  }
}

// Carica timbrature di oggi
async function loadTimbrature() {
  try {
    const res = await fetch('/api/timbratura/oggi');
    if (res.ok) {
      const data = await res.json();
      todayTimbrature = data.timbrature || [];
      pendingOvertime = data.pending_overtime || null;
      updateUI();
    }
  } catch (err) {
    console.error('Errore caricamento timbrature:', err);
  }
}

// Turni multipli - stato globale
let allTurni = [];
let currentTurnoIndex = 0;
let currentShiftLocationName = null; // Sede GPS associata al turno corrente
let currentShiftGpsData = null; // Dati GPS per la timbratura del turno corrente

// Carica turno di oggi (da Rentman)
async function loadTurno() {
  const turnoBox = document.getElementById('turnoBox');
  if (!turnoBox) return; // Se l'elemento non esiste, esci
  
  try {
    const res = await fetch('/api/user/turno-oggi');
    if (!res.ok) {
      turnoBox.style.display = 'none';
      return;
    }
    
    const data = await res.json();
    console.log("ðŸ“¥ TURNI CARICATI DA SERVER:", data);
    
    // Se non c'Ã¨ turno, mostra messaggio
    if (!data.turno && (!data.turni || data.turni.length === 0)) {
      turnoBox.classList.add('no-turno');
      turnoBox.style.display = 'block';
      const turnoProject = document.getElementById('turnoProject');
      const turnoOrario = document.getElementById('turnoOrario');
      const turnoFunzione = document.getElementById('turnoFunzione');
      const turnoBadge = document.getElementById('turnoBadge');
      if (turnoProject) turnoProject.textContent = 'Nessun turno previsto';
      if (turnoOrario) turnoOrario.style.display = 'none';
      if (turnoFunzione) turnoFunzione.style.display = 'none';
      if (turnoBadge) turnoBadge.style.display = 'none';
      const infoBtn = document.getElementById('turnoInfoBtn');
      if (infoBtn) infoBtn.style.display = 'none';
      hideNavigation();
      console.warn("âš ï¸ Nessun turno disponibile");
      return;
    }
    
    // Memorizza tutti i turni
    allTurni = data.turni || [data.turno];
    currentTurnoIndex = 0;
    console.log("ðŸ“Š Turni carichi:", allTurni.length, allTurni);
    
    turnoBox.classList.remove('no-turno');
    turnoBox.style.display = 'block';
    
    // Mostra navigazione se ci sono piÃ¹ turni
    if (allTurni.length > 1) {
      showNavigation();
    } else {
      hideNavigation();
    }
    
    // Visualizza il primo turno
    displayTurno(currentTurnoIndex);
    
  } catch (err) {
    console.error('Errore caricamento turno:', err);
    if (turnoBox) turnoBox.style.display = 'none';
  }
}

// Visualizza un singolo turno
function displayTurno(index) {
  if (index < 0 || index >= allTurni.length) return;
  
  const turno = allTurni[index];
  
  // Memorizza la sede corrente per la validazione GPS
  // PrioritÃ : timbratura_location (sede GPS configurata) > location_name (location progetto)
  currentShiftLocationName = turno.timbratura_location || turno.location_name || null;
  
  // Memorizza le note del turno corrente
  currentTurnoNotes = {
    note: turno.note || null,
    note_planner: turno.note_planner || null
  };
  
  // Gestione badge row (pausa e note)
  const badgesRow = document.getElementById('turnoBadgesRow');
  const badgePausa = document.getElementById('turnoBadgePausa');
  const badgePausaText = document.getElementById('turnoBadgePausaText');
  const badgeNote = document.getElementById('turnoBadgeNote');
  
  let hasPausa = false;
  let hasNote = currentTurnoNotes.note || currentTurnoNotes.note_planner;
  
  // Pausa prevista
  if (turno.break_start && turno.break_end) {
    badgePausaText.textContent = `${turno.break_start}-${turno.break_end}`;
    hasPausa = true;
  } else if (turno.break_minutes && turno.break_minutes > 0) {
    badgePausaText.textContent = `${turno.break_minutes}min`;
    hasPausa = true;
  }
  
  badgePausa.style.display = hasPausa ? 'inline-flex' : 'none';
  badgeNote.style.display = hasNote ? 'inline-flex' : 'none';
  badgesRow.style.display = (hasPausa || hasNote) ? 'flex' : 'none';
  
  // Progetto - nome diretto senza "Progetto"
  let projectText = turno.project_name || '-';
  document.getElementById('turnoProject').textContent = projectText;
  
  // Orario
  if (turno.start || turno.end) {
    let orarioText = '';
    if (turno.start && turno.end) {
      orarioText = `${turno.start} - ${turno.end}`;
    } else if (turno.start) {
      orarioText = `Dalle ${turno.start}`;
    } else if (turno.hours) {
      orarioText = `${turno.hours}h previste`;
    }
    document.getElementById('turnoOrarioText').textContent = orarioText;
  }
  
  // Numero progetto
  const projectCodeEl = document.getElementById('turnoProjectCode');
  if (projectCodeEl) {
    if (turno.project_code) {
      projectCodeEl.textContent = 'P. ' + turno.project_code;
      projectCodeEl.style.display = 'inline-block';
    } else {
      projectCodeEl.style.display = 'none';
    }
  }
  
  // Funzione/Ruolo
  if (turno.function) {
    document.getElementById('turnoFunzioneText').textContent = turno.function;
  } else {
    document.getElementById('turnoFunzioneText').textContent = '-';
  }
  
  // Dove timbrare (GPS) - Consolidato su una riga
  const timbraturaEl = document.getElementById('turnoTimbratura');
  
  console.log("ðŸ” DEBUG TURNO:", {
    timbratura_location: turno.timbratura_location,
    timbratura_lat: turno.timbratura_lat,
    timbratura_lon: turno.timbratura_lon,
    gps_mode: turno.gps_mode,
    gps_timbratura_location: turno.gps_timbratura_location,
    location_name: turno.location_name,
    location_lat: turno.location_lat,
    location_lon: turno.location_lon
  });
  
  if (turno.timbratura_location || turno.location_name) {
    timbraturaEl.style.display = 'flex';
    timbraturaEl.className = 'turno-detail turno-timbratura inline-location';
    
    // Svuota il container
    timbraturaEl.innerHTML = '';
    
    // Location del progetto (se presente)
    if (turno.location_name) {
      const locationItem = document.createElement('div');
      locationItem.className = 'location-item';
      locationItem.innerHTML = `
        <span class="icon"><i class="fas fa-map-marker-alt"></i></span>
        <span class="value">${turno.location_name}</span>
      `;
      timbraturaEl.appendChild(locationItem);
    }
    
    // Timbratura location (prioritaria se presente) - Solo icona come simbolo
    if (turno.timbratura_location) {
      const timbraturaItem = document.createElement('div');
      timbraturaItem.className = 'location-item';
      const hasCoords = turno.timbratura_lat && turno.timbratura_lon;
      const warningText = !hasCoords ? ' âš ï¸' : '';
      timbraturaItem.innerHTML = `
        <span class="icon" title="Timbra presso: ${turno.timbratura_location}"><i class="fas fa-clock"></i></span>
        <span class="value">${turno.timbratura_location}${warningText}</span>
      `;
      timbraturaEl.appendChild(timbraturaItem);
      
      // Salva i dati GPS per la validazione della timbratura
      currentShiftGpsData = {
        location: turno.timbratura_location,
        lat: turno.timbratura_lat,
        lon: turno.timbratura_lon,
        radius: turno.timbratura_radius || 300,
        mode: turno.gps_mode
      };
      
      console.log("âœ… TURNO CARICATO:", {
        timbratura_location: turno.timbratura_location,
        timbratura_lat: turno.timbratura_lat,
        timbratura_lon: turno.timbratura_lon,
        gps_mode: turno.gps_mode,
        location_name: turno.location_name,
        gps_timbratura_location: turno.gps_timbratura_location
      });
      
      if (!hasCoords) {
        console.warn("âš ï¸ ATTENZIONE: Coordinate mancanti per timbratura_location!", {
          timbratura_location: turno.timbratura_location,
          timbratura_lat: turno.timbratura_lat,
          timbratura_lon: turno.timbratura_lon,
          gps_mode: turno.gps_mode,
          gps_timbratura_location: turno.gps_timbratura_location
        });
      }
    } else {
      currentShiftGpsData = null;
    }
  } else {
    timbraturaEl.style.display = 'none';
    currentShiftGpsData = null;
  }
  
  // Badge (Leader)
  const badge = document.getElementById('turnoBadge');
  if (turno.is_leader) {
    badge.textContent = 'â­ Caposquadra';
    badge.classList.add('leader');
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
  
  // Mostra bottone info se Ã¨ un turno Rentman (ha project_code)
  const infoBtn = document.getElementById('turnoInfoBtn');
  if (infoBtn) {
    if (turno.project_code && turno.source !== 'employee_shifts') {
      infoBtn.style.display = 'flex';
    } else {
      infoBtn.style.display = 'none';
    }
  }
  
  // Aggiorna counter e stato bottoni
  updateNavigation();
}

// Naviga tra i turni
function navigateTurno(direction) {
  const newIndex = currentTurnoIndex + direction;
  if (newIndex >= 0 && newIndex < allTurni.length) {
    currentTurnoIndex = newIndex;
    displayTurno(currentTurnoIndex);
  }
}

// Mostra i controlli di navigazione
function showNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'flex';
  document.getElementById('turnoNextBtn').style.display = 'flex';
  document.getElementById('turnoCounter').style.display = 'block';
}

// Nasconde i controlli di navigazione
function hideNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'none';
  document.getElementById('turnoNextBtn').style.display = 'none';
  document.getElementById('turnoCounter').style.display = 'none';
}

// Aggiorna stato navigazione
function updateNavigation() {
  const prevBtn = document.getElementById('turnoPrevBtn');
  const nextBtn = document.getElementById('turnoNextBtn');
  const counter = document.getElementById('turnoCounter');
  
  prevBtn.disabled = currentTurnoIndex === 0;
  nextBtn.disabled = currentTurnoIndex === allTurni.length - 1;
  counter.textContent = `${currentTurnoIndex + 1}/${allTurni.length}`;
}

// â•â•â• Crew Info Modal â•â•â•
async function openCrewInfoModal() {
  const turno = allTurni[currentTurnoIndex];
  if (!turno || !turno.project_code) return;

  const overlay = document.getElementById('crewInfoOverlay');
  const body = document.getElementById('crewInfoBody');
  const title = document.getElementById('crewInfoTitle');

  title.textContent = `â„¹ï¸ ${turno.project_name || turno.project_code}`;
  body.innerHTML = '<div class="crew-info-loading">â³ Caricamento...</div>';
  overlay.classList.add('active');

  try {
    const res = await fetch(`/api/user/turno-crew-info?project_code=${encodeURIComponent(turno.project_code)}`);
    if (!res.ok) throw new Error('Errore caricamento');
    const data = await res.json();

    let html = '';

    // Sezione Squadra
    if (data.crew && data.crew.length > 0) {
      html += `<div class="crew-info-section">
        <div class="crew-info-section-title">ðŸ‘¥ Squadra (${data.total_crew})</div>`;
      data.crew.forEach(m => {
        const initials = (m.crew_name || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        const timeStr = m.start && m.end ? `${m.start} - ${m.end}` : (m.start || '');
        html += `<div class="crew-member-item ${m.is_me ? 'is-me' : ''} ${m.is_leader ? 'is-leader' : ''}">
          <div class="crew-member-avatar">${initials}</div>
          <div class="crew-member-info">
            <div class="crew-member-name">
              ${m.is_leader ? '<span style="font-size:16px;margin-right:4px;">â­</span>' : ''}${escapeHtmlCI(m.crew_name)}${m.is_me ? ' (Tu)' : ''}
            </div>
            <div class="crew-member-role">${escapeHtmlCI(m.function || 'â€”')}${m.location ? ' â€¢ ' + escapeHtmlCI(m.location) : ''}</div>
          </div>
          ${timeStr ? `<div class="crew-member-time">${timeStr}</div>` : ''}
        </div>`;
      });
      html += '</div>';
    } else {
      html += '<div class="crew-info-empty">Nessun collega trovato per questo turno</div>';
    }

    // Sezione Mezzi
    if (data.vehicles && data.vehicles.length > 0) {
      html += `<div class="crew-info-section">
        <div class="crew-info-section-title">ðŸš› Mezzi (${data.total_vehicles})</div>`;
      data.vehicles.forEach(v => {
        html += `<div class="vehicle-info-item">
          <div class="vehicle-info-icon">ðŸš›</div>
          <div class="vehicle-info-details">
            <div class="vehicle-info-name">${escapeHtmlCI(v.vehicle_name)}</div>
            <div class="vehicle-info-driver">${v.driver_name ? 'ðŸ§‘â€âœˆï¸ Autista: ' + escapeHtmlCI(v.driver_name) : 'âš ï¸ Nessun autista assegnato'}</div>
          </div>
        </div>`;
      });
      html += '</div>';
    }

    body.innerHTML = html || '<div class="crew-info-empty">Nessuna informazione disponibile</div>';

  } catch (err) {
    console.error('Errore caricamento crew info:', err);
    body.innerHTML = '<div class="crew-info-empty">âŒ Errore nel caricamento delle informazioni</div>';
  }
}

function closeCrewInfoModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('crewInfoOverlay').classList.remove('active');
}

function escapeHtmlCI(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== Switch Activity Modal (Produzione) =====
async function openSwitchActivityModal() {
  const overlay = document.getElementById('switchActivityOverlay');
  const body = document.getElementById('switchActivityBody');
  
  // Reset override progetto e griglia
  _switchOverrideProject = null;
  _switchGridProject = null;
  _switchCurrentProject = null;
  
  // Prendi il progetto corrente dal turno visualizzato
  const turno = allTurni[currentTurnoIndex] || {};
  const projectCode = turno.project_code || '';
  const projectName = turno.project_name || 'Progetto';
  const plannedFunction = turno.function || 'AttivitÃ ';
  
  // Mostra loading
  body.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">Caricamento...</div>';
  overlay.classList.add('active');
  
  // Recupera attivitÃ  attiva dal server
  let currentActivityLabel = '';
  let currentProjectCode = '';
  let currentProjectName = '';
  let currentNotes = '';
  try {
    const res = await fetch('/api/production/timer');
    const timerData = await res.json();
    if (timerData.ok && timerData.active && timerData.timer) {
      currentActivityLabel = timerData.timer.activity_label || '';
      currentProjectCode = timerData.timer.project_code || '';
      currentProjectName = timerData.timer.project_name || '';
      currentNotes = timerData.timer.notes || '';
      // Salva progetto in corso per uso in griglia
      _switchCurrentProject = { code: currentProjectCode, name: currentProjectName };
    }
  } catch(e) { console.warn('Errore recupero timer attivo:', e); }
  
  // Lista attivitÃ  predefinite magazzino
  const ACTIVITIES = [
    { code: 'Preparazione', icon: 'ðŸ“¦', label: 'Preparazione' },
    { code: 'Carico', icon: 'ðŸšš', label: 'Carico' },
    { code: 'Scarico', icon: 'ðŸ“¥', label: 'Scarico' },
    { code: 'Controllo', icon: 'ðŸ”', label: 'Controllo' },
    { code: 'Pulizia', icon: 'ðŸ§¹', label: 'Pulizia' },
    { code: 'Verifica', icon: 'âœ…', label: 'Verifica' },
    { code: 'Manutenzione', icon: 'ðŸ”§', label: 'Manutenzione' },
    { code: 'Altro', icon: 'ðŸ“', label: 'Altro' }
  ];
  
  let html = '';
  
  // 0. Pulsante Cambia Progetto in alto a tutto
  html += `<div style="margin-bottom:14px;">
    <button onclick="openNumpad()" style="width:100%;background:#3b82f6;color:#fff !important;border:none;border-radius:10px;padding:10px 16px;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 2px 6px rgba(59,130,246,0.3);display:flex;align-items:center;justify-content:center;gap:8px;">
      ðŸ”¢ Cambia Progetto
    </button>
  </div>`;
  
  // 1. Card IN CORSO (progetto + mansione in corso) con Cambio AttivitÃ 
  if (currentActivityLabel) {
    html += `<div style="background:#e8f5e9;border:1px solid #4CAF50;border-radius:12px;padding:12px 14px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:20px;">â–¶ï¸</div>
        <div style="flex:1;">
          <div style="font-size:11px;color:#388E3C;font-weight:600;">IN CORSO</div>
          <div style="font-weight:600;font-size:14px;color:#1b5e20;">${escapeHtmlCI(currentActivityLabel)}</div>
        </div>
      </div>
      ${currentProjectCode ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid #a5d6a7;">
        <div style="font-size:10px;color:#388E3C;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">PROGETTO</div>
        <div style="font-weight:700;font-size:13px;color:#1a56db;">P. ${escapeHtmlCI(currentProjectCode)}</div>
        ${currentProjectName ? `<div style="font-size:12px;color:#1b5e20;">${escapeHtmlCI(currentProjectName)}</div>` : ''}
      </div>` : ''}
      ${currentNotes ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid #a5d6a7;">
        <div style="font-size:10px;color:#388E3C;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">ðŸ“ NOTE</div>
        <div style="font-size:13px;color:#2e7d32;font-style:italic;margin-top:2px;">${escapeHtmlCI(currentNotes)}</div>
      </div>` : ''}
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid #a5d6a7;">
        <button onclick="showSwitchActivityGrid('current')" style="width:100%;padding:10px;background:#fff;color:#388E3C;border:2px solid #4CAF50;border-radius:10px;font-weight:600;cursor:pointer;font-size:13px;">
          ðŸ”„ Cambio AttivitÃ 
        </button>
      </div>
    </div>`;
  }
  
  // 2. Card combinata: Progetto Pianificato + Mansione (font ridotti)
  // Nascondo se l'attivitÃ  in corso coincide con quella pianificata (stesso progetto + stessa mansione)
  const isSameAsCurrent = currentProjectCode && projectCode && 
                          currentProjectCode.toString() === projectCode.toString() && 
                          currentActivityLabel && plannedFunction &&
                          currentActivityLabel.toLowerCase().trim() === plannedFunction.toLowerCase().trim();
  
  console.log('DEBUG Switch Modal:', {
    currentProjectCode, projectCode,
    currentActivityLabel, plannedFunction,
    isSameAsCurrent
  });
  
  if (!isSameAsCurrent) {
    html += `<div id="switchDefaultView">
      <div style="background:#fff3e0;border:2px solid #f59e0b;border-radius:12px;padding:12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(245,158,11,0.15);">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
          <div style="font-size:18px;">â­</div>
          <div style="font-size:11px;color:#f59e0b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progetto Pianificato</div>
        </div>
        ${projectCode ? `<div style="font-weight:700;font-size:13px;color:#1a56db;margin-bottom:1px;letter-spacing:0.3px;">P. ${escapeHtmlCI(projectCode)}</div>` : ''}
        <div style="font-weight:500;font-size:11px;color:#1a1a1a;margin-bottom:8px;">${escapeHtmlCI(projectName)}</div>
        <div style="font-size:10px;color:#888;margin-bottom:1px;">MANSIONE</div>
        <div style="font-weight:700;font-size:13px;color:#f59e0b;margin-bottom:12px;">${escapeHtmlCI(plannedFunction)}</div>
        <div style="display:flex;gap:8px;">
          <button onclick="confirmSwitchActivity('${escapeHtmlCI(projectCode)}', '${escapeHtmlCI(projectName)}', '${escapeHtmlCI(plannedFunction)}')" style="flex:1.3;padding:10px;background:#4CAF50;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:12px;box-shadow:0 3px 12px rgba(76,175,80,0.3);">
            â–¶ï¸ Avvia Mansione Pianificata
          </button>
          <button onclick="showSwitchActivityGrid('planned')" style="flex:1;padding:10px;background:#fff;color:#f59e0b;border:2px solid #f59e0b;border-radius:10px;font-weight:600;cursor:pointer;font-size:12px;">
            ðŸ”„ Cambia AttivitÃ 
          </button>
        </div>
      </div>
    </div>`;
  }
  
  // 3. Card Progetto Manuale (nascosta, appare dopo numpad)
  html += `<div id="switchManualProjectCard" style="display:none;background:#e3f2fd;border:2px solid #42a5f5;border-radius:12px;padding:16px;margin-bottom:14px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
      <div style="font-size:24px;">ðŸ”¢</div>
      <div style="font-size:13px;color:#1e88e5;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progetto Manuale</div>
    </div>
    <div id="switchManualProjectCode" style="font-weight:800;font-size:17px;color:#1a56db;margin-bottom:2px;letter-spacing:0.3px;"></div>
    <div id="switchManualProjectName" style="font-weight:600;font-size:13px;color:#1a1a1a;margin-bottom:12px;"></div>
    <button onclick="showSwitchActivityGrid('manual')" style="width:100%;padding:12px;background:#1e88e5;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 3px 12px rgba(30,136,229,0.3);">
      ðŸ”„ Cambia AttivitÃ 
    </button>
  </div>`;
  
  // 4. Griglia attivitÃ  (nascosta)
  html += '<div id="switchActivityGrid" style="display:none;">';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
  ACTIVITIES.forEach(a => {
    const isCurrent = currentActivityLabel.toLowerCase() === a.code.toLowerCase();
    const isAltro = a.code.toLowerCase() === 'altro';
    // "Altro" rimane cliccabile anche se in corso (per cambiare note)
    const blocked = isCurrent && !isAltro;
    html += `
      <div class="switch-activity-item${isCurrent ? ' current' : ''}"
           onclick="${blocked ? '' : `gridActivityClick('${escapeHtmlCI(a.code)}')`}"
           data-activity="${escapeHtmlCI(a.code)}"
           style="cursor:${blocked ? 'default' : 'pointer'};text-align:center;padding:16px 10px;position:relative;${blocked ? 'opacity:0.5;' : ''}">
        <div style="font-size:32px;margin-bottom:6px;">${a.icon}</div>
        <div style="font-weight:600;font-size:13px;">${escapeHtmlCI(a.label)}</div>
        ${isCurrent ? '<div style="position:absolute;top:6px;right:8px;background:#4CAF50;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700;">IN CORSO</div>' : ''}
      </div>`;
  });
  html += '</div>';
  html += `<button onclick="hideSwitchActivityGrid()" style="width:100%;margin-top:12px;padding:12px;background:#f5f5f5;color:#666;border:1px solid #ddd;border-radius:10px;font-weight:600;cursor:pointer;">
    â† Indietro
  </button>`;
  html += '</div>';
  
  body.innerHTML = html;
}

// Progetto corrente selezionato per la griglia attivitÃ 
let _switchGridProject = null; // { code, name }

function gridActivityClick(activityLabel) {
  if (!_switchGridProject) return;
  confirmSwitchActivity(_switchGridProject.code, _switchGridProject.name, activityLabel);
}

function showSwitchActivityGrid(source) {
  const turno = allTurni[currentTurnoIndex] || {};
  if (source === 'manual' && _switchOverrideProject) {
    _switchGridProject = { code: _switchOverrideProject.code, name: _switchOverrideProject.name };
  } else if (source === 'current') {
    // Usa il progetto in corso (dal timer attivo) â€” lo prendiamo dai dati giÃ  nel DOM
    const curCodeEl = document.querySelector('#switchActivityBody [style*="IN CORSO"]');
    // Fallback: usa il progetto del turno se non riusciamo a estrarlo
    _switchGridProject = _switchCurrentProject || { code: turno.project_code || '', name: turno.project_name || '' };
  } else {
    _switchGridProject = { code: turno.project_code || '', name: turno.project_name || '' };
  }
  const dv = document.getElementById('switchDefaultView');
  if (dv) dv.style.display = 'none';
  const mc = document.getElementById('switchManualProjectCard');
  if (mc) mc.style.display = 'none';
  document.getElementById('switchActivityGrid').style.display = 'block';
}

function hideSwitchActivityGrid() {
  const dv = document.getElementById('switchDefaultView');
  if (dv) dv.style.display = '';
  if (_switchOverrideProject) {
    const mc = document.getElementById('switchManualProjectCard');
    if (mc) mc.style.display = '';
  }
  document.getElementById('switchActivityGrid').style.display = 'none';
}

function closeSwitchActivityModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('switchActivityOverlay').classList.remove('active');
}

// â•â•â• Tastierino Numerico Cambio Progetto â•â•â•
let _numpadValue = '';
let _numpadFoundProject = null;  // { project_code, project_name }
let _numpadSearchTimer = null;

function openNumpad() {
  _numpadValue = '';
  _numpadFoundProject = null;
  document.getElementById('numpadInput').value = '';
  document.getElementById('numpadResult').innerHTML = '';
  document.getElementById('numpadConfirmBtn').disabled = true;
  document.getElementById('numpadOverlay').classList.add('active');
}

function closeNumpad(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('numpadOverlay').classList.remove('active');
  if (_numpadSearchTimer) { clearTimeout(_numpadSearchTimer); _numpadSearchTimer = null; }
}

function numpadPress(digit) {
  if (_numpadValue.length >= 10) return;
  _numpadValue += digit;
  document.getElementById('numpadInput').value = _numpadValue;
  _numpadFoundProject = null;
  document.getElementById('numpadConfirmBtn').disabled = true;
  // Auto-search dopo 500ms di inattivitÃ 
  if (_numpadSearchTimer) clearTimeout(_numpadSearchTimer);
  _numpadSearchTimer = setTimeout(() => numpadSearch(), 500);
}

function numpadDelete() {
  _numpadValue = _numpadValue.slice(0, -1);
  document.getElementById('numpadInput').value = _numpadValue;
  _numpadFoundProject = null;
  document.getElementById('numpadConfirmBtn').disabled = true;
  if (_numpadValue.length > 0) {
    if (_numpadSearchTimer) clearTimeout(_numpadSearchTimer);
    _numpadSearchTimer = setTimeout(() => numpadSearch(), 500);
  } else {
    document.getElementById('numpadResult').innerHTML = '';
  }
}

function numpadClear() {
  _numpadValue = '';
  _numpadFoundProject = null;
  document.getElementById('numpadInput').value = '';
  document.getElementById('numpadResult').innerHTML = '';
  document.getElementById('numpadConfirmBtn').disabled = true;
  if (_numpadSearchTimer) { clearTimeout(_numpadSearchTimer); _numpadSearchTimer = null; }
}

async function numpadSearch() {
  const code = _numpadValue.trim();
  if (!code) return;
  
  const resultEl = document.getElementById('numpadResult');
  resultEl.innerHTML = '<span class="searching">ðŸ” Ricerca...</span>';
  
  try {
    const res = await fetch('/api/production/project-lookup?code=' + encodeURIComponent(code));
    const data = await res.json();
    
    if (data.ok) {
      _numpadFoundProject = { project_code: data.project_code, project_name: data.project_name };
      resultEl.innerHTML = `<span class="found">âœ… ${escapeHtmlCI(data.project_name)}</span>`;
      document.getElementById('numpadConfirmBtn').disabled = false;
    } else {
      _numpadFoundProject = null;
      resultEl.innerHTML = `<span class="not-found">âŒ ${data.error || 'Non trovato'}</span>`;
      document.getElementById('numpadConfirmBtn').disabled = true;
    }
  } catch (err) {
    _numpadFoundProject = null;
    resultEl.innerHTML = '<span class="not-found">âŒ Errore di connessione</span>';
    document.getElementById('numpadConfirmBtn').disabled = true;
  }
}

function numpadConfirm() {
  if (!_numpadFoundProject) return;
  
  const newCode = _numpadFoundProject.project_code;
  const newName = _numpadFoundProject.project_name;
  
  closeNumpad();
  
  // Salva override progetto
  _switchOverrideProject = { code: newCode, name: newName };
  
  // Mostra la card progetto manuale
  const card = document.getElementById('switchManualProjectCard');
  if (card) {
    document.getElementById('switchManualProjectCode').textContent = 'P. ' + newCode;
    document.getElementById('switchManualProjectName').textContent = newName;
    card.style.display = '';
  }
  
  showToast('ðŸ“‹ Progetto manuale aggiunto: P. ' + newCode, 'info');
}

// Progetto override per il modal switch (se l'utente ha cambiato progetto manualmente)
let _switchOverrideProject = null;
let _switchCurrentProject = null;

async function confirmSwitchActivity(projectCode, projectName, activityLabel) {
  // Se attivitÃ  Ã¨ "Altro", chiedi note obbligatorie prima di procedere
  if (activityLabel.toLowerCase() === 'altro') {
    openNotesPopup(async (notes) => {
      closeSwitchActivityModal();
      await _doSwitchActivity(projectCode, projectName, activityLabel, notes);
    });
    return;
  }
  
  closeSwitchActivityModal();
  await _doSwitchActivity(projectCode, projectName, activityLabel, null);
}

async function _doSwitchActivity(projectCode, projectName, activityLabel, notes) {
  // Mostra feedback visivo
  const btn = document.getElementById('btnStartDay');
  const origLabel = document.getElementById('labelStart').textContent;
  document.getElementById('labelStart').textContent = 'Cambio...';
  btn.disabled = true;
  
  try {
    const payload = {
      project_code: projectCode,
      project_name: projectName,
      activity_label: activityLabel
    };
    if (notes) payload.notes = notes;
    
    const resp = await fetch('/api/production/timer/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await resp.json();
    
    if (data.ok) {
      showToast('âœ… AttivitÃ  cambiata: ' + activityLabel);
      // Ricarica le timbrature per aggiornare lo stato
      await loadTimbrature();
    } else {
      showToast('âŒ Errore: ' + (data.error || 'Cambio attivitÃ  fallito'));
    }
  } catch (err) {
    console.error('Errore switch attivitÃ :', err);
    showToast('âŒ Errore di rete');
  } finally {
    document.getElementById('labelStart').textContent = origLabel;
    btn.disabled = false;
  }
}

// Refresh page function
async function refreshPage() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  
  try {
    // Ricarica tutte le informazioni
    await Promise.all([
      loadTimbrature(),
      loadTurno()
    ]);
  } catch (err) {
    console.error('Errore refresh:', err);
  } finally {
    btn.classList.remove('loading');
  }
}

// Menu functions
function toggleMenu() {
  const btn = document.getElementById('hamburgerBtn');
  const menu = document.getElementById('sideMenu');
  const overlay = document.getElementById('menuOverlay');
  
  btn.classList.toggle('active');
  menu.classList.toggle('active');
  overlay.classList.toggle('active');
}

function closeMenu() {
  document.getElementById('hamburgerBtn').classList.remove('active');
  document.getElementById('sideMenu').classList.remove('active');
  document.getElementById('menuOverlay').classList.remove('active');
}

// Profilo Utente Page
function openProfilePage() {
  closeMenu();
  document.getElementById('profilePage').classList.add('active');
  // Reset form
  document.getElementById('profileCurrentPassword').value = '';
  document.getElementById('profileNewPassword').value = '';
  document.getElementById('profileConfirmPassword').value = '';
  document.getElementById('passwordMessage').className = 'profile-message';
  document.getElementById('passwordMessage').textContent = '';
}

function closeProfilePage() {
  document.getElementById('profilePage').classList.remove('active');
}

async function submitProfilePasswordChange(e) {
  e.preventDefault();
  
  const currentPwd = document.getElementById('profileCurrentPassword').value;
  const newPwd = document.getElementById('profileNewPassword').value;
  const confirmPwd = document.getElementById('profileConfirmPassword').value;
  const msgEl = document.getElementById('passwordMessage');
  
  // Reset message
  msgEl.className = 'profile-message';
  msgEl.textContent = '';
  
  if (newPwd !== confirmPwd) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Le password non coincidono';
    return;
  }
  
  if (newPwd.length < 4) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'La password deve essere di almeno 4 caratteri';
    return;
  }
  
  const btn = document.getElementById('btnProfileSavePassword');
  btn.disabled = true;
  btn.textContent = 'Salvataggio...';
  
  try {
    const res = await fetch('/api/user/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_password: currentPwd,
        new_password: newPwd
      })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      msgEl.className = 'profile-message success';
      msgEl.textContent = 'Password aggiornata con successo! âœ“';
      // Reset form
      document.getElementById('profileCurrentPassword').value = '';
      document.getElementById('profileNewPassword').value = '';
      document.getElementById('profileConfirmPassword').value = '';
    } else {
      msgEl.className = 'profile-message error';
      msgEl.textContent = data.error || 'Errore nel cambio password';
    }
  } catch (err) {
    console.error('Errore:', err);
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Errore di connessione';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Aggiorna Password';
  }
}

// Theme toggle
function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  if (isDark) {
    document.documentElement.removeAttribute('data-theme');
    localStorage.removeItem('theme');
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUSH NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const pushState = {
  supported: 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window,
  subscribed: false,
  publicKey: null,
  permission: typeof Notification !== 'undefined' ? Notification.permission : 'unsupported'
};

// Carica stato push dal server
async function loadPushState() {
  if (!pushState.supported) {
    updatePushUI();
    return;
  }
  
  try {
    const res = await fetch('/api/push/status');
    const data = await res.json();
    
    if (data.enabled) {
      pushState.publicKey = data.publicKey;
      pushState.subscribed = data.subscribed || false;
    }
    
    // Verifica anche lo stato locale della subscription
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      pushState.subscribed = Boolean(subscription);
    }
  } catch (err) {
    console.warn('Errore caricamento stato push:', err);
  }
  
  updatePushUI();
  
  // Auto-richiedi notifiche se non attive e permesso non negato
  autoRequestNotifications();
}

// Richiedi automaticamente le notifiche se non sono attive
async function autoRequestNotifications() {
  // Aspetta un secondo per non sovrapporre altri elementi UI
  await new Promise(r => setTimeout(r, 1000));
  
  // Non chiedere se:
  // - Push non supportato
  // - GiÃ  iscritto
  // - Permesso giÃ  negato
  // - GiÃ  chiesto in questa sessione
  if (!pushState.supported) return;
  if (pushState.subscribed) return;
  if (pushState.permission === 'denied') return;
  if (sessionStorage.getItem('push_prompted')) return;
  
  // Segna che abbiamo giÃ  chiesto in questa sessione
  sessionStorage.setItem('push_prompted', '1');
  
  // Se il permesso non Ã¨ stato ancora chiesto, chiedi
  if (Notification.permission === 'default') {
    // Mostra un dialog di conferma prima di chiedere il permesso del browser
    const shouldAsk = await showNotificationPrompt();
    if (shouldAsk) {
      await subscribeToPush();
      updatePushUI();
    }
  } else if (Notification.permission === 'granted' && !pushState.subscribed) {
    // Permesso giÃ  dato ma non iscritto - chiedi conferma comunque
    const shouldAsk = await showNotificationPrompt();
    if (shouldAsk) {
      await subscribeToPush();
      updatePushUI();
    }
  }
}

// Mostra prompt personalizzato per le notifiche
function showNotificationPrompt() {
  return new Promise((resolve) => {
    // Crea overlay
    const overlay = document.createElement('div');
    overlay.id = 'notification-prompt-overlay';
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 10000;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.3s ease;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      background: var(--bg-card, white); border-radius: 16px;
      padding: 24px; max-width: 340px; margin: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    `;
    
    dialog.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">ðŸ””</div>
      <h3 style="margin: 0 0 12px; color: var(--text-primary, #333); font-size: 18px;">
        Vuoi ricevere notifiche?
      </h3>
      <p style="margin: 0 0 20px; color: var(--text-secondary, #666); font-size: 14px; line-height: 1.5;">
        Ti avviseremo quando vengono pubblicati nuovi turni, quando le tue richieste vengono approvate e altre comunicazioni importanti.
      </p>
      <div style="display: flex; gap: 12px;">
        <button id="notif-no" style="
          flex: 1; padding: 12px; border: 1px solid var(--border, #ddd);
          background: transparent; border-radius: 8px; cursor: pointer;
          font-size: 14px; color: var(--text-secondary, #666);
        ">Non ora</button>
        <button id="notif-yes" style="
          flex: 1; padding: 12px; border: none;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white; border-radius: 8px; cursor: pointer;
          font-size: 14px; font-weight: 600;
        ">Attiva</button>
      </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    document.getElementById('notif-yes').onclick = () => {
      overlay.remove();
      resolve(true);
    };
    
    document.getElementById('notif-no').onclick = () => {
      overlay.remove();
      resolve(false);
    };
    
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        resolve(false);
      }
    };
  });
}

// Aggiorna UI in base allo stato
function updatePushUI() {
  const toggle = document.getElementById('pushToggle');
  const icon = document.getElementById('notificationIcon');
  const label = document.getElementById('notificationLabel');
  const menuItem = document.getElementById('notificationMenuItem');
  
  if (!pushState.supported) {
    menuItem.style.display = 'none';
    return;
  }
  
  toggle.checked = pushState.subscribed;
  
  if (pushState.subscribed) {
    icon.textContent = 'ðŸ””';
    label.textContent = 'Notifiche attive';
  } else {
    icon.textContent = 'ðŸ”•';
    label.textContent = 'Attiva Notifiche';
  }
  
  // Disabilita se permesso negato
  if (pushState.permission === 'denied') {
    toggle.disabled = true;
    label.textContent = 'Notifiche bloccate';
  }
}

// Toggle notifiche push
async function togglePushNotifications() {
  const toggle = document.getElementById('pushToggle');
  
  if (toggle.checked) {
    await subscribeToPush();
  } else {
    await unsubscribeFromPush();
  }
  
  updatePushUI();
}

// Converti VAPID key
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// Sottoscrivi alle notifiche push
async function subscribeToPush() {
  if (!pushState.supported) {
    showToast('âš ï¸ Notifiche non supportate', 'error');
    return false;
  }
  
  if (!pushState.publicKey) {
    showToast('âš ï¸ Server non configurato', 'error');
    return false;
  }
  
  // Richiedi permesso se non giÃ  concesso
  if (Notification.permission === 'denied') {
    showToast('âš ï¸ Notifiche bloccate dal browser', 'error');
    pushState.permission = 'denied';
    return false;
  }
  
  if (Notification.permission !== 'granted') {
    const permission = await Notification.requestPermission();
    pushState.permission = permission;
    
    if (permission !== 'granted') {
      showToast('âš ï¸ Permesso notifiche negato', 'error');
      return false;
    }
  }
  
  try {
    // Registra service worker se non giÃ  fatto
    let registration = await navigator.serviceWorker.getRegistration();
    if (!registration) {
      registration = await navigator.serviceWorker.register('/sw.js?v=2026.01.17b');
      await navigator.serviceWorker.ready;
    }
    
    const applicationServerKey = urlBase64ToUint8Array(pushState.publicKey);
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey
    });
    
    // Invia al server
    const payload = subscription.toJSON();
    payload.userAgent = navigator.userAgent || null;
    payload.contentEncoding = 'aes128gcm';
    
    const res = await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (res.ok) {
      pushState.subscribed = true;
      showToast('ðŸ”” Notifiche attivate!', 'success');
      return true;
    } else {
      throw new Error('Errore registrazione server');
    }
  } catch (err) {
    console.error('Errore subscribe push:', err);
    showToast('âš ï¸ Errore attivazione notifiche', 'error');
    return false;
  }
}

// Disiscriviti dalle notifiche push
async function unsubscribeFromPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      const payload = subscription.toJSON();
      
      // Notifica il server
      try {
        await fetch('/api/push/unsubscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: payload.endpoint })
        });
      } catch (e) {
        console.warn('Errore unsubscribe server:', e);
      }
      
      await subscription.unsubscribe();
    }
    
    pushState.subscribed = false;
    showToast('ðŸ”• Notifiche disattivate', 'success');
  } catch (err) {
    console.error('Errore unsubscribe push:', err);
    showToast('âš ï¸ Errore disattivazione', 'error');
  }
}

// Init
updateClock();
updateDate();
setInterval(updateClock, 1000);

// Prima carica la config, poi le timbrature (l'ordine Ã¨ importante!)
(async function initPage() {
  await loadTimbraturaConfig(); // PRIMA la config
  loadTimbrature(); // POI le timbrature (usa is_production_group)
  loadTurno();
  loadPushState();
  
  if (navigator.onLine) {
    syncOfflineTimbrature();
  }
})();

// Ricarica dati quando si torna alla pagina (da bfcache o navigazione)
window.addEventListener('pageshow', async function(event) {
  if (event.persisted) {
    console.log('Pagina ripristinata da bfcache, ricarico dati...');
    await loadTimbraturaConfig();
    loadTimbrature();
    loadTurno();
  }
});

// Ricarica dati quando la tab diventa visibile
document.addEventListener('visibilitychange', async function() {
  if (document.visibilityState === 'visible') {
    console.log('Tab tornata visibile, ricarico dati...');
    await loadTimbraturaConfig();
    loadTimbrature();
    loadTurno();
  }
});

// Tema
if (localStorage.getItem('theme') === 'dark') {
  document.documentElement.setAttribute('data-theme', 'dark');
}

// Registra service worker per PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?v=2026.01.17b')
    .then(reg => console.log('Service Worker registrato'))
    .catch(err => console.warn('Service Worker fallito:', err));
    
  // Ascolta messaggi dal Service Worker (sincronizzazione offline)
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'offline-queue') {
      console.log('[SW Message]', event.data);
      
      if (event.data.action === 'delivered' && event.data.pathname === '/api/timbratura') {
        // Richiesta timbratura sincronizzata con successo
        showToast('âœ… Timbratura sincronizzata dal Service Worker!', 'success');
        loadTimbrature();
      } else if (event.data.action === 'error' && event.data.pathname === '/api/timbratura') {
        showToast('âš ï¸ Errore sincronizzazione timbratura', 'error');
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OFFLINE / ONLINE STATUS - Basato SOLO su /api/ping, ignora navigator.onLine
//  (navigator.onLine dÃ  falsi negativi quando CDN esterni falliscono)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let isReallyOnline = true; // Assumiamo online finchÃ© non verifichiamo

// Verifica lo stato reale chiamando il server
async function checkRealOnlineStatus() {
  try {
    const response = await fetch('/api/ping', { 
      method: 'GET', 
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
    });
    return response.ok;
  } catch {
    return false;
  }
}

// Aggiorna UI in base allo stato online/offline
function updateOnlineUI(online, showToast = false) {
  const existingBar = document.getElementById('offline-bar');
  
  if (!online && !existingBar) {
    const bar = document.createElement('div');
    bar.id = 'offline-bar';
    bar.className = 'offline-bar';
    bar.innerHTML = 'ðŸ“´ Sei offline - Le timbrature verranno salvate in locale';
    document.body.prepend(bar);
    if (showToast) {
      window.showToast?.('ðŸ“´ Connessione persa - ModalitÃ  offline', 'warning');
    }
  } else if (online && existingBar) {
    existingBar.remove();
    if (showToast) {
      window.showToast?.('âœ… Connessione ripristinata', 'success');
      syncOfflineTimbrature();
      setTimeout(loadTimbrature, 1000);
    }
  }
  
  isReallyOnline = online;
}

// Check iniziale - senza toast
checkRealOnlineStatus().then(online => updateOnlineUI(online, false));

// NON usiamo piÃ¹ window.addEventListener('online'/'offline') perchÃ© 
// navigator.onLine dÃ  falsi positivi/negativi con CDN esterni che falliscono

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA INSTALL PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] beforeinstallprompt event fired');
    e.preventDefault();
    deferredInstallPrompt = e;
    
    // Mostra il banner
    if (!localStorage.getItem('pwa-install-dismissed')) {
        showPwaInstallBanner();
    }
    // Mostra pulsante nel menu se esiste
    const menuBtn = document.getElementById('pwa-install-menu-item');
    if (menuBtn) menuBtn.style.display = 'block';
});

window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredInstallPrompt = null;
    hidePwaInstallBanner();
});

function showPwaInstallBanner() {
    hidePwaInstallBanner();
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.innerHTML = `
        <div style="position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                    color: white; padding: 16px 20px; border-radius: 12px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;
                    display: flex; align-items: center; gap: 12px; max-width: 90vw;
                    font-family: system-ui, -apple-system, sans-serif;">
            <div style="font-size: 28px;">ðŸ“±</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 2px;">Installa JobLog</div>
                <div style="font-size: 13px; opacity: 0.9;">Accesso rapido dalla Home</div>
            </div>
            <button onclick="installPwa()" style="background: white; color: #16a34a; border: none; 
                    padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Installa
            </button>
            <button onclick="dismissPwaInstall()" style="background: transparent; border: none; 
                    color: white; opacity: 0.7; cursor: pointer; padding: 4px; font-size: 18px;">
                âœ•
            </button>
        </div>
    `;
    document.body.appendChild(banner);
}

function hidePwaInstallBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.remove();
}

// Rileva iOS
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// Rileva se Ã¨ giÃ  installata come PWA
function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

function showIOSInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'ios-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“²</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su iPhone/iPad</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il pulsante Condividi
                            </div>
                            <div style="font-size: 36px;">
                                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16,6 12,2 8,6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                In basso nella barra di Safari
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Scorri e tocca
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">âž•</span>
                                <span style="font-weight: 600;">Aggiungi a Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">âœ“</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma con "Aggiungi"
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparirÃ  nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissIOSInstallModal()" 
                            style="width: 100%; padding: 14px; background: #007AFF; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function installPwa() {
    // Se siamo giÃ  in standalone mode, l'app Ã¨ giÃ  installata
    if (isStandalone()) {
        alert('âœ… JobLog Ã¨ giÃ  installata!');
        return;
    }
    
    // Se abbiamo il prompt nativo (Android/Desktop Chrome)
    if (deferredInstallPrompt) {
        hidePwaInstallBanner();
        deferredInstallPrompt.prompt();
        const { outcome } = await deferredInstallPrompt.userChoice;
        console.log('[PWA] User choice:', outcome);
        deferredInstallPrompt = null;
        return;
    }
    
    // Se siamo su iOS, mostra istruzioni specifiche
    if (isIOS()) {
        showIOSInstallInstructions();
        return;
    }
    
    // Se siamo su Android senza prompt nativo
    if (isAndroid()) {
        showAndroidInstallInstructions();
        return;
    }
    
    // Fallback per desktop
    alert('Per installare l\'app:\n\nðŸ’» Desktop Chrome: Icona + nella barra indirizzi');
}

function dismissPwaInstall() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    hidePwaInstallBanner();
}

function dismissIOSInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('ios-install-modal');
    if (modal) modal.remove();
}

function dismissAndroidInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('android-install-modal');
    if (modal) modal.remove();
}

// Rileva Android
function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function showAndroidInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'android-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">ðŸ“²</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su Android</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il menu di Chrome
                            </div>
                            <div style="font-size: 36px; color: #333;">â‹®</div>
                            <div style="font-size: 13px; color: #64748b;">
                                I tre puntini in alto a destra
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca "Installa app" o
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">ðŸ“¥</span>
                                <span style="font-weight: 600;">Aggiungi a schermata Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #16a34a; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">âœ“</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma l'installazione
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparirÃ  nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissAndroidInstallModal()" 
                            style="width: 100%; padding: 14px; background: #22c55e; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Mostra pulsante installazione e guida automatica
document.addEventListener('DOMContentLoaded', () => {
    const menuBtn = document.getElementById('pwa-install-menu-item');
    
    // Se non Ã¨ giÃ  installata come standalone
    if (!isStandalone()) {
        // Mostra pulsante nel menu per iOS e Android
        if (menuBtn && (isIOS() || isAndroid())) {
            menuBtn.style.display = 'flex';
        }
        
        // Mostra automaticamente la guida al primo accesso
        if (!localStorage.getItem('pwa-install-dismissed')) {
            setTimeout(() => {
                if (isIOS()) {
                    showIOSInstallInstructions();
                } else if (isAndroid() && !deferredInstallPrompt) {
                    showAndroidInstallInstructions();
                }
            }, 1500);
        }
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERTIME (STRAORDINARI) - Check automatico dopo checkout
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function checkOvertimeAfterCheckout(sessionId) {
    try {
        // Prendi inizio e fine giornata dalla variabile globale todayTimbrature
        const today = new Date().toISOString().split('T')[0];
        
        // todayTimbrature Ã¨ giÃ  caricato dalla loadTimbrature()
        if (!todayTimbrature || todayTimbrature.length === 0) return;
        
        // Trova orari inizio/fine giornata di oggi
        const inizio = todayTimbrature.find(t => t.tipo === 'inizio_giornata');
        const fine = todayTimbrature.find(t => t.tipo === 'fine_giornata');
        
        if (!inizio || !fine) return;
        
        // Estrai l'ora (puÃ² essere oggetto o stringa)
        const getTimeStr = (t) => {
            if (!t.ora) return null;
            if (typeof t.ora === 'string') return t.ora.substring(0, 5);
            if (t.ora.hour !== undefined) return `${String(t.ora.hour).padStart(2,'0')}:${String(t.ora.minute || 0).padStart(2,'0')}`;
            return String(t.ora).substring(0, 5);
        };
        
        const actualStart = getTimeStr(inizio);
        const actualEnd = getTimeStr(fine);
        
        if (!actualStart || !actualEnd) return;
        
        const res = await fetch(`/api/user/check-overtime?date=${today}&actual_start=${actualStart}&actual_end=${actualEnd}&session_id=${sessionId || ''}`);
        const data = await res.json();
        
        if (data.overtime_detected) {
            showOvertimeModal(data);
        }
    } catch (err) {
        console.error('Errore check overtime:', err);
    }
}

function showOvertimeModal(overtimeData) {
    // Rimuovi modal esistente se presente
    const existingModal = document.getElementById('overtimeModal');
    if (existingModal) existingModal.remove();
    
    const hours = Math.floor(overtimeData.total_extra_minutes / 60);
    const mins = overtimeData.total_extra_minutes % 60;
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} minuti`;
    
    const typeLabels = {
        before_shift: 'Prima del turno',
        after_shift: 'Dopo il turno',
        both: 'Prima e dopo il turno',
        extra_day: 'Giornata extra'
    };
    
    const modal = document.createElement('div');
    modal.id = 'overtimeModal';
    modal.innerHTML = `
        <style>
            #overtimeModal {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #overtimeModal .modal-content {
                background: white;
                border-radius: 20px;
                max-width: 400px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #overtimeModal .modal-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 2rem;
            }
            #overtimeModal h3 {
                margin: 0 0 12px;
                font-size: 1.3rem;
            }
            #overtimeModal .time-highlight {
                background: #fef3c7;
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
            }
            #overtimeModal .time-highlight .value {
                font-size: 2rem;
                font-weight: 700;
                color: #92400e;
            }
            #overtimeModal .time-highlight .label {
                font-size: 0.85rem;
                color: #78350f;
            }
            #overtimeModal .details {
                text-align: left;
                font-size: 0.9rem;
                color: #64748b;
                margin: 16px 0;
            }
            #overtimeModal .details .row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #f1f5f9;
            }
            #overtimeModal textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 0.9rem;
                resize: none;
                margin-bottom: 16px;
            }
            #overtimeModal textarea:focus {
                outline: none;
                border-color: #4361ee;
            }
            #overtimeModal .btn-row {
                display: flex;
                gap: 12px;
            }
            #overtimeModal button {
                flex: 1;
                padding: 14px;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                border: none;
            }
            #overtimeModal .btn-cancel {
                background: #f1f5f9;
                color: #64748b;
            }
            #overtimeModal .btn-confirm {
                background: linear-gradient(135deg, #4361ee, #7c3aed);
                color: white;
            }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div class="modal-content">
            <div class="modal-icon">â±ï¸</div>
            <h3>Extra Turno Rilevato</h3>
            <p style="color:#64748b;margin:0 0 16px;">Hai lavorato oltre il turno pianificato</p>
            
            <div class="time-highlight">
                <div class="value">${timeStr}</div>
                <div class="label">${typeLabels[overtimeData.overtime_type] || 'Extra Turno'}</div>
            </div>
            
            <div class="details">
                <div class="row">
                    <span>Turno pianificato</span>
                    <strong>${overtimeData.planned_start || '--'} - ${overtimeData.planned_end || '--'}</strong>
                </div>
                <div class="row">
                    <span>Timbrate originali</span>
                    <strong>${overtimeData.actual_start} - ${overtimeData.actual_end}</strong>
                </div>
                <div class="row" style="background:#fef3c7;margin:0 -8px;padding:8px;border-radius:6px;">
                    <span>Timbrate arrotondate</span>
                    <strong style="color:#92400e;">${overtimeData.rounded_start || overtimeData.actual_start} - ${overtimeData.rounded_end || overtimeData.actual_end}</strong>
                </div>
            </div>
            
            <textarea id="overtimeNotes" placeholder="Inserisci una motivazione..." rows="2" required></textarea>
            <div style="font-size:0.75rem;color:#ef4444;margin:-8px 0 8px;" id="notesError" hidden>âš ï¸ La motivazione Ã¨ obbligatoria</div>
            
            <div class="btn-row">
                <button class="btn-confirm" onclick="submitOvertimeRequest()">Conferma</button>
            </div>
        </div>
    `;
    
    // Salva dati per submit
    modal.dataset.overtimeData = JSON.stringify(overtimeData);
    
    document.body.appendChild(modal);
    
    // Modal obbligatorio - non chiudibile cliccando fuori
}

function closeOvertimeModal() {
    const modal = document.getElementById('overtimeModal');
    if (modal) modal.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP EXTRA TURNO (mostrato dopo timbratura con Extra Turno rilevato)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showExtraTurnoPopup(extraTurnoData, tipo) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('extraTurnoPopup');
    if (existingPopup) existingPopup.remove();
    
    const minutes = extraTurnoData.minutes || 0;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} minuti`;
    
    const typeLabels = {
        before_shift: 'Ingresso anticipato',
        after_shift: 'Uscita posticipata'
    };
    const typeLabel = typeLabels[extraTurnoData.type] || 'Extra Turno';
    
    const tipoLabel = tipo === 'inizio_giornata' ? 'Inizio Giornata' : 'Fine Giornata';
    
    const requestId = extraTurnoData.request_id || null;
    
    const popup = document.createElement('div');
    popup.id = 'extraTurnoPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #extraTurnoPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #extraTurnoPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #extraTurnoPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #10b981, #059669);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #extraTurnoPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #extraTurnoPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #extraTurnoPopup .time-box {
                background: linear-gradient(135deg, #ecfdf5, #d1fae5);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
            }
            #extraTurnoPopup .time-box .value {
                font-size: 2rem;
                font-weight: 700;
                color: #047857;
            }
            #extraTurnoPopup .time-box .label {
                font-size: 0.85rem;
                color: #065f46;
                margin-top: 4px;
            }
            #extraTurnoPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #f59e0b;
            }
            #extraTurnoPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #extraTurnoPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #extraTurnoPopup .motivation-label .required {
                color: #ef4444;
            }
            #extraTurnoPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #extraTurnoPopup .motivation-input:focus {
                outline: none;
                border-color: #10b981;
            }
            #extraTurnoPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #extraTurnoPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #extraTurnoPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #extraTurnoPopup .btn-ok:active {
                transform: scale(0.98);
            }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div class="popup-content">
            <div class="popup-icon">â±ï¸</div>
            <h3>Extra Turno Rilevato!</h3>
            <p class="subtitle">${tipoLabel} registrata con successo</p>
            
            <div class="time-box">
                <div class="value">${timeStr}</div>
                <div class="label">${typeLabel}</div>
            </div>
            
            <div class="info-text">
                â³ Ãˆ stata creata automaticamente una richiesta di Extra Turno. 
                VerrÃ  inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivazione <span class="required">*</span>
                </label>
                <textarea id="extraTurnoMotivation" class="motivation-input" 
                    rows="3" placeholder="Indica il motivo dell'extra turno..." 
                    maxlength="500"></textarea>
                <div id="extraTurnoMotivationError" class="error-msg">
                    La motivazione Ã¨ obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitExtraTurnoMotivation()">Conferma</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('extraTurnoMotivation')?.focus();
    }, 300);
}

function closeExtraTurnoPopup() {
    const popup = document.getElementById('extraTurnoPopup');
    if (popup) popup.remove();
}

async function submitExtraTurnoMotivation() {
    const popup = document.getElementById('extraTurnoPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('extraTurnoMotivation');
    const errorMsg = document.getElementById('extraTurnoMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione
    if (!motivation) {
        motivationInput.classList.add('error');
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeExtraTurnoPopup();
            showToast('âœ… Motivazione salvata', 'success');
            await loadTimbrature();
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio motivazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio motivazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPUP FUORI FLESSIBILITÃ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showFlexWarningPopup(flexData) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('flexWarningPopup');
    if (existingPopup) existingPopup.remove();
    
    const message = flexData.message || 'Timbratura fuori flessibilitÃ ';
    const requestId = flexData.request_id || null;
    const tipoLabel = flexData.tipo === 'inizio_giornata' ? 'Ingresso' : 'Uscita';
    
    const popup = document.createElement('div');
    popup.id = 'flexWarningPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #flexWarningPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #flexWarningPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #flexWarningPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #flexWarningPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #flexWarningPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #flexWarningPopup .warning-box {
                background: linear-gradient(135deg, #fef3c7, #fde68a);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
                border-left: 4px solid #f59e0b;
            }
            #flexWarningPopup .warning-box .message {
                font-size: 0.95rem;
                color: #92400e;
                font-weight: 500;
            }
            #flexWarningPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #f59e0b;
            }
            #flexWarningPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #flexWarningPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #flexWarningPopup .motivation-label .required {
                color: #ef4444;
            }
            #flexWarningPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #flexWarningPopup .motivation-input:focus {
                outline: none;
                border-color: #f59e0b;
            }
            #flexWarningPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #flexWarningPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #flexWarningPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #flexWarningPopup .btn-ok:active {
                transform: scale(0.98);
            }
        </style>
        <div class="popup-content">
            <div class="popup-icon">âš ï¸</div>
            <h3>Fuori FlessibilitÃ </h3>
            <p class="subtitle">${tipoLabel} registrato oltre l'orario consentito</p>
            
            <div class="warning-box">
                <div class="message">${message}</div>
            </div>
            
            <div class="info-text">
                â³ Ãˆ stata creata automaticamente una richiesta di autorizzazione. 
                VerrÃ  inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivazione <span class="required">*</span>
                </label>
                <textarea id="flexWarningMotivation" class="motivation-input" 
                    rows="3" placeholder="Indica il motivo della timbratura fuori orario..." 
                    maxlength="500"></textarea>
                <div id="flexWarningMotivationError" class="error-msg">
                    La motivazione Ã¨ obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitFlexWarningMotivation()">Conferma</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('flexWarningMotivation')?.focus();
    }, 300);
}

function closeFlexWarningPopup() {
    const popup = document.getElementById('flexWarningPopup');
    if (popup) popup.remove();
}

async function submitFlexWarningMotivation() {
    const popup = document.getElementById('flexWarningPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('flexWarningMotivation');
    const errorMsg = document.getElementById('flexWarningMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione
    if (!motivation) {
        motivationInput.classList.add('error');
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeFlexWarningPopup();
            showToast('âœ… Motivazione salvata', 'success');
            await loadTimbrature();
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio motivazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio motivazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LATE ARRIVAL (Ritardo) - Modal per giustificazione
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pendingProductionActivity = null; // AttivitÃ  da mostrare dopo chiusura popup ritardo

function showLateArrivalPopup(lateData) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('lateArrivalPopup');
    if (existingPopup) existingPopup.remove();
    
    const lateMinutes = lateData.late_minutes || 0;
    const turnoStart = lateData.turno_start || '';
    const requestId = lateData.request_id || null;
    
    const popup = document.createElement('div');
    popup.id = 'lateArrivalPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #lateArrivalPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #lateArrivalPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #lateArrivalPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #lateArrivalPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #lateArrivalPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #lateArrivalPopup .late-box {
                background: linear-gradient(135deg, #fee2e2, #fecaca);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
                border-left: 4px solid #dc2626;
            }
            #lateArrivalPopup .late-box .time {
                font-size: 1.8rem;
                font-weight: 700;
                color: #991b1b;
                margin-bottom: 4px;
            }
            #lateArrivalPopup .late-box .message {
                font-size: 0.9rem;
                color: #7f1d1d;
            }
            #lateArrivalPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #dc2626;
            }
            #lateArrivalPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #lateArrivalPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #lateArrivalPopup .motivation-label .required {
                color: #ef4444;
            }
            #lateArrivalPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #lateArrivalPopup .motivation-input:focus {
                outline: none;
                border-color: #dc2626;
            }
            #lateArrivalPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #lateArrivalPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #lateArrivalPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #lateArrivalPopup .btn-ok:active {
                transform: scale(0.98);
            }
        </style>
        <div class="popup-content">
            <div class="popup-icon">â°</div>
            <h3>Ritardo Rilevato</h3>
            <p class="subtitle">Ingresso oltre l'orario previsto</p>
            
            <div class="late-box">
                <div class="time">+${lateMinutes} min</div>
                <div class="message">Orario previsto: ${turnoStart}</div>
            </div>
            
            <div class="info-text">
                ðŸ“ Ãˆ richiesta una giustificazione per il ritardo. 
                La richiesta verrÃ  inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivo del ritardo <span class="required">*</span>
                </label>
                <textarea id="lateArrivalMotivation" class="motivation-input" 
                    rows="3" placeholder="Es: Traffico intenso, problema con i mezzi pubblici..." 
                    maxlength="500"></textarea>
                <div id="lateArrivalMotivationError" class="error-msg">
                    La motivazione Ã¨ obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitLateArrivalMotivation()">Conferma Giustificazione</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('lateArrivalMotivation')?.focus();
    }, 300);
}

function closeLateArrivalPopup() {
    const popup = document.getElementById('lateArrivalPopup');
    if (popup) popup.remove();
}

async function submitLateArrivalMotivation() {
    const popup = document.getElementById('lateArrivalPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('lateArrivalMotivation');
    const errorMsg = document.getElementById('lateArrivalMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione
    if (!motivation) {
        motivationInput.classList.add('error');
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeLateArrivalPopup();
            showToast('âœ… Giustificazione salvata', 'success');
            await loadTimbrature();
            // Mostra popup attivitÃ  di produzione se era in attesa
            if (_pendingProductionActivity) {
                const activity = _pendingProductionActivity;
                _pendingProductionActivity = null;
                setTimeout(() => showProductionActivityPopup(activity), 500);
            }
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio giustificazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio giustificazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function submitOvertimeRequest() {
    const modal = document.getElementById('overtimeModal');
    if (!modal) return;
    
    const data = JSON.parse(modal.dataset.overtimeData || '{}');
    const notes = document.getElementById('overtimeNotes')?.value.trim() || '';
    const notesError = document.getElementById('notesError');
    
    // Validazione note obbligatorie
    if (!notes) {
        notesError.hidden = false;
        document.getElementById('overtimeNotes').focus();
        return;
    }
    notesError.hidden = true;
    
    const btn = modal.querySelector('.btn-confirm');
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        const res = await fetch('/api/user/overtime', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: data.date,
                session_id: data.session_id,
                planning_id: data.planning_id,
                shift_source: data.shift_source,
                planned_start: data.planned_start,
                planned_end: data.planned_end,
                actual_start: data.actual_start,
                actual_end: data.actual_end,
                rounded_start: data.rounded_start,
                rounded_end: data.rounded_end,
                extra_minutes_before: data.extra_minutes_before || 0,
                extra_minutes_after: data.extra_minutes_after || 0,
                total_extra_minutes: data.total_extra_minutes,
                overtime_type: data.overtime_type,
                notes: notes
            })
        });
        
        const result = await res.json();
        
        if (result.ok) {
            closeOvertimeModal();
            showToast('âœ… Richiesta Extra Turno inviata', 'success');
            // Ricarica le timbrature per mostrare il badge "in attesa"
            await loadTimbrature();
        } else {
            showToast(result.error || 'Errore invio richiesta', 'error');
            btn.disabled = false;
            btn.textContent = 'Richiedi';
        }
    } catch (err) {
        console.error('Errore submit overtime:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = 'Richiedi';
    }
}
</script>
</body>
</html>
