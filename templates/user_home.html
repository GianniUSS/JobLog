<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#667eea" />
<link rel="manifest" href="/static/manifest.json" />
<link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<title>Timbratura - JOBLog</title>
<style>
:root {
  --bg: #f0f2f5;
  --bg-card: #ffffff;
  --bg-card-hover: #f8fafc;
  --brand: #667eea;
  --brand-light: #818cf8;
  --brand-dark: #4f46e5;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --green: #22c55e;
  --green-dark: #16a34a;
  --red: #ef4444;
  --red-dark: #dc2626;
  --success: #10b981;
  --success-bg: #d1fae5;
  --warning: #f59e0b;
  --warning-bg: #fef3c7;
  --danger: #ef4444;
  --danger-bg: #fee2e2;
  --orange: #f97316;
  --orange-light: #fed7aa;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow: rgba(0,0,0,0.1);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --radius: 16px;
  --radius-sm: 10px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
[data-theme="dark"] {
  --bg: #0f172a;
  --bg-card: #1e293b;
  --bg-card-hover: #334155;
  --brand: #818cf8;
  --brand-light: #a5b4fc;
  --brand-dark: #6366f1;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #334155;
  --border-light: #1e293b;
  --success-bg: rgba(16, 185, 129, 0.2);
  --warning-bg: rgba(245, 158, 11, 0.2);
  --danger-bg: rgba(239, 68, 68, 0.2);
  --shadow: rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html {
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh;
  touch-action: manipulation;
  -webkit-overflow-scrolling: touch;
}

/* Main Header with Gradient */
.main-header {
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
  padding: calc(var(--safe-top) + 20px) 20px 20px;
  position: relative;
}
.main-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  pointer-events: none;
}
.main-header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
}
.main-header-title {
  flex: 1;
  text-align: center;
}
.main-header-title h1 {
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 2px;
}
.main-header-title p {
  color: rgba(255,255,255,0.8);
  font-size: 0.875rem;
}
.main-header-spacer {
  width: 44px;
  height: 44px;
  flex-shrink: 0;
}

.refresh-btn {
  width: 44px;
  height: 44px;
  border-radius: 14px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 1.1rem;
}

.refresh-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}

.refresh-btn.loading i {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.container {
  max-width: 420px;
  margin: 0 auto;
  padding: 8px 16px 16px;
  padding-bottom: calc(80px + var(--safe-bottom));
}
header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0 16px;
}
.header-info {
  flex: 1;
  text-align: center;
}
.header-title {
  font-size: 20px;
  font-weight: 700;
}
.header-date {
  font-size: 13px;
  color: var(--text-secondary);
}
.clock-section {
  text-align: center;
  padding: 0;
}
.clock {
  font-size: 42px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: -1px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.clock-icon {
  display: inline-block;
  font-size: 28px;
  animation: clockTick 2s ease-in-out infinite;
}
@keyframes clockTick {
  0%, 100% { transform: rotate(0deg); }
  10% { transform: rotate(8deg); }
  20% { transform: rotate(0deg); }
}

/* Scanner Modal */
.scanner-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  padding-top: env(safe-area-inset-top, 20px);
  padding-bottom: env(safe-area-inset-bottom, 20px);
}
.scanner-modal.active {
  display: flex;
}
.scanner-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.scanner-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.scanner-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}
#qr-reader {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  min-height: 280px;
}
#qr-reader video {
  border-radius: 12px;
  width: 100% !important;
  height: auto !important;
}
#qr-reader__scan_region {
  min-height: 250px;
}
.scanner-close {
  padding: 14px 32px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 48px;
  touch-action: manipulation;
}

/* Method Choice Modal */
.method-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.method-modal.active {
  display: flex;
}
.method-container {
  background: var(--bg-card);
  border-radius: 20px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.method-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.method-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}
.method-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}
.method-btn {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px 20px;
  border: 2px solid var(--border);
  border-radius: 14px;
  background: var(--bg-card);
  cursor: pointer;
  transition: all 0.2s ease;
}
.method-btn:hover {
  border-color: var(--brand);
  background: rgba(102, 126, 234, 0.1);
}
.method-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.method-btn-icon {
  font-size: 32px;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  border-radius: 12px;
}
.method-btn-content {
  text-align: left;
  flex: 1;
}
.method-btn-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}
.method-btn-desc {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.method-cancel {
  padding: 12px 24px;
  background: var(--bg);
  color: var(--text-secondary);
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* GPS Modal */
.gps-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.gps-modal.active {
  display: flex;
}
.gps-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.gps-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.gps-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.gps-location-name {
  font-size: 15px;
  color: var(--text-primary);
  padding: 10px 16px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.1) 100%);
  border-radius: 10px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.gps-location-list {
  display: flex;
  flex-direction: column;
  gap: 5px;
  width: 100%;
  text-align: left;
}
.gps-location-item {
  background: rgba(0,0,0,0.03);
  padding: 7px 10px;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* Fullscreen GPS modal */
.gps-modal.active .gps-container {
  max-width: none;
  width: 100%;
  height: 100vh;
  border-radius: 0;
  padding: calc(var(--safe-top) + 20px) 20px 20px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  overflow: auto;
}
.gps-modal .gps-status {
  flex: 1 0 auto;
}
.gps-location-name .location-label {
  font-size: 18px;
}
.gps-status {
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  background: var(--bg);
}
.gps-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.gps-icon.loading {
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}
@keyframes pulseDot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.7); }
}
.gps-message {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.gps-accuracy {
  font-size: 12px;
  color: var(--text-muted);
}
.gps-accuracy.good { color: var(--green); }
.gps-accuracy.medium { color: var(--warning); }
.gps-accuracy.poor { color: var(--danger); }
.gps-tip {
  font-size: 11px;
  color: var(--text-secondary);
  display: block;
  margin-top: 4px;
}
.gps-buttons {
  display: flex;
  gap: 12px;
}
.gps-btn {
  flex: 1;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}
.gps-btn.primary {
  background: var(--green);
  color: white;
}
.gps-btn.primary:disabled {
  background: #64748b;
  cursor: not-allowed;
}
.gps-btn.secondary {
  background: var(--bg);
  color: var(--text-primary);
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}
.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 18px 24px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  color: white;
  min-height: 60px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.action-btn:active:not(:disabled) {
  transform: scale(0.98);
}
.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.action-btn.start {
  background: var(--green);
}
.action-btn.start:hover:not(:disabled),
.action-btn.start:active:not(:disabled) {
  background: var(--green-dark);
}
.action-btn.end {
  background: var(--red);
}
.action-btn.end:hover:not(:disabled),
.action-btn.end:active:not(:disabled) {
  background: var(--red-dark);
}
.action-btn .icon {
  font-size: 20px;
}
.action-btn .check {
  margin-left: auto;
  width: 24px;
  height: 24px;
  border: 2px solid rgba(255,255,255,0.5);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.action-btn .check.done {
  background: white;
  border-color: white;
  color: var(--green);
}
.pause-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.pause-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 16px;
  border: 2px solid var(--orange);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  min-height: 52px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s ease;
  background: var(--orange-light);
  color: #9a3412;
}
.pause-btn:hover:not(:disabled) {
  background: var(--orange);
  color: white;
}
.pause-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.pause-btn .icon {
  font-size: 18px;
}
.history-section {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 900;
  background: var(--bg-card);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  border-radius: 16px 16px 0 0;
}
.history-toggle {
  width: 100%;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  border: none;
  padding: 14px 20px;
  font-size: 15px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: #fff;
  border-radius: 16px 16px 0 0;
}
.history-toggle .history-arrow {
  margin-left: auto;
  font-size: 14px;
  transition: transform 0.3s ease;
  color: #fff;
}
.history-section.open .history-toggle .history-arrow {
  transform: rotate(180deg);
}
.history-content {
  max-height: 0;
  overflow-y: auto;
  transition: max-height 0.35s ease;
}
.history-section.open .history-content {
  max-height: 50vh;
  padding: 12px 16px 16px;
}
.history-spacer {
  height: 56px;
}
.history-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.history-list {
  list-style: none;
}
.history-item {
  display: flex;
  align-items: stretch;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  min-height: 50px;
}
.history-item > *:not(.location-badge):not(.overtime-badge) {
  display: flex;
  align-items: center;
}
.history-item:last-child {
  border-bottom: none;
}
.history-item .time {
  font-weight: 600;
  min-width: 55px;
  align-self: center;
  display: flex;
  flex-direction: column;
  line-height: 1.3;
  align-items: flex-start;
  justify-content: center;
}
.history-item .time .time-main {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
.history-item .time .ora-originale {
  opacity: 0.6;
  font-weight: 400;
  font-size: 12px;
  text-decoration: line-through;
}
.history-item .time .ora-mod {
  color: var(--green);
  font-weight: 700;
}
.history-item .pausa-durata {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 4px;
}
.history-item .pausa-durata .ora-mod {
  color: var(--green);
  font-weight: 600;
}
.history-item .pausa-durata-row {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 2px;
  margin-left: 0;
  display: block;
  width: 100%;
}
.history-item .pausa-durata-row .ora-mod {
  color: var(--green);
  font-weight: 600;
}
.history-item .type {
  color: var(--text-secondary);
  align-self: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.history-item .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  align-self: center;
}
.history-item .dot.start { background: var(--green); }
.history-item .dot.end { background: var(--red); }
.history-item .dot.pause { background: var(--orange); }

/* Sync status indicator */
.history-item .sync-status {
  margin-left: auto;
  font-size: 14px;
  align-self: center;
}
.history-item .sync-status.synced {
  color: var(--green);
  font-size: 12px;
}
.history-item .sync-status.pending {
  animation: pulse-cloud 1.5s ease-in-out infinite;
}
@keyframes pulse-cloud {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Overtime badge (straordinario in attesa) - riga separata */
.history-item.has-overtime {
  border-left: 3px solid #f59e0b;
  padding-left: 12px;
  margin-left: -3px;
}
.history-item.pending-confirmation {
  border-left: 3px solid #f97316;
}
.overtime-info-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0 6px 15px;
  margin-top: -8px;
  font-size: 12px;
  color: #92400e;
  background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
  border-bottom: 1px solid var(--border);
}
.overtime-info-row.pending-confirmation {
  background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
  color: #9a3412;
}
.overtime-info-row .overtime-icon {
  font-size: 14px;
}
.overtime-info-row .overtime-text {
  font-weight: 600;
}
.overtime-info-row .overtime-time {
  background: #fbbf24;
  color: #78350f;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 11px;
}

/* Late Arrival Request */
.late-arrival-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0 6px 15px;
  margin-top: -8px;
  font-size: 12px;
  border-bottom: 1px solid var(--border);
}
.late-arrival-row.pending-confirmation {
  background: linear-gradient(90deg, rgba(249, 115, 22, 0.15), transparent);
  color: #9a3412;
}
.late-arrival-row.approved {
  background: linear-gradient(90deg, rgba(34, 197, 94, 0.15), transparent);
  color: #166534;
}
.late-arrival-row.registered {
  background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
  color: #92400e;
}
.late-arrival-row .overtime-icon {
  font-size: 14px;
}
.late-arrival-row .overtime-text {
  font-weight: 600;
}

/* Location badge - chip grande con contenuto su 2 righe */
.history-item .location-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 42px;
  padding: 6px 14px;
  font-size: 11px;
  font-weight: 500;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-radius: 12px;
  margin-left: auto;
  max-width: 130px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  line-height: 1.2;
  text-align: center;
}
.history-item .location-badge .loc-icon {
  font-size: 14px;
  margin-bottom: 2px;
}
.history-item .location-badge .loc-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.history-item .method-badge {
  font-size: 12px;
  margin-left: 6px;
  align-self: center;
}
.history-item .method-badge.qr {
  opacity: 0.7;
}

/* Badge supervisor - per timbrature create dal caposquadra */
.history-item .supervisor-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  font-size: 10px;
  font-weight: 500;
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
  border-radius: 10px;
  margin-left: 6px;
  white-space: nowrap;
  box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
}

.history-item.offline-pending {
  background: rgba(245, 158, 11, 0.08);
  border-radius: 8px;
  padding-left: 10px;
  padding-right: 10px;
  margin: 2px -10px;
}

.empty-history {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
  font-size: 14px;
}
.user-badge {
  position: fixed;
  bottom: calc(16px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  padding: 10px 20px;
  border-radius: 24px;
  box-shadow: 0 4px 20px var(--shadow);
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 100;
}
.user-badge .avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--green);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}
.logout-link {
  color: var(--red);
  text-decoration: none;
  margin-left: 4px;
  font-size: 18px;
  padding: 4px;
  touch-action: manipulation;
}
.toast {
  position: fixed;
  top: calc(20px + env(safe-area-inset-top, 0px));
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--bg-card);
  padding: 14px 24px;
  border-radius: 12px;
  box-shadow: 0 8px 32px var(--shadow);
  font-weight: 600;
  z-index: 1001;
  transition: transform 0.3s ease, opacity 0.3s ease;
  max-width: calc(100vw - 40px);
  text-align: center;
  opacity: 0;
  pointer-events: none;
}
.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  pointer-events: auto;
}
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.toast.warning { border-left: 4px solid var(--yellow); }

/* Offline Status Bar */
.offline-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
  color: white;
  padding: 8px 16px;
  text-align: center;
  font-weight: 600;
  font-size: 13px;
  z-index: 1100;
}

/* Box Turno */
.turno-box {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 18px;
  padding: 14px 16px;
  margin-bottom: 16px;
  color: white;
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.35);
  position: relative;
  overflow: hidden;
}
.turno-box * {
  color: white !important;
}
.turno-box::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}
.turno-box.no-turno {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  box-shadow: 0 8px 24px rgba(100, 116, 139, 0.35);
}
.turno-nav {
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  z-index: 2;
}
.turno-nav-btn {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.4);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.turno-nav-btn:hover {
  background: rgba(255,255,255,0.35);
  border-color: rgba(255,255,255,0.6);
  transform: scale(1.08) translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}
.turno-nav-btn:active {
  transform: scale(0.93);
}
.turno-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
.turno-nav-btn:disabled:hover {
  background: rgba(255,255,255,0.25);
  border-color: rgba(255,255,255,0.4);
  transform: none;
}
.turno-content {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}
.turno-counter {
  position: absolute;
  top: 12px;
  right: 16px;
  background: rgba(255,255,255,0.3);
  backdrop-filter: blur(10px);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  z-index: 3;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.turno-header {
  display: none; /* Rimosso - ora usiamo direttamente il nome progetto */
}
.turno-project {
  font-size: 15px;
  font-weight: 800;
  margin-bottom: 6px;
  line-height: 1.25;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 2;
  position: relative;
  letter-spacing: -0.3px;
}
.turno-badges-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.turno-badge-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}
.turno-badge-pausa {
  background: rgba(255,140,0,0.9);
  color: white;
}
.turno-badge-note {
  background: rgba(255,193,7,0.9);
  color: #333;
  animation: pulse-note 2s infinite;
}
.turno-badge-note:hover {
  background: rgba(255,193,7,1);
  transform: scale(1.05);
}
.turno-details {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px;
  font-size: 14px;
  opacity: 0.95;
  z-index: 2;
  position: relative;
}
.turno-detail {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.25);
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  white-space: nowrap;
}
.turno-detail .icon {
  font-size: 0.9rem;
  flex-shrink: 0;
}
.turno-detail-row {
  grid-column: 1;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 10px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  font-size: 14px;
  border-radius: 6px;
}
.turno-pausa-badge {
  display: none; /* Ora gestito tramite turno-badges-row */
}
.turno-note-btn {
  display: none; /* Ora gestito tramite turno-badges-row */
}
@keyframes pulse-note {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255,193,7,0.4); }
  50% { box-shadow: 0 0 0 8px rgba(255,193,7,0); }
}
/* Modal Note Turno */
.note-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.note-modal.open {
  display: flex;
}
.note-container {
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border-radius: 20px;
  padding: 24px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.1);
}
.note-title {
  font-size: 20px;
  font-weight: 700;
  color: white;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.note-section {
  background: rgba(255,255,255,0.08);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}
.note-section-label {
  font-size: 11px;
  font-weight: 700;
  color: rgba(255,255,255,0.5);
  text-transform: uppercase;
  margin-bottom: 6px;
}
.note-section-text {
  font-size: 14px;
  color: white;
  line-height: 1.5;
  white-space: pre-wrap;
}
.note-close {
  width: 100%;
  padding: 14px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.2s ease;
}
.note-close:hover {
  background: rgba(255,255,255,0.2);
}
.turno-timbratura {
  width: 100%;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 9px 11px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.25);
  font-weight: 600;
  grid-column: 1;
}
.turno-timbratura .icon {
  font-size: 16px;
  flex-shrink: 0;
}
.turno-timbratura.no-gps {
  background: rgba(239, 68, 68, 0.4);
  border-color: rgba(239, 68, 68, 0.5);
}
.turno-timbratura.inline-location {
  display: flex !important;
  flex-wrap: wrap;
  gap: 8px;
  background: none !important;
  border: none !important;
  padding: 0 !important;
  align-items: flex-start;
}
.location-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
  flex: 1 1 auto;
  background: rgba(255, 255, 255, 0.15);
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid rgba(255, 255, 255, 0.25);
}
.location-item .icon {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.6rem;
  flex-shrink: 0;
}
.location-item .value {
  font-weight: 600;
  color: rgba(255, 255, 255, 0.95);
  font-size: 14px;
  white-space: nowrap;
}
/* Container e bottoni azione inline (Sedi + Info) */
.action-chips {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 0;
}
.action-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 6px 10px;
  border-radius: 6px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  color: rgba(255,255,255,0.8);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  text-align: center;
  transition: background 0.15s;
}
.action-chip:active {
  background: rgba(255,255,255,0.25);
}
.action-chip .icon {
  font-size: 0.9rem;
  flex-shrink: 0;
}
.action-chip b { font-weight: 700; }
/* Pulsante "Sedi" per aprire popup sedi valide */
.valid-locations-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 700;
  background: rgba(255,255,255,0.18);
  border: 1px solid rgba(255,255,255,0.3);
  color: rgba(255,255,255,0.95);
  cursor: pointer;
  white-space: nowrap;
  transition: background 0.15s;
}
.valid-locations-btn:active {
  background: rgba(255,255,255,0.3);
}
/* Popup sedi valide */
.valid-locations-popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 9998;
  display: none;
}
.valid-locations-popup-overlay.active { display: block; }
.valid-locations-popup {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  padding: 18px 20px 14px;
  min-width: 250px;
  max-width: 90vw;
  display: none;
}
.valid-locations-popup.active { display: block; }
.valid-locations-popup h4 {
  margin: 0 0 10px;
  font-size: 14px;
  font-weight: 700;
  color: #333;
}
.valid-locations-popup ul {
  list-style: none;
  margin: 0;
  padding: 0;
}
.valid-locations-popup li {
  padding: 7px 10px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  color: #333;
  background: #f3f4f6;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.valid-locations-popup li:last-child { margin-bottom: 0; }
.valid-locations-popup .close-btn {
  display: block;
  margin: 10px auto 0;
  padding: 6px 20px;
  border: none;
  border-radius: 8px;
  background: #4f46e5;
  color: #fff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
[data-theme="dark"] .valid-locations-popup {
  background: #1e293b;
}
[data-theme="dark"] .valid-locations-popup h4 { color: #e2e8f0; }
[data-theme="dark"] .valid-locations-popup li {
  background: rgba(255,255,255,0.08);
  color: #e2e8f0;
}
.turno-badge {
  display: inline-block;
  background: rgba(251, 191, 36, 0.25);
  border: 1px solid rgba(251, 191, 36, 0.5);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  margin-top: 6px;
  z-index: 2;
  position: relative;
}
.turno-badge.leader {
  background: #fbbf24;
  color: #92400e;
  border: none;
}
.turno-loading {
  text-align: center;
  padding: 12px;
  font-size: 13px;
  opacity: 0.85;
  z-index: 2;
  position: relative;
}

/* Fasi turno */
.turno-phases-box {
  background: var(--card-bg, #fff);
  border-radius: 16px;
  padding: 14px 16px;
  margin: -4px 0 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid var(--border, #e5e7eb);
}
.turno-phases-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.turno-phases-icon { font-size: 16px; }
.turno-phases-title {
  font-weight: 700;
  font-size: 14px;
  flex: 1;
  color: var(--text, #1a1a2e);
}
.turno-phases-counter {
  font-size: 12px;
  font-weight: 600;
  color: var(--brand, #4361ee);
  background: rgba(67,97,238,0.1);
  padding: 2px 8px;
  border-radius: 10px;
}
.turno-phases-bar {
  height: 6px;
  background: #e9ecef;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 10px;
}
.turno-phases-fill {
  height: 100%;
  background: linear-gradient(90deg, #4361ee, #2ecc71);
  border-radius: 3px;
  transition: width 0.3s ease;
}
.turno-phases-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.turno-phase-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--bg-hover, #f8f9fa);
  border-radius: 10px;
  border: 1px solid var(--border-light, #e9ecef);
  cursor: pointer;
  transition: all 0.15s ease;
  -webkit-tap-highlight-color: transparent;
}
.turno-phase-item:active {
  transform: scale(0.98);
}
.turno-phase-item.completed {
  background: rgba(46,204,113,0.08);
  border-color: rgba(46,204,113,0.25);
}
.turno-phase-item .phase-num {
  width: 28px;
  height: 28px;
  background: var(--brand, #4361ee);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}
.turno-phase-item.completed .phase-num {
  background: #2ecc71;
}
.turno-phase-item .phase-label {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}
.turno-phase-item .phase-check {
  font-size: 20px;
}
.turno-phase-item .phase-by {
  font-size: 11px;
  color: var(--muted, #888);
}

/* Info Button */
.turno-info-btn {
  position: absolute;
  bottom: 10px;
  right: 12px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1.5px solid rgba(255,255,255,0.35);
  color: white;
  padding: 5px 12px;
  border-radius: 14px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.3px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  z-index: 3;
  transition: background 0.2s, transform 0.15s;
  white-space: nowrap;
}
.turno-info-btn:hover, .turno-info-btn:active {
  background: rgba(255,255,255,0.35);
  transform: scale(1.03);
}

/* Crew Info Modal */
.crew-info-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.crew-info-overlay.active {
  display: flex;
}
.crew-info-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 420px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: crewInfoSlideIn 0.3s ease;
}
@keyframes crewInfoSlideIn {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.crew-info-modal * {
  color: inherit !important;
}
.crew-info-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 18px 18px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.crew-info-header * {
  color: white !important;
}
.crew-info-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}
.crew-info-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white !important;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.crew-info-close:hover {
  background: rgba(255,255,255,0.35);
}
.crew-info-body {
  padding: 16px 20px;
}
.crew-info-section {
  margin-bottom: 16px;
}
.crew-info-section:last-child {
  margin-bottom: 0;
}
.crew-info-section-title {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.crew-member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border-radius: 10px;
  margin-bottom: 4px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
}
.crew-member-item.is-me {
  background: #eff6ff;
  border-color: #bfdbfe;
}
.crew-member-item.is-leader {
  background: #fffbeb;
  border-color: #fbbf24;
  border-width: 2px;
}
.crew-member-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  color: #64748b;
  flex-shrink: 0;
}
.crew-member-item.is-me .crew-member-avatar {
  background: #3b82f6;
  color: white;
}
.crew-member-item.is-leader .crew-member-avatar {
  background: #fbbf24;
  color: white;
}
.crew-member-info {
  flex: 1;
  min-width: 0;
}
.crew-member-name {
  font-weight: 600;
  font-size: 14px;
  color: #1e293b;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.crew-member-role {
  font-size: 11px;
  color: #94a3b8;
}
.crew-member-time {
  font-size: 12px;
  color: #64748b;
  font-weight: 600;
  white-space: nowrap;
}
.crew-leader-badge {
  display: inline-block;
  background: #fbbf24;
  color: #92400e;
  font-size: 9px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: 8px;
  margin-left: 4px;
}
.vehicle-info-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  margin-bottom: 4px;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
}
.vehicle-info-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.vehicle-info-details {
  flex: 1;
  min-width: 0;
}
.vehicle-info-name {
  font-weight: 600;
  font-size: 13px;
  color: #166534;
}
.vehicle-info-driver {
  font-size: 11px;
  color: #64748b;
  margin-top: 2px;
}
.crew-info-loading {
  text-align: center;
  padding: 30px;
  color: #94a3b8;
}
.crew-info-empty {
  text-align: center;
  padding: 20px;
  color: #94a3b8;
  font-size: 13px;
}

/* Switch Activity Modal */
.switch-activity-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  align-items: stretch;
  justify-content: stretch;
  padding: 0;
}
.switch-activity-overlay.active {
  display: flex;
}
.switch-activity-modal {
  background: white;
  border-radius: 0;
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  overflow-y: auto;
  box-shadow: none;
  animation: switchSlideIn 0.3s ease;
}
@keyframes switchSlideIn {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.switch-activity-modal * {
  color: inherit !important;
}
.switch-activity-header {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 16px 20px;
  border-radius: 18px 18px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.switch-activity-header * {
  color: white !important;
}
.switch-activity-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
}
.switch-activity-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white !important;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.switch-activity-close:hover {
  background: rgba(255,255,255,0.35);
}
.switch-activity-body {
  padding: 16px 20px;
}
.switch-activity-item {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 14px;
  padding: 14px 16px;
  transition: all 0.2s ease;
}
.switch-activity-item:not(.current):hover {
  background: #e3f2fd;
  border-color: #2196F3;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(33,150,243,0.15);
}

/* Numpad per cambio progetto */
.numpad-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 10001;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.numpad-overlay.active {
  display: flex;
}
.numpad-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 340px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: switchSlideIn 0.3s ease;
  overflow: hidden;
}
.numpad-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white !important;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.numpad-header * { color: white !important; }
.numpad-header h3 { margin: 0; font-size: 15px; font-weight: 700; }
.numpad-display {
  padding: 16px 18px 8px;
  text-align: center;
}
.numpad-display input {
  width: 100%;
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  letter-spacing: 3px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  padding: 12px;
  color: #1a56db !important;
  background: #f8faff;
  outline: none;
}
.numpad-display input:focus {
  border-color: #3b82f6;
}
.numpad-result {
  padding: 0 18px 8px;
  text-align: center;
  min-height: 24px;
}
.numpad-result .found {
  color: #16a34a !important;
  font-weight: 600;
  font-size: 13px;
}
.numpad-result .not-found {
  color: #dc2626 !important;
  font-weight: 600;
  font-size: 13px;
}
.numpad-result .searching {
  color: #888 !important;
  font-size: 13px;
}
.numpad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 8px 18px;
}
.numpad-btn {
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 14px;
  font-size: 22px;
  font-weight: 700;
  color: #1e293b !important;
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}
.numpad-btn:active {
  background: #dbeafe;
  border-color: #3b82f6;
  transform: scale(0.95);
}
.numpad-btn.del {
  background: #fef2f2;
  color: #dc2626 !important;
  border-color: #fecaca;
}
.numpad-btn.del:active {
  background: #fee2e2;
}
.numpad-actions {
  display: flex;
  gap: 10px;
  padding: 10px 18px 18px;
}
.numpad-actions button {
  flex: 1;
  padding: 13px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  border: none;
}

/* Popup note obbligatorie per attivit√† Altro */
.notes-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.65);
  z-index: 10002;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.notes-overlay.active {
  display: flex;
}
.notes-modal {
  background: white;
  border-radius: 18px;
  width: 100%;
  max-width: 380px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: switchSlideIn 0.3s ease;
  overflow: hidden;
}
.notes-header {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white !important;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.notes-header * { color: white !important; }
.notes-header h3 { margin: 0; font-size: 15px; font-weight: 700; }
.notes-body {
  padding: 18px;
}
.notes-body textarea {
  width: 100%;
  min-height: 100px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  padding: 12px;
  font-size: 15px;
  font-family: inherit;
  resize: vertical;
  outline: none;
  color: #333;
  background: #fefefe;
}
.notes-body textarea:focus {
  border-color: #f59e0b;
}
.notes-body textarea.error {
  border-color: #dc2626;
  background: #fef2f2;
}
.notes-body .notes-hint {
  font-size: 12px;
  color: #888;
  margin-top: 6px;
}
.notes-body .notes-error {
  font-size: 12px;
  color: #dc2626;
  font-weight: 600;
  margin-top: 6px;
  display: none;
}
.notes-actions {
  display: flex;
  gap: 10px;
  padding: 0 18px 18px;
}
.notes-actions button {
  flex: 1;
  padding: 13px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  border: none;
}

.switch-activity-item.current {
  background: #e8f5e9;
  border-color: #4CAF50;
}
.switch-activity-current {
  background: #fef3c7;
  border: 1px solid #fbbf24;
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.switch-activity-current-icon {
  font-size: 20px;
}
.switch-activity-current-info {
  flex: 1;
}
.switch-activity-current-label {
  font-size: 11px;
  color: #92400e;
  font-weight: 700;
  text-transform: uppercase;
}
.switch-activity-current-name {
  font-size: 14px;
  font-weight: 600;
  color: #78350f;
}
.switch-activity-list-title {
  font-size: 13px;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 10px;
}
.switch-activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 6px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  cursor: pointer;
  transition: all 0.2s;
}
.switch-activity-item:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  transform: translateX(4px);
}
.switch-activity-item:active {
  transform: scale(0.98);
}
.switch-activity-item.current {
  opacity: 0.5;
  pointer-events: none;
  background: #f1f5f9;
}
.switch-activity-item-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: white !important;
  flex-shrink: 0;
}
.switch-activity-item-info {
  flex: 1;
  min-width: 0;
}
.switch-activity-item-project {
  font-weight: 600;
  font-size: 14px;
  color: #1e293b;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.switch-activity-item-detail {
  font-size: 11px;
  color: #94a3b8;
  margin-top: 2px;
}
.switch-activity-item-arrow {
  color: #cbd5e1;
  font-size: 18px;
  flex-shrink: 0;
}

/* Dev Mode Toggle */
.dev-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 10px 16px;
  background: #fef3c7;
  border: 2px dashed #f59e0b;
  border-radius: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #92400e;
}
.dev-toggle label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-weight: 600;
}
.dev-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #f59e0b;
}
.dev-badge {
  background: #f59e0b;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 700;
}

/* Menu Hamburger */
.hamburger-btn {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  width: 44px;
  height: 44px;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: all 0.2s ease;
  touch-action: manipulation;
  flex-shrink: 0;
}
.hamburger-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}
.hamburger-btn span {
  display: block;
  width: 20px;
  height: 2px;
  background: white;
  border-radius: 1px;
  transition: all 0.3s ease;
}
.hamburger-btn.active span:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}
.hamburger-btn.active span:nth-child(2) {
  opacity: 0;
}
.hamburger-btn.active span:nth-child(3) {
  transform: rotate(-45deg) translate(5px, -5px);
}

/* Side Menu */
.side-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}
.side-menu-overlay.active {
  opacity: 1;
  visibility: visible;
}
.side-menu {
  position: fixed;
  top: 0;
  left: -320px;
  width: 300px;
  max-width: 85vw;
  height: 100vh;
  height: 100dvh;
  background: var(--bg-card);
  z-index: 700;
  transition: left 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: 4px 0 20px var(--shadow);
}
.side-menu.active {
  left: 0;
}
.side-menu-header {
  padding: 20px;
  padding-top: calc(20px + env(safe-area-inset-top, 0px));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
}
.side-menu-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}
.side-menu-user-info {
  flex: 1;
}
.side-menu-user-name {
  font-size: 16px;
  font-weight: 700;
  color: white;
}
.side-menu-user-role {
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}
.side-menu-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.menu-section {
  margin-bottom: 24px;
}
.menu-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding: 0 8px;
}
.menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 14px;
  color: var(--text-primary);
  text-decoration: none;
}
.menu-item:hover {
  background: var(--bg);
}
.menu-item.active {
  background: rgba(102, 126, 234, 0.15);
  color: var(--brand);
  font-weight: 600;
}
.menu-item .icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}
.menu-item.danger {
  color: var(--danger);
}
.notification-toggle {
  display: flex;
  align-items: center;
}
.notification-toggle .toggle-switch {
  margin-left: auto;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 28px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider {
  background-color: var(--success);
}
.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(22px);
}
.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Menu Footer con Logo */
.side-menu-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  text-align: center;
}
.side-menu-footer img {
  max-width: 120px;
  max-height: 40px;
  object-fit: contain;
  opacity: 0.8;
  transition: opacity 0.2s;
}
.side-menu-footer img:hover {
  opacity: 1;
}
.side-menu-footer-text {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 8px;
}
}
.user-info-grid {
  display: grid;
  gap: 8px;
}
.user-info-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg);
  border-radius: 8px;
  font-size: 13px;
}
.user-info-row .label {
  color: var(--text-secondary);
}
.user-info-row .value {
  font-weight: 600;
}

/* Profilo Utente Page */
.profile-page {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 800;
  display: none;
  flex-direction: column;
  overflow-y: auto;
}
.profile-page.active {
  display: flex;
}
.profile-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  padding: 24px 20px;
  padding-top: calc(24px + env(safe-area-inset-top, 0px));
  color: white;
  display: flex;
  align-items: center;
  gap: 16px;
}
.profile-back {
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.profile-header-info {
  flex: 1;
}
.profile-header-title {
  font-size: 20px;
  font-weight: 700;
}
.profile-header-subtitle {
  font-size: 13px;
  opacity: 0.9;
}
.profile-avatar-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 700;
}
.profile-content {
  flex: 1;
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  width: 100%;
}
.profile-section {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px var(--shadow);
}
.profile-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.profile-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.profile-field:last-child {
  border-bottom: none;
}
.profile-field-label {
  font-size: 14px;
  color: var(--text-secondary);
}
.profile-field-value {
  font-size: 14px;
  font-weight: 600;
}
.profile-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.profile-input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.profile-input-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.profile-input-group input {
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  background: var(--bg);
  color: var(--text-primary);
  transition: border-color 0.2s;
}
.profile-input-group input:focus {
  outline: none;
  border-color: #3b82f6;
}
.profile-btn {
  padding: 14px 24px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.profile-btn.primary {
  background: var(--green);
  color: white;
}
.profile-btn.primary:hover {
  background: var(--green-dark);
}
.profile-btn.primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.profile-message {
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 14px;
  display: none;
}
.profile-message.success {
  background: #dcfce7;
  color: #166534;
  display: block;
}
.profile-message.error {
  background: #fee2e2;
  color: #991b1b;
  display: block;
}

/* Reset Password Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 800;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 8px 32px var(--shadow);
}
.modal-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.form-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.form-group input {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text-primary);
}
.form-group input:focus {
  outline: none;
  border-color: var(--green);
}
.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}
.modal-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  touch-action: manipulation;
}
.modal-btn.cancel {
  background: var(--bg);
  color: var(--text-primary);
}
.modal-btn.confirm {
  background: var(--green);
  color: white;
}
.modal-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}


</style>
</head>
<body>

<!-- Main Header -->
<div class="main-header">
  <div class="main-header-content">
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="main-header-title">
      <h1>Timbratura</h1>
      <p id="currentDate">Caricamento...</p>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="refreshPage()">
      <i class="fas fa-sync-alt"></i>
    </button>
  </div>
</div>

<!-- Side Menu Overlay -->
<div class="side-menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <div class="side-menu-avatar">{{ user_initials }}</div>
    <div class="side-menu-user-info">
      <div class="side-menu-user-name">{{ user_display }}</div>
      <div class="side-menu-user-role">{{ user_role|default('Utente', true) }}</div>
    </div>
  </div>
  
  <div class="side-menu-content">
    <div class="menu-section">
      <div class="menu-section-title">üìã Menu</div>
      <a href="{{ url_for('home') }}" class="menu-item active">
        <span class="icon">üè†</span>
        <span>Home Timbrature</span>
      </a>
      <a href="{{ url_for('user_turni_page') }}" class="menu-item">
        <span class="icon">üìÖ</span>
        <span>I Miei Turni</span>
      </a>
      <a href="{{ url_for('user_requests_page') }}" class="menu-item">
        <span class="icon">üìù</span>
        <span>Richieste</span>
      </a>
      <a href="{{ url_for('user_documents_page') }}" class="menu-item">
        <span class="icon">üìÑ</span>
        <span>Documenti</span>
      </a>
      <a href="/user/notifications" class="menu-item">
        <span class="icon">üîî</span>
        <span>Storico Notifiche</span>
      </a>
      <a href="/user/storico-timbrature" class="menu-item">
        <span class="icon">üïê</span>
        <span>Storico Timbrature</span>
      </a>

    </div>
    
    <div class="menu-section">
      <div class="menu-section-title">‚öôÔ∏è Impostazioni</div>
      <div class="menu-item" onclick="openProfilePage()">
        <span class="icon">üë§</span>
        <span>Profilo Utente</span>
      </div>
      <div class="menu-item" onclick="toggleTheme(); closeMenu();">
        <span class="icon">üåô</span>
        <span>Tema Scuro</span>
      </div>
      <div class="menu-item" id="pwa-install-menu-item" onclick="installPwa()" style="display: none;">
        <span class="icon">üì≤</span>
        <span>Installa App</span>
      </div>
      <div class="menu-item notification-toggle" id="notificationMenuItem">
        <span class="icon" id="notificationIcon">üîï</span>
        <span id="notificationLabel">Attiva Notifiche</span>
        <label class="toggle-switch">
          <input type="checkbox" id="pushToggle" onchange="togglePushNotifications()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="menu-section">
      <a href="{{ url_for('logout') }}" class="menu-item danger">
        <span class="icon">üö™</span>
        <span>Logout</span>
      </a>
    </div>
  </div>
  
  {% if company_logo %}
  <div class="side-menu-footer">
    <img src="{{ company_logo }}" alt="Logo Azienda">
  </div>
  {% endif %}
</div>

<!-- Profilo Utente Page -->
<div class="profile-page" id="profilePage">
  <div class="profile-header">
    <button class="profile-back" onclick="closeProfilePage()">‚Üê</button>
    <div class="profile-header-info">
      <div class="profile-header-title">Profilo Utente</div>
      <div class="profile-header-subtitle">Gestisci le tue informazioni</div>
    </div>
    <div class="profile-avatar-large">{{ user_initials }}</div>
  </div>
  
  <div class="profile-content">
    <!-- Info Utente -->
    <div class="profile-section">
      <div class="profile-section-title">üë§ Informazioni Account</div>
      <div class="profile-field">
        <span class="profile-field-label">Username</span>
        <span class="profile-field-value">{{ username }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Nome Visualizzato</span>
        <span class="profile-field-value">{{ user_display }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Ruolo</span>
        <span class="profile-field-value">{{ user_role|default('Utente', true) }}</span>
      </div>
    </div>
    
    <!-- Cambio Password -->
    <div class="profile-section">
      <div class="profile-section-title">üîë Cambia Password</div>
      <div id="passwordMessage" class="profile-message"></div>
      <form class="profile-form" id="profilePasswordForm" onsubmit="submitProfilePasswordChange(event)">
        <div class="profile-input-group">
          <label>Password Attuale</label>
          <input type="password" id="profileCurrentPassword" required autocomplete="current-password" placeholder="Inserisci password attuale">
        </div>
        <div class="profile-input-group">
          <label>Nuova Password</label>
          <input type="password" id="profileNewPassword" required minlength="4" autocomplete="new-password" placeholder="Minimo 4 caratteri">
        </div>
        <div class="profile-input-group">
          <label>Conferma Nuova Password</label>
          <input type="password" id="profileConfirmPassword" required minlength="4" autocomplete="new-password" placeholder="Ripeti nuova password">
        </div>
        <button type="submit" class="profile-btn primary" id="btnProfileSavePassword">Aggiorna Password</button>
      </form>
    </div>
  </div>
</div>

<div class="container">
  <div class="clock-section">
    <div class="clock"><span class="clock-icon">üïê</span><span id="clock">--:--:--</span></div>
  </div>

  <!-- Box Turno Oggi -->
  <div class="turno-box" id="turnoBox" style="display:none;">
    <span class="turno-counter" id="turnoCounter" style="display:none;">1/1</span>
    
    <div class="turno-nav">
      <button class="turno-nav-btn" id="turnoPrevBtn" onclick="navigateTurno(-1)" style="display:none;">‚Äπ</button>
      <div class="turno-content">
        <div class="turno-project" id="turnoProject">-</div>
        <!-- Riga badge pausa e note -->
        <div class="turno-badges-row" id="turnoBadgesRow" style="display:none;">
          <span class="turno-badge-item turno-badge-pausa" id="turnoBadgePausa" style="display:none;">
            ‚è∏Ô∏è Pausa <span id="turnoBadgePausaText">30min</span>
          </span>
          <span class="turno-badge-item turno-badge-note" id="turnoBadgeNote" onclick="showTurnoNotes()" style="display:none;">
            üìù Note
          </span>
        </div>
        <div class="turno-details" id="turnoDetailsGrid">
          <!-- Orario -->
          <div class="turno-detail turno-detail-row" id="turnoOrarioRow">
            <span id="turnoProjectCode" style="font-weight:700; font-size:11px; background:rgba(255,255,255,0.25); padding:2px 6px; border-radius:6px; margin-right:14px; display:none;"></span>
            <span class="icon">üïê</span>
            <span id="turnoOrarioText" style="font-weight:600;">-</span>
          </div>
          
          <!-- Funzione -->
          <div class="turno-detail" id="turnoFunzioneRow">
            <span class="icon">üë§</span>
            <span id="turnoFunzioneText" style="font-weight:600; flex:1;">-</span>
          </div>
          
          <!-- Location -->
          <div class="turno-detail turno-timbratura" id="turnoTimbratura" style="display:none;">
            <span class="icon">üìç</span>
            <span id="turnoTimbraturaText" style="font-weight:600; flex:1;">-</span>
          </div>
        </div>
        <span class="turno-badge" id="turnoBadge" style="display:none;"></span>
      </div>
      <button class="turno-nav-btn" id="turnoNextBtn" onclick="navigateTurno(1)" style="display:none;">‚Ä∫</button>
    </div>
  </div>

  <!-- Fasi del turno -->
  <div class="turno-phases-box" id="turnoPhases" style="display:none;">
    <div class="turno-phases-header">
      <span class="turno-phases-icon">üîß</span>
      <span class="turno-phases-title">Fasi Attivit√†</span>
      <span class="turno-phases-counter" id="turnoPhaseCounter">0/0</span>
    </div>
    <div class="turno-phases-bar">
      <div class="turno-phases-fill" id="turnoPhaseBar" style="width:0%"></div>
    </div>
    <div class="turno-phases-list" id="turnoPhasesList"></div>
  </div>

  <div class="actions">
    <button class="action-btn start" id="btnStartDay" onclick="startTimbratura('inizio_giornata')">
      <span class="icon" id="iconStart">‚Üí</span>
      <span id="labelStart">Inizio Giornata</span>
      <span class="check" id="checkStart"></span>
    </button>
    
    <div class="pause-row">
      <button class="pause-btn" id="btnStartPause" onclick="startTimbratura('inizio_pausa')">
        <span class="icon">‚òï</span>
        <span>Inizio Pausa</span>
      </button>
      <button class="pause-btn" id="btnEndPause" onclick="startTimbratura('fine_pausa')">
        <span class="icon">‚úì</span>
        <span>Fine Pausa</span>
      </button>
    </div>
    
    <button class="action-btn end" id="btnEndDay" onclick="startTimbratura('fine_giornata')">
      <span class="icon">‚Üê</span>
      <span>Fine Giornata</span>
      <span class="check" id="checkEnd"></span>
    </button>
  </div>

  <div class="history-spacer"></div>
</div>

<div class="history-section" id="historySection">
  <button class="history-toggle" onclick="toggleHistory()">
    üìã Storico Timbrature Oggi
    <span class="history-arrow">‚ñ≤</span>
  </button>
  <div class="history-content">
    <ul class="history-list" id="historyList">
      <li class="empty-history">Nessuna timbratura registrata</li>
    </ul>
  </div>
</div>

<!-- Switch Activity Modal -->
<div class="switch-activity-overlay" id="switchActivityOverlay" onclick="closeSwitchActivityModal(event)">
  <div class="switch-activity-modal" onclick="event.stopPropagation()">
    <div class="switch-activity-header">
      <h3>üîÑ Cambia Attivit√†</h3>
      <button class="switch-activity-close" onclick="closeSwitchActivityModal()">‚úï</button>
    </div>
    <div class="switch-activity-body" id="switchActivityBody">
      <div class="crew-info-loading">Caricamento...</div>
    </div>
  </div>
</div>

<!-- Numpad Cambio Progetto -->
<div class="numpad-overlay" id="numpadOverlay" onclick="closeNumpad(event)">
  <div class="numpad-modal" onclick="event.stopPropagation()">
    <div class="numpad-header">
      <h3>üî¢ Numero Progetto</h3>
      <button class="switch-activity-close" onclick="closeNumpad()">‚úï</button>
    </div>
    <div id="numpadActivityHint" style="display:none;text-align:center;padding:4px 12px 8px;font-size:13px;color:#1e88e5;font-weight:600;"></div>
    <div class="numpad-display">
      <input type="text" id="numpadInput" readonly placeholder="---" maxlength="10">
    </div>
    <div class="numpad-result" id="numpadResult"></div>
    <div class="numpad-grid">
      <div class="numpad-btn" onclick="numpadPress('1')">1</div>
      <div class="numpad-btn" onclick="numpadPress('2')">2</div>
      <div class="numpad-btn" onclick="numpadPress('3')">3</div>
      <div class="numpad-btn" onclick="numpadPress('4')">4</div>
      <div class="numpad-btn" onclick="numpadPress('5')">5</div>
      <div class="numpad-btn" onclick="numpadPress('6')">6</div>
      <div class="numpad-btn" onclick="numpadPress('7')">7</div>
      <div class="numpad-btn" onclick="numpadPress('8')">8</div>
      <div class="numpad-btn" onclick="numpadPress('9')">9</div>
      <div class="numpad-btn del" onclick="numpadDelete()">‚å´</div>
      <div class="numpad-btn" onclick="numpadPress('0')">0</div>
      <div class="numpad-btn del" onclick="numpadClear()">C</div>
    </div>
    <div class="numpad-actions">
      <button onclick="closeNumpad()" style="background:#f1f5f9;color:#666 !important;">Annulla</button>
      <button id="numpadConfirmBtn" onclick="numpadConfirm()" style="background:#3b82f6;color:#fff !important;" disabled>Conferma</button>
    </div>
  </div>
</div>

<!-- Popup Note Obbligatorie per attivit√† Altro -->
<div class="notes-overlay" id="notesOverlay" onclick="closeNotesPopup(event)">
  <div class="notes-modal" onclick="event.stopPropagation()">
    <div class="notes-header">
      <h3>üìù Note Obbligatorie</h3>
      <button class="switch-activity-close" onclick="closeNotesPopup()">‚úï</button>
    </div>
    <div class="notes-body">
      <p style="font-size:13px;color:#555;margin:0 0 10px;">Per l'attivit√† <strong>"Altro"</strong> √® necessario specificare cosa si sta facendo.</p>
      <textarea id="notesTextarea" placeholder="Descrivi l'attivit√†..." maxlength="500"></textarea>
      <div class="notes-hint">Minimo 3 caratteri</div>
      <div class="notes-error" id="notesError">‚ö†Ô∏è Inserisci una descrizione dell'attivit√†</div>
    </div>
    <div class="notes-actions">
      <button onclick="closeNotesPopup()" style="background:#f1f5f9;color:#666 !important;">Annulla</button>
      <button id="notesConfirmBtn" onclick="confirmNotesAndProceed()" style="background:#f59e0b;color:#fff !important;">Conferma e Avvia</button>
    </div>
  </div>
</div>

<!-- Crew Info Modal -->
<div class="crew-info-overlay" id="crewInfoOverlay" onclick="closeCrewInfoModal(event)">
  <div class="crew-info-modal" onclick="event.stopPropagation()">
    <div class="crew-info-header">
      <h3 id="crewInfoTitle">‚ÑπÔ∏è Info Turno</h3>
      <button class="crew-info-close" onclick="closeCrewInfoModal()">‚úï</button>
    </div>
    <div class="crew-info-body" id="crewInfoBody">
      <div class="crew-info-loading">Caricamento...</div>
    </div>
  </div>
</div>

<!-- Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-container">
    <h2 class="scanner-title" id="scannerTitle">üì∑ Inquadra il QR Code</h2>
    <p class="scanner-subtitle" id="scannerSubtitle">Scansiona per confermare</p>
    <div id="qr-reader"></div>
    <button class="scanner-close" onclick="closeScanner()">Annulla</button>
  </div>
</div>

<!-- Method Choice Modal -->
<div class="method-modal" id="methodModal">
  <div class="method-container">
    <h2 class="method-title" id="methodTitle">Come vuoi confermare?</h2>
    <p class="method-subtitle" id="methodSubtitle">Scegli il metodo di timbratura</p>
    <div class="method-options">
      <button class="method-btn" id="methodQrBtn" onclick="selectMethod('qr')">
        <div class="method-btn-icon">üì∑</div>
        <div class="method-btn-content">
          <div class="method-btn-title">QR Code</div>
          <div class="method-btn-desc">Scansiona il codice in sede</div>
        </div>
      </button>
      <button class="method-btn" id="methodGpsBtn" onclick="selectMethod('gps')">
        <div class="method-btn-icon">üìç</div>
        <div class="method-btn-content">
          <div class="method-btn-title">Posizione GPS</div>
          <div class="method-btn-desc">Conferma con geolocalizzazione</div>
        </div>
      </button>
    </div>
    <button class="method-cancel" onclick="closeMethodModal()">Annulla</button>
  </div>
</div>

<!-- GPS Modal -->
<div class="gps-modal" id="gpsModal">
  <div class="gps-container">
    <h2 class="gps-title" id="gpsTitle">üìç Verifica Posizione</h2>
    <p class="gps-subtitle" id="gpsSubtitle">Attendere la localizzazione...</p>
    <div class="gps-location-name" id="gpsLocationName"></div>
    <div class="gps-status" id="gpsStatus">
      <div class="gps-icon loading" id="gpsIcon">üìç</div>
      <div class="gps-message" id="gpsMessage">Rilevamento posizione...</div>
      <div class="gps-accuracy" id="gpsAccuracy"></div>
    </div>
    <div class="gps-buttons">
      <button class="gps-btn secondary" onclick="closeGpsModal()">Annulla</button>
      <button class="gps-btn primary" id="gpsConfirmBtn" onclick="confirmGpsLocation()" disabled>Conferma</button>
    </div>
  </div>
</div>

<!-- Note Turno Modal -->
<div class="note-modal" id="noteModal">
  <div class="note-container">
    <h2 class="note-title">üìù Note sul Turno</h2>
    <div id="noteRemark" class="note-section" style="display:none;">
      <div class="note-section-label">üìã Note progetto</div>
      <div class="note-section-text" id="noteRemarkText"></div>
    </div>
    <div id="notePlanner" class="note-section" style="display:none;">
      <div class="note-section-label">üë§ Note pianificatore</div>
      <div class="note-section-text" id="notePlannerText"></div>
    </div>
    <div id="noteEmpty" class="note-section" style="display:none;">
      <div class="note-section-text" style="text-align:center; color: rgba(255,255,255,0.5);">Nessuna nota disponibile</div>
    </div>
    <button class="note-close" onclick="closeNoteModal()">Chiudi</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const TIMBRATURA_TYPES = {
  'inizio_giornata': { label: 'Inizio Giornata', dotClass: 'start' },
  'fine_giornata': { label: 'Fine Giornata', dotClass: 'end' },
  'inizio_pausa': { label: 'Inizio Pausa', dotClass: 'pause' },
  'fine_pausa': { label: 'Fine Pausa', dotClass: 'pause' }
};

let todayTimbrature = [];
let pendingOvertime = null;  // Straordinario in attesa di revisione
let html5QrcodeScanner = null;
let pendingTimbraturaType = null;  // Tipo di timbratura in attesa di conferma QR
let currentTurnoNotes = { note: null, note_planner: null };  // Note del turno corrente
let pendingBreakInfo = null;  // Info conferma pausa per fine_giornata

// Funzioni per Note Turno
function showTurnoNotes() {
  const modal = document.getElementById('noteModal');
  const remarkSection = document.getElementById('noteRemark');
  const plannerSection = document.getElementById('notePlanner');
  const emptySection = document.getElementById('noteEmpty');
  const remarkText = document.getElementById('noteRemarkText');
  const plannerText = document.getElementById('notePlannerText');
  
  // Resetta
  remarkSection.style.display = 'none';
  plannerSection.style.display = 'none';
  emptySection.style.display = 'none';
  
  let hasNotes = false;
  
  if (currentTurnoNotes.note) {
    remarkText.textContent = currentTurnoNotes.note;
    remarkSection.style.display = 'block';
    hasNotes = true;
  }
  
  if (currentTurnoNotes.note_planner) {
    plannerText.textContent = currentTurnoNotes.note_planner;
    plannerSection.style.display = 'block';
    hasNotes = true;
  }
  
  if (!hasNotes) {
    emptySection.style.display = 'block';
  }
  
  modal.classList.add('open');
}

function closeNoteModal() {
  document.getElementById('noteModal').classList.remove('open');
}

// Toggle storico timbrature
function toggleHistory() {
  document.getElementById('historySection').classList.toggle('open');
}

// Aggiorna orologio
function updateClock() {
  const now = new Date();
  const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('clock').textContent = time;
}

// Aggiorna data
function updateDate() {
  const now = new Date();
  const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
  let dateStr = now.toLocaleDateString('it-IT', options);
  dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
  document.getElementById('currentDate').textContent = 'Oggi: ' + dateStr;
}

// Toast notification
let toastTimer = null;
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  if (toastTimer) clearTimeout(toastTimer);
  toast.textContent = message;
  toast.className = 'toast ' + type + ' show';
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    toastTimer = null;
  }, 2000);
}

// Configurazione timbratura (caricata dal server)
let timbraturaConfig = {
  qr_enabled: true,
  gps_enabled: false,
  gps_locations: [],
  gps_max_accuracy_meters: 50
};

// Stato GPS
let gpsWatchId = null;
let lastGpsPosition = null;

// Carica configurazione timbratura dal server
async function loadTimbraturaConfig() {
  try {
    const res = await fetch('/api/timbratura/config');
    if (res.ok) {
      timbraturaConfig = await res.json();
      console.log('Timbratura config loaded:', timbraturaConfig);
    }
  } catch (err) {
    console.warn('Errore caricamento config timbratura:', err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VERIFICA PAUSA PRIMA DI FINE GIORNATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseTimeToMinutes(rawTime) {
  if (!rawTime) return null;
  const text = String(rawTime);
  const hhmm = text.length > 10 ? text.substring(11, 16) : text.substring(0, 5);
  const parts = hhmm.split(':');
  if (parts.length < 2) return null;
  const h = parseInt(parts[0], 10);
  const m = parseInt(parts[1], 10);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h * 60 + m;
}

function calculateStampedBreakMinutes() {
  const pausaTimbrature = todayTimbrature
    .filter(t => t.tipo === 'inizio_pausa' || t.tipo === 'fine_pausa')
    .slice()
    .sort((a, b) => {
      const am = parseTimeToMinutes(a.ora || a.ora_mod || '00:00') || 0;
      const bm = parseTimeToMinutes(b.ora || b.ora_mod || '00:00') || 0;
      return am - bm;
    });

  let total = 0;
  let startMin = null;
  pausaTimbrature.forEach(t => {
    const tMin = parseTimeToMinutes(t.ora || t.ora_mod);
    if (tMin == null) return;
    if (t.tipo === 'inizio_pausa') {
      startMin = tMin;
    } else if (t.tipo === 'fine_pausa' && startMin != null && tMin >= startMin) {
      total += (tMin - startMin);
      startMin = null;
    }
  });

  return Math.max(0, total);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VERIFICA RIDUZIONE PAUSA PRIMA DI FINE PAUSA
// Quando l'utente timbra Fine Pausa, calcola la pausa effettiva
// (ora attuale - inizio_pausa) e confronta con quella pianificata.
// Se riduzione >= 30 min ‚Üí popup motivazione obbligatoria.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBreakReductionBeforeFinePausa(callback) {
  // Trova l'ultima timbratura inizio_pausa
  const inizioPausaTimb = todayTimbrature
    .filter(t => t.tipo === 'inizio_pausa')
    .slice(-1)[0];
  
  if (!inizioPausaTimb) {
    console.log('üîç checkBreakReduction: nessun inizio_pausa trovato, procedo');
    callback();
    return;
  }
  
  // Calcola pausa effettiva: ora corrente - inizio_pausa
  const inizioMin = parseTimeToMinutes(inizioPausaTimb.ora || inizioPausaTimb.ora_mod);
  const now = new Date();
  const nowMin = now.getHours() * 60 + now.getMinutes();
  
  if (inizioMin == null) {
    console.log('üîç checkBreakReduction: impossibile parsare inizio_pausa, procedo');
    callback();
    return;
  }
  
  const effectiveBreakMinutes = Math.max(0, nowMin - inizioMin);
  
  // Trova pausa pianificata dal turno
  const turniGiorno = (allTurni && allTurni.length > 0)
    ? allTurni
    : [allTurni[currentTurnoIndex] || {}];

  const turnoConPausa = turniGiorno.find(t =>
    (t && t.break_start && t.break_end) ||
    (t && Number(t.break_minutes || 0) > 0)
  ) || {};

  let plannedBreakMinutes = 0;
  if (turnoConPausa.break_start && turnoConPausa.break_end) {
    const bs = parseTimeToMinutes(turnoConPausa.break_start);
    const be = parseTimeToMinutes(turnoConPausa.break_end);
    if (bs != null && be != null && be > bs) plannedBreakMinutes = be - bs;
  } else {
    plannedBreakMinutes = Number(turnoConPausa.break_minutes || 0) || 0;
  }
  
  const reduction = plannedBreakMinutes - effectiveBreakMinutes;
  
  console.log('üîçüîçüîç BREAK REDUCTION CHECK (Fine Pausa):');
  console.log('  inizio_pausa=', inizioPausaTimb.ora || inizioPausaTimb.ora_mod, '(', inizioMin, 'min)');
  console.log('  ora corrente=', now.getHours() + ':' + String(now.getMinutes()).padStart(2,'0'), '(', nowMin, 'min)');
  console.log('  effectiveBreak=', effectiveBreakMinutes, 'min');
  console.log('  plannedBreak=', plannedBreakMinutes, 'min');
  console.log('  reduction=', reduction, 'min');
  
  if (plannedBreakMinutes > 0 && effectiveBreakMinutes >= 0 && reduction >= 30) {
    console.log('üîçüîçüîç ‚úÖ SHOWING BREAK REDUCTION POPUP!');
    showBreakReductionMotivationPopup(
      plannedBreakMinutes,
      effectiveBreakMinutes,
      callback,
      {
        break_start: turnoConPausa.break_start || null,
        break_end: turnoConPausa.break_end || null,
        break_minutes: plannedBreakMinutes || null,
      }
    );
    return;
  }
  
  console.log('üîçüîçüîç ‚ùå Nessuna riduzione critica, procedo normalmente');
  callback();
}

function checkBreakBeforeEndDay(callback) {
  // Verifica se la pausa √® stata timbrata oggi
  const hasPauseStart = todayTimbrature.some(t => t.tipo === 'inizio_pausa');
  const hasPauseEnd = todayTimbrature.some(t => t.tipo === 'fine_pausa');
  
  console.log('üîç checkBreakBeforeEndDay: hasPauseStart=', hasPauseStart, 'hasPauseEnd=', hasPauseEnd);
  
  // Verifica se la giornata ha una pausa pianificata.
  const turniGiorno = (allTurni && allTurni.length > 0)
    ? allTurni
    : [allTurni[currentTurnoIndex] || {}];

  const turnoConPausa = turniGiorno.find(t =>
    (t && t.break_start && t.break_end) ||
    (t && Number(t.break_minutes || 0) > 0)
  ) || {};

  let plannedBreakMinutes = 0;
  if (turnoConPausa.break_start && turnoConPausa.break_end) {
    const bs = parseTimeToMinutes(turnoConPausa.break_start);
    const be = parseTimeToMinutes(turnoConPausa.break_end);
    if (bs != null && be != null && be > bs) plannedBreakMinutes = be - bs;
  } else {
    plannedBreakMinutes = Number(turnoConPausa.break_minutes || 0) || 0;
  }

  const hasPlannedBreak = Boolean(
    (turnoConPausa.break_start && turnoConPausa.break_end) ||
    Number(turnoConPausa.break_minutes || 0) > 0
  );

  // Se la pausa √® stata timbrata (sia inizio che fine), procedi
  if (hasPauseStart && hasPauseEnd) {
    pendingBreakInfo = { break_confirmed: true, break_stamped: true };
    console.log('üîç checkBreakBeforeEndDay: pausa gi√† timbrata, skip popup');
    callback();
    return;
  }
  
  // Se non c'√® pausa pianificata dai dati Rentman, chiedi al backend come fallback
  // (in produzione break_start/end/minutes possono essere NULL nei dati Rentman)
  if (!hasPlannedBreak) {
    fetch('/api/check_break_needed')
      .then(r => r.json())
      .then(backendData => {
        if (backendData.planned_break_minutes > 0 && !backendData.has_pausa_timbrata) {
          console.log('üîç checkBreakBeforeEndDay (backend fallback): pausa pianificata=', backendData.planned_break_minutes, 'min, non timbrata ‚Üí mostro popup');
          showBreakConfirmPopup(`${backendData.planned_break_minutes} minuti`, callback, {
            break_start: null,
            break_end: null,
            break_minutes: backendData.planned_break_minutes,
          });
        } else {
          console.log('üîç checkBreakBeforeEndDay (backend fallback): nessuna pausa necessaria, procedo');
          pendingBreakInfo = null;
          callback();
        }
      })
      .catch(err => {
        console.warn('üîç checkBreakBeforeEndDay: errore fetch backend, procedo:', err);
        pendingBreakInfo = null;
        callback();
      });
    return;
  }
  
  // Pausa pianificata ma NON timbrata ‚Üí mostra popup
  const breakText = turnoConPausa.break_start && turnoConPausa.break_end
    ? `${turnoConPausa.break_start} - ${turnoConPausa.break_end}`
    : `${turnoConPausa.break_minutes} minuti`;
  
  showBreakConfirmPopup(breakText, callback, {
    break_start: turnoConPausa.break_start || null,
    break_end: turnoConPausa.break_end || null,
    break_minutes: plannedBreakMinutes || Number(turnoConPausa.break_minutes || 0) || null
  });
}

function showBreakReductionMotivationPopup(plannedMinutes, effectiveMinutes, callback, breakMeta = null) {
  const existing = document.getElementById('breakConfirmPopup');
  if (existing) existing.remove();

  const reduction = Math.max(0, plannedMinutes - effectiveMinutes);
  const popup = document.createElement('div');
  popup.id = 'breakConfirmPopup';
  popup.innerHTML = `
    <style>
      #breakConfirmPopup {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
      }
      #breakConfirmPopup .popup-card {
        background: white; border-radius: 20px; padding: 24px;
        max-width: 430px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }
      #breakConfirmPopup h3 { text-align: center; margin: 0 0 8px; color: #1e293b; }
      #breakConfirmPopup .popup-subtitle { text-align: center; color: #64748b; font-size: 0.9rem; margin-bottom: 16px; }
      #breakConfirmPopup .break-info {
        background: #fff7ed; border: 1px solid #fdba74;
        border-radius: 12px; padding: 12px 14px; margin-bottom: 14px;
      }
      #breakConfirmPopup .break-row { display:flex; justify-content:space-between; font-size:0.92rem; margin:4px 0; }
      #breakConfirmPopup textarea {
        width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
        font-size: 0.9rem; resize: none; margin-bottom: 10px; box-sizing: border-box;
      }
      #breakConfirmPopup textarea:focus { outline: none; border-color: #f59e0b; }
      #breakConfirmPopup .motivation-error { color: #ef4444; font-size: 0.8rem; margin: -6px 0 8px; display: none; }
      #breakConfirmPopup .btn-confirm {
        width: 100%; padding: 13px; border-radius: 12px; border: none;
        font-size: 0.95rem; font-weight: 600; cursor: pointer;
        background: linear-gradient(135deg, #4361ee, #7c3aed); color: white;
      }
      #breakConfirmPopup .btn-cancel {
        margin-top: 8px; width: 100%; padding: 11px;
        border-radius: 12px; border: 1px solid #e2e8f0;
        font-size: 0.9rem; cursor: pointer; background: #f8fafc; color: #64748b;
      }
    </style>
    <div class="popup-card">
      <h3>‚ö†Ô∏è Pausa ridotta rilevata</h3>
      <p class="popup-subtitle">La pausa timbrata √® inferiore di almeno 30 minuti rispetto al pianificato</p>
      <div class="break-info">
        <div class="break-row"><span>‚è∞ Pausa pianificata</span><strong>${plannedMinutes} min</strong></div>
        <div class="break-row"><span>üïí Pausa timbrata</span><strong>${effectiveMinutes} min</strong></div>
        <div class="break-row"><span>üìâ Differenza</span><strong style="color:#c2410c;">-${reduction} min</strong></div>
      </div>
      <p style="font-size:0.85rem;color:#92400e;font-weight:600;margin-bottom:8px;">üìù Motivazione obbligatoria (verr√† inviata ad approvazione admin):</p>
      <textarea id="breakReductionReason" rows="3" placeholder="Es: necessit√† operativa, urgenza cliente, ecc..."></textarea>
      <div class="motivation-error" id="breakReductionError">‚ö†Ô∏è La motivazione √® obbligatoria</div>
      <button class="btn-confirm" onclick="confirmBreakReductionReason(${plannedMinutes}, ${effectiveMinutes})">Conferma e prosegui</button>
      <button class="btn-cancel" onclick="cancelBreakConfirm()">Annulla</button>
    </div>
  `;

  popup._callback = callback;
  popup._breakMeta = breakMeta || null;
  document.body.appendChild(popup);
  document.getElementById('breakReductionReason')?.focus();
}

function confirmBreakReductionReason(plannedMinutes, effectiveMinutes) {
  const reason = document.getElementById('breakReductionReason')?.value?.trim() || '';
  if (!reason) {
    const err = document.getElementById('breakReductionError');
    if (err) err.style.display = 'block';
    return;
  }

  const popup = document.getElementById('breakConfirmPopup');
  const breakMeta = popup?._breakMeta || {};
  const reduction = Math.max(0, plannedMinutes - effectiveMinutes);

  pendingBreakInfo = {
    break_confirmed: true,
    break_stamped: true,
    break_start: breakMeta.break_start || null,
    break_end: breakMeta.break_end || null,
    break_minutes: breakMeta.break_minutes || plannedMinutes || null,
    break_reduction_reason: reason,
    planned_break_minutes: plannedMinutes,
    effective_break_minutes: effectiveMinutes,
    break_reduction_minutes: reduction,
  };

  const cb = popup?._callback;
  if (popup) popup.remove();
  if (cb) cb();
}

function showBreakConfirmPopup(breakText, callback, breakMeta = null) {
  // Rimuovi popup esistente
  const existing = document.getElementById('breakConfirmPopup');
  if (existing) existing.remove();
  
  const popup = document.createElement('div');
  popup.id = 'breakConfirmPopup';
  popup.innerHTML = `
    <style>
      #breakConfirmPopup {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      #breakConfirmPopup .popup-card {
        background: white; border-radius: 20px; padding: 28px;
        max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease;
      }
      #breakConfirmPopup .popup-icon { text-align: center; font-size: 3rem; margin-bottom: 8px; }
      #breakConfirmPopup h3 { text-align: center; margin: 0 0 4px; color: #1e293b; font-size: 1.2rem; }
      #breakConfirmPopup .popup-subtitle { text-align: center; color: #64748b; font-size: 0.9rem; margin-bottom: 16px; }
      #breakConfirmPopup .break-info {
        background: linear-gradient(135deg, #fff7ed, #ffedd5); border: 1px solid #fdba74;
        border-radius: 12px; padding: 12px 16px; text-align: center;
        margin-bottom: 20px;
      }
      #breakConfirmPopup .break-info .label { font-size: 0.8rem; color: #9a3412; font-weight: 600; }
      #breakConfirmPopup .break-info .value { font-size: 1.3rem; font-weight: 700; color: #c2410c; margin-top: 4px; }
      #breakConfirmPopup .btn-group { display: flex; flex-direction: column; gap: 10px; }
      #breakConfirmPopup .btn-yes {
        padding: 14px; border-radius: 12px; border: none; font-size: 1rem;
        font-weight: 600; cursor: pointer;
        background: linear-gradient(135deg, #22c55e, #16a34a); color: white;
      }
      #breakConfirmPopup .btn-no {
        padding: 14px; border-radius: 12px; border: none; font-size: 1rem;
        font-weight: 600; cursor: pointer;
        background: linear-gradient(135deg, #f59e0b, #d97706); color: white;
      }
      #breakConfirmPopup .btn-cancel {
        padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0;
        font-size: 0.9rem; cursor: pointer; background: #f8fafc; color: #64748b;
      }
      #breakConfirmPopup .motivation-section {
        margin-top: 16px; display: none;
      }
      #breakConfirmPopup .motivation-section.visible { display: block; }
      #breakConfirmPopup .motivation-section textarea {
        width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
        font-size: 0.9rem; resize: none; margin-bottom: 12px; box-sizing: border-box;
      }
      #breakConfirmPopup .motivation-section textarea:focus {
        outline: none; border-color: #f59e0b;
      }
      #breakConfirmPopup .btn-confirm-skip {
        width: 100%; padding: 14px; border-radius: 12px; border: none;
        font-size: 1rem; font-weight: 600; cursor: pointer;
        background: linear-gradient(135deg, #4361ee, #7c3aed); color: white;
      }
      #breakConfirmPopup .motivation-error {
        color: #ef4444; font-size: 0.8rem; margin: -8px 0 8px; display: none;
      }
    </style>
    <div class="popup-card">
      <div class="popup-icon">‚òï</div>
      <h3>Pausa non timbrata</h3>
      <p class="popup-subtitle">La pausa prevista non √® stata registrata</p>
      
      <div class="break-info">
        <div class="label">‚è∞ Pausa pianificata</div>
        <div class="value">${breakText}</div>
      </div>
      
      <div class="btn-group" id="breakBtnGroup">
        <button class="btn-yes" onclick="confirmBreakDone()">‚úÖ S√¨, ho fatto la pausa</button>
        <button class="btn-no" onclick="showBreakSkipMotivation()">‚ö†Ô∏è No, non ho fatto la pausa</button>
        <button class="btn-cancel" onclick="cancelBreakConfirm()">Annulla</button>
      </div>
      
      <div class="motivation-section" id="breakMotivationSection">
        <p style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 8px;">
          üìù Indica il motivo della mancata pausa:
        </p>
        <textarea id="breakSkipReason" rows="3" placeholder="Es: urgenza lavorativa, carico eccessivo..."></textarea>
        <div class="motivation-error" id="breakMotivationError">‚ö†Ô∏è La motivazione √® obbligatoria</div>
        <button class="btn-confirm-skip" onclick="confirmBreakSkip()">Conferma e prosegui</button>
        <button class="btn-cancel" style="margin-top: 8px; width: 100%;" onclick="cancelBreakConfirm()">Annulla</button>
      </div>
    </div>
  `;
  
  // Salva callback per usarla dopo
  popup._callback = callback;
  popup._breakMeta = breakMeta || null;
  document.body.appendChild(popup);
}

function confirmBreakDone() {
  const popup = document.getElementById('breakConfirmPopup');
  const breakMeta = popup?._breakMeta || {};
  pendingBreakInfo = {
    break_confirmed: true,
    break_stamped: false,
    break_start: breakMeta.break_start || null,
    break_end: breakMeta.break_end || null,
    break_minutes: breakMeta.break_minutes || null,
  };
  console.log('‚úÖ BREAK CONFIRMED - pendingBreakInfo:', JSON.stringify(pendingBreakInfo));
  const cb = popup._callback;
  popup.remove();
  if (cb) cb();
}

function showBreakSkipMotivation() {
  document.getElementById('breakBtnGroup').style.display = 'none';
  document.getElementById('breakMotivationSection').classList.add('visible');
  document.getElementById('breakSkipReason').focus();
}

function confirmBreakSkip() {
  const reason = document.getElementById('breakSkipReason').value.trim();
  if (!reason) {
    document.getElementById('breakMotivationError').style.display = 'block';
    return;
  }
  const popup = document.getElementById('breakConfirmPopup');
  pendingBreakInfo = { break_skipped: true, break_skip_reason: reason };
  console.log('‚ö†Ô∏è BREAK SKIPPED - pendingBreakInfo:', JSON.stringify(pendingBreakInfo));
  const cb = popup._callback;
  popup.remove();
  if (cb) cb();
}

function cancelBreakConfirm() {
  const popup = document.getElementById('breakConfirmPopup');
  if (popup) popup.remove();
  pendingTimbraturaType = null;
  pendingBreakInfo = null;
}

// Inizia processo timbratura: sceglie metodo o apre direttamente
function startTimbratura(tipo) {
  pendingTimbraturaType = tipo;
  pendingBreakInfo = null;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  console.log('üöÄ startTimbratura:', tipo, 'todayTimbrature.length=', todayTimbrature.length, 'allTurni.length=', allTurni.length);
  
  // Se √® Fine Giornata, verifica prima la pausa (popup: "non hai timbrato la pausa")
  if (tipo === 'fine_giornata') {
    checkBreakBeforeEndDay(() => {
      proceedWithTimbratura(tipo, label);
    });
    return;
  }
  
  // Se √® Fine Pausa, verifica eventuale riduzione critica della pausa
  if (tipo === 'fine_pausa') {
    checkBreakReductionBeforeFinePausa(() => {
      proceedWithTimbratura(tipo, label);
    });
    return;
  }
  
  proceedWithTimbratura(tipo, label);
}

function proceedWithTimbratura(tipo, label) {
  // Se NESSUN metodo √® abilitato (entrambi disabilitati), timbratura diretta
  if (!timbraturaConfig.qr_enabled && !timbraturaConfig.gps_enabled) {
    registerTimbraturaDirectly(tipo);
    return;
  }
  
  // Se entrambi i metodi sono abilitati, mostra la scelta
  if (timbraturaConfig.qr_enabled && timbraturaConfig.gps_enabled) {
    openMethodModal(label);
    return;
  }
  
  // Se solo GPS √® abilitato
  if (timbraturaConfig.gps_enabled && !timbraturaConfig.qr_enabled) {
    openGpsModal(label);
    return;
  }
  
  // Se solo QR √® abilitato
  document.getElementById('scannerTitle').textContent = 'üì∑ ' + label;
  document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
  openScanner();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// METHOD CHOICE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openMethodModal(label) {
  document.getElementById('methodTitle').textContent = label;
  document.getElementById('methodSubtitle').textContent = 'Come vuoi confermare la timbratura?';
  
  // Abilita/disabilita pulsanti in base alla config
  document.getElementById('methodQrBtn').style.display = timbraturaConfig.qr_enabled ? 'flex' : 'none';
  document.getElementById('methodGpsBtn').style.display = timbraturaConfig.gps_enabled ? 'flex' : 'none';
  
  document.getElementById('methodModal').classList.add('active');
}

function closeMethodModal() {
  document.getElementById('methodModal').classList.remove('active');
  pendingTimbraturaType = null;  // Reset solo quando l'utente annulla
}

function selectMethod(method) {
  // Salva il tipo PRIMA di chiudere il modal
  const tipo = pendingTimbraturaType;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  // Chiudi solo il modal visivamente
  document.getElementById('methodModal').classList.remove('active');
  
  if (method === 'qr') {
    document.getElementById('scannerTitle').textContent = 'üì∑ ' + label;
    document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
    openScanner();
  } else if (method === 'gps') {
    openGpsModal(label);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP SEDI VALIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showValidLocationsPopup() {
  // Rimuovi popup precedente se esiste
  let overlay = document.getElementById('validLocOverlay');
  let popup = document.getElementById('validLocPopup');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'validLocOverlay';
    overlay.className = 'valid-locations-popup-overlay';
    overlay.onclick = function() { closeValidLocationsPopup(); };
    document.body.appendChild(overlay);
  }
  if (!popup) {
    popup = document.createElement('div');
    popup.id = 'validLocPopup';
    popup.className = 'valid-locations-popup';
    document.body.appendChild(popup);
  }

  let html = '<h4>üìç Sedi valide per timbrare</h4><ul>';
  if (Array.isArray(currentValidLocations) && currentValidLocations.length) {
    currentValidLocations.forEach(function(loc) {
      const name = loc.name || String(loc);
      html += `<li><span>üè¢</span> ${name}</li>`;
    });
  } else {
    html += '<li>Nessuna sede configurata</li>';
  }
  html += '</ul><button class="close-btn" onclick="closeValidLocationsPopup()">Chiudi</button>';
  popup.innerHTML = html;
  overlay.classList.add('active');
  popup.classList.add('active');
}

function closeValidLocationsPopup() {
  const overlay = document.getElementById('validLocOverlay');
  const popup = document.getElementById('validLocPopup');
  if (overlay) overlay.classList.remove('active');
  if (popup) popup.classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openGpsModal(label) {
  document.getElementById('gpsTitle').textContent = 'üìç ' + label;
  document.getElementById('gpsSubtitle').textContent = 'Avvicinati alla sede per timbrare';
  
  // Mostra le sedi valide del turno (sede gruppo + location turno)
  let locationNames;
  // Priorit√†: valid_locations (sede gruppo + location turno) > legacy fallbacks
  // Costruisci lista unificata delle sedi abilitate (currentValidLocations + gps_config + shift fallback)
  const gpsLocationEl = document.getElementById('gpsLocationName');
  gpsLocationEl.innerHTML = '';

  // Raccogli le sedi valide SOLO dal backend (valid_locations del turno, che include sede gruppo + location Rentman + custom locations)
  const collected = [];
  if (Array.isArray(currentValidLocations) && currentValidLocations.length) {
    currentValidLocations.forEach(vl => collected.push({ name: vl.name || String(vl), source: 'turno' }));
  }
  // Fallback: se il backend non ha fornito valid_locations, usa la location dallo shift GPS data
  if (!collected.length && currentShiftGpsData && currentShiftGpsData.location) {
    collected.push({ name: currentShiftGpsData.location, source: 'shift' });
  }

  // Rimuovi duplicati preservando ordine (confronto su nome normalizzato)
  const seen = new Set();
  const unified = [];
  collected.forEach(item => {
    const key = (item.name || '').toString().trim().toLowerCase();
    if (!key) return;
    if (!seen.has(key)) {
      seen.add(key);
      unified.push(item);
    }
  });

  if (unified.length) {
    const list = document.createElement('div');
    list.className = 'gps-location-list';
    unified.forEach(it => {
      const item = document.createElement('div');
      item.className = 'gps-location-item';
      item.textContent = it.name;
      // Tagga la location pi√π probabile (turno) con un'icona
      if (it.source === 'turno') {
        const badge = document.createElement('span');
        badge.style.marginRight = '8px';
        badge.textContent = 'üè¢';
        item.prepend(badge);
      }
      list.appendChild(item);
    });
    gpsLocationEl.appendChild(list);
  } else {
    const fallback = (currentShiftGpsData && currentShiftGpsData.location) || currentShiftLocationName || 'Sede';
    gpsLocationEl.innerHTML = `<span class="location-label">üè¢</span> <strong>${fallback}</strong>`;
  }
  
  document.getElementById('gpsIcon').textContent = 'üìç';
  document.getElementById('gpsIcon').classList.add('loading');
  document.getElementById('gpsMessage').textContent = 'Rilevamento posizione...';
  document.getElementById('gpsAccuracy').textContent = '';
  document.getElementById('gpsAccuracy').className = 'gps-accuracy';
  document.getElementById('gpsConfirmBtn').disabled = true;
  
  lastGpsPosition = null;
  
  document.getElementById('gpsModal').classList.add('active');
  
  // Inizia il tracking GPS
  startGpsTracking();
}

function closeGpsModal() {
  document.getElementById('gpsModal').classList.remove('active');
  stopGpsTracking();
  pendingTimbraturaType = null;
  lastGpsPosition = null;
}

function startGpsTracking() {
  if (!navigator.geolocation) {
    updateGpsStatus('error', '‚ùå GPS non supportato', 'Il tuo browser non supporta la geolocalizzazione');
    return;
  }
  
  const options = {
    enableHighAccuracy: true,
    timeout: 15000,
    maximumAge: 0
  };
  
  gpsWatchId = navigator.geolocation.watchPosition(
    onGpsSuccess,
    onGpsError,
    options
  );
}

function stopGpsTracking() {
  if (gpsWatchId !== null) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
}

function onGpsSuccess(position) {
  const { latitude, longitude, accuracy } = position.coords;
  lastGpsPosition = { latitude, longitude, accuracy };
  
  // Calcola distanza dalla sede pi√π vicina
  // Usa valid_locations dal backend (sede gruppo + location turno)
  let minDistance = Infinity;
  let nearestLocation = null;
  let locations = [];
  
  // Priorit√† 1: Usa valid_locations dal backend (sede default gruppo + location turno)
  if (currentValidLocations && currentValidLocations.length > 0) {
    locations = currentValidLocations.map(vl => ({
      name: vl.name,
      latitude: parseFloat(vl.latitude),
      longitude: parseFloat(vl.longitude),
      radius_meters: vl.radius_meters || 300
    }));
  }
  // Priorit√† 2: Coordinate dirette dal turno Rentman (fallback legacy)
  else if (currentShiftGpsData && currentShiftGpsData.lat && currentShiftGpsData.lon) {
    locations = [{
      name: currentShiftGpsData.location || 'Sede',
      latitude: parseFloat(currentShiftGpsData.lat),
      longitude: parseFloat(currentShiftGpsData.lon),
      radius_meters: currentShiftGpsData.radius || 300
    }];
  }
  // Priorit√† 3: Filtra per sede specifica del turno nelle gps_locations globali
  else if (currentShiftLocationName && (timbraturaConfig.gps_locations || []).length > 0) {
    const allLocs = timbraturaConfig.gps_locations;
    const filteredLocations = allLocs.filter(l => l.name === currentShiftLocationName);
    locations = filteredLocations.length > 0 ? filteredLocations : allLocs;
  }
  // Priorit√† 4: Tutte le gps_locations globali
  else {
    locations = timbraturaConfig.gps_locations || [];
  }
  
  for (const loc of locations) {
    if (loc.latitude && loc.longitude) {
      const dist = haversineDistance(latitude, longitude, loc.latitude, loc.longitude);
      if (dist < minDistance) {
        minDistance = dist;
        nearestLocation = loc;
      }
    }
  }
  
  // Determina qualit√† del segnale
  let accuracyClass = 'poor';
  let accuracyText = 'Precisione bassa';
  let accuracyTip = 'üí° Vai all\'aperto per migliorare';
  
  if (accuracy <= 15) {
    accuracyClass = 'good';
    accuracyText = 'Precisione ottima';
    accuracyTip = '';
  } else if (accuracy <= 30) {
    accuracyClass = 'good';
    accuracyText = 'Precisione buona';
    accuracyTip = '';
  } else if (accuracy <= timbraturaConfig.gps_max_accuracy_meters) {
    accuracyClass = 'medium';
    accuracyText = 'Precisione sufficiente';
    accuracyTip = '';
  }
  
  const isAccuracyOk = accuracy <= timbraturaConfig.gps_max_accuracy_meters;
  
  // Verifica anche la distanza dalla sede
  const maxRadius = nearestLocation ? (nearestLocation.radius_meters || 300) : 300;
  const isDistanceOk = minDistance <= (maxRadius + accuracy); // considera l'accuracy come margine
  const isValid = isAccuracyOk && isDistanceOk;
  
  document.getElementById('gpsIcon').textContent = isValid ? '‚úÖ' : (isAccuracyOk ? '‚ö†Ô∏è' : 'üìç');
  document.getElementById('gpsIcon').classList.toggle('loading', !isAccuracyOk);
  
  // Messaggio in base allo stato
  if (!isAccuracyOk) {
    document.getElementById('gpsMessage').textContent = 'In attesa di precisione migliore...';
  } else if (!isDistanceOk) {
    document.getElementById('gpsMessage').textContent = '‚ö†Ô∏è Troppo lontano dalla sede';
  } else {
    document.getElementById('gpsMessage').textContent = 'Posizione rilevata!';
  }
  
  // Mostra precisione E distanza
  let accuracyDisplay = `${accuracyText} (¬±${Math.round(accuracy)}m)`;
  if (nearestLocation && minDistance !== Infinity) {
    const distText = minDistance >= 1000 
      ? `${(minDistance/1000).toFixed(1)} km` 
      : `${Math.round(minDistance)} m`;
    const distColor = isDistanceOk ? 'var(--success)' : 'var(--danger, #dc3545)';
    accuracyDisplay += `<br><span style="color: ${distColor}">üìç Distanza dalla sede: <strong>${distText}</strong></span>`;
    if (!isDistanceOk) {
      accuracyDisplay += `<br><span class="gps-tip">‚ö†Ô∏è Devi essere entro ${maxRadius}m dalla sede</span>`;
    }
  }
  if (accuracyTip) {
    accuracyDisplay += `<br><span class="gps-tip">${accuracyTip}</span>`;
  }
  document.getElementById('gpsAccuracy').innerHTML = accuracyDisplay;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy ' + (isValid ? accuracyClass : 'poor');
  document.getElementById('gpsConfirmBtn').disabled = !isAccuracyOk; // Permetti conferma, il server far√† la validazione finale
  
  if (isAccuracyOk) {
    document.getElementById('gpsSubtitle').textContent = isDistanceOk 
      ? 'Premi Conferma per timbrare' 
      : 'Avvicinati alla sede per timbrare';
  }
}

// Funzione per calcolare la distanza tra due coordinate (formula di Haversine)
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000; // Raggio della Terra in metri
  const phi1 = lat1 * Math.PI / 180;
  const phi2 = lat2 * Math.PI / 180;
  const deltaPhi = (lat2 - lat1) * Math.PI / 180;
  const deltaLambda = (lon2 - lon1) * Math.PI / 180;
  
  const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  
  return R * c;
}

function onGpsError(error) {
  let message = 'Errore GPS';
  let detail = '';
  
  switch(error.code) {
    case error.PERMISSION_DENIED:
      message = '‚ö†Ô∏è Permesso negato';
      detail = 'Abilita la posizione nelle impostazioni';
      break;
    case error.POSITION_UNAVAILABLE:
      message = '‚ö†Ô∏è Posizione non disponibile';
      detail = 'Prova all\'aperto o attendi';
      break;
    case error.TIMEOUT:
      message = '‚ö†Ô∏è Timeout';
      detail = 'Rilevamento troppo lento';
      break;
  }
  
  updateGpsStatus('error', message, detail);
}

function updateGpsStatus(type, message, detail) {
  document.getElementById('gpsIcon').textContent = type === 'error' ? '‚ö†Ô∏è' : 'üìç';
  document.getElementById('gpsIcon').classList.remove('loading');
  document.getElementById('gpsMessage').textContent = message;
  document.getElementById('gpsAccuracy').textContent = detail;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy poor';
  document.getElementById('gpsConfirmBtn').disabled = true;
}

async function confirmGpsLocation() {
  if (!lastGpsPosition) {
    showToast('Posizione non disponibile', 'error');
    return;
  }
  
  const tipo = pendingTimbraturaType;
  const confirmBtn = document.getElementById('gpsConfirmBtn');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Verifica...';
  
  // Se offline, salva la timbratura con coordinate per sincronizzarla dopo
  if (!navigator.onLine) {
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con coordinate GPS. Verr√† sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
    return;
  }
  
  try {
    // Valida posizione con il server
    // Invia le valid_locations (sede gruppo + location turno) per validazione
    const validatePayload = {
      latitude: lastGpsPosition.latitude,
      longitude: lastGpsPosition.longitude,
      accuracy: lastGpsPosition.accuracy
    };
    // Invia valid_locations dal backend (sede gruppo + location turno)
    if (currentValidLocations && currentValidLocations.length > 0) {
      validatePayload.valid_locations = currentValidLocations;
    }
    if (currentShiftLocationName) {
      validatePayload.shift_location_name = currentShiftLocationName;
    }
    // Invia anche le coordinate della sede per il fallback
    if (currentShiftGpsData && currentShiftGpsData.lat && currentShiftGpsData.lon) {
      validatePayload.shift_location_lat = currentShiftGpsData.lat;
      validatePayload.shift_location_lon = currentShiftGpsData.lon;
    }
    
    console.log("üîµ GPS Validate - currentValidLocations:", currentValidLocations);
    console.log("üîµ GPS Validate Payload:", validatePayload);
    console.log("üîµ currentShiftGpsData:", currentShiftGpsData);
    
    const validateRes = await fetch('/api/timbratura/validate-gps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(validatePayload)
    });
    
    const validateData = await validateRes.json();
    
    console.log("GPS Validate Response:", validateData);
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'Posizione non valida', 'error');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Conferma';
      return;
    }
    
    closeGpsModal();
    
    // GPS valido, registra timbratura
    const token = validateData.token;
    
    const gpsPayload = { tipo, token };
    if (pendingBreakInfo) gpsPayload.break_info = pendingBreakInfo;
    console.log('üîµ GPS Payload (break_info):', JSON.stringify(gpsPayload));
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(gpsPayload)
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      const locationName = validateData.location || 'Sede';
      showToast(`${TIMBRATURA_TYPES[tipo]?.label} registrata (${locationName})! ‚úì`, 'success');
      
      // üîç DEBUG: pausa confermata e flessibilit√† uscita
      if (data._break_debug) console.log('üîç BREAK_DEBUG (GPS):', JSON.stringify(data._break_debug, null, 2));
      if (data._flex_exit_debug) console.log('üîç FLEX_EXIT_DEBUG (GPS):', JSON.stringify(data._flex_exit_debug, null, 2));
      
      // üß™ TEST PAYLOAD POPUP - Mostra URL CedolinoWeb
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo);
      }
      
      loadTimbrature();
      
      // Se √® stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        if (data.extra_turno.skip_motivation) {
          showToast('‚è±Ô∏è Extra Turno rilevato - motivazione copiata dall\'anticipo ingresso', 'success');
        } else {
          setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
        }
      }
      // Se √® stato rilevato Fuori Flessibilit√†, mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se √® stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se √® stata rilevata un'attivit√† di produzione da avviare
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          _pendingProductionActivity = data.production_activity;
        } else {
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': '‚è∏Ô∏è Attivit√† in pausa',
          'resumed': '‚ñ∂Ô∏è Attivit√† ripresa',
          'stopped': '‚èπÔ∏è Attivit√† terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else if (data.need_break_reduction_reason) {
      const br = data.break_reduction || {};
      showBreakReductionMotivationPopup(
        br.planned_break_minutes || 0,
        br.effective_break_minutes || 0,
        () => { pendingTimbraturaType = tipo; proceedWithTimbratura(tipo); },
        null
      );
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
      // Mostra anche l'URL di debug in caso di errore
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo, data.error);
      }
    }
  } catch (err) {
    console.error('Errore GPS:', err);
    // Fallback offline
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QR SCANNER (esistente)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Registra timbratura direttamente (modalit√† diretta o offline)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEST PAYLOAD - Imposta a true per vedere popup con payload CedolinoWeb
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TEST_PAYLOAD_POPUP = false;  // <-- Cambia a true per attivare

async function registerTimbraturaDirectly(tipo) {
  try {
    const payload = { tipo, bypass_qr: true, offline_ts: Date.now() };
    if (pendingBreakInfo) payload.break_info = pendingBreakInfo;
    console.log('üîµ Direct Payload (break_info):', JSON.stringify(payload));
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! ‚úì', 'success');
      
      // üîç DEBUG: pausa confermata e flessibilit√† uscita
      if (data._break_debug) console.log('üîç BREAK_DEBUG (Direct):', JSON.stringify(data._break_debug, null, 2));
      if (data._flex_exit_debug) console.log('üîç FLEX_EXIT_DEBUG (Direct):', JSON.stringify(data._flex_exit_debug, null, 2));
      
      // üß™ TEST PAYLOAD POPUP - Mostra URL CedolinoWeb
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo);
      }
      
      loadTimbrature();
      
      // Se √® stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        if (data.extra_turno.skip_motivation) {
          showToast('‚è±Ô∏è Extra Turno rilevato - motivazione copiata dall\'anticipo ingresso', 'success');
        } else {
          setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
        }
      }
      // Se √® stato rilevato Fuori Flessibilit√†, mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se √® stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se √® stata rilevata una pausa ridotta, informa che √® in approvazione admin
      if (data.break_reduction_request && data.break_reduction_request.detected) {
        const br = data.break_reduction_request;
        setTimeout(() => {
          showToast(`‚òï Pausa ridotta: richiesta inviata (${br.effective_break_minutes}/${br.planned_break_minutes} min)`, 'warning');
        }, 700);
      }
      // Se √® stata rilevata una pausa ridotta, informa che √® in approvazione admin
      if (data.break_reduction_request && data.break_reduction_request.detected) {
        const br = data.break_reduction_request;
        setTimeout(() => {
          showToast(`‚òï Pausa ridotta: richiesta inviata (${br.effective_break_minutes}/${br.planned_break_minutes} min)`, 'warning');
        }, 700);
      }
      // Se √® stata rilevata un'attivit√† di produzione da avviare (mostrato SEMPRE, anche con altri popup)
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          // Se c'√® anche il ritardo, salva l'attivit√† e mostrala dopo chiusura popup ritardo
          _pendingProductionActivity = data.production_activity;
        } else {
          // Delay maggiore se ci sono altri popup
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': '‚è∏Ô∏è Attivit√† in pausa',
          'resumed': '‚ñ∂Ô∏è Attivit√† ripresa',
          'stopped': '‚èπÔ∏è Attivit√† terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else if (data.need_break_reduction_reason) {
      const br = data.break_reduction || {};
      showBreakReductionMotivationPopup(
        br.planned_break_minutes || 0,
        br.effective_break_minutes || 0,
        () => { pendingTimbraturaType = tipo; proceedWithTimbratura(tipo); },
        null
      );
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
      // Mostra anche l'URL di debug in caso di errore
      if (TEST_PAYLOAD_POPUP && data.cedolino_url) {
        showTestPayloadPopup(data.cedolino_url, tipo, data.error);
      }
    }
  } catch (err) {
    console.error('Errore:', err);
    
    // Se offline, il Service Worker metter√† in coda la richiesta
    if (!navigator.onLine) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      // Salva anche in localStorage come backup
      saveOfflineTimbratura(tipo);
    } else {
      showToast('Errore di connessione', 'error');
    }
  }
  pendingTimbraturaType = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP ATTIVIT√Ä PRODUZIONE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function showProductionActivityPopup(activity) {
  // Se tutti i turni sono gestione_squadra e l'utente non √® leader, skip popup
  // L'attivit√† √® gestita dal capo squadra/supervisore
  const isGestioneSquadra = allTurni.length > 0 && allTurni.every(t => t.gestione_squadra && !t.is_leader);
  if (isGestioneSquadra) {
    console.log('[PROD-POPUP] Gestione squadra attiva, skip popup attivit√† (gestito dal supervisore)');
    showToast('‚úì Timbratura registrata', 'success');
    return;
  }
  
  const timbraturaTs = activity.timbratura_ts || Date.now();
  
  // Prendi progetto e attivit√† dal turno visualizzato sulla home (prioritario)
  const turno = allTurni[currentTurnoIndex] || {};
  const projectCode = turno.project_code || activity.project_code || '';
  const projectName = turno.project_name || activity.project_name || projectCode;
  const activityLabel = turno.function || activity.activity_label || 'Attivit√†';
  const normalizedActivity = (activityLabel || '').toString().trim().toLowerCase();
  const requiresManualSelection =
    Boolean(activity.manual_selection || activity.requires_project_selection || activity.requires_activity_selection) ||
    !projectCode ||
    !activityLabel ||
    normalizedActivity === '-' ||
    normalizedActivity === 'attivit√†' ||
    normalizedActivity === 'attivita';

  console.log('[PROD-POPUP] activity:', JSON.stringify(activity));
  console.log('[PROD-POPUP] allTurni.length:', allTurni.length, 'currentTurnoIndex:', currentTurnoIndex);
  console.log('[PROD-POPUP] turno.project_code:', turno.project_code, 'turno.function:', turno.function);
  console.log('[PROD-POPUP] projectCode:', projectCode, 'activityLabel:', activityLabel, 'normalized:', normalizedActivity);
  console.log('[PROD-POPUP] requiresManualSelection:', requiresManualSelection,
    '{ manual_selection:', activity.manual_selection,
    ', requires_project:', activity.requires_project_selection,
    ', !projectCode:', !projectCode,
    ', !activityLabel:', !activityLabel,
    ', isAttivita:', normalizedActivity === 'attivit√†' || normalizedActivity === 'attivita', '}');

  if (requiresManualSelection) {
    console.warn('[PROD-POPUP] ‚ö†Ô∏è Opening numpad (manual selection required)');
    openSwitchActivityModal({ forceProjectSelection: true, forceActivitySelection: true, timbraturaTs });
    return;
  }
  
  // ‚ïê‚ïê‚ïê Aspetta che le fasi siano caricate (risolve race condition) ‚ïê‚ïê‚ïê
  console.log('[FASI-POPUP] _loadTurnoPhasesPromise:', !!_loadTurnoPhasesPromise, 'currentTurnoPhasesData:', currentTurnoPhasesData);
  if (_loadTurnoPhasesPromise) {
    try {
      await _loadTurnoPhasesPromise;
      console.log('[FASI-POPUP] Promise risolta, currentTurnoPhasesData:', currentTurnoPhasesData);
    } catch (e) {
      console.error('[FASI-POPUP] Errore attesa caricamento fasi:', e);
    }
  }

  // Se non c'√® ancora, forza il caricamento
  if (!currentTurnoPhasesData) {
    console.log('[FASI-POPUP] currentTurnoPhasesData ancora null, forzo caricamento...');
    const turno = allTurni[currentTurnoIndex] || {};
    if (turno.function && turno.project_code) {
      await loadTurnoPhases(turno);
      console.log('[FASI-POPUP] Caricamento forzato completato:', currentTurnoPhasesData);
    }
  }
  
  // ‚ïê‚ïê‚ïê Se la funzione ha FASI configurate, mostra selezione fasi ‚ïê‚ïê‚ïê
  if (currentTurnoPhasesData && currentTurnoPhasesData.matchedPhases.length > 0) {
    console.log('[FASI-POPUP] Mostra selezione fasi!', currentTurnoPhasesData.matchedPhases.length, 'fasi');
    showPhaseSelectionPopup(projectCode, projectName, activityLabel, timbraturaTs, 'start');
    return;
  }
  
  console.log('[FASI-POPUP] Nessuna fase trovata, mostra popup generico');
  // Lista attivit√† predefinite produzione
  const ACTIVITIES = [
    { code: 'Preparazione', icon: 'üì¶', label: 'Preparazione' },
    { code: 'Carico', icon: 'üöö', label: 'Carico' },
    { code: 'Scarico', icon: 'üì•', label: 'Scarico' },
    { code: 'Controllo', icon: 'üîç', label: 'Controllo' },
    { code: 'Pulizia', icon: 'üßπ', label: 'Pulizia' },
    { code: 'Verifica', icon: '‚úÖ', label: 'Verifica' },
    { code: 'Manutenzione', icon: 'üîß', label: 'Manutenzione' },
    { code: 'Altro', icon: 'üìù', label: 'Altro' }
  ];
  
  let listHtml = '<div id="productionActivityGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;display:none;">';
  ACTIVITIES.forEach(a => {
    listHtml += `
      <div onclick="confirmStartProductionActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(a.code)}', ${timbraturaTs})"
           style="background:var(--bg);border:2px solid var(--border);border-radius:14px;padding:16px 10px;cursor:pointer;transition:all 0.2s;text-align:center;"
           onmouseover="this.style.borderColor='var(--brand)';this.style.background='#e3f2fd';this.style.transform='scale(1.03)'"
           onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg)';this.style.transform='scale(1)'">
        <div style="font-size:32px;margin-bottom:6px;">${a.icon}</div>
        <div style="font-weight:600;font-size:13px;color:var(--text-primary);">${escapeHtml(a.label)}</div>
      </div>`;
  });
  listHtml += '</div>';
  
  const html = `
    <div id="productionActivityPopup" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;">
      <div style="background:var(--bg-card);color:var(--text-primary);padding:24px;border-radius:16px;max-width:400px;width:100%;box-shadow:var(--shadow-lg);max-height:85vh;overflow-y:auto;">
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:48px;margin-bottom:12px;">üè≠</div>
          <h3 style="margin:0 0 8px;font-size:18px;font-weight:600;" id="productionPopupTitle">Avviare attivit√†?</h3>
          <p style="margin:0;color:var(--text-secondary);font-size:14px;" id="productionPopupSubtitle">Stai iniziando la giornata su un turno di produzione.</p>
        </div>
        
        <div id="productionDefaultView">
          <div style="background:var(--bg);padding:16px;border-radius:12px;margin-bottom:20px;">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">PROGETTO</div>
            <div style="font-weight:600;font-size:15px;margin-bottom:12px;">${escapeHtml(projectName)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">MANSIONE</div>
            <div style="font-weight:600;font-size:15px;color:var(--brand);">${escapeHtml(activityLabel)}</div>
          </div>
          
          <p style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;text-align:center;">
            Vuoi avviare automaticamente il timer per questa attivit√†?
          </p>
          
          <div style="display:flex;gap:12px;">
            <button onclick="showProductionActivityGrid()" style="flex:1;padding:14px;background:var(--bg);color:var(--brand);border:2px solid var(--brand);border-radius:10px;font-weight:600;cursor:pointer;">
              üîÑ Cambia Attivit√†
            </button>
            <button onclick="confirmStartProductionActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(activityLabel)}', ${timbraturaTs})" style="flex:1;padding:14px;background:var(--green);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;">
              Avvia ‚ñ∂Ô∏è
            </button>
          </div>
        </div>
        
        ${listHtml}
        
        <button onclick="hideProductionActivityGrid()" style="width:100%;margin-top:14px;padding:12px;background:var(--bg);color:var(--text-secondary);border:1px solid var(--border);border-radius:10px;font-weight:600;cursor:pointer;display:none;" id="productionBackBtn">
          ‚Üê Indietro
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', html);
}

function showProductionActivityGrid() {
  document.getElementById('productionDefaultView').style.display = 'none';
  document.getElementById('productionActivityGrid').style.display = 'grid';
  document.getElementById('productionBackBtn').style.display = 'block';
  document.getElementById('productionPopupTitle').textContent = 'Seleziona attivit√†';
  document.getElementById('productionPopupSubtitle').textContent = 'Scegli l\'attivit√† da avviare.';
}

function hideProductionActivityGrid() {
  document.getElementById('productionDefaultView').style.display = '';
  document.getElementById('productionActivityGrid').style.display = 'none';
  document.getElementById('productionBackBtn').style.display = 'none';
  document.getElementById('productionPopupTitle').textContent = 'Avviare attivit√†?';
  document.getElementById('productionPopupSubtitle').textContent = 'Stai iniziando la giornata su un turno di produzione.';
}

function dismissProductionActivityPopup() {
  const popup = document.getElementById('productionActivityPopup');
  if (popup) popup.remove();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP SELEZIONE FASI (per avvio giornata e cambio attivit√†)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function showPhaseSelectionPopup(projectCode, projectName, functionLabel, timbraturaTs, mode) {
  // mode: 'start' = avvio giornata, 'switch' = cambio attivit√†
  const pd = currentTurnoPhasesData;
  if (!pd) return;
  
  const phases = pd.matchedPhases;
  const states = pd.states || [];
  const isSwitch = mode === 'switch';
  
  // Recupera l'attivit√† in corso dal timer per evidenziare fase attiva
  let activePhaseLabel = '';
  try {
    const timerRes = await fetch('/api/production/timer');
    const timerData = await timerRes.json();
    if (timerData.ok && timerData.active && timerData.timer) {
      activePhaseLabel = (timerData.timer.activity_label || '').trim();
    }
  } catch(e) { console.warn('Errore recupero timer attivo per fasi:', e); }
  
  let phasesHtml = '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">';
  phases.forEach((ph, i) => {
    const state = states.find(st => st.phase_name === ph.name);
    const isDone = state && state.completed;
    const doneBy = isDone && state.completed_by ? state.completed_by : '';
    const isActive = activePhaseLabel && ph.name.trim().toLowerCase() === activePhaseLabel.toLowerCase();
    
    if (isActive) {
      // Fase IN CORSO ‚Äî bloccata, non cliccabile
      phasesHtml += `
        <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;
                    background:rgba(67,97,238,0.10);
                    border:2px solid var(--brand, #4361ee);
                    border-radius:12px;cursor:default;position:relative;overflow:hidden;">
          <span style="width:32px;height:32px;background:var(--brand, #4361ee);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;">
            ${i + 1}
          </span>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:14px;color:var(--brand, #4361ee);">${escapeHtml(ph.name)}</div>
            <div style="font-size:11px;color:var(--brand, #4361ee);margin-top:2px;display:flex;align-items:center;gap:4px;">
              <span style="display:inline-block;width:8px;height:8px;background:#4361ee;border-radius:50%;animation:pulseDot 1.2s ease-in-out infinite;"></span>
              IN CORSO
            </div>
          </div>
          <span style="font-size:18px;color:var(--brand, #4361ee);font-weight:700;">‚è±Ô∏è</span>
        </div>`;
    } else if (isDone) {
      // Fase completata ‚Äî cliccabile ma mostra come completata
      phasesHtml += `
        <div onclick="selectPhaseForActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(ph.name)}', ${ph.order}, ${timbraturaTs || 0}, '${mode}')"
             style="display:flex;align-items:center;gap:12px;padding:14px 16px;
                    background:rgba(46,204,113,0.08);
                    border:2px solid rgba(46,204,113,0.3);
                    border-radius:12px;cursor:pointer;transition:all 0.15s ease;-webkit-tap-highlight-color:transparent;"
             onmouseover="this.style.borderColor='#2ecc71';this.style.transform='scale(1.02)'"
             onmouseout="this.style.borderColor='rgba(46,204,113,0.3)';this.style.transform='scale(1)'">
          <span style="width:32px;height:32px;background:#2ecc71;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;">
            ‚úì
          </span>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;color:var(--text-primary);text-decoration:line-through;opacity:0.6;">${escapeHtml(ph.name)}</div>
            ${doneBy ? `<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">‚úì ${escapeHtml(doneBy)}</div>` : ''}
          </div>
          <span style="font-size:22px;">‚úÖ</span>
        </div>`;
    } else {
      // Fase non ancora fatto ‚Äî cliccabile
      phasesHtml += `
        <div onclick="selectPhaseForActivity('${escapeHtml(projectCode)}', '${escapeHtml(projectName)}', '${escapeHtml(ph.name)}', ${ph.order}, ${timbraturaTs || 0}, '${mode}')"
             style="display:flex;align-items:center;gap:12px;padding:14px 16px;
                    background:var(--bg);
                    border:2px solid var(--border);
                    border-radius:12px;cursor:pointer;transition:all 0.15s ease;-webkit-tap-highlight-color:transparent;"
             onmouseover="this.style.borderColor='var(--brand)';this.style.transform='scale(1.02)'"
             onmouseout="this.style.borderColor='var(--border)';this.style.transform='scale(1)'">
          <span style="width:32px;height:32px;background:var(--brand, #4361ee);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;">
            ${i + 1}
          </span>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:14px;color:var(--text-primary);">${escapeHtml(ph.name)}</div>
          </div>
          <span style="font-size:22px;">‚ñ∂Ô∏è</span>
        </div>`;
    }
  });
  phasesHtml += '</div>';
  
  const title = isSwitch ? 'Seleziona Fase' : 'Seleziona la fase da avviare';
  const subtitle = isSwitch 
    ? 'La fase precedente verr√† completata automaticamente.' 
    : `Progetto: ${escapeHtml(projectName)}`;
  
  const html = `
    <div id="phaseSelectionPopup" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px 20px;" onclick="dismissPhaseSelectionPopup()">
      <div style="background:var(--bg-card, #fff);color:var(--text-primary);padding:20px;border-radius:16px;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
        <div style="text-align:center;margin-bottom:14px;">
          <h3 style="margin:0 0 4px;font-size:17px;font-weight:700;">${title}</h3>
          <p style="margin:0;color:var(--text-secondary, #888);font-size:13px;">${subtitle}</p>
        </div>
        
        <div style="background:var(--bg, #f8f9fa);padding:12px;border-radius:10px;margin-bottom:16px;">
          <div style="font-size:11px;color:var(--text-muted, #999);margin-bottom:2px;">MANSIONE</div>
          <div style="font-weight:700;font-size:14px;color:var(--brand, #4361ee);">${escapeHtml(functionLabel)}</div>
        </div>
        
        ${phasesHtml}
        
        <!-- Extra attivit√† con descrizione libera -->
        <div id="extraActivitySection" style="margin-bottom:12px;">
          <div onclick="toggleExtraActivityInput()" 
               style="display:flex;align-items:center;gap:12px;padding:14px 16px;
                      background:rgba(255,152,0,0.08);
                      border:2px dashed rgba(255,152,0,0.4);
                      border-radius:12px;cursor:pointer;transition:all 0.15s ease;-webkit-tap-highlight-color:transparent;"
               onmouseover="this.style.borderColor='#ff9800';this.style.transform='scale(1.02)'"
               onmouseout="this.style.borderColor='rgba(255,152,0,0.4)';this.style.transform='scale(1)'">
            <span style="width:32px;height:32px;background:#ff9800;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0;">+</span>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:14px;color:var(--text-primary);">Extra attivit√†</div>
              <div style="font-size:11px;color:var(--text-muted);margin-top:1px;">Descrizione libera</div>
            </div>
            <span style="font-size:20px;">üìù</span>
          </div>
          <div id="extraActivityInputBox" style="display:none;margin-top:8px;padding:12px;background:var(--bg, #f8f9fa);border-radius:10px;">
            <input type="text" id="extraActivityInput" placeholder="Descrivi l'attivit√†..." maxlength="100"
                   style="width:100%;padding:10px 12px;border:2px solid var(--border, #ddd);border-radius:8px;font-size:14px;box-sizing:border-box;outline:none;transition:border-color 0.2s;"
                   onfocus="this.style.borderColor='#ff9800'" onblur="this.style.borderColor='var(--border, #ddd)'"
                   onkeydown="if(event.key==='Enter')confirmExtraActivity('${escapeHtml(projectCode)}','${escapeHtml(projectName)}',${timbraturaTs || 0},'${mode}')">
            <button onclick="confirmExtraActivity('${escapeHtml(projectCode)}','${escapeHtml(projectName)}',${timbraturaTs || 0},'${mode}')"
                    style="width:100%;margin-top:8px;padding:10px;background:#ff9800;color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;transition:background 0.2s;"
                    onmouseover="this.style.background='#f57c00'" onmouseout="this.style.background='#ff9800'">
              ‚ñ∂ Avvia Extra
            </button>
          </div>
        </div>
        
        <button onclick="dismissPhaseSelectionPopup()" style="width:100%;padding:12px;background:var(--bg, #f5f5f5);color:var(--text-secondary, #666);border:1px solid var(--border, #ddd);border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;">
          ‚úï Annulla
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', html);
}

function dismissPhaseSelectionPopup() {
  const popup = document.getElementById('phaseSelectionPopup');
  if (popup) popup.remove();
}

function toggleExtraActivityInput() {
  const box = document.getElementById('extraActivityInputBox');
  if (!box) return;
  const visible = box.style.display !== 'none';
  box.style.display = visible ? 'none' : 'block';
  if (!visible) {
    const inp = document.getElementById('extraActivityInput');
    if (inp) { inp.value = ''; inp.focus(); }
  }
}

async function confirmExtraActivity(projectCode, projectName, timbraturaTs, mode) {
  const inp = document.getElementById('extraActivityInput');
  const desc = (inp ? inp.value : '').trim();
  if (!desc) {
    inp && inp.focus();
    inp && (inp.style.borderColor = '#e74c3c');
    setTimeout(() => inp && (inp.style.borderColor = 'var(--border, #ddd)'), 1500);
    return;
  }
  dismissPhaseSelectionPopup();
  
  if (mode === 'start') {
    await _doStartProductionActivity(projectCode, projectName, desc, timbraturaTs, null);
    await loadTimbrature();
  } else {
    // Chiudi la fase in corso (come in selectPhaseForActivity)
    const pd = currentTurnoPhasesData;
    if (pd) {
      let currentPhaseToClose = null;
      try {
        const timerRes = await fetch('/api/production/timer');
        const timerData = await timerRes.json();
        if (timerData.ok && timerData.active && timerData.timer) {
          currentPhaseToClose = (timerData.timer.activity_label || '').trim();
        }
      } catch(e) { console.warn('Errore recupero timer:', e); }
      
      if (currentPhaseToClose) {
        const prevPhase = pd.matchedPhases.find(p => p.name === currentPhaseToClose);
        if (prevPhase) {
          const prevState = (pd.states || []).find(st => st.phase_name === currentPhaseToClose);
          if (!prevState || !prevState.completed) {
            try {
              await fetch('/api/project-phases/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  date: pd.dateStr,
                  project_key: pd.projectKey,
                  function_key: pd.matchedKey,
                  phase_name: currentPhaseToClose,
                  phase_order: prevPhase.order,
                  completed: true
                })
              });
              const existingState = (pd.states || []).find(st => st.phase_name === currentPhaseToClose);
              if (existingState) {
                existingState.completed = 1;
              } else {
                pd.states.push({ phase_name: currentPhaseToClose, phase_order: prevPhase.order, completed: 1 });
              }
            } catch(e) { console.warn('Errore chiusura fase precedente:', e); }
          }
        }
      }
      turnoCurrentPhases = pd.states || [];
    }
    await _doSwitchActivity(projectCode, projectName, desc, null);
  }
}

async function selectPhaseForActivity(projectCode, projectName, phaseName, phaseOrder, timbraturaTs, mode) {
  dismissPhaseSelectionPopup();
  
  const pd = currentTurnoPhasesData;
  if (!pd) return;
  
  if (mode === 'start') {
    // AVVIO GIORNATA: avvia timer con il nome della fase come activity_label
    await _doStartProductionActivity(projectCode, projectName, phaseName, timbraturaTs, null);
    // Ricarica UI per aggiornare lo stato
    await loadTimbrature();
  } else {
    // CAMBIO ATTIVIT√Ä: chiudi fase precedente + avvia nuova fase
    // 1. Recupera timer attivo per sapere quale fase chiudere
    let currentPhaseToClose = null;
    try {
      const timerRes = await fetch('/api/production/timer');
      const timerData = await timerRes.json();
      if (timerData.ok && timerData.active && timerData.timer) {
        currentPhaseToClose = timerData.timer.activity_label || '';
      }
    } catch(e) { console.warn('Errore recupero timer:', e); }
    
    // 2. Marca la fase precedente come completata (se esiste e non √® gi√† completata)
    if (currentPhaseToClose) {
      const prevPhase = pd.matchedPhases.find(p => p.name === currentPhaseToClose);
      if (prevPhase) {
        const prevState = (pd.states || []).find(st => st.phase_name === currentPhaseToClose);
        if (!prevState || !prevState.completed) {
          try {
            await fetch('/api/project-phases/toggle', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                date: pd.dateStr,
                project_key: pd.projectKey,
                function_key: pd.matchedKey,
                phase_name: currentPhaseToClose,
                phase_order: prevPhase.order,
                completed: true
              })
            });
            // Aggiorna stato locale
            const existingState = (pd.states || []).find(st => st.phase_name === currentPhaseToClose);
            if (existingState) {
              existingState.completed = 1;
            } else {
              pd.states.push({ phase_name: currentPhaseToClose, phase_order: prevPhase.order, completed: 1 });
            }
          } catch(e) { console.warn('Errore chiusura fase precedente:', e); }
        }
      }
    }
    
    // 3. Switch timer alla nuova fase (questo chiama anche loadTimbrature)
    await _doSwitchActivity(projectCode, projectName, phaseName, null);
  }
  
  // Aggiorna turnoCurrentPhases per riflettere i cambiamenti
  if (pd) {
    turnoCurrentPhases = pd.states || [];
  }
}

// --- Gestione note obbligatorie per attivit√† "Altro" ---
let _pendingNotesCallback = null;

function openNotesPopup(callback) {
  _pendingNotesCallback = callback;
  const overlay = document.getElementById('notesOverlay');
  const textarea = document.getElementById('notesTextarea');
  const errorEl = document.getElementById('notesError');
  textarea.value = '';
  textarea.classList.remove('error');
  errorEl.style.display = 'none';
  overlay.classList.add('active');
  setTimeout(() => textarea.focus(), 200);
}

function closeNotesPopup(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('notesOverlay').classList.remove('active');
  _pendingNotesCallback = null;
}

function confirmNotesAndProceed() {
  const textarea = document.getElementById('notesTextarea');
  const errorEl = document.getElementById('notesError');
  const notes = (textarea.value || '').trim();
  
  if (notes.length < 3) {
    textarea.classList.add('error');
    errorEl.style.display = 'block';
    textarea.focus();
    return;
  }
  
  // Chiudi popup e chiama il callback con le note
  document.getElementById('notesOverlay').classList.remove('active');
  if (_pendingNotesCallback) {
    _pendingNotesCallback(notes);
    _pendingNotesCallback = null;
  }
}

async function confirmStartProductionActivity(projectCode, projectName, activityLabel, startTs) {
  // Se c'√® gi√† un progetto valido dal turno, avvia direttamente senza chiedere numpad
  if (projectCode) {
    // Attivit√† "Altro" richiede note obbligatorie
    if (activityLabel.toLowerCase() === 'altro') {
      openNotesPopup(async (notes) => {
        dismissProductionActivityPopup();
        await _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, notes);
      });
      return;
    }
    dismissProductionActivityPopup();
    await _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, null);
    return;
  }
  // Nessun progetto ‚Üí chiedi tramite numpad DOPO aver scelto l'attivit√†
  _pendingProductionStart = { projectCode, projectName, activityLabel, startTs };
  openNumpad('');
}

async function _doStartProductionActivity(projectCode, projectName, activityLabel, startTs, notes) {
  console.log('[ProductionActivity] Avvio timer con:', { projectCode, projectName, activityLabel, startTs, notes });
  
  try {
    const payload = {
      project_code: projectCode,
      project_name: projectName,
      activity_label: activityLabel,
      start_ts: startTs
    };
    if (notes) payload.notes = notes;
    
    const res = await fetch('/api/production/timer/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    console.log('[ProductionActivity] Risposta server:', data);
    
    if (res.ok && data.ok) {
      showToast('‚ñ∂Ô∏è Attivit√† avviata: ' + activityLabel, 'success');
    } else {
      showToast(data.error || 'Errore avvio attivit√†', 'error');
    }
  } catch (err) {
    console.error('Errore avvio attivit√†:', err);
    showToast('Errore di connessione', 'error');
  }
}

// Helper per escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

// üß™ TEST PAYLOAD - Mostra popup con dettagli CedolinoWeb
function showTestPayloadPopup(url, tipo, error = null) {
  // Parsa i parametri dall'URL
  const params = new URL(url).searchParams;
  let html = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="this.remove()">
      <div style="background:#1e1e1e;color:#fff;padding:20px;border-radius:12px;max-width:95%;max-height:90vh;overflow:auto;font-family:monospace;font-size:12px;" onclick="event.stopPropagation()">
        <h3 style="color:#4fc3f7;margin:0 0 15px;">üß™ TEST PAYLOAD CEDOLINO</h3>
        <div style="color:#aaa;margin-bottom:10px;">Tipo: <strong style="color:#fff;">${tipo}</strong></div>
        ${error ? `<div style="color:#ff5252;margin-bottom:15px;">‚ö†Ô∏è Errore: ${error}</div>` : ''}
        <table style="width:100%;border-collapse:collapse;">
          <tr style="border-bottom:1px solid #333;">
            <th style="text-align:left;padding:8px;color:#81c784;">Parametro</th>
            <th style="text-align:left;padding:8px;color:#81c784;">Valore</th>
          </tr>
  `;
  
  for (const [key, value] of params) {
    const isNull = value === 'NULL' || value === '' || value === 'N/A';
    html += `
      <tr style="border-bottom:1px solid #333;">
        <td style="padding:8px;color:#fff;">${key}</td>
        <td style="padding:8px;color:${isNull ? '#ff9800' : '#4fc3f7'};">${value || '(vuoto)'}</td>
      </tr>
    `;
  }
  
  html += `
        </table>
        <div style="margin-top:15px;padding:10px;background:#2d2d2d;border-radius:6px;word-break:break-all;font-size:10px;color:#888;">
          <strong>URL completo:</strong><br>${url}
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#4fc3f7;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">
          CHIUDI
        </button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', html);
}

// Salva timbratura offline in localStorage come backup
function saveOfflineTimbratura(tipo, extra = {}) {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  offlineQueue.push({
    tipo,
    timestamp: new Date().toISOString(),
    ts: Date.now(),
    ...extra
  });
  localStorage.setItem('offline_timbrature', JSON.stringify(offlineQueue));
  updateUI(); // Aggiorna subito lo storico per mostrare la timbratura offline
}

// Sincronizza timbrature offline
async function syncOfflineTimbrature() {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  if (offlineQueue.length === 0) return;
  
  console.log('[Offline Sync] Sincronizzazione di', offlineQueue.length, 'timbrature...');
  
  const remaining = [];
  let syncedCount = 0;
  
  for (const item of offlineQueue) {
    try {
      // Costruisci payload con dati opzionali (GPS, QR)
      const payload = { 
        tipo: item.tipo, 
        offline_ts: item.ts,
        offline_timestamp: item.timestamp
      };
      
      // Se ha dati GPS, aggiungi al payload per validazione server
      // NON impostare bypass_qr quando c'√® GPS - il server deve validare le coordinate
      if (item.gps) {
        payload.offline_gps = item.gps;
      } else if (item.qr_code) {
        // Se ha dati QR, aggiungi al payload
        payload.offline_qr = item.qr_code;
      } else {
        // Solo se non ci sono n√© GPS n√© QR, usa bypass_qr (timbratura diretta)
        payload.bypass_qr = true;
      }
      
      const res = await fetch('/api/timbratura', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (res.ok) {
        console.log('[Offline Sync] Sincronizzata:', item.tipo, item.timestamp);
        syncedCount++;
      } else {
        const errData = await res.json().catch(() => ({}));
        console.warn('[Offline Sync] Errore server:', errData.error || res.status);
        remaining.push(item);
      }
    } catch (err) {
      remaining.push(item);
    }
  }
  
  localStorage.setItem('offline_timbrature', JSON.stringify(remaining));
  
  if (syncedCount > 0) {
    showToast(`‚úÖ ${syncedCount} timbratur${syncedCount === 1 ? 'a' : 'e'} sincronizzat${syncedCount === 1 ? 'a' : 'e'}!`, 'success');
    loadTimbrature(); // Ricarica dal server per avere i dati completi
  }
  
  if (remaining.length > 0) {
    console.warn('[Offline Sync] Rimaste', remaining.length, 'timbrature non sincronizzate');
  }
}

// Apri scanner
function openScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.add('active');
  
  html5QrcodeScanner = new Html5Qrcode("qr-reader");
  
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    onScanFailure
  ).catch((err) => {
    console.error('Errore avvio scanner:', err);
    
    // Messaggio specifico per problemi HTTPS/permessi
    let errorMsg = 'Errore accesso alla camera';
    const errStr = String(err).toLowerCase();
    
    if (errStr.includes('notallowed') || errStr.includes('permission')) {
      errorMsg = '‚ö†Ô∏è Permesso camera negato. Controlla le impostazioni del browser.';
    } else if (errStr.includes('notfound') || errStr.includes('no camera')) {
      errorMsg = '‚ö†Ô∏è Nessuna camera trovata sul dispositivo.';
    } else if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      errorMsg = '‚ö†Ô∏è HTTPS richiesto! La camera funziona solo su connessioni sicure (HTTPS) o localhost.';
    }
    
    showToast(errorMsg, 'error');
    closeScanner();
  });
}

// Chiudi scanner
function closeScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.remove('active');
  pendingTimbraturaType = null;
  
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    }).catch((err) => {
      console.error('Errore stop scanner:', err);
    });
  }
}

// Callback scan riuscito - valida QR e registra timbratura
async function onScanSuccess(decodedText, decodedResult) {
  // Salva il tipo PRIMA di chiudere lo scanner (che resetta pendingTimbraturaType)
  const tipo = pendingTimbraturaType;
  
  closeScanner();
  
  if (!tipo) {
    showToast('Errore: nessuna timbratura selezionata', 'error');
    return;
  }
  
  // Se offline, salva QR code per validazione successiva
  if (!navigator.onLine) {
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con QR. Verr√† sincronizzata automaticamente.', 'warning');
    return;
  }
  
  try {
    // Prima valida il QR
    const validateRes = await fetch('/api/timbratura/validate-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: decodedText })
    });
    
    const validateData = await validateRes.json();
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'QR non valido', 'error');
      return;
    }
    
    // QR valido, ora registra la timbratura
    const token = validateData.token;
    
    const qrPayload = { tipo, token };
    if (pendingBreakInfo) qrPayload.break_info = pendingBreakInfo;
    console.log('üîµ QR Payload (break_info):', JSON.stringify(qrPayload));
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(qrPayload)
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! ‚úì', 'success');
      
      // üîç DEBUG: pausa confermata e flessibilit√† uscita
      if (data._break_debug) console.log('üîç BREAK_DEBUG (QR):', JSON.stringify(data._break_debug, null, 2));
      if (data._flex_exit_debug) console.log('üîç FLEX_EXIT_DEBUG (QR):', JSON.stringify(data._flex_exit_debug, null, 2));
      
      loadTimbrature();
      
      // Se √® stato rilevato un Extra Turno, mostra il popup
      if (data.extra_turno && data.extra_turno.detected) {
        if (data.extra_turno.skip_motivation) {
          showToast('‚è±Ô∏è Extra Turno rilevato - motivazione copiata dall\'anticipo ingresso', 'success');
        } else {
          setTimeout(() => showExtraTurnoPopup(data.extra_turno, tipo), 500);
        }
      }
      // Se √® stato rilevato Fuori Flessibilit√†, mostra il popup
      if (data.flex_warning && data.flex_warning.detected) {
        setTimeout(() => showFlexWarningPopup(data.flex_warning), 600);
      }
      // Se √® stato rilevato un Ritardo, mostra il popup
      if (data.late_arrival && data.late_arrival.detected) {
        const lateDelay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1200 : 600;
        setTimeout(() => showLateArrivalPopup(data.late_arrival), lateDelay);
      }
      // Se √® stata rilevata una pausa ridotta, informa che √® in approvazione admin
      if (data.break_reduction_request && data.break_reduction_request.detected) {
        const br = data.break_reduction_request;
        setTimeout(() => {
          showToast(`‚òï Pausa ridotta: richiesta inviata (${br.effective_break_minutes}/${br.planned_break_minutes} min)`, 'warning');
        }, 700);
      }
      // Se √® stata rilevata un'attivit√† di produzione da avviare
      if (data.production_activity && data.production_activity.detected && data.production_activity.action === 'start') {
        if (data.late_arrival?.detected) {
          _pendingProductionActivity = data.production_activity;
        } else {
          const delay = (data.extra_turno?.detected || data.flex_warning?.detected) ? 1800 : 500;
          setTimeout(() => showProductionActivityPopup(data.production_activity), delay);
        }
      }
      // Notifica azioni automatiche sul timer di produzione (pausa/resume/stop)
      else if (data.production_activity && data.production_activity.action) {
        const actionMessages = {
          'paused': '‚è∏Ô∏è Attivit√† in pausa',
          'resumed': '‚ñ∂Ô∏è Attivit√† ripresa',
          'stopped': '‚èπÔ∏è Attivit√† terminata e salvata'
        };
        if (actionMessages[data.production_activity.action]) {
          setTimeout(() => showToast(actionMessages[data.production_activity.action], 'info'), 500);
        }
      }
    } else if (data.need_break_reduction_reason) {
      const br = data.break_reduction || {};
      showBreakReductionMotivationPopup(
        br.planned_break_minutes || 0,
        br.effective_break_minutes || 0,
        () => { pendingTimbraturaType = tipo; proceedWithTimbratura(tipo); },
        null
      );
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
    }
  } catch (err) {
    console.error('Errore:', err);
    // Fallback offline
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
  }
}

// Callback scan fallito (ignora errori continui)
function onScanFailure(error) {
  // Ignora - √® normale durante la scansione
}

// Aggiorna UI in base alle timbrature
function updateUI() {
  // Combina timbrature server + offline pending
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filtra solo timbrature offline di oggi e crea oggetti compatibili
  const offlineToday = offlineQueue
    .filter(item => item.timestamp && item.timestamp.startsWith(today))
    .map(item => ({
      tipo: item.tipo,
      ora: item.timestamp.split('T')[1].substring(0, 8), // HH:MM:SS
      ora_mod: null,
      offline: true,  // Marca come offline
      offline_ts: item.ts
    }));
  
  // Ordine logico dei tipi di timbratura (per risolvere parit√† di orario)
  const TIPO_ORDER = {
    'inizio_giornata': 1,
    'inizio_pausa': 2,
    'fine_pausa': 3,
    'fine_giornata': 4
  };
  
  // Combina e ordina per ora (crescente per logica interna)
  const allTimbrature = [...todayTimbrature.map(t => ({...t, offline: false})), ...offlineToday]
    .sort((a, b) => {
      // Normalizza ora con zero-padding (es: "9:20" -> "09:20:00")
      const normalizeOra = (ora) => {
        if (!ora) return '00:00:00';
        const parts = ora.split(':');
        const hh = (parts[0] || '00').padStart(2, '0');
        const mm = (parts[1] || '00').padStart(2, '0');
        const ss = (parts[2] || '00').padStart(2, '0');
        return `${hh}:${mm}:${ss}`;
      };
      const oraA = normalizeOra(a.ora);
      const oraB = normalizeOra(b.ora);
      const cmp = oraA.localeCompare(oraB);
      // In caso di parit√†, ordina per tipo logico
      if (cmp === 0) {
        return (TIPO_ORDER[a.tipo] || 99) - (TIPO_ORDER[b.tipo] || 99);
      }
      return cmp;
    });
  
  // Per lo storico, ordine decrescente (pi√π recente in alto)
  const allTimbratureDisplay = [...allTimbrature].sort((a, b) => {
    // Normalizza ora con zero-padding (es: "9:20" -> "09:20")
    const oraA = (a.ora || '00:00').split(':').map(p => p.padStart(2, '0')).join(':');
    const oraB = (b.ora || '00:00').split(':').map(p => p.padStart(2, '0')).join(':');
    const cmp = oraB.localeCompare(oraA);  // b-a per decrescente
    // In caso di parit√†, ordina per tipo logico (inverso per decrescente)
    if (cmp === 0) {
      return (TIPO_ORDER[b.tipo] || 99) - (TIPO_ORDER[a.tipo] || 99);
    }
    return cmp;
  });
  
  const hasStarted = allTimbrature.some(t => t.tipo === 'inizio_giornata');
  const hasEnded = allTimbrature.some(t => t.tipo === 'fine_giornata');
  const lastPause = [...allTimbrature].reverse().find(t => t.tipo === 'inizio_pausa' || t.tipo === 'fine_pausa');
  const inPause = lastPause?.tipo === 'inizio_pausa';

  // Pulsanti - abilitati in base allo stato (la validazione QR avviene al click)
  document.getElementById('btnStartDay').disabled = hasStarted;
  document.getElementById('btnEndDay').disabled = !hasStarted || hasEnded || inPause;
  
  // Controlla se TUTTI i turni hanno gestione_squadra attiva e l'utente NON √® leader
  // In tal caso, l'operatore deve solo timbrare: niente "Cambia Attivit√†" n√© popup attivit√†
  const isGestioneSquadraOnly = timbraturaConfig.is_production_group && allTurni.length > 0 &&
    allTurni.every(t => t.gestione_squadra && !t.is_leader);
  
  // Se gruppo di produzione e ha gi√† timbrato inizio, cambia il bottone in "Cambia Attivit√†"
  // MA solo se NON √® in modalit√† gestione_squadra (altrimenti solo timbratura)
  const btnStart = document.getElementById('btnStartDay');
  if (timbraturaConfig.is_production_group && hasStarted && !hasEnded && !isGestioneSquadraOnly) {
    btnStart.disabled = false;
    document.getElementById('labelStart').textContent = 'Cambia Attivit√†';
    document.getElementById('iconStart').textContent = 'üîÑ';
    btnStart.onclick = function() { openSwitchActivityModal(); };
    document.getElementById('checkStart').className = 'check done';
    document.getElementById('checkStart').innerHTML = '‚úì';
  } else {
    if (!hasStarted) {
      document.getElementById('labelStart').textContent = 'Inizio Giornata';
      document.getElementById('iconStart').textContent = '‚Üí';
    }
    btnStart.onclick = function() { startTimbratura('inizio_giornata'); };
  }
  
  // Check marks
  if (!(timbraturaConfig.is_production_group && hasStarted && !hasEnded && !isGestioneSquadraOnly)) {
    document.getElementById('checkStart').className = 'check' + (hasStarted ? ' done' : '');
    document.getElementById('checkStart').innerHTML = hasStarted ? '‚úì' : '';
  }
  
  // Se gestione_squadra e ha gi√† timbrato inizio: mostra ‚úì e tieni il bottone disabled
  if (isGestioneSquadraOnly && hasStarted && !hasEnded) {
    btnStart.disabled = true;
    document.getElementById('checkStart').className = 'check done';
    document.getElementById('checkStart').innerHTML = '‚úì';
    document.getElementById('labelStart').textContent = 'Inizio Giornata';
    document.getElementById('iconStart').textContent = '‚Üí';
  }
  document.getElementById('checkEnd').className = 'check' + (hasEnded ? ' done' : '');
  document.getElementById('checkEnd').innerHTML = hasEnded ? '‚úì' : '';
  
  // Pulsanti pausa
  document.getElementById('btnStartPause').disabled = !hasStarted || hasEnded || inPause;
  document.getElementById('btnEndPause').disabled = !inPause;

  // Storico (ordine decrescente - pi√π recente in alto)
  const historyList = document.getElementById('historyList');
  if (allTimbratureDisplay.length === 0) {
    historyList.innerHTML = '<li class="empty-history">Nessuna timbratura registrata</li>';
  } else {
    historyList.innerHTML = allTimbratureDisplay.map((t, idx) => {
      const info = TIMBRATURA_TYPES[t.tipo] || { label: t.tipo, dotClass: 'start' };
      // Mostra ora originale e ora modificata se diversa (solo HH:MM)
      const formatHHMM = (ora) => {
        if (!ora) return '';
        const parts = String(ora).split(':');
        if (parts.length >= 2) {
          const hh = parts[0].padStart(2, '0');
          const mm = parts[1].padStart(2, '0');
          return `${hh}:${mm}`;
        }
        return ora;
      };
      let oraDisplay = formatHHMM(t.ora);
      let extraInfo = '';
      
      // Icona sync status
      let syncIcon = '';
      if (t.offline) {
        syncIcon = '<span class="sync-status pending" title="In attesa di sincronizzazione">‚òÅÔ∏è</span>';
      } else {
        syncIcon = '<span class="sync-status synced" title="Sincronizzata">‚úì</span>';
      }
      
      // Badge Extra Turno in attesa - per qualsiasi timbratura con pending_extra_turno
      let overtimeRow = '';
      let hasOvertimeClass = '';
      
      // Verifica se questa timbratura √® in attesa di conferma Extra Turno
      if (t.pending_extra_turno) {
        hasOvertimeClass = 'has-overtime pending-confirmation';
        // Usa sync_error se disponibile, altrimenti messaggio specifico Extra Turno
        const waitMessage = (t.sync_error && t.sync_error !== 'In attesa di revisione') ? t.sync_error : 'Extra Turno in attesa di approvazione';
        overtimeRow = `
          <div class="overtime-info-row pending-confirmation">
            <span class="overtime-icon">‚è≥</span>
            <span class="overtime-text">${waitMessage}</span>
          </div>
        `;
      } else if (t.tipo === 'fine_giornata' && pendingOvertime) {
        const mins = pendingOvertime.minutes || 0;
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        const timeStr = h > 0 ? `${h}h ${m}m` : `${m}m`;
        hasOvertimeClass = 'has-overtime';
        overtimeRow = `
          <div class="overtime-info-row">
            <span class="overtime-icon">‚è≥</span>
            <span class="overtime-text">Extra Turno in attesa</span>
            <span class="overtime-time">${timeStr}</span>
          </div>
        `;
      }
      
      // Badge Giustificazione Ritardo - per inizio_giornata con late_arrival_request
      if (t.late_arrival_request && t.tipo === 'inizio_giornata') {
        const lateReq = t.late_arrival_request;
        let lateIcon = '‚è∞';
        let lateText = '';
        let lateClass = 'late-arrival-row';
        
        if (lateReq.status === 'pending') {
          lateIcon = '‚è≥';
          lateText = 'In attesa di revisione';
          lateClass = 'late-arrival-row pending-confirmation';
        } else if (lateReq.status === 'approved') {
          lateIcon = '‚úÖ';
          lateText = 'Giustificazione accettata';
          lateClass = 'late-arrival-row approved';
        } else if (lateReq.status === 'rejected') {
          lateIcon = '‚è∞';
          lateText = 'Ritardo registrato';
          lateClass = 'late-arrival-row registered';
        }
        
        if (lateText) {
          hasOvertimeClass = hasOvertimeClass || 'has-late-request';
          overtimeRow += `
            <div class="${lateClass}">
              <span class="overtime-icon">${lateIcon}</span>
              <span class="overtime-text">${lateText}</span>
            </div>
          `;
        }
      }

      // Badge Deroga Pausa Ridotta - per fine_pausa con richiesta break_reduction
      if (t.break_reduction_request && t.tipo === 'fine_pausa') {
        const brReq = t.break_reduction_request;
        let brIcon = '‚òï';
        let brText = '';
        let brClass = 'late-arrival-row';

        if (brReq.status === 'pending') {
          brIcon = '‚è≥';
          const effMin = brReq.effective_break_minutes || '?';
          const planMin = brReq.planned_break_minutes || '?';
          const roundedMin = brReq.rounded_break_minutes;
          const roundedStr = roundedMin ? ` ‚Üí ${roundedMin} min arrotondati` : '';
          brText = `Pausa ridotta in attesa di revisione (${effMin}/${planMin} min${roundedStr})`;
          brClass = 'late-arrival-row pending-confirmation';
        } else if (brReq.status === 'approved') {
          brIcon = '‚úÖ';
          const roundedMin = brReq.rounded_break_minutes;
          brText = roundedMin ? `Pausa ridotta autorizzata (${roundedMin} min)` : 'Pausa ridotta autorizzata';
          brClass = 'late-arrival-row approved';
        } else if (brReq.status === 'rejected') {
          brIcon = '‚Ü©Ô∏è';
          brText = 'Pausa ridotta non autorizzata';
          brClass = 'late-arrival-row registered';
        }

        if (brText) {
          hasOvertimeClass = hasOvertimeClass || 'has-break-reduction';
          overtimeRow += `
            <div class="${brClass}">
              <span class="overtime-icon">${brIcon}</span>
              <span class="overtime-text">${brText}</span>
            </div>
          `;
        }
      }

      // Badge Fuori Flessibilit√† - per inizio_giornata con richiesta creata su anticipo
      if (t.flex_request && t.tipo === 'inizio_giornata') {
        const flexReq = t.flex_request;
        let flexIcon = '‚ö†Ô∏è';
        let flexText = '';
        let flexClass = 'late-arrival-row';
        let flexNoteHtml = '';

        if (flexReq.status === 'pending') {
          flexIcon = '‚è≥';
          flexText = 'Timbrata in attesa di revisione';
          flexClass = 'late-arrival-row pending-confirmation';
        } else if (flexReq.status === 'approved') {
          flexIcon = '‚úÖ';
          flexText = 'Anticipo autorizzato';
          flexClass = 'late-arrival-row approved';
        } else if (flexReq.status === 'rejected') {
          flexIcon = '‚Ü©Ô∏è';
          flexText = 'Anticipo non autorizzato';
          flexClass = 'late-arrival-row registered';
        }

        if (flexText) {
          const noteText = (flexReq.review_notes || flexReq.notes || '').trim();
          if (noteText) {
            flexNoteHtml = `<div class="pausa-durata-row" style="font-size:11px; color:#64748b; margin-top:2px;">üìù ${escapeHtml(noteText)}</div>`;
          }

          hasOvertimeClass = hasOvertimeClass || 'has-late-request';
          overtimeRow += `
            <div class="${flexClass}">
              <span class="overtime-icon">${flexIcon}</span>
              <span class="overtime-text">${flexText}${flexNoteHtml}</span>
            </div>
          `;
        }
      }

      // Badge Mancata Timbratura - per timbrature pre-inserite con richiesta pendente
      if (t.mancata_timbratura_request) {
        const mtReq = t.mancata_timbratura_request;
        let mtIcon = 'üìù';
        let mtText = '';
        let mtClass = 'late-arrival-row';

        if (mtReq.status === 'pending') {
          mtIcon = '‚è≥';
          mtText = 'Mancata Timbratura - In attesa di revisione';
          mtClass = 'late-arrival-row pending-confirmation';
        } else if (mtReq.status === 'approved') {
          mtIcon = '‚úÖ';
          mtText = 'Mancata Timbratura confermata';
          mtClass = 'late-arrival-row approved';
        } else if (mtReq.status === 'rejected') {
          mtIcon = '‚ùå';
          mtText = 'Mancata Timbratura rifiutata';
          mtClass = 'late-arrival-row registered';
        }

        if (mtText) {
          hasOvertimeClass = hasOvertimeClass || 'has-late-request';
          overtimeRow += `
            <div class="${mtClass}">
              <span class="overtime-icon">${mtIcon}</span>
              <span class="overtime-text">${mtText}</span>
            </div>
          `;
        }
      }

      // Badge pausa confermata automaticamente (quando il sistema crea inizio/fine pausa)
      if ((t.tipo === 'inizio_pausa' || t.tipo === 'fine_pausa') && t.method === 'confirmed_by_user') {
        hasOvertimeClass = hasOvertimeClass || 'has-late-request';
        overtimeRow += `
          <div class="late-arrival-row approved">
            <span class="overtime-icon">‚òï</span>
            <span class="overtime-text">Pausa confermata automaticamente</span>
          </div>
        `;
      }
      
      if (t.tipo === 'fine_pausa') {
        // Per fine_pausa, trova l'inizio_pausa corrispondente (quello con ora < fine_pausa)
        // Usiamo allTimbrature (ordine crescente) per trovare l'ultimo inizio_pausa prima di questa fine
        const finePausaOra = t.ora;
        const inizioPausa = [...allTimbrature].filter(x => x.tipo === 'inizio_pausa' && x.ora < finePausaOra).pop();
        if (inizioPausa) {
          const inizioMin = parseInt(inizioPausa.ora.split(':')[0]) * 60 + parseInt(inizioPausa.ora.split(':')[1]);
          const fineMin = parseInt(t.ora.split(':')[0]) * 60 + parseInt(t.ora.split(':')[1]);
          const durataEffettiva = fineMin - inizioMin;
          
          // Calcola anche la durata conteggiata (usando ora_mod)
          const inizioModMin = parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[0]) * 60 + parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[1]);
          const fineModMin = parseInt((t.ora_mod || t.ora).split(':')[0]) * 60 + parseInt((t.ora_mod || t.ora).split(':')[1]);
          const durataConteggiata = fineModMin - inizioModMin;
          
          if (durataConteggiata !== durataEffettiva) {
            // Mostra durata su riga separata sotto l'orario
            extraInfo = `<div class="pausa-durata-row">(${durataEffettiva} min ‚Üí <span class="ora-mod">${durataConteggiata} min</span>)</div>`;
          } else {
            extraInfo = `<div class="pausa-durata-row">(${durataEffettiva} min)</div>`;
          }
        }
        
        // Mostra ora barrata anche per fine_pausa se ora_mod √® diversa
        if (t.ora_mod && formatHHMM(t.ora_mod) !== formatHHMM(t.ora)) {
          oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
        }
      } else if (t.ora_mod && formatHHMM(t.ora_mod) !== formatHHMM(t.ora) && t.rounding_mode !== 'daily') {
        // Mostra ora barrata SOLO se NON √® modalit√† daily (arrotondamento a fine giornata)
        oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
      } else if (t.tipo === 'fine_giornata' && t.rounding_mode === 'daily' && t.ora_mod && formatHHMM(t.ora_mod) !== formatHHMM(t.ora)) {
        // Modalit√† daily: controlla se c'√® deroga pausa approvata (anche senza Extra Turno)
        const brApprovedToday = allTimbrature.some(x => x.tipo === 'fine_pausa' && x.break_reduction_request && x.break_reduction_request.status === 'approved');
        if (pendingOvertime) {
          const otStatus = pendingOvertime.status;
          if (otStatus === 'approved') {
            oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
            extraInfo = `<div class="pausa-durata-row" style="color: #22c55e; font-size: 11px;">‚úÖ Confermato</div>`;
          } else if (otStatus === 'rejected') {
            oraDisplay = formatHHMM(t.ora);
            extraInfo = `<div class="pausa-durata-row" style="color: #e53935; font-size: 11px;">‚ùå Extra rifiutato</div>`;
          } else {
            oraDisplay = formatHHMM(t.ora);
            extraInfo = `<div class="pausa-durata-row" style="color: #f59e0b; font-size: 11px;">‚è≥ Sar√† ${formatHHMM(t.ora_mod)} se approvato</div>`;
          }
        } else if (brApprovedToday) {
          // Deroga pausa approvata ‚Üí mostra ora arrotondata
          oraDisplay = `<span class="ora-originale">${formatHHMM(t.ora)}</span><span class="ora-mod">${formatHHMM(t.ora_mod)}</span>`;
        }
      }
      
      // Mostra location se presente (GPS)
      let locationInfo = '';
      if (t.location_name) {
        locationInfo = `<span class="location-badge" title="${t.location_name}">${t.location_name}</span>`;
      } else if (t.method === 'qr' || t.method === 'qr_offline') {
        locationInfo = '<span class="method-badge qr" title="QR Code">üì±</span>';
      }
      
      // Badge supervisor se la timbratura √® stata creata da un caposquadra
      let supervisorBadge = '';
      if (t.method === 'supervisor') {
        supervisorBadge = `<span class="supervisor-badge" title="Registrata dal Supervisor">üë∑ Supervisor</span>`;
      }
      
      // Per fine_pausa, extraInfo va su riga separata sotto il tipo
      const pausaDurataInfo = (t.tipo === 'fine_pausa' && extraInfo) ? extraInfo : '';
      const inlineExtraInfo = (t.tipo !== 'fine_pausa' && extraInfo) ? extraInfo : '';
      
      return `
        <li class="history-item ${t.offline ? 'offline-pending' : ''} ${hasOvertimeClass}">
          <span class="dot ${info.dotClass}"></span>
          <span class="time">${oraDisplay}</span>
          <span class="type">${info.label}${pausaDurataInfo}${inlineExtraInfo}</span>
          ${locationInfo}
          ${supervisorBadge}
          ${syncIcon}
        </li>
        ${overtimeRow}
      `;
    }).join('');
  }
}

// Carica timbrature di oggi
async function loadTimbrature() {
  try {
    const res = await fetch('/api/timbratura/oggi');
    if (res.ok) {
      const data = await res.json();
      todayTimbrature = data.timbrature || [];
      pendingOvertime = data.pending_overtime || null;
      updateUI();
    }
  } catch (err) {
    console.error('Errore caricamento timbrature:', err);
  }
}

// Turni multipli - stato globale
let allTurni = [];
let currentTurnoIndex = 0;
let currentShiftLocationName = null; // Sede GPS associata al turno corrente
let currentShiftGpsData = null; // Dati GPS per la timbratura del turno corrente
let currentValidLocations = []; // Lista locations valide (sede gruppo + location turno)

// Carica turno di oggi (da Rentman)
async function loadTurno() {
  const turnoBox = document.getElementById('turnoBox');
  if (!turnoBox) return; // Se l'elemento non esiste, esci
  
  try {
    const res = await fetch('/api/user/turno-oggi');
    if (!res.ok) {
      turnoBox.style.display = 'none';
      return;
    }
    
    const data = await res.json();
    console.log("üì• TURNI CARICATI DA SERVER:", data);
    
    // Se non c'√® turno, mostra messaggio
    if (!data.turno && (!data.turni || data.turni.length === 0)) {
      turnoBox.classList.add('no-turno');
      turnoBox.style.display = 'block';
      const turnoProject = document.getElementById('turnoProject');
      const turnoOrario = document.getElementById('turnoOrario');
      const turnoFunzione = document.getElementById('turnoFunzione');
      const turnoBadge = document.getElementById('turnoBadge');
      if (turnoProject) turnoProject.textContent = 'Nessun turno previsto';
      if (turnoOrario) turnoOrario.style.display = 'none';
      if (turnoFunzione) turnoFunzione.style.display = 'none';
      if (turnoBadge) turnoBadge.style.display = 'none';
      const infoBtnInline = document.getElementById('turnoInfoInline');
      if (infoBtnInline) infoBtnInline.style.display = 'none';
      hideNavigation();
      console.warn("‚ö†Ô∏è Nessun turno disponibile");
      return;
    }
    
    // Memorizza tutti i turni
    allTurni = data.turni || [data.turno];
    currentTurnoIndex = 0;
    console.log("üìä Turni carichi:", allTurni.length, allTurni);
    
    turnoBox.classList.remove('no-turno');
    turnoBox.style.display = 'block';
    
    // Mostra navigazione se ci sono pi√π turni
    if (allTurni.length > 1) {
      showNavigation();
    } else {
      hideNavigation();
    }
    
    // Visualizza il primo turno
    displayTurno(currentTurnoIndex);
    
  } catch (err) {
    console.error('Errore caricamento turno:', err);
    if (turnoBox) turnoBox.style.display = 'none';
  }
}

// Visualizza un singolo turno
function displayTurno(index) {
  if (index < 0 || index >= allTurni.length) return;
  
  const turno = allTurni[index];
  
  // Memorizza la sede corrente per la validazione GPS
  // Priorit√†: timbratura_location (sede GPS configurata) > location_name (location progetto)
  currentShiftLocationName = turno.timbratura_location || turno.location_name || null;
  
  // Memorizza le note del turno corrente
  currentTurnoNotes = {
    note: turno.note || null,
    note_planner: turno.note_planner || null
  };
  
  // Gestione badge row (pausa e note)
  const badgesRow = document.getElementById('turnoBadgesRow');
  const badgePausa = document.getElementById('turnoBadgePausa');
  const badgePausaText = document.getElementById('turnoBadgePausaText');
  const badgeNote = document.getElementById('turnoBadgeNote');
  
  let hasPausa = false;
  let hasNote = currentTurnoNotes.note || currentTurnoNotes.note_planner;
  
  // Pausa prevista
  if (turno.break_start && turno.break_end) {
    badgePausaText.textContent = `${turno.break_start}-${turno.break_end}`;
    hasPausa = true;
  } else if (turno.break_minutes && turno.break_minutes > 0) {
    badgePausaText.textContent = `${turno.break_minutes}min`;
    hasPausa = true;
  }
  
  badgePausa.style.display = hasPausa ? 'inline-flex' : 'none';
  badgeNote.style.display = hasNote ? 'inline-flex' : 'none';
  badgesRow.style.display = (hasPausa || hasNote) ? 'flex' : 'none';
  
  // Progetto - nome diretto senza "Progetto"
  let projectText = turno.project_name || '-';
  document.getElementById('turnoProject').textContent = projectText;
  
  // Orario
  if (turno.start || turno.end) {
    let orarioText = '';
    if (turno.start && turno.end) {
      orarioText = `${turno.start} - ${turno.end}`;
    } else if (turno.start) {
      orarioText = `Dalle ${turno.start}`;
    } else if (turno.hours) {
      orarioText = `${turno.hours}h previste`;
    }
    document.getElementById('turnoOrarioText').textContent = orarioText;
  }
  
  // Numero progetto
  const projectCodeEl = document.getElementById('turnoProjectCode');
  if (projectCodeEl) {
    if (turno.project_code) {
      projectCodeEl.textContent = 'P. ' + turno.project_code;
      projectCodeEl.style.display = 'inline-block';
    } else {
      projectCodeEl.style.display = 'none';
    }
  }
  
  // Funzione/Ruolo
  if (turno.function) {
    document.getElementById('turnoFunzioneText').textContent = turno.function;
  } else {
    document.getElementById('turnoFunzioneText').textContent = '-';
  }
  
  // Dove timbrare (GPS) - Consolidato su una riga
  const timbraturaEl = document.getElementById('turnoTimbratura');
  
  console.log("üîç DEBUG TURNO:", {
    timbratura_location: turno.timbratura_location,
    timbratura_lat: turno.timbratura_lat,
    timbratura_lon: turno.timbratura_lon,
    gps_mode: turno.gps_mode,
    gps_timbratura_location: turno.gps_timbratura_location,
    location_name: turno.location_name,
    location_lat: turno.location_lat,
    location_lon: turno.location_lon
  });
  
  if (turno.timbratura_location || turno.location_name) {
    timbraturaEl.style.display = 'flex';
    timbraturaEl.className = 'turno-detail turno-timbratura inline-location';
    
    // Svuota il container
    timbraturaEl.innerHTML = '';
    
    // Location del progetto (se presente)
    if (turno.location_name) {
      const locationItem = document.createElement('div');
      locationItem.className = 'location-item';
      locationItem.innerHTML = `
        <span class="icon"><i class="fas fa-map-marker-alt"></i></span>
        <span class="value">${turno.location_name}</span>
      `;
      timbraturaEl.appendChild(locationItem);
    }
    
    // Timbratura location (prioritaria se presente)
    // Nota: non mostriamo pi√π la "chip" della timbratura per evitare confusione.
    if (turno.timbratura_location) {
      // Salva i dati GPS per la validazione della timbratura (necessari internamente)
      currentShiftGpsData = {
        location: turno.timbratura_location,
        lat: turno.timbratura_lat,
        lon: turno.timbratura_lon,
        radius: turno.timbratura_radius || 300,
        mode: turno.gps_mode
      };
      const hasCoords = Boolean(turno.timbratura_lat && turno.timbratura_lon);
      // Salva le locations valide dal backend (sede gruppo + location turno + custom)
      currentValidLocations = Array.isArray(turno.valid_locations) ? turno.valid_locations : [];
      
      console.log("‚úÖ TURNO CARICATO:", {
        timbratura_location: turno.timbratura_location,
        timbratura_lat: turno.timbratura_lat,
        timbratura_lon: turno.timbratura_lon,
        gps_mode: turno.gps_mode,
        location_name: turno.location_name,
        gps_timbratura_location: turno.gps_timbratura_location,
        valid_locations: currentValidLocations
      });
      
      if (!hasCoords) {
        console.warn("‚ö†Ô∏è ATTENZIONE: Coordinate mancanti per timbratura_location!", {
          timbratura_location: turno.timbratura_location,
          timbratura_lat: turno.timbratura_lat,
          timbratura_lon: turno.timbratura_lon,
          gps_mode: turno.gps_mode,
          gps_timbratura_location: turno.gps_timbratura_location
        });
      }
    } else {
      currentShiftGpsData = null;
      currentValidLocations = [];
    }
  } else {
    timbraturaEl.style.display = 'none';
    currentShiftGpsData = null;
    currentValidLocations = [];
  }
  
      // Pulsanti azione: Sedi + Info (inline nella griglia turno-details)
      try {
        const existingAction = document.getElementById('turnoActionChips');
        if (existingAction) existingAction.remove();

        const detailsGrid = document.getElementById('turnoDetailsGrid');
        if (Array.isArray(currentValidLocations) && currentValidLocations.length > 0 && detailsGrid) {
          const container = document.createElement('div');
          container.id = 'turnoActionChips';
          container.className = 'action-chips';

          const sedeBtn = document.createElement('button');
          sedeBtn.className = 'action-chip';
          sedeBtn.id = 'turnoSediBtnInline';
          sedeBtn.type = 'button';
          sedeBtn.innerHTML = `<span class="icon">üìç</span> Sedi <b>${currentValidLocations.length}</b>`;
          sedeBtn.onclick = function(e) { e.stopPropagation(); showValidLocationsPopup(); };

          const infoBtnInline = document.createElement('button');
          infoBtnInline.className = 'action-chip';
          infoBtnInline.id = 'turnoInfoInline';
          infoBtnInline.type = 'button';
          infoBtnInline.innerHTML = '<span class="icon">‚ÑπÔ∏è</span> Info turno';
          infoBtnInline.onclick = function(e) { e.stopPropagation(); openCrewInfoModal(); };

          container.appendChild(sedeBtn);
          container.appendChild(infoBtnInline);
          detailsGrid.appendChild(container);
        }
      } catch (e) {
        console.warn('Errore rendering action chips:', e);
      }

      // Badge (Leader)
  const badge = document.getElementById('turnoBadge');
  if (turno.is_leader) {
    badge.textContent = '‚≠ê Caposquadra';
    badge.classList.add('leader');
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
  
  // Mostra bottone info inline se √® un turno Rentman (ha project_code)
  const infoBtnInline = document.getElementById('turnoInfoInline');
  if (infoBtnInline) {
    if (turno.project_code && turno.source !== 'employee_shifts') {
      infoBtnInline.style.display = 'inline-flex';
    } else {
      infoBtnInline.style.display = 'none';
    }
  }
  
  // Aggiorna counter e stato bottoni
  updateNavigation();

  // Carica fasi del turno (salva promise per sincronizzazione)
  _loadTurnoPhasesPromise = loadTurnoPhases(turno);
}

// Naviga tra i turni
function navigateTurno(direction) {
  const newIndex = currentTurnoIndex + direction;
  if (newIndex >= 0 && newIndex < allTurni.length) {
    currentTurnoIndex = newIndex;
    displayTurno(currentTurnoIndex);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FASI TURNO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let turnoFunctionPhasesConfig = null;
let turnoCurrentPhases = []; // Stato corrente delle fasi
let currentTurnoPhasesData = null; // Dati fasi per popup attivit√†
let _loadTurnoPhasesPromise = null; // Promise per sincronizzare il caricamento fasi

async function loadTurnoPhases(turno) {
  const phasesBox = document.getElementById('turnoPhases');
  phasesBox.style.display = 'none';
  currentTurnoPhasesData = null;
  
  if (!turno || !turno.function || !turno.project_code) {
    console.log('[FASI] Skip: turno mancante o senza function/project_code', turno?.function, turno?.project_code);
    return;
  }

  console.log('[FASI] Caricamento fasi per funzione:', turno.function, 'progetto:', turno.project_code);

  // Carica config se non ancora fatto
  if (!turnoFunctionPhasesConfig) {
    try {
      const res = await fetch('/api/admin/function-phases');
      const data = await res.json();
      turnoFunctionPhasesConfig = data.ok ? (data.function_phases || {}) : {};
      console.log('[FASI] Config caricata, chiavi:', Object.keys(turnoFunctionPhasesConfig));
    } catch (e) {
      turnoFunctionPhasesConfig = {};
      console.error('[FASI] Errore caricamento config:', e);
    }
  }

  // Trova template fasi per questa funzione (matching ESATTO, case-insensitive)
  const fnLower = turno.function.toLowerCase().trim();
  let matchedKey = null;
  let matchedPhases = [];
  
  for (const [key, tmpl] of Object.entries(turnoFunctionPhasesConfig)) {
    const keyLower = key.toLowerCase().trim();
    if (fnLower === keyLower) {
      matchedKey = key;
      matchedPhases = (tmpl.phases || []).sort((a, b) => a.order - b.order);
      break;
    }
  }

  console.log('[FASI] Match per "' + turno.function + '":', matchedKey ? matchedKey + ' (' + matchedPhases.length + ' fasi)' : 'NESSUN MATCH');

  if (!matchedKey || matchedPhases.length === 0) {
    return;
  }

  // Carica stato dal server
  const dateStr = turno.planning_date || new Date().toISOString().slice(0, 10);
  const projectKey = turno.project_code;

  try {
    const res = await fetch(`/api/project-phases?date=${encodeURIComponent(dateStr)}&project_key=${encodeURIComponent(projectKey)}&function_key=${encodeURIComponent(matchedKey)}`);
    const data = await res.json();
    turnoCurrentPhases = data.ok ? (data.phases || []) : [];
  } catch (e) {
    turnoCurrentPhases = [];
  }

  // Salva dati fasi per uso nei popup (avvio giornata / cambio attivit√†)
  currentTurnoPhasesData = {
    projectKey: projectKey,
    matchedKey: matchedKey,
    matchedPhases: matchedPhases,
    dateStr: dateStr,
    states: turnoCurrentPhases
  };

  console.log('[FASI] Dati fasi pronti:', matchedPhases.length, 'fasi, stati:', turnoCurrentPhases.length);
  // Le fasi NON vengono mostrate nella home, solo nei popup (Avvia / Cambia Attivit√†)
}

function renderTurnoPhases(projectKey, functionKey, phases, dateStr) {
  const phasesList = document.getElementById('turnoPhasesList');
  const counter = document.getElementById('turnoPhaseCounter');
  const bar = document.getElementById('turnoPhaseBar');

  const total = phases.length;
  const completed = phases.filter(ph => {
    const s = turnoCurrentPhases.find(st => st.phase_name === ph.name);
    return s && s.completed;
  }).length;
  const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

  counter.textContent = `${completed}/${total}`;
  bar.style.width = `${pct}%`;

  let html = '';
  phases.forEach((ph, i) => {
    const state = turnoCurrentPhases.find(st => st.phase_name === ph.name);
    const isDone = state && state.completed;
    const doneBy = isDone && state.completed_by ? state.completed_by : '';

    html += `<div class="turno-phase-item ${isDone ? 'completed' : ''}" 
      onclick="toggleTurnoPhase('${escapeAttrSafe(projectKey)}', '${escapeAttrSafe(functionKey)}', '${escapeAttrSafe(ph.name)}', ${ph.order}, '${escapeAttrSafe(dateStr)}', this)">
      <span class="phase-num">${isDone ? '‚úì' : (i + 1)}</span>
      <span class="phase-label">${escapeHtmlSafe(ph.name)}</span>
      ${doneBy ? `<span class="phase-by">${escapeHtmlSafe(doneBy)}</span>` : ''}
      <span class="phase-check">${isDone ? '‚úÖ' : '‚¨ú'}</span>
    </div>`;
  });

  phasesList.innerHTML = html;
}

function escapeAttrSafe(str) {
  return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function escapeHtmlSafe(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

async function toggleTurnoPhase(projectKey, functionKey, phaseName, phaseOrder, dateStr, el) {
  if (el._loading) return;
  el._loading = true;

  const state = turnoCurrentPhases.find(st => st.phase_name === phaseName);
  const newCompleted = !(state && state.completed);

  try {
    const res = await fetch('/api/project-phases/toggle', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        date: dateStr,
        project_key: projectKey,
        function_key: functionKey,
        phase_name: phaseName,
        phase_order: phaseOrder,
        completed: newCompleted
      })
    });
    const data = await res.json();
    if (data.ok) {
      // Aggiorna stato locale
      const existing = turnoCurrentPhases.find(st => st.phase_name === phaseName);
      if (existing) {
        existing.completed = newCompleted ? 1 : 0;
        existing.completed_by = data.completed_by;
      } else {
        turnoCurrentPhases.push({
          phase_name: phaseName,
          phase_order: phaseOrder,
          function_key: functionKey,
          completed: newCompleted ? 1 : 0,
          completed_by: data.completed_by
        });
      }

      // Trova le fasi config per re-render
      for (const [key, tmpl] of Object.entries(turnoFunctionPhasesConfig)) {
        if (key === functionKey) {
          const phases = (tmpl.phases || []).sort((a, b) => a.order - b.order);
          renderTurnoPhases(projectKey, functionKey, phases, dateStr);
          break;
        }
      }
    }
  } catch (e) {
    console.error('Errore toggle fase:', e);
  }
  el._loading = false;
}

// Mostra i controlli di navigazione
function showNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'flex';
  document.getElementById('turnoNextBtn').style.display = 'flex';
  document.getElementById('turnoCounter').style.display = 'block';
}

// Nasconde i controlli di navigazione
function hideNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'none';
  document.getElementById('turnoNextBtn').style.display = 'none';
  document.getElementById('turnoCounter').style.display = 'none';
}

// Aggiorna stato navigazione
function updateNavigation() {
  const prevBtn = document.getElementById('turnoPrevBtn');
  const nextBtn = document.getElementById('turnoNextBtn');
  const counter = document.getElementById('turnoCounter');
  
  prevBtn.disabled = currentTurnoIndex === 0;
  nextBtn.disabled = currentTurnoIndex === allTurni.length - 1;
  counter.textContent = `${currentTurnoIndex + 1}/${allTurni.length}`;
}

// ‚ïê‚ïê‚ïê Crew Info Modal ‚ïê‚ïê‚ïê
async function openCrewInfoModal() {
  const turno = allTurni[currentTurnoIndex];
  if (!turno || !turno.project_code) return;

  const overlay = document.getElementById('crewInfoOverlay');
  const body = document.getElementById('crewInfoBody');
  const title = document.getElementById('crewInfoTitle');

  title.textContent = `‚ÑπÔ∏è ${turno.project_name || turno.project_code}`;
  body.innerHTML = '<div class="crew-info-loading">‚è≥ Caricamento...</div>';
  overlay.classList.add('active');

  try {
    const res = await fetch(`/api/user/turno-crew-info?project_code=${encodeURIComponent(turno.project_code)}`);
    if (!res.ok) throw new Error('Errore caricamento');
    const data = await res.json();

    let html = '';

    // Sezione Squadra
    if (data.crew && data.crew.length > 0) {
      html += `<div class="crew-info-section">
        <div class="crew-info-section-title">üë• Squadra (${data.total_crew})</div>`;
      data.crew.forEach(m => {
        const initials = (m.crew_name || '?').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        const timeStr = m.start && m.end ? `${m.start} - ${m.end}` : (m.start || '');
        html += `<div class="crew-member-item ${m.is_me ? 'is-me' : ''} ${m.is_leader ? 'is-leader' : ''}">
          <div class="crew-member-avatar">${initials}</div>
          <div class="crew-member-info">
            <div class="crew-member-name">
              ${m.is_leader ? '<span style="font-size:16px;margin-right:4px;">‚≠ê</span>' : ''}${escapeHtmlCI(m.crew_name)}${m.is_me ? ' (Tu)' : ''}
            </div>
            <div class="crew-member-role">${escapeHtmlCI(m.function || '‚Äî')}${m.location ? ' ‚Ä¢ ' + escapeHtmlCI(m.location) : ''}</div>
          </div>
          ${timeStr ? `<div class="crew-member-time">${timeStr}</div>` : ''}
        </div>`;
      });
      html += '</div>';
    } else {
      html += '<div class="crew-info-empty">Nessun collega trovato per questo turno</div>';
    }

    // Sezione Mezzi
    if (data.vehicles && data.vehicles.length > 0) {
      html += `<div class="crew-info-section">
        <div class="crew-info-section-title">üöõ Mezzi (${data.total_vehicles})</div>`;
      data.vehicles.forEach(v => {
        html += `<div class="vehicle-info-item">
          <div class="vehicle-info-icon">üöõ</div>
          <div class="vehicle-info-details">
            <div class="vehicle-info-name">${escapeHtmlCI(v.vehicle_name)}</div>
            <div class="vehicle-info-driver">${v.driver_name ? 'üßë‚Äç‚úàÔ∏è Autista: ' + escapeHtmlCI(v.driver_name) : '‚ö†Ô∏è Nessun autista assegnato'}</div>
          </div>
        </div>`;
      });
      html += '</div>';
    }

    body.innerHTML = html || '<div class="crew-info-empty">Nessuna informazione disponibile</div>';

  } catch (err) {
    console.error('Errore caricamento crew info:', err);
    body.innerHTML = '<div class="crew-info-empty">‚ùå Errore nel caricamento delle informazioni</div>';
  }
}

function closeCrewInfoModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('crewInfoOverlay').classList.remove('active');
}

function escapeHtmlCI(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ===== Switch Activity Modal (Produzione) =====
async function openSwitchActivityModal(options = {}) {
  // ‚ïê‚ïê‚ïê Se ci sono FASI configurate, mostra popup fasi invece del modal generico ‚ïê‚ïê‚ïê
  // Forza caricamento fasi se non ancora disponibili
  if (!options?.forceProjectSelection && !options?.forceActivitySelection) {
    if (!currentTurnoPhasesData && _loadTurnoPhasesPromise) {
      try { await _loadTurnoPhasesPromise; } catch(e) {}
    }
    if (!currentTurnoPhasesData) {
      const turno = allTurni[currentTurnoIndex] || {};
      if (turno.function && turno.project_code) {
        await loadTurnoPhases(turno);
      }
    }
    if (currentTurnoPhasesData && currentTurnoPhasesData.matchedPhases.length > 0) {
      const turno = allTurni[currentTurnoIndex] || {};
      // Aggiorna gli stati fasi dal server prima di mostrare
      try {
        const pd = currentTurnoPhasesData;
        const res = await fetch(`/api/project-phases?date=${encodeURIComponent(pd.dateStr)}&project_key=${encodeURIComponent(pd.projectKey)}&function_key=${encodeURIComponent(pd.matchedKey)}`);
        const data = await res.json();
        pd.states = data.ok ? (data.phases || []) : pd.states;
        turnoCurrentPhases = pd.states;
      } catch(e) {}
      showPhaseSelectionPopup(
        turno.project_code || '',
        turno.project_name || '',
        turno.function || '',
        0,
        'switch'
      );
      return;
    }
  }

  const overlay = document.getElementById('switchActivityOverlay');
  const body = document.getElementById('switchActivityBody');
  const forceProjectSelection = Boolean(options?.forceProjectSelection);
  const forceActivitySelection = Boolean(options?.forceActivitySelection);
  _switchForceActivitySelection = forceActivitySelection;
  
  // Reset override progetto e griglia
  _switchOverrideProject = null;
  _switchGridProject = null;
  _switchCurrentProject = null;
  
  // Prendi il progetto corrente dal turno visualizzato
  const turno = allTurni[currentTurnoIndex] || {};
  const projectCode = turno.project_code || '';
  const projectName = turno.project_name || '';
  const plannedFunction = turno.function || '';
  const hasPlannedProject = !!projectCode;
  const hasPlannedFunction = !!plannedFunction && plannedFunction !== '-';
  
  // Mostra loading
  body.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">Caricamento...</div>';
  overlay.classList.add('active');
  
  // Recupera attivit√† attiva dal server
  let currentActivityLabel = '';
  let currentProjectCode = '';
  let currentProjectName = '';
  let currentNotes = '';
  try {
    const res = await fetch('/api/production/timer');
    const timerData = await res.json();
    if (timerData.ok && timerData.active && timerData.timer) {
      currentActivityLabel = timerData.timer.activity_label || '';
      currentProjectCode = timerData.timer.project_code || '';
      currentProjectName = timerData.timer.project_name || '';
      currentNotes = timerData.timer.notes || '';
      // Salva progetto in corso per uso in griglia
      _switchCurrentProject = { code: currentProjectCode, name: currentProjectName };
    }
  } catch(e) { console.warn('Errore recupero timer attivo:', e); }
  
  // Lista attivit√† predefinite produzione
  const ACTIVITIES = [
    { code: 'Preparazione', icon: 'üì¶', label: 'Preparazione' },
    { code: 'Carico', icon: 'üöö', label: 'Carico' },
    { code: 'Scarico', icon: 'üì•', label: 'Scarico' },
    { code: 'Controllo', icon: 'üîç', label: 'Controllo' },
    { code: 'Pulizia', icon: 'üßπ', label: 'Pulizia' },
    { code: 'Verifica', icon: '‚úÖ', label: 'Verifica' },
    { code: 'Manutenzione', icon: 'üîß', label: 'Manutenzione' },
    { code: 'Altro', icon: 'üìù', label: 'Altro' }
  ];
  
  let html = '';

  if (forceProjectSelection || forceActivitySelection) {
    html += `<div style="background:#fff3cd;border:1px solid #f59e0b;border-radius:10px;padding:10px 12px;margin-bottom:12px;color:#92400e;font-size:13px;font-weight:600;">
      ‚ö†Ô∏è Nessun turno/mansione pianificata: seleziona progetto e attivit√† per avviare il timer.
    </div>`;
  }
  
  // 0. Pulsante Cambia Progetto in alto a tutto
  html += `<div id="switchTopCards">`;
  html += `<div style="margin-bottom:14px;">
    <button onclick="openNumpad()" style="width:100%;background:#3b82f6;color:#fff !important;border:none;border-radius:12px;padding:16px 20px;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(59,130,246,0.35);display:flex;align-items:center;justify-content:center;gap:10px;">
      üî¢ Cambia Progetto
    </button>
  </div>`;
  
  // 1. Card IN CORSO (progetto + mansione in corso) con Cambio Attivit√†
  if (currentActivityLabel) {
    html += `<div style="background:#e8f5e9;border:1px solid #4CAF50;border-radius:12px;padding:12px 14px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:20px;">‚ñ∂Ô∏è</div>
        <div style="flex:1;">
          <div style="font-size:11px;color:#388E3C;font-weight:600;">IN CORSO</div>
          <div style="font-weight:600;font-size:14px;color:#1b5e20;">${escapeHtmlCI(currentActivityLabel)}</div>
        </div>
      </div>
      ${currentProjectCode ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid #a5d6a7;">
        <div style="font-size:10px;color:#388E3C;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">PROGETTO</div>
        <div style="font-weight:700;font-size:13px;color:#1a56db;">P. ${escapeHtmlCI(currentProjectCode)}</div>
        ${currentProjectName ? `<div style="font-size:12px;color:#1b5e20;">${escapeHtmlCI(currentProjectName)}</div>` : ''}
      </div>` : ''}
      ${currentNotes ? `<div style="margin-top:8px;padding-top:8px;border-top:1px solid #a5d6a7;">
        <div style="font-size:10px;color:#388E3C;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">üìù NOTE</div>
        <div style="font-size:13px;color:#2e7d32;font-style:italic;margin-top:2px;">${escapeHtmlCI(currentNotes)}</div>
      </div>` : ''}
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid #a5d6a7;">
        <button onclick="showSwitchActivityGrid('current')" style="width:100%;padding:10px;background:#fff;color:#388E3C;border:2px solid #4CAF50;border-radius:10px;font-weight:600;cursor:pointer;font-size:13px;">
          üîÑ Cambio Attivit√†
        </button>
      </div>
    </div>`;
  }
  
  // 2. Card combinata: Progetto Pianificato + Mansione (font ridotti)
  // Nascondo se l'attivit√† in corso coincide con quella pianificata (stesso progetto + stessa mansione)
  const isSameAsCurrent = hasPlannedProject && hasPlannedFunction && currentProjectCode && projectCode && 
                          currentProjectCode.toString() === projectCode.toString() && 
                          currentActivityLabel && plannedFunction &&
                          currentActivityLabel.toLowerCase().trim() === plannedFunction.toLowerCase().trim();
  
  console.log('DEBUG Switch Modal:', {
    currentProjectCode, projectCode,
    currentActivityLabel, plannedFunction,
    isSameAsCurrent
  });
  
  if (!forceProjectSelection && hasPlannedProject && hasPlannedFunction && !isSameAsCurrent) {
    html += `<div id="switchDefaultView">
      <div style="background:#fff3e0;border:2px solid #f59e0b;border-radius:12px;padding:12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(245,158,11,0.15);">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
          <div style="font-size:18px;">‚≠ê</div>
          <div style="font-size:11px;color:#f59e0b;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progetto Pianificato</div>
        </div>
        ${projectCode ? `<div style="font-weight:700;font-size:13px;color:#1a56db;margin-bottom:1px;letter-spacing:0.3px;">P. ${escapeHtmlCI(projectCode)}</div>` : ''}
        <div style="font-weight:500;font-size:11px;color:#1a1a1a;margin-bottom:8px;">${escapeHtmlCI(projectName)}</div>
        <div style="font-size:10px;color:#888;margin-bottom:1px;">MANSIONE</div>
        <div style="font-weight:700;font-size:13px;color:#f59e0b;margin-bottom:12px;">${escapeHtmlCI(plannedFunction)}</div>
        <div style="display:flex;gap:8px;">
          <button onclick="confirmSwitchActivity('${escapeHtmlCI(projectCode)}', '${escapeHtmlCI(projectName)}', '${escapeHtmlCI(plannedFunction)}')" style="flex:1.3;padding:10px;background:#4CAF50;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:12px;box-shadow:0 3px 12px rgba(76,175,80,0.3);">
            ‚ñ∂Ô∏è Avvia Mansione Pianificata
          </button>
          <button onclick="showSwitchActivityGrid('planned')" style="flex:1;padding:10px;background:#fff;color:#f59e0b;border:2px solid #f59e0b;border-radius:10px;font-weight:600;cursor:pointer;font-size:12px;">
            üîÑ Cambia Attivit√†
          </button>
        </div>
      </div>
    </div>`;
  }
  
  // 3. Card Progetto Manuale (nascosta, appare dopo numpad)
  html += `</div>`; // chiudi #switchTopCards
  html += `<div id="switchManualProjectCard" style="display:none;background:#e3f2fd;border:2px solid #42a5f5;border-radius:12px;padding:16px;margin-bottom:14px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
      <div style="font-size:24px;">üî¢</div>
      <div style="font-size:13px;color:#1e88e5;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Progetto Manuale</div>
    </div>
    <div id="switchManualProjectCode" style="font-weight:800;font-size:17px;color:#1a56db;margin-bottom:2px;letter-spacing:0.3px;"></div>
    <div id="switchManualProjectName" style="font-weight:600;font-size:13px;color:#1a1a1a;margin-bottom:12px;"></div>
    <button onclick="showSwitchActivityGrid('manual')" style="width:100%;padding:12px;background:#1e88e5;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 3px 12px rgba(30,136,229,0.3);">
      üîÑ Cambia Attivit√†
    </button>
  </div>`;
  
  // 4. Griglia attivit√† (nascosta)
  html += '<div id="switchActivityGrid" style="display:none;">';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
  ACTIVITIES.forEach(a => {
    const isCurrent = currentActivityLabel.toLowerCase() === a.code.toLowerCase();
    const isAltro = a.code.toLowerCase() === 'altro';
    // "Altro" rimane cliccabile anche se in corso (per cambiare note)
    const blocked = isCurrent && !isAltro;
    html += `
      <div class="switch-activity-item${isCurrent ? ' current' : ''}"
           onclick="${blocked ? '' : `gridActivityClick('${escapeHtmlCI(a.code)}')`}"
           data-activity="${escapeHtmlCI(a.code)}"
           style="cursor:${blocked ? 'default' : 'pointer'};text-align:center;padding:16px 10px;position:relative;${blocked ? 'opacity:0.5;' : ''}">
        <div style="font-size:32px;margin-bottom:6px;">${a.icon}</div>
        <div style="font-weight:600;font-size:13px;">${escapeHtmlCI(a.label)}</div>
        ${isCurrent ? '<div style="position:absolute;top:6px;right:8px;background:#4CAF50;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700;">IN CORSO</div>' : ''}
      </div>`;
  });
  html += '</div>';
  html += `<button onclick="hideSwitchActivityGrid()" style="width:100%;margin-top:12px;padding:12px;background:#f5f5f5;color:#666;border:1px solid #ddd;border-radius:10px;font-weight:600;cursor:pointer;">
    ‚Üê Indietro
  </button>`;
  html += '</div>';
  
  body.innerHTML = html;

  // Se √® richiesta la selezione attivit√† forzata o non c'√® progetto/timer, mostra direttamente la griglia attivit√†
  if (forceActivitySelection || forceProjectSelection || (!hasPlannedProject && !currentProjectCode)) {
    showSwitchActivityGrid('planned');
  }
}

// Progetto corrente selezionato per la griglia attivit√†
let _switchGridProject = null; // { code, name }
let _pendingGridActivity = null; // Attivit√† in attesa di selezione progetto (dal modal Cambia Attivit√†)
let _pendingProductionStart = null; // { projectCode, projectName, activityLabel, startTs } - dal popup produzione iniziale

function gridActivityClick(activityLabel) {
  // Usa il progetto gi√† selezionato (override manuale, griglia, o corrente)
  const proj = _switchOverrideProject || _switchGridProject || _switchCurrentProject;
  if (proj && proj.code) {
    confirmSwitchActivity(proj.code.toString(), proj.name || '', activityLabel);
    return;
  }
  // Fallback: se non c'√® nessun progetto, apri il numpad
  _pendingGridActivity = activityLabel;
  openNumpad();
}

function showSwitchActivityGrid(source) {
  const turno = allTurni[currentTurnoIndex] || {};
  if (source === 'manual' && _switchOverrideProject) {
    _switchGridProject = { code: _switchOverrideProject.code, name: _switchOverrideProject.name };
  } else if (source === 'current') {
    // Usa il progetto in corso (dal timer attivo) ‚Äî lo prendiamo dai dati gi√† nel DOM
    const curCodeEl = document.querySelector('#switchActivityBody [style*="IN CORSO"]');
    // Fallback: usa il progetto del turno se non riusciamo a estrarlo
    _switchGridProject = _switchCurrentProject || { code: turno.project_code || '', name: turno.project_name || '' };
  } else {
    _switchGridProject = { code: turno.project_code || '', name: turno.project_name || '' };
  }

  // Se il progetto selezionato √® diverso da quello in corso, rigenera la griglia sbloccando tutte le attivit√†
  const isDifferentProject = _switchGridProject && _switchCurrentProject &&
    _switchGridProject.code.toString() !== _switchCurrentProject.code.toString();

  if (isDifferentProject || source === 'manual') {
    _rebuildActivityGrid(isDifferentProject);
  }

  const dv = document.getElementById('switchDefaultView');
  if (dv) dv.style.display = 'none';
  const mc = document.getElementById('switchManualProjectCard');
  if (mc) mc.style.display = 'none';
  
  // Per cambio progetto: nascondi TUTTO tranne la griglia (card IN CORSO, pianificato, ecc.)
  const tc = document.getElementById('switchTopCards');
  if (source === 'manual' && tc) {
    tc.style.display = 'none';
  }
  
  document.getElementById('switchActivityGrid').style.display = 'block';
}

function _rebuildActivityGrid(unlockAll) {
  const ACTIVITIES = [
    { code: 'Preparazione', icon: 'üì¶', label: 'Preparazione' },
    { code: 'Carico', icon: 'üöö', label: 'Carico' },
    { code: 'Scarico', icon: 'üì•', label: 'Scarico' },
    { code: 'Controllo', icon: 'üîç', label: 'Controllo' },
    { code: 'Pulizia', icon: 'üßπ', label: 'Pulizia' },
    { code: 'Verifica', icon: '‚úÖ', label: 'Verifica' },
    { code: 'Manutenzione', icon: 'üîß', label: 'Manutenzione' },
    { code: 'Altro', icon: 'üìù', label: 'Altro' }
  ];
  const gridContainer = document.getElementById('switchActivityGrid');
  if (!gridContainer) return;
  
  // Recupera attivit√† corrente dal DOM (card IN CORSO)
  let currentActivityLabel = '';
  if (!unlockAll && _switchCurrentProject) {
    const inCorsoEl = document.querySelector('#switchActivityBody .switch-activity-item.current');
    if (inCorsoEl) currentActivityLabel = inCorsoEl.getAttribute('data-activity') || '';
  }

  let gridHtml = '';
  
  // Se progetto manuale selezionato, mostra header con codice progetto
  if (unlockAll && _switchOverrideProject) {
    gridHtml += `<div style="background:#e3f2fd;border:2px solid #42a5f5;border-radius:12px;padding:12px 14px;margin-bottom:14px;text-align:center;">
      <div style="font-size:10px;color:#1e88e5;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">PROGETTO SELEZIONATO</div>
      <div style="font-weight:800;font-size:17px;color:#1a56db;">P. ${escapeHtmlCI(_switchOverrideProject.code)}</div>
      <div style="font-size:12px;color:#333;margin-top:2px;">${escapeHtmlCI(_switchOverrideProject.name)}</div>
      <div style="font-size:12px;color:#1e88e5;margin-top:8px;font-weight:600;">‚Üì Scegli attivit√†</div>
    </div>`;
  }
  
  gridHtml += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
  ACTIVITIES.forEach(a => {
    const isCurrent = !unlockAll && currentActivityLabel.toLowerCase() === a.code.toLowerCase();
    const isAltro = a.code.toLowerCase() === 'altro';
    const blocked = isCurrent && !isAltro;
    gridHtml += `
      <div class="switch-activity-item${isCurrent ? ' current' : ''}"
           onclick="${blocked ? '' : `gridActivityClick('${escapeHtmlCI(a.code)}')`}"
           data-activity="${escapeHtmlCI(a.code)}"
           style="cursor:${blocked ? 'default' : 'pointer'};text-align:center;padding:16px 10px;position:relative;${blocked ? 'opacity:0.5;' : ''}">
        <div style="font-size:32px;margin-bottom:6px;">${a.icon}</div>
        <div style="font-weight:600;font-size:13px;">${escapeHtmlCI(a.label)}</div>
        ${isCurrent ? '<div style="position:absolute;top:6px;right:8px;background:#4CAF50;color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700;">IN CORSO</div>' : ''}
      </div>`;
  });
  gridHtml += '</div>';
  gridHtml += `<button onclick="hideSwitchActivityGrid()" style="width:100%;margin-top:12px;padding:12px;background:#f5f5f5;color:#666;border:1px solid #ddd;border-radius:10px;font-weight:600;cursor:pointer;">
    ‚Üê Indietro
  </button>`;
  gridContainer.innerHTML = gridHtml;
}

function hideSwitchActivityGrid() {
  const dv = document.getElementById('switchDefaultView');
  if (dv) dv.style.display = '';
  const tc = document.getElementById('switchTopCards');
  if (tc) tc.style.display = '';
  if (_switchOverrideProject) {
    const mc = document.getElementById('switchManualProjectCard');
    if (mc) mc.style.display = '';
  }
  document.getElementById('switchActivityGrid').style.display = 'none';
}

function closeSwitchActivityModal(event) {
  if (event && event.target !== event.currentTarget) return;
  _switchForceActivitySelection = false;
  document.getElementById('switchActivityOverlay').classList.remove('active');
}

// ‚ïê‚ïê‚ïê Tastierino Numerico Cambio Progetto ‚ïê‚ïê‚ïê
let _numpadValue = '';
let _numpadFoundProject = null;  // { project_code, project_name }
let _numpadSearchTimer = null;

function openNumpad(prefillCode) {
  _numpadValue = '';
  _numpadFoundProject = null;
  document.getElementById('numpadInput').value = '';
  document.getElementById('numpadResult').innerHTML = '';
  document.getElementById('numpadConfirmBtn').disabled = true;
  
  // Mostra hint attivit√† selezionata (se presente)
  const hintEl = document.getElementById('numpadActivityHint');
  const actName = (_pendingGridActivity || (_pendingProductionStart && _pendingProductionStart.activityLabel)) || null;
  if (hintEl && actName) {
    hintEl.textContent = 'üìã Attivit√†: ' + actName;
    hintEl.style.display = 'block';
  } else if (hintEl) {
    hintEl.style.display = 'none';
  }
  
  document.getElementById('numpadOverlay').classList.add('active');

  // Pre-compilazione: da parametro esplicito, oppure dal progetto corrente per attivit√† griglia
  const preCode = prefillCode || ((_pendingGridActivity || _pendingProductionStart) && (_switchGridProject || _switchCurrentProject) ? (_switchGridProject || _switchCurrentProject).code : null);
  if (preCode) {
    _numpadValue = String(preCode);
    document.getElementById('numpadInput').value = _numpadValue;
    setTimeout(() => numpadSearch(), 100);
  }
}

function closeNumpad(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('numpadOverlay').classList.remove('active');
  if (_numpadSearchTimer) { clearTimeout(_numpadSearchTimer); _numpadSearchTimer = null; }
  _pendingGridActivity = null; // Reset attivit√† in attesa se si chiude il numpad
  _pendingProductionStart = null; // Reset anche il pending produzione
}

function closeNumpadSilent() {
  // Chiudi numpad senza resettare le variabili pending (usata da numpadConfirm)
  document.getElementById('numpadOverlay').classList.remove('active');
  if (_numpadSearchTimer) { clearTimeout(_numpadSearchTimer); _numpadSearchTimer = null; }
}

function numpadPress(digit) {
  if (_numpadValue.length >= 10) return;
  _numpadValue += digit;
  document.getElementById('numpadInput').value = _numpadValue;
  _numpadFoundProject = null;
  document.getElementById('numpadConfirmBtn').disabled = true;
  // Auto-search dopo 500ms di inattivit√†
  if (_numpadSearchTimer) clearTimeout(_numpadSearchTimer);
  _numpadSearchTimer = setTimeout(() => numpadSearch(), 500);
}

function numpadDelete() {
  _numpadValue = _numpadValue.slice(0, -1);
  document.getElementById('numpadInput').value = _numpadValue;
  _numpadFoundProject = null;
  document.getElementById('numpadConfirmBtn').disabled = true;
  if (_numpadValue.length > 0) {
    if (_numpadSearchTimer) clearTimeout(_numpadSearchTimer);
    _numpadSearchTimer = setTimeout(() => numpadSearch(), 500);
  } else {
    document.getElementById('numpadResult').innerHTML = '';
  }
}

function numpadClear() {
  _numpadValue = '';
  _numpadFoundProject = null;
  document.getElementById('numpadInput').value = '';
  document.getElementById('numpadResult').innerHTML = '';
  document.getElementById('numpadConfirmBtn').disabled = true;
  if (_numpadSearchTimer) { clearTimeout(_numpadSearchTimer); _numpadSearchTimer = null; }
}

async function numpadSearch() {
  const code = _numpadValue.trim();
  if (!code) return;
  
  const resultEl = document.getElementById('numpadResult');
  resultEl.innerHTML = '<span class="searching">üîç Ricerca...</span>';
  
  try {
    const res = await fetch('/api/production/project-lookup?code=' + encodeURIComponent(code));
    const data = await res.json();
    
    if (data.ok) {
      _numpadFoundProject = { project_code: data.project_code, project_name: data.project_name };
      resultEl.innerHTML = `<span class="found">‚úÖ ${escapeHtmlCI(data.project_name)}</span>`;
      document.getElementById('numpadConfirmBtn').disabled = false;
    } else {
      _numpadFoundProject = null;
      resultEl.innerHTML = `<span class="not-found">‚ùå ${data.error || 'Non trovato'}</span>`;
      document.getElementById('numpadConfirmBtn').disabled = true;
    }
  } catch (err) {
    _numpadFoundProject = null;
    resultEl.innerHTML = '<span class="not-found">‚ùå Errore di connessione</span>';
    document.getElementById('numpadConfirmBtn').disabled = true;
  }
}

function numpadConfirm() {
  if (!_numpadFoundProject) return;
  
  const newCode = _numpadFoundProject.project_code;
  const newName = _numpadFoundProject.project_name;
  
  closeNumpadSilent(); // Chiudi senza resettare _pendingGridActivity/_pendingProductionStart
  
  // ‚ïê‚ïê‚ïê Caso 1: Avvio produzione dal popup iniziale (dopo timbratura) ‚ïê‚ïê‚ïê
  if (_pendingProductionStart) {
    const pending = _pendingProductionStart;
    _pendingProductionStart = null;
    _pendingGridActivity = null;
    
    const actLabel = pending.activityLabel;
    const startTs = pending.startTs;
    
    // Se attivit√† √® "Altro", chiedi note obbligatorie prima
    if (actLabel.toLowerCase() === 'altro') {
      openNotesPopup(async (notes) => {
        dismissProductionActivityPopup();
        await _doStartProductionActivity(newCode, newName, actLabel, startTs, notes);
      });
      return;
    }
    
    dismissProductionActivityPopup();
    _doStartProductionActivity(newCode, newName, actLabel, startTs, null);
    return;
  }
  
  // ‚ïê‚ïê‚ïê Caso 2: Attivit√† dalla griglia "Cambia Attivit√†" ‚ïê‚ïê‚ïê
  if (_pendingGridActivity) {
    const actLabel = _pendingGridActivity;
    _pendingGridActivity = null;
    confirmSwitchActivity(newCode, newName, actLabel);
    return;
  }
  
  // ‚ïê‚ïê‚ïê Caso 3: Cambio progetto generico (senza attivit√† selezionata) ‚ïê‚ïê‚ïê
  // Salva override progetto
  _switchOverrideProject = { code: newCode, name: newName };
  
  // Aggiorna la card progetto manuale (ma non la mostriamo ‚Äî si va diretti alla griglia)
  const card = document.getElementById('switchManualProjectCard');
  if (card) {
    document.getElementById('switchManualProjectCode').textContent = 'P. ' + newCode;
    document.getElementById('switchManualProjectName').textContent = newName;
    // Non mostrare la card, passiamo direttamente alle attivit√†
  }

  // Nascondi card IN CORSO e progetto pianificato ‚Äî mostra direttamente la griglia attivit√†
  showSwitchActivityGrid('manual');
  showToast('üìã Progetto: P. ' + newCode + ' ‚Äî Scegli attivit√†', 'info');
}

// Progetto override per il modal switch (se l'utente ha cambiato progetto manualmente)
let _switchOverrideProject = null;
let _switchCurrentProject = null;
let _switchForceActivitySelection = false;

async function confirmSwitchActivity(projectCode, projectName, activityLabel) {
  // Se attivit√† √® "Altro", chiedi note obbligatorie prima di procedere
  if (activityLabel.toLowerCase() === 'altro') {
    openNotesPopup(async (notes) => {
      closeSwitchActivityModal();
      await _doSwitchActivity(projectCode, projectName, activityLabel, notes);
    });
    return;
  }
  
  closeSwitchActivityModal();
  await _doSwitchActivity(projectCode, projectName, activityLabel, null);
}

async function _doSwitchActivity(projectCode, projectName, activityLabel, notes) {
  // Mostra feedback visivo
  const btn = document.getElementById('btnStartDay');
  const origLabel = document.getElementById('labelStart').textContent;
  document.getElementById('labelStart').textContent = 'Cambio...';
  btn.disabled = true;
  
  try {
    const payload = {
      project_code: projectCode,
      project_name: projectName,
      activity_label: activityLabel
    };
    if (notes) payload.notes = notes;
    
    const resp = await fetch('/api/production/timer/switch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await resp.json();
    
    if (data.ok) {
      showToast('‚úÖ Attivit√† cambiata: ' + activityLabel);
      // Ricarica le timbrature per aggiornare lo stato
      await loadTimbrature();
    } else {
      showToast('‚ùå Errore: ' + (data.error || 'Cambio attivit√† fallito'));
    }
  } catch (err) {
    console.error('Errore switch attivit√†:', err);
    showToast('‚ùå Errore di rete');
  } finally {
    document.getElementById('labelStart').textContent = origLabel;
    btn.disabled = false;
  }
}

// Refresh page function
async function refreshPage() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  
  try {
    // Ricarica tutte le informazioni
    await Promise.all([
      loadTimbrature(),
      loadTurno()
    ]);
  } catch (err) {
    console.error('Errore refresh:', err);
  } finally {
    btn.classList.remove('loading');
  }
}

// Menu functions
function toggleMenu() {
  const btn = document.getElementById('hamburgerBtn');
  const menu = document.getElementById('sideMenu');
  const overlay = document.getElementById('menuOverlay');
  
  btn.classList.toggle('active');
  menu.classList.toggle('active');
  overlay.classList.toggle('active');
}

function closeMenu() {
  document.getElementById('hamburgerBtn').classList.remove('active');
  document.getElementById('sideMenu').classList.remove('active');
  document.getElementById('menuOverlay').classList.remove('active');
}

// Profilo Utente Page
function openProfilePage() {
  closeMenu();
  document.getElementById('profilePage').classList.add('active');
  // Reset form
  document.getElementById('profileCurrentPassword').value = '';
  document.getElementById('profileNewPassword').value = '';
  document.getElementById('profileConfirmPassword').value = '';
  document.getElementById('passwordMessage').className = 'profile-message';
  document.getElementById('passwordMessage').textContent = '';
}

function closeProfilePage() {
  document.getElementById('profilePage').classList.remove('active');
}

async function submitProfilePasswordChange(e) {
  e.preventDefault();
  
  const currentPwd = document.getElementById('profileCurrentPassword').value;
  const newPwd = document.getElementById('profileNewPassword').value;
  const confirmPwd = document.getElementById('profileConfirmPassword').value;
  const msgEl = document.getElementById('passwordMessage');
  
  // Reset message
  msgEl.className = 'profile-message';
  msgEl.textContent = '';
  
  if (newPwd !== confirmPwd) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Le password non coincidono';
    return;
  }
  
  if (newPwd.length < 4) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'La password deve essere di almeno 4 caratteri';
    return;
  }
  
  const btn = document.getElementById('btnProfileSavePassword');
  btn.disabled = true;
  btn.textContent = 'Salvataggio...';
  
  try {
    const res = await fetch('/api/user/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_password: currentPwd,
        new_password: newPwd
      })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      msgEl.className = 'profile-message success';
      msgEl.textContent = 'Password aggiornata con successo! ‚úì';
      // Reset form
      document.getElementById('profileCurrentPassword').value = '';
      document.getElementById('profileNewPassword').value = '';
      document.getElementById('profileConfirmPassword').value = '';
    } else {
      msgEl.className = 'profile-message error';
      msgEl.textContent = data.error || 'Errore nel cambio password';
    }
  } catch (err) {
    console.error('Errore:', err);
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Errore di connessione';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Aggiorna Password';
  }
}

// Theme toggle
function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  if (isDark) {
    document.documentElement.removeAttribute('data-theme');
    localStorage.removeItem('theme');
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUSH NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const pushState = {
  supported: 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window,
  subscribed: false,
  publicKey: null,
  permission: typeof Notification !== 'undefined' ? Notification.permission : 'unsupported'
};

// Carica stato push dal server
async function loadPushState() {
  if (!pushState.supported) {
    updatePushUI();
    return;
  }
  
  try {
    const res = await fetch('/api/push/status');
    const data = await res.json();
    
    if (data.enabled) {
      pushState.publicKey = data.publicKey;
      pushState.subscribed = data.subscribed || false;
    }
    
    // Verifica anche lo stato locale della subscription
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      pushState.subscribed = Boolean(subscription);
    }
  } catch (err) {
    console.warn('Errore caricamento stato push:', err);
  }
  
  updatePushUI();
  
  // Auto-richiedi notifiche se non attive e permesso non negato
  autoRequestNotifications();
}

// Richiedi automaticamente le notifiche se non sono attive
async function autoRequestNotifications() {
  // Aspetta un secondo per non sovrapporre altri elementi UI
  await new Promise(r => setTimeout(r, 1000));
  
  // Non chiedere se:
  // - Push non supportato
  // - Gi√† iscritto
  // - Permesso gi√† negato
  // - Gi√† chiesto in questa sessione
  if (!pushState.supported) return;
  if (pushState.subscribed) return;
  if (pushState.permission === 'denied') return;
  if (sessionStorage.getItem('push_prompted')) return;
  
  // Segna che abbiamo gi√† chiesto in questa sessione
  sessionStorage.setItem('push_prompted', '1');
  
  // Se il permesso non √® stato ancora chiesto, chiedi
  if (Notification.permission === 'default') {
    // Mostra un dialog di conferma prima di chiedere il permesso del browser
    const shouldAsk = await showNotificationPrompt();
    if (shouldAsk) {
      await subscribeToPush();
      updatePushUI();
    }
  } else if (Notification.permission === 'granted' && !pushState.subscribed) {
    // Permesso gi√† dato ma non iscritto - chiedi conferma comunque
    const shouldAsk = await showNotificationPrompt();
    if (shouldAsk) {
      await subscribeToPush();
      updatePushUI();
    }
  }
}

// Mostra prompt personalizzato per le notifiche
function showNotificationPrompt() {
  return new Promise((resolve) => {
    // Crea overlay
    const overlay = document.createElement('div');
    overlay.id = 'notification-prompt-overlay';
    overlay.style.cssText = `
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 10000;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.3s ease;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
      background: var(--bg-card, white); border-radius: 16px;
      padding: 24px; max-width: 340px; margin: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    `;
    
    dialog.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">üîî</div>
      <h3 style="margin: 0 0 12px; color: var(--text-primary, #333); font-size: 18px;">
        Vuoi ricevere notifiche?
      </h3>
      <p style="margin: 0 0 20px; color: var(--text-secondary, #666); font-size: 14px; line-height: 1.5;">
        Ti avviseremo quando vengono pubblicati nuovi turni, quando le tue richieste vengono approvate e altre comunicazioni importanti.
      </p>
      <div style="display: flex; gap: 12px;">
        <button id="notif-no" style="
          flex: 1; padding: 12px; border: 1px solid var(--border, #ddd);
          background: transparent; border-radius: 8px; cursor: pointer;
          font-size: 14px; color: var(--text-secondary, #666);
        ">Non ora</button>
        <button id="notif-yes" style="
          flex: 1; padding: 12px; border: none;
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white; border-radius: 8px; cursor: pointer;
          font-size: 14px; font-weight: 600;
        ">Attiva</button>
      </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    document.getElementById('notif-yes').onclick = () => {
      overlay.remove();
      resolve(true);
    };
    
    document.getElementById('notif-no').onclick = () => {
      overlay.remove();
      resolve(false);
    };
    
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        resolve(false);
      }
    };
  });
}

// Aggiorna UI in base allo stato
function updatePushUI() {
  const toggle = document.getElementById('pushToggle');
  const icon = document.getElementById('notificationIcon');
  const label = document.getElementById('notificationLabel');
  const menuItem = document.getElementById('notificationMenuItem');
  
  if (!pushState.supported) {
    menuItem.style.display = 'none';
    return;
  }
  
  toggle.checked = pushState.subscribed;
  
  if (pushState.subscribed) {
    icon.textContent = 'üîî';
    label.textContent = 'Notifiche attive';
  } else {
    icon.textContent = 'üîï';
    label.textContent = 'Attiva Notifiche';
  }
  
  // Disabilita se permesso negato
  if (pushState.permission === 'denied') {
    toggle.disabled = true;
    label.textContent = 'Notifiche bloccate';
  }
}

// Toggle notifiche push
async function togglePushNotifications() {
  const toggle = document.getElementById('pushToggle');
  
  if (toggle.checked) {
    await subscribeToPush();
  } else {
    await unsubscribeFromPush();
  }
  
  updatePushUI();
}

// Converti VAPID key
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// Sottoscrivi alle notifiche push
async function subscribeToPush() {
  if (!pushState.supported) {
    showToast('‚ö†Ô∏è Notifiche non supportate', 'error');
    return false;
  }
  
  if (!pushState.publicKey) {
    showToast('‚ö†Ô∏è Server non configurato', 'error');
    return false;
  }
  
  // Richiedi permesso se non gi√† concesso
  if (Notification.permission === 'denied') {
    showToast('‚ö†Ô∏è Notifiche bloccate dal browser', 'error');
    pushState.permission = 'denied';
    return false;
  }
  
  if (Notification.permission !== 'granted') {
    const permission = await Notification.requestPermission();
    pushState.permission = permission;
    
    if (permission !== 'granted') {
      showToast('‚ö†Ô∏è Permesso notifiche negato', 'error');
      return false;
    }
  }
  
  try {
    // Registra service worker se non gi√† fatto
    let registration = await navigator.serviceWorker.getRegistration();
    if (!registration) {
      registration = await navigator.serviceWorker.register('/sw.js?v=2026.01.17b');
      await navigator.serviceWorker.ready;
    }
    
    const applicationServerKey = urlBase64ToUint8Array(pushState.publicKey);
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey
    });
    
    // Invia al server
    const payload = subscription.toJSON();
    payload.userAgent = navigator.userAgent || null;
    payload.contentEncoding = 'aes128gcm';
    
    const res = await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (res.ok) {
      pushState.subscribed = true;
      showToast('üîî Notifiche attivate!', 'success');
      return true;
    } else {
      throw new Error('Errore registrazione server');
    }
  } catch (err) {
    console.error('Errore subscribe push:', err);
    showToast('‚ö†Ô∏è Errore attivazione notifiche', 'error');
    return false;
  }
}

// Disiscriviti dalle notifiche push
async function unsubscribeFromPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      const payload = subscription.toJSON();
      
      // Notifica il server
      try {
        await fetch('/api/push/unsubscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: payload.endpoint })
        });
      } catch (e) {
        console.warn('Errore unsubscribe server:', e);
      }
      
      await subscription.unsubscribe();
    }
    
    pushState.subscribed = false;
    showToast('üîï Notifiche disattivate', 'success');
  } catch (err) {
    console.error('Errore unsubscribe push:', err);
    showToast('‚ö†Ô∏è Errore disattivazione', 'error');
  }
}

// Init
updateClock();
updateDate();
setInterval(updateClock, 1000);

// Prima carica la config, poi le timbrature (l'ordine √® importante!)
(async function initPage() {
  await loadTimbraturaConfig(); // PRIMA la config
  await loadTimbrature(); // POI le timbrature (usa is_production_group)
  await loadTurno(); // Turno DEVE essere caricato prima che l'utente possa timbrare
  loadPushState();
  
  if (navigator.onLine) {
    syncOfflineTimbrature();
  }
  
  // ‚îÄ‚îÄ MANCATA TIMBRATURA PRODUZIONE: auto-apertura popup attivit√† ‚îÄ‚îÄ
  // Se arriviamo dalla pagina richieste dopo una mancata timbratura pre-inserita,
  // mostra il popup attivit√† produzione come se l'utente avesse appena timbrato.
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const fromMancata = urlParams.get('from_mancata_timbratura');
    const pendingActivity = sessionStorage.getItem('pending_production_activity');
    
    if (fromMancata && pendingActivity) {
      sessionStorage.removeItem('pending_production_activity');
      // Pulisci il parametro URL senza ricaricare
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
      const activity = JSON.parse(pendingActivity);
      if (activity && activity.detected && activity.action === 'start') {
        // Mostra il popup attivit√† con un piccolo delay per dare tempo alla UI di caricare
        setTimeout(() => showProductionActivityPopup(activity), 600);
      }
    } else if (fromMancata) {
      // Pre-inserimento avvenuto ma senza dati activity (es. pausa/uscita) ‚Üí pulisci URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      showToast('‚úì Timbratura mancata registrata', 'success');
    }
  } catch (e) {
    console.warn('Errore gestione mancata timbratura produzione:', e);
  }
})();

// Ricarica dati quando si torna alla pagina (da bfcache o navigazione)
window.addEventListener('pageshow', async function(event) {
  if (event.persisted) {
    console.log('Pagina ripristinata da bfcache, ricarico dati...');
    await loadTimbraturaConfig();
    await loadTimbrature();
    await loadTurno();
  }
});

// Ricarica dati quando la tab diventa visibile
document.addEventListener('visibilitychange', async function() {
  if (document.visibilityState === 'visible') {
    console.log('Tab tornata visibile, ricarico dati...');
    await loadTimbraturaConfig();
    loadTimbrature();
    loadTurno();
  }
});

// Tema
if (localStorage.getItem('theme') === 'dark') {
  document.documentElement.setAttribute('data-theme', 'dark');
}

// Registra service worker per PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js?v=2026.01.17b')
    .then(reg => console.log('Service Worker registrato'))
    .catch(err => console.warn('Service Worker fallito:', err));
    
  // Ascolta messaggi dal Service Worker (sincronizzazione offline)
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'offline-queue') {
      console.log('[SW Message]', event.data);
      
      if (event.data.action === 'delivered' && event.data.pathname === '/api/timbratura') {
        // Richiesta timbratura sincronizzata con successo
        showToast('‚úÖ Timbratura sincronizzata dal Service Worker!', 'success');
        loadTimbrature();
      } else if (event.data.action === 'error' && event.data.pathname === '/api/timbratura') {
        showToast('‚ö†Ô∏è Errore sincronizzazione timbratura', 'error');
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OFFLINE / ONLINE STATUS - Basato SOLO su /api/ping, ignora navigator.onLine
//  (navigator.onLine d√† falsi negativi quando CDN esterni falliscono)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let isReallyOnline = true; // Assumiamo online finch√© non verifichiamo

// Verifica lo stato reale chiamando il server
async function checkRealOnlineStatus() {
  try {
    const response = await fetch('/api/ping', { 
      method: 'GET', 
      cache: 'no-store',
      headers: { 'Cache-Control': 'no-cache' }
    });
    return response.ok;
  } catch {
    return false;
  }
}

// Aggiorna UI in base allo stato online/offline
function updateOnlineUI(online, showToast = false) {
  const existingBar = document.getElementById('offline-bar');
  
  if (!online && !existingBar) {
    const bar = document.createElement('div');
    bar.id = 'offline-bar';
    bar.className = 'offline-bar';
    bar.innerHTML = 'üì¥ Sei offline - Le timbrature verranno salvate in locale';
    document.body.prepend(bar);
    if (showToast) {
      window.showToast?.('üì¥ Connessione persa - Modalit√† offline', 'warning');
    }
  } else if (online && existingBar) {
    existingBar.remove();
    if (showToast) {
      window.showToast?.('‚úÖ Connessione ripristinata', 'success');
      syncOfflineTimbrature();
      setTimeout(loadTimbrature, 1000);
    }
  }
  
  isReallyOnline = online;
}

// Check iniziale - senza toast
checkRealOnlineStatus().then(online => updateOnlineUI(online, false));

// NON usiamo pi√π window.addEventListener('online'/'offline') perch√© 
// navigator.onLine d√† falsi positivi/negativi con CDN esterni che falliscono

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PWA INSTALL PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] beforeinstallprompt event fired');
    e.preventDefault();
    deferredInstallPrompt = e;
    
    // Mostra il banner
    if (!localStorage.getItem('pwa-install-dismissed')) {
        showPwaInstallBanner();
    }
    // Mostra pulsante nel menu se esiste
    const menuBtn = document.getElementById('pwa-install-menu-item');
    if (menuBtn) menuBtn.style.display = 'block';
});

window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredInstallPrompt = null;
    hidePwaInstallBanner();
});

function showPwaInstallBanner() {
    hidePwaInstallBanner();
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.innerHTML = `
        <div style="position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                    color: white; padding: 16px 20px; border-radius: 12px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;
                    display: flex; align-items: center; gap: 12px; max-width: 90vw;
                    font-family: system-ui, -apple-system, sans-serif;">
            <div style="font-size: 28px;">üì±</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 2px;">Installa JobLog</div>
                <div style="font-size: 13px; opacity: 0.9;">Accesso rapido dalla Home</div>
            </div>
            <button onclick="installPwa()" style="background: white; color: #16a34a; border: none; 
                    padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Installa
            </button>
            <button onclick="dismissPwaInstall()" style="background: transparent; border: none; 
                    color: white; opacity: 0.7; cursor: pointer; padding: 4px; font-size: 18px;">
                ‚úï
            </button>
        </div>
    `;
    document.body.appendChild(banner);
}

function hidePwaInstallBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.remove();
}

// Rileva iOS
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// Rileva se √® gi√† installata come PWA
function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

function showIOSInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'ios-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üì≤</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su iPhone/iPad</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il pulsante Condividi
                            </div>
                            <div style="font-size: 36px;">
                                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16,6 12,2 8,6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                In basso nella barra di Safari
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Scorri e tocca
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">‚ûï</span>
                                <span style="font-weight: 600;">Aggiungi a Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">‚úì</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma con "Aggiungi"
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparir√† nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissIOSInstallModal()" 
                            style="width: 100%; padding: 14px; background: #007AFF; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function installPwa() {
    // Se siamo gi√† in standalone mode, l'app √® gi√† installata
    if (isStandalone()) {
        alert('‚úÖ JobLog √® gi√† installata!');
        return;
    }
    
    // Se abbiamo il prompt nativo (Android/Desktop Chrome)
    if (deferredInstallPrompt) {
        hidePwaInstallBanner();
        deferredInstallPrompt.prompt();
        const { outcome } = await deferredInstallPrompt.userChoice;
        console.log('[PWA] User choice:', outcome);
        deferredInstallPrompt = null;
        return;
    }
    
    // Se siamo su iOS, mostra istruzioni specifiche
    if (isIOS()) {
        showIOSInstallInstructions();
        return;
    }
    
    // Se siamo su Android senza prompt nativo
    if (isAndroid()) {
        showAndroidInstallInstructions();
        return;
    }
    
    // Fallback per desktop
    alert('Per installare l\'app:\n\nüíª Desktop Chrome: Icona + nella barra indirizzi');
}

function dismissPwaInstall() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    hidePwaInstallBanner();
}

function dismissIOSInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('ios-install-modal');
    if (modal) modal.remove();
}

function dismissAndroidInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('android-install-modal');
    if (modal) modal.remove();
}

// Rileva Android
function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function showAndroidInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'android-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üì≤</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su Android</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il menu di Chrome
                            </div>
                            <div style="font-size: 36px; color: #333;">‚ãÆ</div>
                            <div style="font-size: 13px; color: #64748b;">
                                I tre puntini in alto a destra
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca "Installa app" o
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">üì•</span>
                                <span style="font-weight: 600;">Aggiungi a schermata Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #16a34a; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">‚úì</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma l'installazione
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparir√† nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissAndroidInstallModal()" 
                            style="width: 100%; padding: 14px; background: #22c55e; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Mostra pulsante installazione e guida automatica
document.addEventListener('DOMContentLoaded', () => {
    const menuBtn = document.getElementById('pwa-install-menu-item');
    
    // Se non √® gi√† installata come standalone
    if (!isStandalone()) {
        // Mostra pulsante nel menu per iOS e Android
        if (menuBtn && (isIOS() || isAndroid())) {
            menuBtn.style.display = 'flex';
        }
        
        // Mostra automaticamente la guida al primo accesso
        if (!localStorage.getItem('pwa-install-dismissed')) {
            setTimeout(() => {
                if (isIOS()) {
                    showIOSInstallInstructions();
                } else if (isAndroid() && !deferredInstallPrompt) {
                    showAndroidInstallInstructions();
                }
            }, 1500);
        }
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERTIME (STRAORDINARI) - Check automatico dopo checkout
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function checkOvertimeAfterCheckout(sessionId) {
    try {
        // Prendi inizio e fine giornata dalla variabile globale todayTimbrature
        const today = new Date().toISOString().split('T')[0];
        
        // todayTimbrature √® gi√† caricato dalla loadTimbrature()
        if (!todayTimbrature || todayTimbrature.length === 0) return;
        
        // Trova orari inizio/fine giornata di oggi
        const inizio = todayTimbrature.find(t => t.tipo === 'inizio_giornata');
        const fine = todayTimbrature.find(t => t.tipo === 'fine_giornata');
        
        if (!inizio || !fine) return;
        
        // Estrai l'ora (pu√≤ essere oggetto o stringa)
        const getTimeStr = (t) => {
            if (!t.ora) return null;
            if (typeof t.ora === 'string') return t.ora.substring(0, 5);
            if (t.ora.hour !== undefined) return `${String(t.ora.hour).padStart(2,'0')}:${String(t.ora.minute || 0).padStart(2,'0')}`;
            return String(t.ora).substring(0, 5);
        };
        
        const actualStart = getTimeStr(inizio);
        const actualEnd = getTimeStr(fine);
        
        if (!actualStart || !actualEnd) return;
        
        const res = await fetch(`/api/user/check-overtime?date=${today}&actual_start=${actualStart}&actual_end=${actualEnd}&session_id=${sessionId || ''}`);
        const data = await res.json();
        
        if (data.overtime_detected) {
            showOvertimeModal(data);
        }
    } catch (err) {
        console.error('Errore check overtime:', err);
    }
}

function showOvertimeModal(overtimeData) {
    // Rimuovi modal esistente se presente
    const existingModal = document.getElementById('overtimeModal');
    if (existingModal) existingModal.remove();
    
    const hours = Math.floor(overtimeData.total_extra_minutes / 60);
    const mins = overtimeData.total_extra_minutes % 60;
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} minuti`;
    
    const typeLabels = {
        before_shift: 'Prima del turno',
        after_shift: 'Dopo il turno',
        both: 'Prima e dopo il turno',
        extra_day: 'Giornata extra'
    };
    
    const modal = document.createElement('div');
    modal.id = 'overtimeModal';
    modal.innerHTML = `
        <style>
            #overtimeModal {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #overtimeModal .modal-content {
                background: white;
                border-radius: 20px;
                max-width: 400px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #overtimeModal .modal-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 2rem;
            }
            #overtimeModal h3 {
                margin: 0 0 12px;
                font-size: 1.3rem;
            }
            #overtimeModal .time-highlight {
                background: #fef3c7;
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
            }
            #overtimeModal .time-highlight .value {
                font-size: 2rem;
                font-weight: 700;
                color: #92400e;
            }
            #overtimeModal .time-highlight .label {
                font-size: 0.85rem;
                color: #78350f;
            }
            #overtimeModal .details {
                text-align: left;
                font-size: 0.9rem;
                color: #64748b;
                margin: 16px 0;
            }
            #overtimeModal .details .row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #f1f5f9;
            }
            #overtimeModal textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 0.9rem;
                resize: none;
                margin-bottom: 16px;
            }
            #overtimeModal textarea:focus {
                outline: none;
                border-color: #4361ee;
            }
            #overtimeModal .btn-row {
                display: flex;
                gap: 12px;
            }
            #overtimeModal button {
                flex: 1;
                padding: 14px;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                border: none;
            }
            #overtimeModal .btn-cancel {
                background: #f1f5f9;
                color: #64748b;
            }
            #overtimeModal .btn-confirm {
                background: linear-gradient(135deg, #4361ee, #7c3aed);
                color: white;
            }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div class="modal-content">
            <div class="modal-icon">‚è±Ô∏è</div>
            <h3>Extra Turno Rilevato</h3>
            <p style="color:#64748b;margin:0 0 16px;">Hai lavorato oltre il turno pianificato</p>
            
            <div class="time-highlight">
                <div class="value">${timeStr}</div>
                <div class="label">${typeLabels[overtimeData.overtime_type] || 'Extra Turno'}</div>
            </div>
            
            <div class="details">
                <div class="row">
                    <span>Turno pianificato</span>
                    <strong>${overtimeData.planned_start || '--'} - ${overtimeData.planned_end || '--'}</strong>
                </div>
                <div class="row">
                    <span>Timbrate originali</span>
                    <strong>${overtimeData.actual_start} - ${overtimeData.actual_end}</strong>
                </div>
                <div class="row" style="background:#fef3c7;margin:0 -8px;padding:8px;border-radius:6px;">
                    <span>Timbrate arrotondate</span>
                    <strong style="color:#92400e;">${overtimeData.rounded_start || overtimeData.actual_start} - ${overtimeData.rounded_end || overtimeData.actual_end}</strong>
                </div>
            </div>
            
            <textarea id="overtimeNotes" placeholder="Inserisci una motivazione..." rows="2" required></textarea>
            <div style="font-size:0.75rem;color:#ef4444;margin:-8px 0 8px;" id="notesError" hidden>‚ö†Ô∏è La motivazione √® obbligatoria</div>
            
            <div class="btn-row">
                <button class="btn-confirm" onclick="submitOvertimeRequest()">Conferma</button>
            </div>
        </div>
    `;
    
    // Salva dati per submit
    modal.dataset.overtimeData = JSON.stringify(overtimeData);
    
    document.body.appendChild(modal);
    
    // Modal obbligatorio - non chiudibile cliccando fuori
}

function closeOvertimeModal() {
    const modal = document.getElementById('overtimeModal');
    if (modal) modal.remove();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP EXTRA TURNO (mostrato dopo timbratura con Extra Turno rilevato)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showExtraTurnoPopup(extraTurnoData, tipo) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('extraTurnoPopup');
    if (existingPopup) existingPopup.remove();
    
    const minutes = extraTurnoData.minutes || 0;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} minuti`;
    
    const typeLabels = {
        before_shift: 'Ingresso anticipato',
        after_shift: 'Uscita posticipata'
    };
    const typeLabel = typeLabels[extraTurnoData.type] || 'Extra Turno';
    
    const tipoLabel = tipo === 'inizio_giornata' ? 'Inizio Giornata' : 'Fine Giornata';
    
    const requestId = extraTurnoData.request_id || null;
    
    const popup = document.createElement('div');
    popup.id = 'extraTurnoPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #extraTurnoPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #extraTurnoPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #extraTurnoPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #10b981, #059669);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #extraTurnoPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #extraTurnoPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #extraTurnoPopup .time-box {
                background: linear-gradient(135deg, #ecfdf5, #d1fae5);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
            }
            #extraTurnoPopup .time-box .value {
                font-size: 2rem;
                font-weight: 700;
                color: #047857;
            }
            #extraTurnoPopup .time-box .label {
                font-size: 0.85rem;
                color: #065f46;
                margin-top: 4px;
            }
            #extraTurnoPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #f59e0b;
            }
            #extraTurnoPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #extraTurnoPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #extraTurnoPopup .motivation-label .required {
                color: #ef4444;
            }
            #extraTurnoPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #extraTurnoPopup .motivation-input:focus {
                outline: none;
                border-color: #10b981;
            }
            #extraTurnoPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #extraTurnoPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #extraTurnoPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #extraTurnoPopup .btn-ok:active {
                transform: scale(0.98);
            }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div class="popup-content">
            <div class="popup-icon">‚è±Ô∏è</div>
            <h3>Extra Turno Rilevato!</h3>
            <p class="subtitle">${tipoLabel} registrata con successo</p>
            
            <div class="time-box">
                <div class="value">${timeStr}</div>
                <div class="label">${typeLabel}</div>
            </div>
            
            <div class="info-text">
                ‚è≥ √à stata creata automaticamente una richiesta di Extra Turno. 
                Verr√† inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivazione <span class="required">*</span>
                </label>
                <textarea id="extraTurnoMotivation" class="motivation-input" 
                    rows="3" placeholder="Indica il motivo dell'extra turno..." 
                    maxlength="500"></textarea>
                <div id="extraTurnoMotivationError" class="error-msg">
                    La motivazione √® obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitExtraTurnoMotivation()">Conferma</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('extraTurnoMotivation')?.focus();
    }, 300);
}

function closeExtraTurnoPopup() {
    const popup = document.getElementById('extraTurnoPopup');
    if (popup) popup.remove();
}

async function submitExtraTurnoMotivation() {
    const popup = document.getElementById('extraTurnoPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('extraTurnoMotivation');
    const errorMsg = document.getElementById('extraTurnoMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione
    if (!motivation) {
        motivationInput.classList.add('error');
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeExtraTurnoPopup();
            showToast('‚úÖ Motivazione salvata', 'success');
            await loadTimbrature();
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio motivazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio motivazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POPUP RICHIESTA ANTICIPO INGRESSO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showFlexWarningPopup(flexData) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('flexWarningPopup');
    if (existingPopup) existingPopup.remove();
    
    const message = flexData.message || 'Richiesta anticipo ingresso';
    const requestId = flexData.request_id || null;
    const tipoLabel = flexData.tipo === 'inizio_giornata' ? 'Ingresso' : 'Uscita';
    
    const popup = document.createElement('div');
    popup.id = 'flexWarningPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #flexWarningPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #flexWarningPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #flexWarningPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #flexWarningPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #flexWarningPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #flexWarningPopup .warning-box {
                background: linear-gradient(135deg, #fef3c7, #fde68a);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
                border-left: 4px solid #f59e0b;
            }
            #flexWarningPopup .warning-box .message {
                font-size: 0.95rem;
                color: #92400e;
                font-weight: 500;
            }
            #flexWarningPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #f59e0b;
            }
            #flexWarningPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #flexWarningPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #flexWarningPopup .motivation-label .required {
                color: #ef4444;
            }
            #flexWarningPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #flexWarningPopup .motivation-input:focus {
                outline: none;
                border-color: #f59e0b;
            }
            #flexWarningPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #flexWarningPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #flexWarningPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #flexWarningPopup .btn-ok:active {
                transform: scale(0.98);
            }
        </style>
        <div class="popup-content">
            <div class="popup-icon">‚ö†Ô∏è</div>
            <h3>${flexData.tipo === 'inizio_giornata' ? 'Richiesta anticipo ingresso' : 'Uscita oltre flessibilit√†'}</h3>
            <p class="subtitle">${flexData.tipo === 'inizio_giornata' ? tipoLabel + ' registrato prima della fascia consentita' : tipoLabel + ' registrata oltre la fascia consentita'}</p>
            
            <div class="warning-box">
                <div class="message">${message}</div>
            </div>
            
            <div class="info-text">
                ‚è≥ √à stata creata automaticamente una richiesta di autorizzazione. 
                Verr√† inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivazione <span class="required">*</span>
                </label>
                <textarea id="flexWarningMotivation" class="motivation-input" 
                    rows="3" placeholder="${flexData.tipo === 'inizio_giornata' ? 'Indica il motivo dell\'anticipo ingresso...' : 'Indica il motivo dell\'uscita oltre orario...'}" 
                    maxlength="500"></textarea>
                <div id="flexWarningMotivationError" class="error-msg">
                    La motivazione √® obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitFlexWarningMotivation()">Conferma</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('flexWarningMotivation')?.focus();
    }, 300);
}

function closeFlexWarningPopup() {
    const popup = document.getElementById('flexWarningPopup');
    if (popup) popup.remove();
}

async function submitFlexWarningMotivation() {
    const popup = document.getElementById('flexWarningPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('flexWarningMotivation');
    const errorMsg = document.getElementById('flexWarningMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione
    if (!motivation) {
        motivationInput.classList.add('error');
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeFlexWarningPopup();
            showToast('‚úÖ Motivazione salvata', 'success');
            await loadTimbrature();
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio motivazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio motivazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LATE ARRIVAL (Ritardo) - Modal per giustificazione
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _pendingProductionActivity = null; // Attivit√† da mostrare dopo chiusura popup ritardo

function showLateArrivalPopup(lateData) {
    // Rimuovi popup esistente se presente
    const existingPopup = document.getElementById('lateArrivalPopup');
    if (existingPopup) existingPopup.remove();
    
    const lateMinutes = lateData.late_minutes || 0;
    const turnoStart = lateData.turno_start || '';
    const requestId = lateData.request_id || null;
    const flexMinuti = lateData.flessibilita_ingresso_minuti || 0;
    const lateThreshold = lateData.late_threshold_minutes || 15;
    const isProduction = lateData.is_production || false;
    
    const popup = document.createElement('div');
    popup.id = 'lateArrivalPopup';
    popup.dataset.requestId = requestId;
    popup.innerHTML = `
        <style>
            #lateArrivalPopup {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #lateArrivalPopup .popup-content {
                background: white;
                border-radius: 20px;
                max-width: 380px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #lateArrivalPopup .popup-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 16px;
                font-size: 2rem;
            }
            #lateArrivalPopup h3 {
                margin: 0 0 8px;
                font-size: 1.25rem;
                color: #1e293b;
            }
            #lateArrivalPopup .subtitle {
                color: #64748b;
                margin: 0 0 16px;
                font-size: 0.9rem;
            }
            #lateArrivalPopup .late-box {
                background: linear-gradient(135deg, #fee2e2, #fecaca);
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
                border-left: 4px solid #dc2626;
            }
            #lateArrivalPopup .late-box .time {
                font-size: 1.8rem;
                font-weight: 700;
                color: #991b1b;
                margin-bottom: 4px;
            }
            #lateArrivalPopup .late-box .message {
                font-size: 0.9rem;
                color: #7f1d1d;
            }
            #lateArrivalPopup .info-text {
                font-size: 0.85rem;
                color: #64748b;
                margin: 16px 0;
                padding: 12px;
                background: #f8fafc;
                border-radius: 8px;
                border-left: 3px solid #dc2626;
            }
            #lateArrivalPopup .motivation-section {
                margin: 16px 0;
                text-align: left;
            }
            #lateArrivalPopup .motivation-label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #374151;
                margin-bottom: 8px;
                display: block;
            }
            #lateArrivalPopup .motivation-label .required {
                color: #ef4444;
            }
            #lateArrivalPopup .motivation-input {
                width: 100%;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 10px;
                font-size: 0.95rem;
                resize: none;
                transition: border-color 0.2s;
                box-sizing: border-box;
            }
            #lateArrivalPopup .motivation-input:focus {
                outline: none;
                border-color: #dc2626;
            }
            #lateArrivalPopup .motivation-input.error {
                border-color: #ef4444;
            }
            #lateArrivalPopup .error-msg {
                color: #ef4444;
                font-size: 0.8rem;
                margin-top: 6px;
                display: none;
            }
            #lateArrivalPopup .btn-ok {
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #dc2626, #b91c1c);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                margin-top: 8px;
            }
            #lateArrivalPopup .btn-ok:active {
                transform: scale(0.98);
            }
        </style>
        <div class="popup-content">
            <div class="popup-icon">‚è∞</div>
            <h3>Ritardo Rilevato</h3>
            <p class="subtitle">Ingresso oltre l'orario previsto</p>
            
            <div class="late-box">
                <div class="time">+${lateMinutes} min</div>
                <div class="message">Orario previsto: ${turnoStart}</div>
            </div>
            <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 6px;">
            ${!isProduction && flexMinuti > 0 ? `
            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 10px 14px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">‚è≥</span>
                <span style="color: #1e40af; font-size: 0.9rem;">Flessibilit√† ingresso: <strong>${flexMinuti} min</strong></span>
            </div>` : ''}
            ${lateThreshold > 0 ? `
            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 10px; padding: 10px 14px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.2rem;">üîî</span>
                <span style="color: #92400e; font-size: 0.9rem;">Tolleranza ritardo: <strong>${lateThreshold} min</strong></span>
            </div>` : ''}
            </div>
            
            <div class="info-text">
                üìù √à richiesta una giustificazione per il ritardo. 
                La richiesta verr√† inviata all'amministratore per l'approvazione.
            </div>
            
            <div class="motivation-section">
                <label class="motivation-label">
                    Motivo del ritardo <span class="required">*</span>
                </label>
                <textarea id="lateArrivalMotivation" class="motivation-input" 
                    rows="3" placeholder="Es: Traffico intenso, problema con i mezzi pubblici..." 
                    maxlength="500"></textarea>
                <div id="lateArrivalMotivationError" class="error-msg">
                    La motivazione √® obbligatoria
                </div>
            </div>
            
            <button class="btn-ok" onclick="submitLateArrivalMotivation()">Conferma Giustificazione</button>
        </div>
    `;
    
    document.body.appendChild(popup);
    
    // Focus sul campo motivazione
    setTimeout(() => {
        document.getElementById('lateArrivalMotivation')?.focus();
    }, 300);
}

function closeLateArrivalPopup() {
    const popup = document.getElementById('lateArrivalPopup');
    if (popup) popup.remove();
}

async function submitLateArrivalMotivation() {
    const popup = document.getElementById('lateArrivalPopup');
    if (!popup) return;
    
    const requestId = popup.dataset.requestId;
    const motivationInput = document.getElementById('lateArrivalMotivation');
    const errorMsg = document.getElementById('lateArrivalMotivationError');
    const motivation = motivationInput?.value.trim() || '';
    
    // Validazione: minimo 10 caratteri
    if (!motivation || motivation.length < 10) {
        motivationInput.classList.add('error');
        errorMsg.textContent = !motivation ? 'La motivazione √® obbligatoria' : 'La motivazione deve essere di almeno 10 caratteri';
        errorMsg.style.display = 'block';
        motivationInput.focus();
        return;
    }
    
    motivationInput.classList.remove('error');
    errorMsg.style.display = 'none';
    
    // Disabilita il bottone durante l'invio
    const btn = popup.querySelector('.btn-ok');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        // Aggiorna la richiesta con la motivazione
        const res = await fetch(`/api/user/requests/${requestId}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: motivation })
        });
        
        if (res.ok) {
            closeLateArrivalPopup();
            showToast('‚úÖ Giustificazione salvata', 'success');
            await loadTimbrature();
            // Mostra popup attivit√† di produzione se era in attesa
            if (_pendingProductionActivity) {
                const activity = _pendingProductionActivity;
                _pendingProductionActivity = null;
                setTimeout(() => showProductionActivityPopup(activity), 500);
            }
        } else {
            const data = await res.json();
            showToast(data.error || 'Errore salvataggio giustificazione', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (err) {
        console.error('Errore salvataggio giustificazione:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function submitOvertimeRequest() {
    const modal = document.getElementById('overtimeModal');
    if (!modal) return;
    
    const data = JSON.parse(modal.dataset.overtimeData || '{}');
    const notes = document.getElementById('overtimeNotes')?.value.trim() || '';
    const notesError = document.getElementById('notesError');
    
    // Validazione note obbligatorie
    if (!notes) {
        notesError.hidden = false;
        document.getElementById('overtimeNotes').focus();
        return;
    }
    notesError.hidden = true;
    
    const btn = modal.querySelector('.btn-confirm');
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        const res = await fetch('/api/user/overtime', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: data.date,
                session_id: data.session_id,
                planning_id: data.planning_id,
                shift_source: data.shift_source,
                planned_start: data.planned_start,
                planned_end: data.planned_end,
                actual_start: data.actual_start,
                actual_end: data.actual_end,
                rounded_start: data.rounded_start,
                rounded_end: data.rounded_end,
                extra_minutes_before: data.extra_minutes_before || 0,
                extra_minutes_after: data.extra_minutes_after || 0,
                total_extra_minutes: data.total_extra_minutes,
                overtime_type: data.overtime_type,
                notes: notes
            })
        });
        
        const result = await res.json();
        
        if (result.ok) {
            closeOvertimeModal();
            showToast('‚úÖ Richiesta Extra Turno inviata', 'success');
            // Ricarica le timbrature per mostrare il badge "in attesa"
            await loadTimbrature();
        } else {
            showToast(result.error || 'Errore invio richiesta', 'error');
            btn.disabled = false;
            btn.textContent = 'Richiedi';
        }
    } catch (err) {
        console.error('Errore submit overtime:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = 'Richiedi';
    }
}
</script>
</body>
</html>
