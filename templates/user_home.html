<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#667eea" />
<link rel="manifest" href="/static/manifest.json" />
<link rel="apple-touch-icon" href="/static/icons/icon-192x192.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<title>Timbratura - JOBLog</title>
<style>
:root {
  --bg: #f0f2f5;
  --bg-card: #ffffff;
  --bg-card-hover: #f8fafc;
  --brand: #667eea;
  --brand-light: #818cf8;
  --brand-dark: #4f46e5;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --green: #22c55e;
  --green-dark: #16a34a;
  --red: #ef4444;
  --red-dark: #dc2626;
  --success: #10b981;
  --success-bg: #d1fae5;
  --warning: #f59e0b;
  --warning-bg: #fef3c7;
  --danger: #ef4444;
  --danger-bg: #fee2e2;
  --orange: #f97316;
  --orange-light: #fed7aa;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow: rgba(0,0,0,0.1);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --radius: 16px;
  --radius-sm: 10px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
[data-theme="dark"] {
  --bg: #0f172a;
  --bg-card: #1e293b;
  --bg-card-hover: #334155;
  --brand: #818cf8;
  --brand-light: #a5b4fc;
  --brand-dark: #6366f1;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #334155;
  --border-light: #1e293b;
  --success-bg: rgba(16, 185, 129, 0.2);
  --warning-bg: rgba(245, 158, 11, 0.2);
  --danger-bg: rgba(239, 68, 68, 0.2);
  --shadow: rgba(0,0,0,0.3);
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html {
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh;
  touch-action: manipulation;
  -webkit-overflow-scrolling: touch;
}

/* Main Header with Gradient */
.main-header {
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
  padding: calc(var(--safe-top) + 20px) 20px 30px;
  position: relative;
}
.main-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  pointer-events: none;
}
.main-header-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
}
.main-header-title {
  flex: 1;
}
.main-header-title h1 {
  color: white;
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 2px;
}
.main-header-title p {
  color: rgba(255,255,255,0.8);
  font-size: 0.875rem;
}

.container {
  max-width: 420px;
  margin: 0 auto;
  padding: 16px;
  padding-bottom: calc(80px + var(--safe-bottom));
}
header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0 16px;
}
.header-info {
  flex: 1;
  text-align: center;
}
.header-title {
  font-size: 20px;
  font-weight: 700;
}
.header-date {
  font-size: 13px;
  color: var(--text-secondary);
}
.clock-section {
  text-align: center;
  padding: 24px 0 32px;
}
.clock {
  font-size: 64px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  letter-spacing: -2px;
}

/* Scanner Modal */
.scanner-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  padding-top: env(safe-area-inset-top, 20px);
  padding-bottom: env(safe-area-inset-bottom, 20px);
}
.scanner-modal.active {
  display: flex;
}
.scanner-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.scanner-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.scanner-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}
#qr-reader {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 16px;
  min-height: 280px;
}
#qr-reader video {
  border-radius: 12px;
  width: 100% !important;
  height: auto !important;
}
#qr-reader__scan_region {
  min-height: 250px;
}
.scanner-close {
  padding: 14px 32px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  min-height: 48px;
  touch-action: manipulation;
}

/* Method Choice Modal */
.method-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.method-modal.active {
  display: flex;
}
.method-container {
  background: var(--bg-card);
  border-radius: 20px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.method-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}
.method-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 24px;
}
.method-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 16px;
}
.method-btn {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 18px 20px;
  border: 2px solid var(--border);
  border-radius: 14px;
  background: var(--bg-card);
  cursor: pointer;
  transition: all 0.2s ease;
}
.method-btn:hover {
  border-color: var(--brand);
  background: rgba(102, 126, 234, 0.1);
}
.method-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.method-btn-icon {
  font-size: 32px;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  border-radius: 12px;
}
.method-btn-content {
  text-align: left;
  flex: 1;
}
.method-btn-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
}
.method-btn-desc {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.method-cancel {
  padding: 12px 24px;
  background: var(--bg);
  color: var(--text-secondary);
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}

/* GPS Modal */
.gps-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.gps-modal.active {
  display: flex;
}
.gps-container {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  max-width: 350px;
  width: 100%;
  text-align: center;
}
.gps-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.gps-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.gps-location-name {
  font-size: 15px;
  color: var(--text-primary);
  padding: 10px 16px;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(29, 78, 216, 0.1) 100%);
  border-radius: 10px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.gps-location-name .location-label {
  font-size: 18px;
}
.gps-status {
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  background: var(--bg);
}
.gps-icon {
  font-size: 48px;
  margin-bottom: 12px;
}
.gps-icon.loading {
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}
.gps-message {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.gps-accuracy {
  font-size: 12px;
  color: var(--text-muted);
}
.gps-accuracy.good { color: var(--green); }
.gps-accuracy.medium { color: var(--warning); }
.gps-accuracy.poor { color: var(--danger); }
.gps-tip {
  font-size: 11px;
  color: var(--text-secondary);
  display: block;
  margin-top: 4px;
}
.gps-buttons {
  display: flex;
  gap: 12px;
}
.gps-btn {
  flex: 1;
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
}
.gps-btn.primary {
  background: var(--green);
  color: white;
}
.gps-btn.primary:disabled {
  background: #64748b;
  cursor: not-allowed;
}
.gps-btn.secondary {
  background: var(--bg);
  color: var(--text-primary);
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 24px;
}
.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 18px 24px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s ease;
  color: white;
  min-height: 60px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.action-btn:active:not(:disabled) {
  transform: scale(0.98);
}
.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.action-btn.start {
  background: var(--green);
}
.action-btn.start:hover:not(:disabled),
.action-btn.start:active:not(:disabled) {
  background: var(--green-dark);
}
.action-btn.end {
  background: var(--red);
}
.action-btn.end:hover:not(:disabled),
.action-btn.end:active:not(:disabled) {
  background: var(--red-dark);
}
.action-btn .icon {
  font-size: 20px;
}
.action-btn .check {
  margin-left: auto;
  width: 24px;
  height: 24px;
  border: 2px solid rgba(255,255,255,0.5);
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.action-btn .check.done {
  background: white;
  border-color: white;
  color: var(--green);
}
.pause-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.pause-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 16px;
  border: 2px solid var(--orange);
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  min-height: 52px;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.2s ease;
  background: var(--orange-light);
  color: #9a3412;
}
.pause-btn:hover:not(:disabled) {
  background: var(--orange);
  color: white;
}
.pause-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.pause-btn .icon {
  font-size: 18px;
}
.history-section {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 16px var(--shadow);
}
.history-title {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.history-list {
  list-style: none;
}
.history-item {
  display: flex;
  align-items: stretch;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  min-height: 50px;
}
.history-item > *:not(.location-badge):not(.overtime-badge) {
  display: flex;
  align-items: center;
}
.history-item:last-child {
  border-bottom: none;
}
.history-item .time {
  font-weight: 600;
  min-width: 55px;
  align-self: center;
  display: flex;
  flex-direction: column;
  line-height: 1.3;
}
.history-item .time .ora-originale {
  opacity: 0.6;
  font-weight: 400;
  font-size: 12px;
  text-decoration: line-through;
}
.history-item .time .ora-mod {
  color: var(--green);
  font-weight: 700;
}
.history-item .pausa-durata {
  font-size: 12px;
  color: var(--text-secondary);
  margin-left: 4px;
}
.history-item .pausa-durata .ora-mod {
  color: var(--green);
  font-weight: 600;
}
.history-item .type {
  color: var(--text-secondary);
  align-self: center;
  flex: 1;
}
.history-item .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
  align-self: center;
}
.history-item .dot.start { background: var(--green); }
.history-item .dot.end { background: var(--red); }
.history-item .dot.pause { background: var(--orange); }

/* Sync status indicator */
.history-item .sync-status {
  margin-left: auto;
  font-size: 14px;
  align-self: center;
}
.history-item .sync-status.synced {
  color: var(--green);
  font-size: 12px;
}
.history-item .sync-status.pending {
  animation: pulse-cloud 1.5s ease-in-out infinite;
}
@keyframes pulse-cloud {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Overtime badge (straordinario in attesa) - riga separata */
.history-item.has-overtime {
  border-left: 3px solid #f59e0b;
  padding-left: 12px;
  margin-left: -3px;
}
.overtime-info-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0 6px 15px;
  margin-top: -8px;
  font-size: 12px;
  color: #92400e;
  background: linear-gradient(90deg, rgba(251, 191, 36, 0.15), transparent);
  border-bottom: 1px solid var(--border);
}
.overtime-info-row .overtime-icon {
  font-size: 14px;
}
.overtime-info-row .overtime-text {
  font-weight: 600;
}
.overtime-info-row .overtime-time {
  background: #fbbf24;
  color: #78350f;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 11px;
}

/* Location badge - chip grande con contenuto su 2 righe */
.history-item .location-badge {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 42px;
  padding: 6px 14px;
  font-size: 11px;
  font-weight: 500;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border-radius: 12px;
  margin-left: auto;
  max-width: 130px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  line-height: 1.2;
  text-align: center;
}
.history-item .location-badge .loc-icon {
  font-size: 14px;
  margin-bottom: 2px;
}
.history-item .location-badge .loc-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.history-item .method-badge {
  font-size: 12px;
  margin-left: 6px;
  align-self: center;
}
.history-item .method-badge.qr {
  opacity: 0.7;
}

.history-item.offline-pending {
  background: rgba(245, 158, 11, 0.08);
  border-radius: 8px;
  padding-left: 10px;
  padding-right: 10px;
  margin: 2px -10px;
}

.empty-history {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
  font-size: 14px;
}
.user-badge {
  position: fixed;
  bottom: calc(16px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  padding: 10px 20px;
  border-radius: 24px;
  box-shadow: 0 4px 20px var(--shadow);
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 100;
}
.user-badge .avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--green);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}
.logout-link {
  color: var(--red);
  text-decoration: none;
  margin-left: 4px;
  font-size: 18px;
  padding: 4px;
  touch-action: manipulation;
}
.toast {
  position: fixed;
  top: calc(20px + env(safe-area-inset-top, 0px));
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: var(--bg-card);
  padding: 14px 24px;
  border-radius: 12px;
  box-shadow: 0 8px 32px var(--shadow);
  font-weight: 600;
  z-index: 1001;
  transition: transform 0.3s ease, opacity 0.3s ease;
  max-width: calc(100vw - 40px);
  text-align: center;
  opacity: 0;
  pointer-events: none;
}
.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  pointer-events: auto;
}
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.toast.warning { border-left: 4px solid var(--yellow); }

/* Offline Status Bar */
.offline-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
  color: white;
  padding: 8px 16px;
  text-align: center;
  font-weight: 600;
  font-size: 13px;
  z-index: 1100;
}

/* Box Turno */
.turno-box {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 16px;
  padding: 16px 20px;
  margin-bottom: 20px;
  color: white;
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
  position: relative;
  overflow: hidden;
}
.turno-box.no-turno {
  background: linear-gradient(135deg, #64748b 0%, #475569 100%);
  box-shadow: 0 4px 16px rgba(100, 116, 139, 0.3);
}
.turno-nav {
  display: flex;
  align-items: center;
  gap: 12px;
}
.turno-nav-btn {
  background: rgba(255,255,255,0.3);
  border: 2px solid rgba(255,255,255,0.5);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.turno-nav-btn:hover {
  background: rgba(255,255,255,0.5);
  transform: scale(1.1);
}
.turno-nav-btn:active {
  transform: scale(0.95);
}
.turno-nav-btn:disabled {
  opacity: 0.25;
  cursor: not-allowed;
}
.turno-nav-btn:disabled:hover {
  background: rgba(255,255,255,0.3);
  transform: none;
}
.turno-content {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}
.turno-counter {
  position: absolute;
  top: 12px;
  right: 16px;
  background: rgba(255,255,255,0.25);
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.turno-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 600;
  opacity: 0.9;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.turno-project {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 4px;
  line-height: 1.3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.turno-details {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  font-size: 14px;
  opacity: 0.95;
}
.turno-detail {
  display: flex;
  align-items: center;
  gap: 4px;
}
.turno-detail .icon {
  font-size: 14px;
}
.turno-badge {
  display: inline-block;
  background: rgba(255,255,255,0.2);
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
}
.turno-badge.leader {
  background: #fbbf24;
  color: #92400e;
}
.turno-loading {
  text-align: center;
  padding: 12px;
  font-size: 14px;
  opacity: 0.8;
}

/* Dev Mode Toggle */
.dev-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 10px 16px;
  background: #fef3c7;
  border: 2px dashed #f59e0b;
  border-radius: 12px;
  margin-bottom: 16px;
  font-size: 13px;
  color: #92400e;
}
.dev-toggle label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-weight: 600;
}
.dev-toggle input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #f59e0b;
}
.dev-badge {
  background: #f59e0b;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 700;
}

/* Menu Hamburger */
.hamburger-btn {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.1);
  width: 44px;
  height: 44px;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  transition: all 0.2s ease;
  touch-action: manipulation;
}
.hamburger-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: scale(1.05);
}
.hamburger-btn span {
  display: block;
  width: 20px;
  height: 2px;
  background: white;
  border-radius: 1px;
  transition: all 0.3s ease;
}
.hamburger-btn.active span:nth-child(1) {
  transform: rotate(45deg) translate(5px, 5px);
}
.hamburger-btn.active span:nth-child(2) {
  opacity: 0;
}
.hamburger-btn.active span:nth-child(3) {
  transform: rotate(-45deg) translate(5px, -5px);
}

/* Side Menu */
.side-menu-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 600;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}
.side-menu-overlay.active {
  opacity: 1;
  visibility: visible;
}
.side-menu {
  position: fixed;
  top: 0;
  left: -320px;
  width: 300px;
  max-width: 85vw;
  height: 100vh;
  height: 100dvh;
  background: var(--bg-card);
  z-index: 700;
  transition: left 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: 4px 0 20px var(--shadow);
}
.side-menu.active {
  left: 0;
}
.side-menu-header {
  padding: 20px;
  padding-top: calc(20px + env(safe-area-inset-top, 0px));
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
}
.side-menu-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
}
.side-menu-user-info {
  flex: 1;
}
.side-menu-user-name {
  font-size: 16px;
  font-weight: 700;
  color: white;
}
.side-menu-user-role {
  font-size: 13px;
  color: rgba(255,255,255,0.8);
}
.side-menu-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.menu-section {
  margin-bottom: 24px;
}
.menu-section-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  padding: 0 8px;
}
.menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 14px;
  color: var(--text-primary);
  text-decoration: none;
}
.menu-item:hover {
  background: var(--bg);
}
.menu-item.active {
  background: rgba(102, 126, 234, 0.15);
  color: var(--brand);
  font-weight: 600;
}
.menu-item .icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}
.menu-item.danger {
  color: var(--danger);
}
.notification-toggle {
  display: flex;
  align-items: center;
}
.notification-toggle .toggle-switch {
  margin-left: auto;
}
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 28px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}
.toggle-switch input:checked + .toggle-slider {
  background-color: var(--success);
}
.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(22px);
}
.toggle-switch input:disabled + .toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}
.user-info-grid {
  display: grid;
  gap: 8px;
}
.user-info-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg);
  border-radius: 8px;
  font-size: 13px;
}
.user-info-row .label {
  color: var(--text-secondary);
}
.user-info-row .value {
  font-weight: 600;
}

/* Profilo Utente Page */
.profile-page {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 800;
  display: none;
  flex-direction: column;
  overflow-y: auto;
}
.profile-page.active {
  display: flex;
}
.profile-header {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  padding: 24px 20px;
  padding-top: calc(24px + env(safe-area-inset-top, 0px));
  color: white;
  display: flex;
  align-items: center;
  gap: 16px;
}
.profile-back {
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.2);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.profile-header-info {
  flex: 1;
}
.profile-header-title {
  font-size: 20px;
  font-weight: 700;
}
.profile-header-subtitle {
  font-size: 13px;
  opacity: 0.9;
}
.profile-avatar-large {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 700;
}
.profile-content {
  flex: 1;
  padding: 20px;
  max-width: 500px;
  margin: 0 auto;
  width: 100%;
}
.profile-section {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px var(--shadow);
}
.profile-section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.profile-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.profile-field:last-child {
  border-bottom: none;
}
.profile-field-label {
  font-size: 14px;
  color: var(--text-secondary);
}
.profile-field-value {
  font-size: 14px;
  font-weight: 600;
}
.profile-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.profile-input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.profile-input-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.profile-input-group input {
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  background: var(--bg);
  color: var(--text-primary);
  transition: border-color 0.2s;
}
.profile-input-group input:focus {
  outline: none;
  border-color: #3b82f6;
}
.profile-btn {
  padding: 14px 24px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.profile-btn.primary {
  background: var(--green);
  color: white;
}
.profile-btn.primary:hover {
  background: var(--green-dark);
}
.profile-btn.primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.profile-message {
  padding: 12px 16px;
  border-radius: 10px;
  font-size: 14px;
  display: none;
}
.profile-message.success {
  background: #dcfce7;
  color: #166534;
  display: block;
}
.profile-message.error {
  background: #fee2e2;
  color: #991b1b;
  display: block;
}

/* Reset Password Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 800;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  width: 100%;
  max-width: 360px;
  box-shadow: 0 8px 32px var(--shadow);
}
.modal-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.modal-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.form-group label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
}
.form-group input {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text-primary);
}
.form-group input:focus {
  outline: none;
  border-color: var(--green);
}
.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 8px;
}
.modal-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  touch-action: manipulation;
}
.modal-btn.cancel {
  background: var(--bg);
  color: var(--text-primary);
}
.modal-btn.confirm {
  background: var(--green);
  color: white;
}
.modal-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
</style>
</head>
<body>

<!-- Main Header -->
<header class="main-header">
  <div class="main-header-content">
    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="main-header-title">
      <h1>Timbratura</h1>
      <p id="currentDate">Caricamento...</p>
    </div>
  </div>
</header>

<!-- Side Menu Overlay -->
<div class="side-menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

<!-- Side Menu -->
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <div class="side-menu-avatar">{{ user_initials }}</div>
    <div class="side-menu-user-info">
      <div class="side-menu-user-name">{{ user_display }}</div>
      <div class="side-menu-user-role">{{ user_role|default('Utente', true) }}</div>
    </div>
  </div>
  
  <div class="side-menu-content">
    <div class="menu-section">
      <div class="menu-section-title">üìã Menu</div>
      <a href="{{ url_for('home') }}" class="menu-item active">
        <span class="icon">üè†</span>
        <span>Home Timbrature</span>
      </a>
      <a href="{{ url_for('user_turni_page') }}" class="menu-item">
        <span class="icon">üìÖ</span>
        <span>I Miei Turni</span>
      </a>
      <a href="{{ url_for('user_requests_page') }}" class="menu-item">
        <span class="icon">üìù</span>
        <span>Richieste</span>
      </a>
      <a href="{{ url_for('user_documents_page') }}" class="menu-item">
        <span class="icon">üìÑ</span>
        <span>Documenti</span>
      </a>
      <a href="/user/notifications" class="menu-item">
        <span class="icon">üîî</span>
        <span>Storico Notifiche</span>
      </a>
    </div>
    
    <div class="menu-section">
      <div class="menu-section-title">‚öôÔ∏è Impostazioni</div>
      <div class="menu-item" onclick="openProfilePage()">
        <span class="icon">üë§</span>
        <span>Profilo Utente</span>
      </div>
      <div class="menu-item" onclick="toggleTheme(); closeMenu();">
        <span class="icon">üåô</span>
        <span>Tema Scuro</span>
      </div>
      <div class="menu-item" id="pwa-install-menu-item" onclick="installPwa()" style="display: none;">
        <span class="icon">üì≤</span>
        <span>Installa App</span>
      </div>
      <div class="menu-item notification-toggle" id="notificationMenuItem">
        <span class="icon" id="notificationIcon">üîï</span>
        <span id="notificationLabel">Attiva Notifiche</span>
        <label class="toggle-switch">
          <input type="checkbox" id="pushToggle" onchange="togglePushNotifications()">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="menu-section">
      <a href="{{ url_for('logout') }}" class="menu-item danger">
        <span class="icon">üö™</span>
        <span>Logout</span>
      </a>
    </div>
  </div>
</div>

<!-- Profilo Utente Page -->
<div class="profile-page" id="profilePage">
  <div class="profile-header">
    <button class="profile-back" onclick="closeProfilePage()">‚Üê</button>
    <div class="profile-header-info">
      <div class="profile-header-title">Profilo Utente</div>
      <div class="profile-header-subtitle">Gestisci le tue informazioni</div>
    </div>
    <div class="profile-avatar-large">{{ user_initials }}</div>
  </div>
  
  <div class="profile-content">
    <!-- Info Utente -->
    <div class="profile-section">
      <div class="profile-section-title">üë§ Informazioni Account</div>
      <div class="profile-field">
        <span class="profile-field-label">Username</span>
        <span class="profile-field-value">{{ username }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Nome Visualizzato</span>
        <span class="profile-field-value">{{ user_display }}</span>
      </div>
      <div class="profile-field">
        <span class="profile-field-label">Ruolo</span>
        <span class="profile-field-value">{{ user_role|default('Utente', true) }}</span>
      </div>
    </div>
    
    <!-- Cambio Password -->
    <div class="profile-section">
      <div class="profile-section-title">üîë Cambia Password</div>
      <div id="passwordMessage" class="profile-message"></div>
      <form class="profile-form" id="profilePasswordForm" onsubmit="submitProfilePasswordChange(event)">
        <div class="profile-input-group">
          <label>Password Attuale</label>
          <input type="password" id="profileCurrentPassword" required autocomplete="current-password" placeholder="Inserisci password attuale">
        </div>
        <div class="profile-input-group">
          <label>Nuova Password</label>
          <input type="password" id="profileNewPassword" required minlength="4" autocomplete="new-password" placeholder="Minimo 4 caratteri">
        </div>
        <div class="profile-input-group">
          <label>Conferma Nuova Password</label>
          <input type="password" id="profileConfirmPassword" required minlength="4" autocomplete="new-password" placeholder="Ripeti nuova password">
        </div>
        <button type="submit" class="profile-btn primary" id="btnProfileSavePassword">Aggiorna Password</button>
      </form>
    </div>
  </div>
</div>

<div class="container">
  <div class="clock-section">
    <div class="clock" id="clock">--:--:--</div>
  </div>

  <!-- Box Turno Oggi -->
  <div class="turno-box" id="turnoBox" style="display:none;">
    <span class="turno-counter" id="turnoCounter" style="display:none;">1/1</span>
    <div class="turno-header">
      <span>üìÖ</span> Il tuo turno oggi
    </div>
    <div class="turno-nav">
      <button class="turno-nav-btn" id="turnoPrevBtn" onclick="navigateTurno(-1)" style="display:none;">‚Äπ</button>
      <div class="turno-content">
        <div class="turno-project" id="turnoProject">-</div>
        <div class="turno-details">
          <div class="turno-detail" id="turnoOrario">
            <span class="icon">üïê</span>
            <span id="turnoOrarioText">-</span>
          </div>
          <div class="turno-detail" id="turnoPausa" style="display:none;">
            <span class="icon">‚òï</span>
            <span id="turnoPausaText">-</span>
          </div>
          <div class="turno-detail" id="turnoFunzione">
            <span class="icon">üë§</span>
            <span id="turnoFunzioneText">-</span>
          </div>
          <div class="turno-detail" id="turnoLocation" style="display:none;">
            <span class="icon">üìç</span>
            <span id="turnoLocationText">-</span>
          </div>
        </div>
        <span class="turno-badge" id="turnoBadge" style="display:none;"></span>
      </div>
      <button class="turno-nav-btn" id="turnoNextBtn" onclick="navigateTurno(1)" style="display:none;">‚Ä∫</button>
    </div>
  </div>

  <div class="actions">
    <button class="action-btn start" id="btnStartDay" onclick="startTimbratura('inizio_giornata')">
      <span class="icon">‚Üí</span>
      <span>Inizio Giornata</span>
      <span class="check" id="checkStart"></span>
    </button>
    
    <button class="action-btn end" id="btnEndDay" onclick="startTimbratura('fine_giornata')">
      <span class="icon">‚Üê</span>
      <span>Fine Giornata</span>
      <span class="check" id="checkEnd"></span>
    </button>
    
    <div class="pause-row">
      <button class="pause-btn" id="btnStartPause" onclick="startTimbratura('inizio_pausa')">
        <span class="icon">‚òï</span>
        <span>Inizio Pausa</span>
      </button>
      <button class="pause-btn" id="btnEndPause" onclick="startTimbratura('fine_pausa')">
        <span class="icon">‚úì</span>
        <span>Fine Pausa</span>
      </button>
    </div>
  </div>

  <div class="history-section">
    <h2 class="history-title">üìã Storico Timbrature Oggi:</h2>
    <ul class="history-list" id="historyList">
      <li class="empty-history">Nessuna timbratura registrata</li>
    </ul>
  </div>
</div>

<!-- Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-container">
    <h2 class="scanner-title" id="scannerTitle">üì∑ Inquadra il QR Code</h2>
    <p class="scanner-subtitle" id="scannerSubtitle">Scansiona per confermare</p>
    <div id="qr-reader"></div>
    <button class="scanner-close" onclick="closeScanner()">Annulla</button>
  </div>
</div>

<!-- Method Choice Modal -->
<div class="method-modal" id="methodModal">
  <div class="method-container">
    <h2 class="method-title" id="methodTitle">Come vuoi confermare?</h2>
    <p class="method-subtitle" id="methodSubtitle">Scegli il metodo di timbratura</p>
    <div class="method-options">
      <button class="method-btn" id="methodQrBtn" onclick="selectMethod('qr')">
        <div class="method-btn-icon">üì∑</div>
        <div class="method-btn-content">
          <div class="method-btn-title">QR Code</div>
          <div class="method-btn-desc">Scansiona il codice in sede</div>
        </div>
      </button>
      <button class="method-btn" id="methodGpsBtn" onclick="selectMethod('gps')">
        <div class="method-btn-icon">üìç</div>
        <div class="method-btn-content">
          <div class="method-btn-title">Posizione GPS</div>
          <div class="method-btn-desc">Conferma con geolocalizzazione</div>
        </div>
      </button>
    </div>
    <button class="method-cancel" onclick="closeMethodModal()">Annulla</button>
  </div>
</div>

<!-- GPS Modal -->
<div class="gps-modal" id="gpsModal">
  <div class="gps-container">
    <h2 class="gps-title" id="gpsTitle">üìç Verifica Posizione</h2>
    <p class="gps-subtitle" id="gpsSubtitle">Attendere la localizzazione...</p>
    <div class="gps-location-name" id="gpsLocationName"></div>
    <div class="gps-status" id="gpsStatus">
      <div class="gps-icon loading" id="gpsIcon">üìç</div>
      <div class="gps-message" id="gpsMessage">Rilevamento posizione...</div>
      <div class="gps-accuracy" id="gpsAccuracy"></div>
    </div>
    <div class="gps-buttons">
      <button class="gps-btn secondary" onclick="closeGpsModal()">Annulla</button>
      <button class="gps-btn primary" id="gpsConfirmBtn" onclick="confirmGpsLocation()" disabled>Conferma</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
const TIMBRATURA_TYPES = {
  'inizio_giornata': { label: 'Inizio Giornata', dotClass: 'start' },
  'fine_giornata': { label: 'Fine Giornata', dotClass: 'end' },
  'inizio_pausa': { label: 'Inizio Pausa', dotClass: 'pause' },
  'fine_pausa': { label: 'Fine Pausa', dotClass: 'pause' }
};

let todayTimbrature = [];
let pendingOvertime = null;  // Straordinario in attesa di revisione
let html5QrcodeScanner = null;
let pendingTimbraturaType = null;  // Tipo di timbratura in attesa di conferma QR

// Aggiorna orologio
function updateClock() {
  const now = new Date();
  const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('clock').textContent = time;
}

// Aggiorna data
function updateDate() {
  const now = new Date();
  const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
  let dateStr = now.toLocaleDateString('it-IT', options);
  dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
  document.getElementById('currentDate').textContent = 'Oggi: ' + dateStr;
}

// Toast notification
let toastTimer = null;
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  if (toastTimer) clearTimeout(toastTimer);
  toast.textContent = message;
  toast.className = 'toast ' + type + ' show';
  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
    toastTimer = null;
  }, 2000);
}

// Configurazione timbratura (caricata dal server)
let timbraturaConfig = {
  qr_enabled: true,
  gps_enabled: false,
  gps_locations: [],
  gps_max_accuracy_meters: 50
};

// Stato GPS
let gpsWatchId = null;
let lastGpsPosition = null;

// Carica configurazione timbratura dal server
async function loadTimbraturaConfig() {
  try {
    const res = await fetch('/api/timbratura/config');
    if (res.ok) {
      timbraturaConfig = await res.json();
      console.log('Timbratura config loaded:', timbraturaConfig);
    }
  } catch (err) {
    console.warn('Errore caricamento config timbratura:', err);
  }
}

// Inizia processo timbratura: sceglie metodo o apre direttamente
function startTimbratura(tipo) {
  pendingTimbraturaType = tipo;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  // Se NESSUN metodo √® abilitato (entrambi disabilitati), timbratura diretta
  if (!timbraturaConfig.qr_enabled && !timbraturaConfig.gps_enabled) {
    registerTimbraturaDirectly(tipo);
    return;
  }
  
  // Se entrambi i metodi sono abilitati, mostra la scelta
  if (timbraturaConfig.qr_enabled && timbraturaConfig.gps_enabled) {
    openMethodModal(label);
    return;
  }
  
  // Se solo GPS √® abilitato
  if (timbraturaConfig.gps_enabled && !timbraturaConfig.qr_enabled) {
    openGpsModal(label);
    return;
  }
  
  // Se solo QR √® abilitato
  document.getElementById('scannerTitle').textContent = 'üì∑ ' + label;
  document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
  openScanner();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// METHOD CHOICE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openMethodModal(label) {
  document.getElementById('methodTitle').textContent = label;
  document.getElementById('methodSubtitle').textContent = 'Come vuoi confermare la timbratura?';
  
  // Abilita/disabilita pulsanti in base alla config
  document.getElementById('methodQrBtn').style.display = timbraturaConfig.qr_enabled ? 'flex' : 'none';
  document.getElementById('methodGpsBtn').style.display = timbraturaConfig.gps_enabled ? 'flex' : 'none';
  
  document.getElementById('methodModal').classList.add('active');
}

function closeMethodModal() {
  document.getElementById('methodModal').classList.remove('active');
  pendingTimbraturaType = null;  // Reset solo quando l'utente annulla
}

function selectMethod(method) {
  // Salva il tipo PRIMA di chiudere il modal
  const tipo = pendingTimbraturaType;
  const label = TIMBRATURA_TYPES[tipo]?.label || tipo;
  
  // Chiudi solo il modal visivamente
  document.getElementById('methodModal').classList.remove('active');
  
  if (method === 'qr') {
    document.getElementById('scannerTitle').textContent = 'üì∑ ' + label;
    document.getElementById('scannerSubtitle').textContent = 'Scansiona il QR per confermare';
    openScanner();
  } else if (method === 'gps') {
    openGpsModal(label);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openGpsModal(label) {
  document.getElementById('gpsTitle').textContent = 'üìç ' + label;
  document.getElementById('gpsSubtitle').textContent = 'Avvicinati alla sede per timbrare';
  
  // Mostra la sede specifica del turno se presente, altrimenti tutte le location
  let locationNames;
  if (currentShiftLocationName) {
    locationNames = currentShiftLocationName;
  } else {
    locationNames = timbraturaConfig.gps_locations.map(l => l.name).join(', ') || 'Sede';
  }
  document.getElementById('gpsLocationName').innerHTML = `<span class="location-label">üè¢</span> <strong>${locationNames}</strong>`;
  
  document.getElementById('gpsIcon').textContent = 'üìç';
  document.getElementById('gpsIcon').classList.add('loading');
  document.getElementById('gpsMessage').textContent = 'Rilevamento posizione...';
  document.getElementById('gpsAccuracy').textContent = '';
  document.getElementById('gpsAccuracy').className = 'gps-accuracy';
  document.getElementById('gpsConfirmBtn').disabled = true;
  
  lastGpsPosition = null;
  
  document.getElementById('gpsModal').classList.add('active');
  
  // Inizia il tracking GPS
  startGpsTracking();
}

function closeGpsModal() {
  document.getElementById('gpsModal').classList.remove('active');
  stopGpsTracking();
  pendingTimbraturaType = null;
  lastGpsPosition = null;
}

function startGpsTracking() {
  if (!navigator.geolocation) {
    updateGpsStatus('error', '‚ùå GPS non supportato', 'Il tuo browser non supporta la geolocalizzazione');
    return;
  }
  
  const options = {
    enableHighAccuracy: true,
    timeout: 15000,
    maximumAge: 0
  };
  
  gpsWatchId = navigator.geolocation.watchPosition(
    onGpsSuccess,
    onGpsError,
    options
  );
}

function stopGpsTracking() {
  if (gpsWatchId !== null) {
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId = null;
  }
}

function onGpsSuccess(position) {
  const { latitude, longitude, accuracy } = position.coords;
  lastGpsPosition = { latitude, longitude, accuracy };
  
  // Calcola distanza dalla sede pi√π vicina
  // Se il turno ha una sede specifica, usa solo quella
  let minDistance = Infinity;
  let nearestLocation = null;
  let locations = timbraturaConfig.gps_locations || [];
  
  // Filtra per sede specifica del turno se presente
  if (currentShiftLocationName && locations.length > 0) {
    const filteredLocations = locations.filter(l => l.name === currentShiftLocationName);
    if (filteredLocations.length > 0) {
      locations = filteredLocations;
    }
  }
  
  for (const loc of locations) {
    if (loc.latitude && loc.longitude) {
      const dist = haversineDistance(latitude, longitude, loc.latitude, loc.longitude);
      if (dist < minDistance) {
        minDistance = dist;
        nearestLocation = loc;
      }
    }
  }
  
  // Determina qualit√† del segnale
  let accuracyClass = 'poor';
  let accuracyText = 'Precisione bassa';
  let accuracyTip = 'üí° Vai all\'aperto per migliorare';
  
  if (accuracy <= 15) {
    accuracyClass = 'good';
    accuracyText = 'Precisione ottima';
    accuracyTip = '';
  } else if (accuracy <= 30) {
    accuracyClass = 'good';
    accuracyText = 'Precisione buona';
    accuracyTip = '';
  } else if (accuracy <= timbraturaConfig.gps_max_accuracy_meters) {
    accuracyClass = 'medium';
    accuracyText = 'Precisione sufficiente';
    accuracyTip = '';
  }
  
  const isAccuracyOk = accuracy <= timbraturaConfig.gps_max_accuracy_meters;
  
  // Verifica anche la distanza dalla sede
  const maxRadius = nearestLocation ? (nearestLocation.radius_meters || 100) : 100;
  const isDistanceOk = minDistance <= (maxRadius + accuracy); // considera l'accuracy come margine
  const isValid = isAccuracyOk && isDistanceOk;
  
  document.getElementById('gpsIcon').textContent = isValid ? '‚úÖ' : (isAccuracyOk ? '‚ö†Ô∏è' : 'üìç');
  document.getElementById('gpsIcon').classList.toggle('loading', !isAccuracyOk);
  
  // Messaggio in base allo stato
  if (!isAccuracyOk) {
    document.getElementById('gpsMessage').textContent = 'In attesa di precisione migliore...';
  } else if (!isDistanceOk) {
    document.getElementById('gpsMessage').textContent = '‚ö†Ô∏è Troppo lontano dalla sede';
  } else {
    document.getElementById('gpsMessage').textContent = 'Posizione rilevata!';
  }
  
  // Mostra precisione E distanza
  let accuracyDisplay = `${accuracyText} (¬±${Math.round(accuracy)}m)`;
  if (nearestLocation && minDistance !== Infinity) {
    const distText = minDistance >= 1000 
      ? `${(minDistance/1000).toFixed(1)} km` 
      : `${Math.round(minDistance)} m`;
    const distColor = isDistanceOk ? 'var(--success)' : 'var(--danger, #dc3545)';
    accuracyDisplay += `<br><span style="color: ${distColor}">üìç Distanza dalla sede: <strong>${distText}</strong></span>`;
    if (!isDistanceOk) {
      accuracyDisplay += `<br><span class="gps-tip">‚ö†Ô∏è Devi essere entro ${maxRadius}m dalla sede</span>`;
    }
  }
  if (accuracyTip) {
    accuracyDisplay += `<br><span class="gps-tip">${accuracyTip}</span>`;
  }
  document.getElementById('gpsAccuracy').innerHTML = accuracyDisplay;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy ' + (isValid ? accuracyClass : 'poor');
  document.getElementById('gpsConfirmBtn').disabled = !isAccuracyOk; // Permetti conferma, il server far√† la validazione finale
  
  if (isAccuracyOk) {
    document.getElementById('gpsSubtitle').textContent = isDistanceOk 
      ? 'Premi Conferma per timbrare' 
      : 'Avvicinati alla sede per timbrare';
  }
}

// Funzione per calcolare la distanza tra due coordinate (formula di Haversine)
function haversineDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000; // Raggio della Terra in metri
  const phi1 = lat1 * Math.PI / 180;
  const phi2 = lat2 * Math.PI / 180;
  const deltaPhi = (lat2 - lat1) * Math.PI / 180;
  const deltaLambda = (lon2 - lon1) * Math.PI / 180;
  
  const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
            Math.cos(phi1) * Math.cos(phi2) *
            Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  
  return R * c;
}

function onGpsError(error) {
  let message = 'Errore GPS';
  let detail = '';
  
  switch(error.code) {
    case error.PERMISSION_DENIED:
      message = '‚ö†Ô∏è Permesso negato';
      detail = 'Abilita la posizione nelle impostazioni';
      break;
    case error.POSITION_UNAVAILABLE:
      message = '‚ö†Ô∏è Posizione non disponibile';
      detail = 'Prova all\'aperto o attendi';
      break;
    case error.TIMEOUT:
      message = '‚ö†Ô∏è Timeout';
      detail = 'Rilevamento troppo lento';
      break;
  }
  
  updateGpsStatus('error', message, detail);
}

function updateGpsStatus(type, message, detail) {
  document.getElementById('gpsIcon').textContent = type === 'error' ? '‚ö†Ô∏è' : 'üìç';
  document.getElementById('gpsIcon').classList.remove('loading');
  document.getElementById('gpsMessage').textContent = message;
  document.getElementById('gpsAccuracy').textContent = detail;
  document.getElementById('gpsAccuracy').className = 'gps-accuracy poor';
  document.getElementById('gpsConfirmBtn').disabled = true;
}

async function confirmGpsLocation() {
  if (!lastGpsPosition) {
    showToast('Posizione non disponibile', 'error');
    return;
  }
  
  const tipo = pendingTimbraturaType;
  const confirmBtn = document.getElementById('gpsConfirmBtn');
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Verifica...';
  
  // Se offline, salva la timbratura con coordinate per sincronizzarla dopo
  if (!navigator.onLine) {
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con coordinate GPS. Verr√† sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
    return;
  }
  
  try {
    // Valida posizione con il server
    // Se il turno ha una sede specifica, passa il nome per validazione mirata
    const validatePayload = {
      latitude: lastGpsPosition.latitude,
      longitude: lastGpsPosition.longitude,
      accuracy: lastGpsPosition.accuracy
    };
    if (currentShiftLocationName) {
      validatePayload.shift_location_name = currentShiftLocationName;
    }
    
    const validateRes = await fetch('/api/timbratura/validate-gps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(validatePayload)
    });
    
    const validateData = await validateRes.json();
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'Posizione non valida', 'error');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Conferma';
      return;
    }
    
    closeGpsModal();
    
    // GPS valido, registra timbratura
    const token = validateData.token;
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, token })
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      const locationName = validateData.location || 'Sede';
      showToast(`${TIMBRATURA_TYPES[tipo]?.label} registrata (${locationName})! ‚úì`, 'success');
      loadTimbrature();
      // Check straordinario dopo fine giornata
      if (tipo === 'fine_giornata') {
        setTimeout(() => checkOvertimeAfterCheckout(), 1500);
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
    }
  } catch (err) {
    console.error('Errore GPS:', err);
    // Fallback offline
    closeGpsModal();
    saveOfflineTimbratura(tipo, {
      gps: {
        latitude: lastGpsPosition.latitude,
        longitude: lastGpsPosition.longitude,
        accuracy: lastGpsPosition.accuracy
      }
    });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
    confirmBtn.disabled = false;
    confirmBtn.textContent = 'Conferma';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QR SCANNER (esistente)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Registra timbratura direttamente (modalit√† diretta o offline)
async function registerTimbraturaDirectly(tipo) {
  try {
    const payload = { tipo, bypass_qr: true, offline_ts: Date.now() };
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! ‚úì', 'success');
      loadTimbrature();
      // Check straordinario dopo fine giornata
      if (tipo === 'fine_giornata') {
        setTimeout(() => checkOvertimeAfterCheckout(), 1500);
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
    }
  } catch (err) {
    console.error('Errore:', err);
    
    // Se offline, il Service Worker metter√† in coda la richiesta
    if (!navigator.onLine) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      // Salva anche in localStorage come backup
      saveOfflineTimbratura(tipo);
    } else {
      showToast('Errore di connessione', 'error');
    }
  }
  pendingTimbraturaType = null;
}

// Salva timbratura offline in localStorage come backup
function saveOfflineTimbratura(tipo, extra = {}) {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  offlineQueue.push({
    tipo,
    timestamp: new Date().toISOString(),
    ts: Date.now(),
    ...extra
  });
  localStorage.setItem('offline_timbrature', JSON.stringify(offlineQueue));
  updateUI(); // Aggiorna subito lo storico per mostrare la timbratura offline
}

// Sincronizza timbrature offline
async function syncOfflineTimbrature() {
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  if (offlineQueue.length === 0) return;
  
  console.log('[Offline Sync] Sincronizzazione di', offlineQueue.length, 'timbrature...');
  
  const remaining = [];
  let syncedCount = 0;
  
  for (const item of offlineQueue) {
    try {
      // Costruisci payload con dati opzionali (GPS, QR)
      const payload = { 
        tipo: item.tipo, 
        offline_ts: item.ts,
        offline_timestamp: item.timestamp
      };
      
      // Se ha dati GPS, aggiungi al payload per validazione server
      // NON impostare bypass_qr quando c'√® GPS - il server deve validare le coordinate
      if (item.gps) {
        payload.offline_gps = item.gps;
      } else if (item.qr_code) {
        // Se ha dati QR, aggiungi al payload
        payload.offline_qr = item.qr_code;
      } else {
        // Solo se non ci sono n√© GPS n√© QR, usa bypass_qr (timbratura diretta)
        payload.bypass_qr = true;
      }
      
      const res = await fetch('/api/timbratura', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      
      if (res.ok) {
        console.log('[Offline Sync] Sincronizzata:', item.tipo, item.timestamp);
        syncedCount++;
      } else {
        const errData = await res.json().catch(() => ({}));
        console.warn('[Offline Sync] Errore server:', errData.error || res.status);
        remaining.push(item);
      }
    } catch (err) {
      remaining.push(item);
    }
  }
  
  localStorage.setItem('offline_timbrature', JSON.stringify(remaining));
  
  if (syncedCount > 0) {
    showToast(`‚úÖ ${syncedCount} timbratur${syncedCount === 1 ? 'a' : 'e'} sincronizzat${syncedCount === 1 ? 'a' : 'e'}!`, 'success');
    loadTimbrature(); // Ricarica dal server per avere i dati completi
  }
  
  if (remaining.length > 0) {
    console.warn('[Offline Sync] Rimaste', remaining.length, 'timbrature non sincronizzate');
  }
}

// Apri scanner
function openScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.add('active');
  
  html5QrcodeScanner = new Html5Qrcode("qr-reader");
  
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    onScanFailure
  ).catch((err) => {
    console.error('Errore avvio scanner:', err);
    
    // Messaggio specifico per problemi HTTPS/permessi
    let errorMsg = 'Errore accesso alla camera';
    const errStr = String(err).toLowerCase();
    
    if (errStr.includes('notallowed') || errStr.includes('permission')) {
      errorMsg = '‚ö†Ô∏è Permesso camera negato. Controlla le impostazioni del browser.';
    } else if (errStr.includes('notfound') || errStr.includes('no camera')) {
      errorMsg = '‚ö†Ô∏è Nessuna camera trovata sul dispositivo.';
    } else if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      errorMsg = '‚ö†Ô∏è HTTPS richiesto! La camera funziona solo su connessioni sicure (HTTPS) o localhost.';
    }
    
    showToast(errorMsg, 'error');
    closeScanner();
  });
}

// Chiudi scanner
function closeScanner() {
  const modal = document.getElementById('scannerModal');
  modal.classList.remove('active');
  pendingTimbraturaType = null;
  
  if (html5QrcodeScanner) {
    html5QrcodeScanner.stop().then(() => {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    }).catch((err) => {
      console.error('Errore stop scanner:', err);
    });
  }
}

// Callback scan riuscito - valida QR e registra timbratura
async function onScanSuccess(decodedText, decodedResult) {
  // Salva il tipo PRIMA di chiudere lo scanner (che resetta pendingTimbraturaType)
  const tipo = pendingTimbraturaType;
  
  closeScanner();
  
  if (!tipo) {
    showToast('Errore: nessuna timbratura selezionata', 'error');
    return;
  }
  
  // Se offline, salva QR code per validazione successiva
  if (!navigator.onLine) {
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline con QR. Verr√† sincronizzata automaticamente.', 'warning');
    return;
  }
  
  try {
    // Prima valida il QR
    const validateRes = await fetch('/api/timbratura/validate-qr', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ qr_data: decodedText })
    });
    
    const validateData = await validateRes.json();
    
    if (!validateRes.ok || !validateData.valid) {
      showToast(validateData.error || 'QR non valido', 'error');
      return;
    }
    
    // QR valido, ora registra la timbratura
    const token = validateData.token;
    
    const res = await fetch('/api/timbratura', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, token })
    });
    
    const data = await res.json();
    
    // Gestisci risposta 202 dal Service Worker (richiesta in coda offline)
    if (res.status === 202 && data.queued) {
      showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
      saveOfflineTimbratura(tipo);
    } else if (res.ok && data.success) {
      showToast(TIMBRATURA_TYPES[tipo]?.label + ' registrata! ‚úì', 'success');
      loadTimbrature();
      // Check straordinario dopo fine giornata
      if (tipo === 'fine_giornata') {
        setTimeout(() => checkOvertimeAfterCheckout(), 1500);
      }
    } else {
      showToast(data.error || 'Errore registrazione', 'error');
    }
  } catch (err) {
    console.error('Errore:', err);
    // Fallback offline
    saveOfflineTimbratura(tipo, { qr_code: decodedText });
    showToast('üì¥ ' + TIMBRATURA_TYPES[tipo]?.label + ' salvata offline. Verr√† sincronizzata automaticamente.', 'warning');
  }
}

// Callback scan fallito (ignora errori continui)
function onScanFailure(error) {
  // Ignora - √® normale durante la scansione
}

// Aggiorna UI in base alle timbrature
function updateUI() {
  // Combina timbrature server + offline pending
  const offlineQueue = JSON.parse(localStorage.getItem('offline_timbrature') || '[]');
  const today = new Date().toISOString().split('T')[0];
  
  // Filtra solo timbrature offline di oggi e crea oggetti compatibili
  const offlineToday = offlineQueue
    .filter(item => item.timestamp && item.timestamp.startsWith(today))
    .map(item => ({
      tipo: item.tipo,
      ora: item.timestamp.split('T')[1].substring(0, 8), // HH:MM:SS
      ora_mod: null,
      offline: true,  // Marca come offline
      offline_ts: item.ts
    }));
  
  // Combina e ordina per ora
  const allTimbrature = [...todayTimbrature.map(t => ({...t, offline: false})), ...offlineToday]
    .sort((a, b) => a.ora.localeCompare(b.ora));
  
  const hasStarted = allTimbrature.some(t => t.tipo === 'inizio_giornata');
  const hasEnded = allTimbrature.some(t => t.tipo === 'fine_giornata');
  const lastPause = [...allTimbrature].reverse().find(t => t.tipo === 'inizio_pausa' || t.tipo === 'fine_pausa');
  const inPause = lastPause?.tipo === 'inizio_pausa';

  // Pulsanti - abilitati in base allo stato (la validazione QR avviene al click)
  document.getElementById('btnStartDay').disabled = hasStarted;
  document.getElementById('btnEndDay').disabled = !hasStarted || hasEnded;
  
  // Check marks
  document.getElementById('checkStart').className = 'check' + (hasStarted ? ' done' : '');
  document.getElementById('checkStart').innerHTML = hasStarted ? '‚úì' : '';
  document.getElementById('checkEnd').className = 'check' + (hasEnded ? ' done' : '');
  document.getElementById('checkEnd').innerHTML = hasEnded ? '‚úì' : '';
  
  // Pulsanti pausa
  document.getElementById('btnStartPause').disabled = !hasStarted || hasEnded || inPause;
  document.getElementById('btnEndPause').disabled = !inPause;

  // Storico
  const historyList = document.getElementById('historyList');
  if (allTimbrature.length === 0) {
    historyList.innerHTML = '<li class="empty-history">Nessuna timbratura registrata</li>';
  } else {
    historyList.innerHTML = allTimbrature.map((t, idx) => {
      const info = TIMBRATURA_TYPES[t.tipo] || { label: t.tipo, dotClass: 'start' };
      // Mostra ora originale e ora modificata se diversa
      let oraDisplay = t.ora;
      let extraInfo = '';
      
      // Icona sync status
      let syncIcon = '';
      if (t.offline) {
        syncIcon = '<span class="sync-status pending" title="In attesa di sincronizzazione">‚òÅÔ∏è</span>';
      } else {
        syncIcon = '<span class="sync-status synced" title="Sincronizzata">‚úì</span>';
      }
      
      // Badge straordinario in attesa (solo per fine_giornata)
      let overtimeRow = '';
      let hasOvertimeClass = '';
      if (t.tipo === 'fine_giornata' && pendingOvertime) {
        const mins = pendingOvertime.minutes || 0;
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        const timeStr = h > 0 ? `${h}h ${m}m` : `${m}m`;
        hasOvertimeClass = 'has-overtime';
        overtimeRow = `
          <div class="overtime-info-row">
            <span class="overtime-icon">‚è≥</span>
            <span class="overtime-text">Straordinario in attesa</span>
            <span class="overtime-time">${timeStr}</span>
          </div>
        `;
      }
      
      if (t.tipo === 'fine_pausa') {
        // Per fine_pausa, trova l'inizio_pausa corrispondente e mostra durata
        const inizioPausa = [...allTimbrature].slice(0, idx).reverse().find(x => x.tipo === 'inizio_pausa');
        if (inizioPausa) {
          const inizioMin = parseInt(inizioPausa.ora.split(':')[0]) * 60 + parseInt(inizioPausa.ora.split(':')[1]);
          const fineMin = parseInt(t.ora.split(':')[0]) * 60 + parseInt(t.ora.split(':')[1]);
          const durataEffettiva = fineMin - inizioMin;
          
          // Calcola anche la durata conteggiata (usando ora_mod)
          const inizioModMin = parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[0]) * 60 + parseInt((inizioPausa.ora_mod || inizioPausa.ora).split(':')[1]);
          const fineModMin = parseInt((t.ora_mod || t.ora).split(':')[0]) * 60 + parseInt((t.ora_mod || t.ora).split(':')[1]);
          const durataConteggiata = fineModMin - inizioModMin;
          
          if (durataConteggiata !== durataEffettiva) {
            extraInfo = ` <span class="pausa-durata">(${durataEffettiva} min ‚Üí <span class="ora-mod">${durataConteggiata} min</span>)</span>`;
          } else {
            extraInfo = ` <span class="pausa-durata">(${durataEffettiva} min)</span>`;
          }
        }
      } else if (t.ora_mod && t.ora_mod !== t.ora) {
        oraDisplay = `<span class="ora-originale">${t.ora}</span><span class="ora-mod">${t.ora_mod}</span>`;
      }
      
      // Mostra location se presente (GPS)
      let locationInfo = '';
      if (t.location_name) {
        locationInfo = `<span class="location-badge" title="${t.location_name}">${t.location_name}</span>`;
      } else if (t.method === 'qr' || t.method === 'qr_offline') {
        locationInfo = '<span class="method-badge qr" title="QR Code">üì±</span>';
      }
      
      return `
        <li class="history-item ${t.offline ? 'offline-pending' : ''} ${hasOvertimeClass}">
          <span class="dot ${info.dotClass}"></span>
          <span class="time">${oraDisplay}</span>
          <span class="type">${info.label}${extraInfo}</span>
          ${locationInfo}
          ${syncIcon}
        </li>
        ${overtimeRow}
      `;
    }).join('');
  }
}

// Carica timbrature di oggi
async function loadTimbrature() {
  try {
    const res = await fetch('/api/timbratura/oggi');
    if (res.ok) {
      const data = await res.json();
      todayTimbrature = data.timbrature || [];
      pendingOvertime = data.pending_overtime || null;
      updateUI();
    }
  } catch (err) {
    console.error('Errore caricamento timbrature:', err);
  }
}

// Turni multipli - stato globale
let allTurni = [];
let currentTurnoIndex = 0;
let currentShiftLocationName = null; // Sede GPS associata al turno corrente

// Carica turno di oggi (da Rentman)
async function loadTurno() {
  const turnoBox = document.getElementById('turnoBox');
  
  try {
    const res = await fetch('/api/user/turno-oggi');
    if (!res.ok) {
      turnoBox.style.display = 'none';
      return;
    }
    
    const data = await res.json();
    
    // Se non c'√® turno, mostra messaggio
    if (!data.turno && (!data.turni || data.turni.length === 0)) {
      turnoBox.classList.add('no-turno');
      turnoBox.style.display = 'block';
      document.getElementById('turnoProject').textContent = 'Nessun turno previsto';
      document.getElementById('turnoOrario').style.display = 'none';
      document.getElementById('turnoFunzione').style.display = 'none';
      document.getElementById('turnoBadge').style.display = 'none';
      hideNavigation();
      return;
    }
    
    // Memorizza tutti i turni
    allTurni = data.turni || [data.turno];
    currentTurnoIndex = 0;
    
    turnoBox.classList.remove('no-turno');
    turnoBox.style.display = 'block';
    
    // Mostra navigazione se ci sono pi√π turni
    if (allTurni.length > 1) {
      showNavigation();
    } else {
      hideNavigation();
    }
    
    // Visualizza il primo turno
    displayTurno(currentTurnoIndex);
    
  } catch (err) {
    console.error('Errore caricamento turno:', err);
    turnoBox.style.display = 'none';
  }
}

// Visualizza un singolo turno
function displayTurno(index) {
  if (index < 0 || index >= allTurni.length) return;
  
  const turno = allTurni[index];
  
  // Memorizza la sede corrente per la validazione GPS
  currentShiftLocationName = turno.location_name || null;
  
  // Progetto
  const projectText = turno.project_name || turno.project_code || 'Progetto';
  document.getElementById('turnoProject').textContent = projectText;
  
  // Orario
  if (turno.start || turno.end) {
    document.getElementById('turnoOrario').style.display = 'flex';
    let orarioText = '';
    if (turno.start && turno.end) {
      orarioText = `${turno.start} - ${turno.end}`;
    } else if (turno.start) {
      orarioText = `Dalle ${turno.start}`;
    } else if (turno.hours) {
      orarioText = `${turno.hours}h previste`;
    }
    document.getElementById('turnoOrarioText').textContent = orarioText;
  } else {
    document.getElementById('turnoOrario').style.display = 'none';
  }
  
  // Pausa prevista
  if (turno.break_start && turno.break_end) {
    document.getElementById('turnoPausa').style.display = 'flex';
    document.getElementById('turnoPausaText').textContent = `Pausa ${turno.break_start} - ${turno.break_end}`;
  } else if (turno.break_minutes && turno.break_minutes > 0) {
    document.getElementById('turnoPausa').style.display = 'flex';
    document.getElementById('turnoPausaText').textContent = `Pausa: ${turno.break_minutes} min`;
  } else {
    document.getElementById('turnoPausa').style.display = 'none';
  }
  
  // Funzione/Ruolo
  if (turno.function) {
    document.getElementById('turnoFunzione').style.display = 'flex';
    document.getElementById('turnoFunzioneText').textContent = turno.function;
  } else {
    document.getElementById('turnoFunzione').style.display = 'none';
  }
  
  // Sede GPS associata al turno
  if (turno.location_name) {
    document.getElementById('turnoLocation').style.display = 'flex';
    document.getElementById('turnoLocationText').textContent = turno.location_name;
  } else {
    document.getElementById('turnoLocation').style.display = 'none';
  }
  
  // Badge (Leader / Trasporto)
  const badge = document.getElementById('turnoBadge');
  if (turno.is_leader) {
    badge.textContent = '‚≠ê Caposquadra';
    badge.classList.add('leader');
    badge.style.display = 'inline-block';
  } else if (turno.transport) {
    badge.textContent = `üöó ${turno.transport}`;
    badge.classList.remove('leader');
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
  
  // Aggiorna counter e stato bottoni
  updateNavigation();
}

// Naviga tra i turni
function navigateTurno(direction) {
  const newIndex = currentTurnoIndex + direction;
  if (newIndex >= 0 && newIndex < allTurni.length) {
    currentTurnoIndex = newIndex;
    displayTurno(currentTurnoIndex);
  }
}

// Mostra i controlli di navigazione
function showNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'flex';
  document.getElementById('turnoNextBtn').style.display = 'flex';
  document.getElementById('turnoCounter').style.display = 'block';
}

// Nasconde i controlli di navigazione
function hideNavigation() {
  document.getElementById('turnoPrevBtn').style.display = 'none';
  document.getElementById('turnoNextBtn').style.display = 'none';
  document.getElementById('turnoCounter').style.display = 'none';
}

// Aggiorna stato navigazione
function updateNavigation() {
  const prevBtn = document.getElementById('turnoPrevBtn');
  const nextBtn = document.getElementById('turnoNextBtn');
  const counter = document.getElementById('turnoCounter');
  
  prevBtn.disabled = currentTurnoIndex === 0;
  nextBtn.disabled = currentTurnoIndex === allTurni.length - 1;
  counter.textContent = `${currentTurnoIndex + 1}/${allTurni.length}`;
}

// Menu functions
function toggleMenu() {
  const btn = document.getElementById('hamburgerBtn');
  const menu = document.getElementById('sideMenu');
  const overlay = document.getElementById('menuOverlay');
  
  btn.classList.toggle('active');
  menu.classList.toggle('active');
  overlay.classList.toggle('active');
}

function closeMenu() {
  document.getElementById('hamburgerBtn').classList.remove('active');
  document.getElementById('sideMenu').classList.remove('active');
  document.getElementById('menuOverlay').classList.remove('active');
}

// Profilo Utente Page
function openProfilePage() {
  closeMenu();
  document.getElementById('profilePage').classList.add('active');
  // Reset form
  document.getElementById('profileCurrentPassword').value = '';
  document.getElementById('profileNewPassword').value = '';
  document.getElementById('profileConfirmPassword').value = '';
  document.getElementById('passwordMessage').className = 'profile-message';
  document.getElementById('passwordMessage').textContent = '';
}

function closeProfilePage() {
  document.getElementById('profilePage').classList.remove('active');
}

async function submitProfilePasswordChange(e) {
  e.preventDefault();
  
  const currentPwd = document.getElementById('profileCurrentPassword').value;
  const newPwd = document.getElementById('profileNewPassword').value;
  const confirmPwd = document.getElementById('profileConfirmPassword').value;
  const msgEl = document.getElementById('passwordMessage');
  
  // Reset message
  msgEl.className = 'profile-message';
  msgEl.textContent = '';
  
  if (newPwd !== confirmPwd) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Le password non coincidono';
    return;
  }
  
  if (newPwd.length < 4) {
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'La password deve essere di almeno 4 caratteri';
    return;
  }
  
  const btn = document.getElementById('btnProfileSavePassword');
  btn.disabled = true;
  btn.textContent = 'Salvataggio...';
  
  try {
    const res = await fetch('/api/user/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_password: currentPwd,
        new_password: newPwd
      })
    });
    
    const data = await res.json();
    
    if (res.ok && data.success) {
      msgEl.className = 'profile-message success';
      msgEl.textContent = 'Password aggiornata con successo! ‚úì';
      // Reset form
      document.getElementById('profileCurrentPassword').value = '';
      document.getElementById('profileNewPassword').value = '';
      document.getElementById('profileConfirmPassword').value = '';
    } else {
      msgEl.className = 'profile-message error';
      msgEl.textContent = data.error || 'Errore nel cambio password';
    }
  } catch (err) {
    console.error('Errore:', err);
    msgEl.className = 'profile-message error';
    msgEl.textContent = 'Errore di connessione';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Aggiorna Password';
  }
}

// Theme toggle
function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  if (isDark) {
    document.documentElement.removeAttribute('data-theme');
    localStorage.removeItem('theme');
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUSH NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const pushState = {
  supported: 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window,
  subscribed: false,
  publicKey: null,
  permission: typeof Notification !== 'undefined' ? Notification.permission : 'unsupported'
};

// Carica stato push dal server
async function loadPushState() {
  if (!pushState.supported) {
    updatePushUI();
    return;
  }
  
  try {
    const res = await fetch('/api/push/status');
    const data = await res.json();
    
    if (data.enabled) {
      pushState.publicKey = data.publicKey;
      pushState.subscribed = data.subscribed || false;
    }
    
    // Verifica anche lo stato locale della subscription
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      pushState.subscribed = Boolean(subscription);
    }
  } catch (err) {
    console.warn('Errore caricamento stato push:', err);
  }
  
  updatePushUI();
}

// Aggiorna UI in base allo stato
function updatePushUI() {
  const toggle = document.getElementById('pushToggle');
  const icon = document.getElementById('notificationIcon');
  const label = document.getElementById('notificationLabel');
  const menuItem = document.getElementById('notificationMenuItem');
  
  if (!pushState.supported) {
    menuItem.style.display = 'none';
    return;
  }
  
  toggle.checked = pushState.subscribed;
  
  if (pushState.subscribed) {
    icon.textContent = 'üîî';
    label.textContent = 'Notifiche attive';
  } else {
    icon.textContent = 'üîï';
    label.textContent = 'Attiva Notifiche';
  }
  
  // Disabilita se permesso negato
  if (pushState.permission === 'denied') {
    toggle.disabled = true;
    label.textContent = 'Notifiche bloccate';
  }
}

// Toggle notifiche push
async function togglePushNotifications() {
  const toggle = document.getElementById('pushToggle');
  
  if (toggle.checked) {
    await subscribeToPush();
  } else {
    await unsubscribeFromPush();
  }
  
  updatePushUI();
}

// Converti VAPID key
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// Sottoscrivi alle notifiche push
async function subscribeToPush() {
  if (!pushState.supported) {
    showToast('‚ö†Ô∏è Notifiche non supportate', 'error');
    return false;
  }
  
  if (!pushState.publicKey) {
    showToast('‚ö†Ô∏è Server non configurato', 'error');
    return false;
  }
  
  // Richiedi permesso se non gi√† concesso
  if (Notification.permission === 'denied') {
    showToast('‚ö†Ô∏è Notifiche bloccate dal browser', 'error');
    pushState.permission = 'denied';
    return false;
  }
  
  if (Notification.permission !== 'granted') {
    const permission = await Notification.requestPermission();
    pushState.permission = permission;
    
    if (permission !== 'granted') {
      showToast('‚ö†Ô∏è Permesso notifiche negato', 'error');
      return false;
    }
  }
  
  try {
    // Registra service worker se non gi√† fatto
    let registration = await navigator.serviceWorker.getRegistration();
    if (!registration) {
      registration = await navigator.serviceWorker.register('/sw.js');
      await navigator.serviceWorker.ready;
    }
    
    const applicationServerKey = urlBase64ToUint8Array(pushState.publicKey);
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey
    });
    
    // Invia al server
    const payload = subscription.toJSON();
    payload.userAgent = navigator.userAgent || null;
    payload.contentEncoding = 'aes128gcm';
    
    const res = await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (res.ok) {
      pushState.subscribed = true;
      showToast('üîî Notifiche attivate!', 'success');
      return true;
    } else {
      throw new Error('Errore registrazione server');
    }
  } catch (err) {
    console.error('Errore subscribe push:', err);
    showToast('‚ö†Ô∏è Errore attivazione notifiche', 'error');
    return false;
  }
}

// Disiscriviti dalle notifiche push
async function unsubscribeFromPush() {
  try {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.getSubscription();
    
    if (subscription) {
      const payload = subscription.toJSON();
      
      // Notifica il server
      try {
        await fetch('/api/push/unsubscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: payload.endpoint })
        });
      } catch (e) {
        console.warn('Errore unsubscribe server:', e);
      }
      
      await subscription.unsubscribe();
    }
    
    pushState.subscribed = false;
    showToast('üîï Notifiche disattivate', 'success');
  } catch (err) {
    console.error('Errore unsubscribe push:', err);
    showToast('‚ö†Ô∏è Errore disattivazione', 'error');
  }
}

// Init
updateClock();
updateDate();
setInterval(updateClock, 1000);
loadTimbrature();
loadTurno();
loadPushState(); // Carica stato notifiche
loadTimbraturaConfig(); // Carica configurazione timbratura (QR/GPS)

// Sync offline timbrature se online
if (navigator.onLine) {
  syncOfflineTimbrature();
}

// Tema
if (localStorage.getItem('theme') === 'dark') {
  document.documentElement.setAttribute('data-theme', 'dark');
}

// Registra service worker per PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('Service Worker registrato'))
    .catch(err => console.warn('Service Worker fallito:', err));
    
  // Ascolta messaggi dal Service Worker (sincronizzazione offline)
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'offline-queue') {
      console.log('[SW Message]', event.data);
      
      if (event.data.action === 'delivered' && event.data.pathname === '/api/timbratura') {
        // Richiesta timbratura sincronizzata con successo
        showToast('‚úÖ Timbratura sincronizzata dal Service Worker!', 'success');
        loadTimbrature();
      } else if (event.data.action === 'error' && event.data.pathname === '/api/timbratura') {
        showToast('‚ö†Ô∏è Errore sincronizzazione timbratura', 'error');
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OFFLINE / ONLINE EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

window.addEventListener('online', () => {
  console.log('[Network] Online');
  document.getElementById('offline-bar')?.remove();
  showToast('‚úÖ Connessione ripristinata', 'success');
  // Sincronizza timbrature offline
  syncOfflineTimbrature();
  // Aggiorna lista timbrature dal server
  setTimeout(loadTimbrature, 1000);
});

window.addEventListener('offline', () => {
  console.log('[Network] Offline');
  // Mostra barra offline se non esiste gi√†
  if (!document.getElementById('offline-bar')) {
    const bar = document.createElement('div');
    bar.id = 'offline-bar';
    bar.className = 'offline-bar';
    bar.innerHTML = 'üì¥ Sei offline - Le timbrature verranno salvate in locale';
    document.body.prepend(bar);
  }
  showToast('üì¥ Connessione persa - Modalit√† offline', 'warning');
});

// Mostra barra offline se gi√† offline all'avvio
if (!navigator.onLine) {
  const bar = document.createElement('div');
  bar.id = 'offline-bar';
  bar.className = 'offline-bar';
  bar.innerHTML = 'üì¥ Sei offline - Le timbrature verranno salvate in locale';
  document.body.prepend(bar);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PWA INSTALL PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
    console.log('[PWA] beforeinstallprompt event fired');
    e.preventDefault();
    deferredInstallPrompt = e;
    
    // Mostra il banner
    if (!localStorage.getItem('pwa-install-dismissed')) {
        showPwaInstallBanner();
    }
    // Mostra pulsante nel menu se esiste
    const menuBtn = document.getElementById('pwa-install-menu-item');
    if (menuBtn) menuBtn.style.display = 'block';
});

window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredInstallPrompt = null;
    hidePwaInstallBanner();
});

function showPwaInstallBanner() {
    hidePwaInstallBanner();
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.innerHTML = `
        <div style="position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); 
                    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                    color: white; padding: 16px 20px; border-radius: 12px; 
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000;
                    display: flex; align-items: center; gap: 12px; max-width: 90vw;
                    font-family: system-ui, -apple-system, sans-serif;">
            <div style="font-size: 28px;">üì±</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 2px;">Installa JobLog</div>
                <div style="font-size: 13px; opacity: 0.9;">Accesso rapido dalla Home</div>
            </div>
            <button onclick="installPwa()" style="background: white; color: #16a34a; border: none; 
                    padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Installa
            </button>
            <button onclick="dismissPwaInstall()" style="background: transparent; border: none; 
                    color: white; opacity: 0.7; cursor: pointer; padding: 4px; font-size: 18px;">
                ‚úï
            </button>
        </div>
    `;
    document.body.appendChild(banner);
}

function hidePwaInstallBanner() {
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.remove();
}

// Rileva iOS
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

// Rileva se √® gi√† installata come PWA
function isStandalone() {
    return window.matchMedia('(display-mode: standalone)').matches || 
           window.navigator.standalone === true;
}

function showIOSInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'ios-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üì≤</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su iPhone/iPad</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il pulsante Condividi
                            </div>
                            <div style="font-size: 36px;">
                                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2">
                                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
                                    <polyline points="16,6 12,2 8,6"/>
                                    <line x1="12" y1="2" x2="12" y2="15"/>
                                </svg>
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                In basso nella barra di Safari
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #007AFF; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Scorri e tocca
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">‚ûï</span>
                                <span style="font-weight: 600;">Aggiungi a Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">‚úì</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma con "Aggiungi"
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparir√† nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissIOSInstallModal()" 
                            style="width: 100%; padding: 14px; background: #007AFF; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function installPwa() {
    // Se siamo gi√† in standalone mode, l'app √® gi√† installata
    if (isStandalone()) {
        alert('‚úÖ JobLog √® gi√† installata!');
        return;
    }
    
    // Se abbiamo il prompt nativo (Android/Desktop Chrome)
    if (deferredInstallPrompt) {
        hidePwaInstallBanner();
        deferredInstallPrompt.prompt();
        const { outcome } = await deferredInstallPrompt.userChoice;
        console.log('[PWA] User choice:', outcome);
        deferredInstallPrompt = null;
        return;
    }
    
    // Se siamo su iOS, mostra istruzioni specifiche
    if (isIOS()) {
        showIOSInstallInstructions();
        return;
    }
    
    // Se siamo su Android senza prompt nativo
    if (isAndroid()) {
        showAndroidInstallInstructions();
        return;
    }
    
    // Fallback per desktop
    alert('Per installare l\'app:\n\nüíª Desktop Chrome: Icona + nella barra indirizzi');
}

function dismissPwaInstall() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    hidePwaInstallBanner();
}

function dismissIOSInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('ios-install-modal');
    if (modal) modal.remove();
}

function dismissAndroidInstallModal() {
    localStorage.setItem('pwa-install-dismissed', Date.now().toString());
    const modal = document.getElementById('android-install-modal');
    if (modal) modal.remove();
}

// Rileva Android
function isAndroid() {
    return /Android/i.test(navigator.userAgent);
}

function showAndroidInstallInstructions() {
    const modal = document.createElement('div');
    modal.id = 'android-install-modal';
    modal.innerHTML = `
        <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10001; 
                    display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; border-radius: 20px; max-width: 340px; width: 100%; 
                        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                            padding: 24px 20px; text-align: center; color: white;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üì≤</div>
                    <div style="font-size: 20px; font-weight: 700;">Installa JobLog</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">su Android</div>
                </div>
                
                <!-- Steps -->
                <div style="padding: 24px 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca il menu di Chrome
                            </div>
                            <div style="font-size: 36px; color: #333;">‚ãÆ</div>
                            <div style="font-size: 13px; color: #64748b;">
                                I tre puntini in alto a destra
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 20px;">
                        <div style="width: 32px; height: 32px; background: #22c55e; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Tocca "Installa app" o
                            </div>
                            <div style="display: inline-flex; align-items: center; gap: 8px; 
                                        background: #f1f5f9; padding: 8px 14px; border-radius: 10px;
                                        font-size: 15px; color: #1e293b;">
                                <span style="font-size: 20px;">üì•</span>
                                <span style="font-weight: 600;">Aggiungi a schermata Home</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: #16a34a; color: white; 
                                    border-radius: 50%; display: flex; align-items: center; 
                                    justify-content: center; font-weight: 700; flex-shrink: 0;">‚úì</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                Conferma l'installazione
                            </div>
                            <div style="font-size: 13px; color: #64748b;">
                                L'icona apparir√† nella Home
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0;">
                    <button onclick="dismissAndroidInstallModal()" 
                            style="width: 100%; padding: 14px; background: #22c55e; color: white; 
                                   border: none; border-radius: 12px; font-size: 16px; 
                                   font-weight: 600; cursor: pointer;">
                        Ho capito
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Mostra pulsante installazione e guida automatica
document.addEventListener('DOMContentLoaded', () => {
    const menuBtn = document.getElementById('pwa-install-menu-item');
    
    // Se non √® gi√† installata come standalone
    if (!isStandalone()) {
        // Mostra pulsante nel menu per iOS e Android
        if (menuBtn && (isIOS() || isAndroid())) {
            menuBtn.style.display = 'flex';
        }
        
        // Mostra automaticamente la guida al primo accesso
        if (!localStorage.getItem('pwa-install-dismissed')) {
            setTimeout(() => {
                if (isIOS()) {
                    showIOSInstallInstructions();
                } else if (isAndroid() && !deferredInstallPrompt) {
                    showAndroidInstallInstructions();
                }
            }, 1500);
        }
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERTIME (STRAORDINARI) - Check automatico dopo checkout
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function checkOvertimeAfterCheckout(sessionId) {
    try {
        // Prendi inizio e fine giornata dalla variabile globale todayTimbrature
        const today = new Date().toISOString().split('T')[0];
        
        // todayTimbrature √® gi√† caricato dalla loadTimbrature()
        if (!todayTimbrature || todayTimbrature.length === 0) return;
        
        // Trova orari inizio/fine giornata di oggi
        const inizio = todayTimbrature.find(t => t.tipo === 'inizio_giornata');
        const fine = todayTimbrature.find(t => t.tipo === 'fine_giornata');
        
        if (!inizio || !fine) return;
        
        // Estrai l'ora (pu√≤ essere oggetto o stringa)
        const getTimeStr = (t) => {
            if (!t.ora) return null;
            if (typeof t.ora === 'string') return t.ora.substring(0, 5);
            if (t.ora.hour !== undefined) return `${String(t.ora.hour).padStart(2,'0')}:${String(t.ora.minute || 0).padStart(2,'0')}`;
            return String(t.ora).substring(0, 5);
        };
        
        const actualStart = getTimeStr(inizio);
        const actualEnd = getTimeStr(fine);
        
        if (!actualStart || !actualEnd) return;
        
        const res = await fetch(`/api/user/check-overtime?date=${today}&actual_start=${actualStart}&actual_end=${actualEnd}&session_id=${sessionId || ''}`);
        const data = await res.json();
        
        if (data.overtime_detected) {
            showOvertimeModal(data);
        }
    } catch (err) {
        console.error('Errore check overtime:', err);
    }
}

function showOvertimeModal(overtimeData) {
    // Rimuovi modal esistente se presente
    const existingModal = document.getElementById('overtimeModal');
    if (existingModal) existingModal.remove();
    
    const hours = Math.floor(overtimeData.total_extra_minutes / 60);
    const mins = overtimeData.total_extra_minutes % 60;
    const timeStr = hours > 0 ? `${hours}h ${mins}m` : `${mins} minuti`;
    
    const typeLabels = {
        before_shift: 'Prima del turno',
        after_shift: 'Dopo il turno',
        both: 'Prima e dopo il turno',
        extra_day: 'Giornata extra'
    };
    
    const modal = document.createElement('div');
    modal.id = 'overtimeModal';
    modal.innerHTML = `
        <style>
            #overtimeModal {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            }
            #overtimeModal .modal-content {
                background: white;
                border-radius: 20px;
                max-width: 400px;
                width: 100%;
                padding: 28px;
                text-align: center;
                animation: slideUp 0.3s ease;
            }
            #overtimeModal .modal-icon {
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 20px;
                font-size: 2rem;
            }
            #overtimeModal h3 {
                margin: 0 0 12px;
                font-size: 1.3rem;
            }
            #overtimeModal .time-highlight {
                background: #fef3c7;
                padding: 16px;
                border-radius: 12px;
                margin: 16px 0;
            }
            #overtimeModal .time-highlight .value {
                font-size: 2rem;
                font-weight: 700;
                color: #92400e;
            }
            #overtimeModal .time-highlight .label {
                font-size: 0.85rem;
                color: #78350f;
            }
            #overtimeModal .details {
                text-align: left;
                font-size: 0.9rem;
                color: #64748b;
                margin: 16px 0;
            }
            #overtimeModal .details .row {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid #f1f5f9;
            }
            #overtimeModal textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                font-size: 0.9rem;
                resize: none;
                margin-bottom: 16px;
            }
            #overtimeModal textarea:focus {
                outline: none;
                border-color: #4361ee;
            }
            #overtimeModal .btn-row {
                display: flex;
                gap: 12px;
            }
            #overtimeModal button {
                flex: 1;
                padding: 14px;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                border: none;
            }
            #overtimeModal .btn-cancel {
                background: #f1f5f9;
                color: #64748b;
            }
            #overtimeModal .btn-confirm {
                background: linear-gradient(135deg, #4361ee, #7c3aed);
                color: white;
            }
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div class="modal-content">
            <div class="modal-icon">‚è±Ô∏è</div>
            <h3>Straordinario Rilevato</h3>
            <p style="color:#64748b;margin:0 0 16px;">Hai lavorato oltre il turno pianificato</p>
            
            <div class="time-highlight">
                <div class="value">${timeStr}</div>
                <div class="label">${typeLabels[overtimeData.overtime_type] || 'Straordinario'}</div>
            </div>
            
            <div class="details">
                <div class="row">
                    <span>Turno pianificato</span>
                    <strong>${overtimeData.planned_start || '--'} - ${overtimeData.planned_end || '--'}</strong>
                </div>
                <div class="row">
                    <span>Timbrate originali</span>
                    <strong>${overtimeData.actual_start} - ${overtimeData.actual_end}</strong>
                </div>
                <div class="row" style="background:#fef3c7;margin:0 -8px;padding:8px;border-radius:6px;">
                    <span>Timbrate arrotondate</span>
                    <strong style="color:#92400e;">${overtimeData.rounded_start || overtimeData.actual_start} - ${overtimeData.rounded_end || overtimeData.actual_end}</strong>
                </div>
            </div>
            
            <textarea id="overtimeNotes" placeholder="Inserisci una motivazione..." rows="2" required></textarea>
            <div style="font-size:0.75rem;color:#ef4444;margin:-8px 0 8px;" id="notesError" hidden>‚ö†Ô∏è La motivazione √® obbligatoria</div>
            
            <div class="btn-row">
                <button class="btn-confirm" onclick="submitOvertimeRequest()">Conferma</button>
            </div>
        </div>
    `;
    
    // Salva dati per submit
    modal.dataset.overtimeData = JSON.stringify(overtimeData);
    
    document.body.appendChild(modal);
    
    // Modal obbligatorio - non chiudibile cliccando fuori
}

function closeOvertimeModal() {
    const modal = document.getElementById('overtimeModal');
    if (modal) modal.remove();
}

async function submitOvertimeRequest() {
    const modal = document.getElementById('overtimeModal');
    if (!modal) return;
    
    const data = JSON.parse(modal.dataset.overtimeData || '{}');
    const notes = document.getElementById('overtimeNotes')?.value.trim() || '';
    const notesError = document.getElementById('notesError');
    
    // Validazione note obbligatorie
    if (!notes) {
        notesError.hidden = false;
        document.getElementById('overtimeNotes').focus();
        return;
    }
    notesError.hidden = true;
    
    const btn = modal.querySelector('.btn-confirm');
    btn.disabled = true;
    btn.textContent = 'Invio...';
    
    try {
        const res = await fetch('/api/user/overtime', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: data.date,
                session_id: data.session_id,
                planning_id: data.planning_id,
                shift_source: data.shift_source,
                planned_start: data.planned_start,
                planned_end: data.planned_end,
                actual_start: data.actual_start,
                actual_end: data.actual_end,
                rounded_start: data.rounded_start,
                rounded_end: data.rounded_end,
                extra_minutes_before: data.extra_minutes_before || 0,
                extra_minutes_after: data.extra_minutes_after || 0,
                total_extra_minutes: data.total_extra_minutes,
                overtime_type: data.overtime_type,
                notes: notes
            })
        });
        
        const result = await res.json();
        
        if (result.ok) {
            closeOvertimeModal();
            showToast('‚úÖ Richiesta straordinario inviata', 'success');
            // Ricarica le timbrature per mostrare il badge "in attesa"
            await loadTimbrature();
        } else {
            showToast(result.error || 'Errore invio richiesta', 'error');
            btn.disabled = false;
            btn.textContent = 'Richiedi';
        }
    } catch (err) {
        console.error('Errore submit overtime:', err);
        showToast('Errore di connessione', 'error');
        btn.disabled = false;
        btn.textContent = 'Richiedi';
    }
}
</script>
</body>
</html>
